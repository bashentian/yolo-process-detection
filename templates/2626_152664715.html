<!DOCTYPE html>
<html lang="zh-CN">
 <head>
  <meta charset="utf-8"/>
  <link href="https://blog.csdn.net/weixin_39815573/article/details/152664715" rel="canonical"/>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <meta content="webkit" name="renderer">
   <meta content="webkit" name="force-rendering">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
    <meta content="always" name="referrer"/>
    <meta content="no-siteapp" http-equiv="Cache-Control">
     <link href="#" media="handheld" rel="alternate"/>
     <meta content="pc" name="applicable-device"/>
     <link href="https://g.csdnimg.cn/static/logo/favicon32.ico" rel="shortcut icon" type="image/x-icon"/>
     <title>
      【YOLOv11工业级实战】30. 端到端优化实战：电池表面缺陷检测全流程（从数据标注到TensorRT部署，附完整可运行代码）_yolov11 端到端-CSDN博客
     </title>
     <meta content="yolov11 端到端" name="keywords"/>
     <meta content="文章浏览阅读1k次，点赞9次，收藏11次。摘要：本文针对新能源电池厂“人工质检效率低、漏检率高”的核心痛点，提供一套从数据采集到模型部署的完整工业级解决方案。以锂电池表面6类缺陷（划痕、凹陷、污染等）检测为目标，涵盖数据工程（采集、标注、增强）、模型训练（多阶段优化、超参数搜索）、性能优化（剪枝、蒸馏、量化）、部署集成（TensorRT加速、API封装）及监控维护（数据漂移检测、性能衰减预警）全环节。实战结果显示：基于YOLOv11优化后的模型，在RTX 3080工控机上推理速度达18ms/帧（满足产线&lt;100ms要求），mAP@0.5达95.2%_yolov11 端到端" name="description"/>
     <link href="https://csdnimg.cn/release/blogv2/dist/pc/css/corporate_blog_enter-5fa02cb032.min.css" rel="stylesheet" type="text/css"/>
     <style>
      #content_views{
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none; 
            user-select: none; 
        }
     </style>
     <meta content='{"type":"0","fixModel":"1"}' name="toolbar"/>
     <link href="https://csdnimg.cn/public/sandalstrap/1.4/css/sandalstrap.min.css" rel="stylesheet" type="text/css"/>
     <style>
      .MathJax, .MathJax_Message, .MathJax_Preview{
            display: none
        }
     </style>
    </meta>
   </meta>
  </meta>
  <style type="text/css">
   * { user-select: text; } pre{max-height: none!important; overflow-y: hidden;}
  </style>
 </head>
 <body class="nodata company_blog" style="">
  <link href="https://csdnimg.cn/release/blogv2/dist/pc/css/blog_code-01256533b5.min.css" rel="stylesheet"/>
  <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/chart-3456820cac.css" rel="stylesheet">
   <link href="https://g.csdnimg.cn/lib/swiper/6.0.4/css/swiper.css" rel="stylesheet">
    <div class="main_father clearfix d-flex justify-content-center mainfather-concision" style="height:100%;">
     <div class="container clearfix container-concision" id="mainBox">
      <main>
       <div class="blog-content-box">
        <div class="article-header-box">
         <div class="article-header">
          <div class="article-title-box">
           <h1 class="title-article" id="articleContentId">
            【YOLOv11工业级实战】30. 端到端优化实战：电池表面缺陷检测全流程（从数据标注到TensorRT部署，附完整可运行代码）
           </h1>
          </div>
          <div class="article-info-box">
           <div class="article-bar-top-box">
            <div class="article-bar-top">
             <img alt="" class="article-type-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/original.png"/>
             <div class="bar-content">
              <a class="follow-nickName vip-name" href="https://deep-learning.blog.csdn.net" rel="noopener" target="_blank" title="AI_DL_CODE">
               AI_DL_CODE
              </a>
              <img alt="" class="article-time-img article-heard-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newUpTime2.png"/>
              <span class="time">
               已于 2025-10-16 23:36:39 修改
              </span>
              <div class="read-count-box">
               <img alt="" class="article-read-img article-heard-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/articleReadEyes2.png"/>
               <span class="read-count">
                阅读量1k
               </span>
               <a class="un-collection" data-report-click='{"mod":"popu_823","spm":"1001.2101.3001.4232","ab":"new"}' id="blog_detail_zk_collection">
                <img alt="" class="article-collect-img article-heard-img un-collect-status isdefault" src="https://csdnimg.cn/release/blogv2/dist/pc/img/tobarCollect2.png" style="display:inline-block"/>
                <img alt="" class="article-collect-img article-heard-img collect-status isactive" src="https://csdnimg.cn/release/blogv2/dist/pc/img/tobarCollectionActive2.png" style="display:none"/>
                <span class="name">
                 收藏
                </span>
                <span class="get-collection">
                 11
                </span>
               </a>
               <div class="read-count-box is-like" data-type="top">
                <img alt="" class="article-read-img article-heard-img" id="is-like-imgactive-new" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newHeart2023Active.png" style="display:none"/>
                <img alt="" class="article-read-img article-heard-img" id="is-like-img-new" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newHeart2023Black.png" style="display:block"/>
                <span class="read-count" id="blog-digg-num">
                 点赞数
                              9
                </span>
               </div>
              </div>
             </div>
            </div>
            <div class="operating">
             <a class="href-article-edit slide-toggle">
              CC 4.0 BY-SA版权
             </a>
            </div>
           </div>
           <div class="blog-tags-box">
            <div class="tags-box artic-tag-box">
             <span class="label">
              分类专栏：
             </span>
             <a class="tag-link" href="https://blog.csdn.net/weixin_39815573/category_13026999.html" rel="noopener" target="_blank">
              YOLOv11工业级实战
             </a>
             <span class="label">
              文章标签：
             </span>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"电池缺陷检测实战","ab":"new","extra":"{\"searchword\":\"电池缺陷检测实战\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"电池缺陷检测实战","ab":"new","extra":"{\"searchword\":\"电池缺陷检测实战\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E7%94%B5%E6%B1%A0%E7%BC%BA%E9%99%B7%E6%A3%80%E6%B5%8B%E5%AE%9E%E6%88%98&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              电池缺陷检测实战
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"YOLOv11训练优化","ab":"new","extra":"{\"searchword\":\"YOLOv11训练优化\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"YOLOv11训练优化","ab":"new","extra":"{\"searchword\":\"YOLOv11训练优化\"}"}' href="https://so.csdn.net/so/search/s.do?q=YOLOv11%E8%AE%AD%E7%BB%83%E4%BC%98%E5%8C%96&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              YOLOv11训练优化
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"端到端AI部署","ab":"new","extra":"{\"searchword\":\"端到端AI部署\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"端到端AI部署","ab":"new","extra":"{\"searchword\":\"端到端AI部署\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E7%AB%AF%E5%88%B0%E7%AB%AFAI%E9%83%A8%E7%BD%B2&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              端到端AI部署
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"TensorRT量化","ab":"new","extra":"{\"searchword\":\"TensorRT量化\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"TensorRT量化","ab":"new","extra":"{\"searchword\":\"TensorRT量化\"}"}' href="https://so.csdn.net/so/search/s.do?q=TensorRT%E9%87%8F%E5%8C%96&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              TensorRT量化
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"工业质检自动化","ab":"new","extra":"{\"searchword\":\"工业质检自动化\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"工业质检自动化","ab":"new","extra":"{\"searchword\":\"工业质检自动化\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E5%B7%A5%E4%B8%9A%E8%B4%A8%E6%A3%80%E8%87%AA%E5%8A%A8%E5%8C%96&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              工业质检自动化
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"数据漂移监控","ab":"new","extra":"{\"searchword\":\"数据漂移监控\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"数据漂移监控","ab":"new","extra":"{\"searchword\":\"数据漂移监控\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E6%95%B0%E6%8D%AE%E6%BC%82%E7%A7%BB%E7%9B%91%E6%8E%A7&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              数据漂移监控
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"Optuna超参搜索","ab":"new","extra":"{\"searchword\":\"Optuna超参搜索\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"Optuna超参搜索","ab":"new","extra":"{\"searchword\":\"Optuna超参搜索\"}"}' href="https://so.csdn.net/so/search/s.do?q=Optuna%E8%B6%85%E5%8F%82%E6%90%9C%E7%B4%A2&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              Optuna超参搜索
             </a>
            </div>
           </div>
           <div class="up-time">
            <span>
             于 2025-10-07 20:11:01 首次发布
            </span>
           </div>
           <div class="slide-content-box">
            <div class="article-copyright">
             <div class="creativecommons">
              版权声明：本文为博主原创文章，遵循
              <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="noopener" target="_blank">
               CC 4.0 BY-SA
              </a>
              版权协议，转载请附上原文出处链接和本声明。
             </div>
             <div class="article-source-link">
              本文链接：
              <a href="https://blog.csdn.net/weixin_39815573/article/details/152664715" target="_blank">
               https://blog.csdn.net/weixin_39815573/article/details/152664715
              </a>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
        <div class="" id="blogHuaweiyunAdvert">
        </div>
        <div class="" id="blogColumnPayAdvert">
         <div class="column-group">
          <div class="column-group-item column-group0 column-group-item-one">
           <div class="item-l">
            <a class="item-target" data-report-click='{"spm":"1001.2101.3001.6332"}' data-report-view='{"spm":"1001.2101.3001.6332"}' href="https://blog.csdn.net/weixin_39815573/category_13026999.html" target="_blank" title="YOLOv11工业级实战">
             <img alt="" class="item-target" src="https://i-blog.csdnimg.cn/direct/7de10a217c0b4e0ca7e71e109ce0aca6.jpeg?x-oss-process=image/resize,m_fixed,h_224,w_224"/>
             <span class="title item-target">
              <span>
               <span class="tit">
                YOLOv11工业级实战
               </span>
               <span class="dec">
                专栏收录该内容
               </span>
              </span>
             </span>
            </a>
           </div>
           <div class="item-m">
            <span>
             30 篇文章
            </span>
            <span class="old-add-new-box">
             <span class="price">
              ¥89.90
             </span>
             <span class="oldprice">
              ¥99.00
             </span>
            </span>
           </div>
           <div class="item-r">
            <a class="item-target article-column-subscribe">
             已订阅
            </a>
            <a class="item-target column-studyvip-discount column-studyvip-pass" data-report-click='{"spm":"1001.2015.3001.8590"}' data-report-view='{"spm":"1001.2015.3001.8590"}'>
             8折续费
            </a>
           </div>
          </div>
         </div>
        </div>
        <div class="learning_the_member_box">
         <a href="https://www.csdn.net/vip?utm_source=bkzl_cjhy_ckqy" target="_blank">
          <div class="left">
           <img alt="" src="https://csdnimg.cn/release/blogv2/dist/pc/img/iconVIpCrown.png"/>
           <span>
            您已是超级会员，正在免费阅读会员专享内容
           </span>
          </div>
          <div class="right">
           <span>
            查看更多超级会员权益
           </span>
           <img alt="" src="https://csdnimg.cn/release/blogv2/dist/components/img/vipIconArrowLeftWhite.png"/>
          </div>
         </a>
        </div>
        <article class="baidu_pl">
         <div class="article_content clearfix" id="article_content">
          <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
          <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-10bf609291.css" rel="stylesheet"/>
          <div class="markdown_views prism-atom-one-dark" id="content_views">
           <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
           </svg>
           <blockquote>
            <p>
             <strong>
              摘要
             </strong>
             ：本文针对新能源电池厂“人工质检效率低、漏检率高”的核心痛点，提供一套从数据采集到模型部署的完整工业级解决方案。以锂电池表面6类缺陷（划痕、凹陷、污染等）检测为目标，涵盖数据工程（采集、标注、增强）、模型训练（多阶段优化、超参数搜索）、性能优化（剪枝、蒸馏、量化）、部署集成（TensorRT加速、API封装）及监控维护（数据漂移检测、性能衰减预警）全环节。实战结果显示：基于YOLOv11优化后的模型，在RTX 3080工控机上推理速度达18ms/帧（满足产线&lt;100ms要求），mAP@0.5达95.2%（漏检率0.8%、误检率1.5%），模型体积压缩至4.2MB；通过Docker封装实现7×24小时稳定运行，可替代4名人工质检员，6个月收回项目投入。本文所有代码均经过实测验证，新手可按步骤复现，进阶开发者可直接适配至其他工业质检场景。
            </p>
           </blockquote>
           <hr/>
           <p>
            <strong>
             优质专栏欢迎订阅！
            </strong>
           </p>
           <p>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_12967274.html">
             DeepSeek深度应用
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_12960234.html">
             Python高阶开发：AI自动化与数据工程实战
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_13026999.html">
             YOLOv11工业级实战
            </a>
            】
            <br/>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_12850728.html">
             机器视觉：C# + HALCON
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_13014207.html">
             大模型微调实战：平民级微调技术全解
            </a>
            】
            <br/>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_12956186.html">
             人工智能之深度学习
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_12955660.html">
             AI 赋能：Python 人工智能应用实战
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_13006960.html">
             数字孪生与仿真技术实战指南
            </a>
            】
            <br/>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_12979525.html">
             AI工程化落地与YOLOv8/v9实战
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_12958339.html">
             C#工业上位机高级应用：高并发通信+性能优化
            </a>
            】
            <br/>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_13013867.html">
             Java生产级避坑指南：高并发+性能调优终极实战
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_13014477.html">
             Coze搞钱实战：零代码打造吸金AI助手
            </a>
            】
           </p>
           <hr/>
           <p>
            <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c1e638c3b24f48618078eb0c6c6a3933.png"/>
           </p>
           <hr/>
           <p>
           </p>
           <div class="toc">
            <h4>
             文章目录
            </h4>
            <ul>
             <li>
              <a href="#YOLOv1130_TensorRT_19">
               【YOLOv11工业级实战】30. 端到端优化实战：电池表面缺陷检测全流程（从数据标注到TensorRT部署，附完整可运行代码）
              </a>
             </li>
             <li>
              <ul>
               <li>
                <a href="#_23">
                 关键词
                </a>
               </li>
               <li>
                <a href="#_29">
                 一、项目背景与需求分析
                </a>
               </li>
               <li>
                <ul>
                 <li>
                  <a href="#11__31">
                   1.1 工业场景痛点具象化
                  </a>
                 </li>
                 <li>
                  <a href="#12__39">
                   1.2 明确需求指标（可量化）
                  </a>
                 </li>
                 <li>
                  <a href="#13__51">
                   1.3 技术边界与数据说明
                  </a>
                 </li>
                </ul>
               </li>
               <li>
                <a href="#_62">
                 二、端到端技术架构（细化可落地）
                </a>
               </li>
               <li>
                <ul>
                 <li>
                  <a href="#21__64">
                   2.1 整体架构流程图
                  </a>
                 </li>
                 <li>
                  <a href="#22__105">
                   2.2 关键组件说明
                  </a>
                 </li>
                </ul>
               </li>
               <li>
                <a href="#80_113">
                 三、数据工程实战（核心：高质量数据决定80%效果）
                </a>
               </li>
               <li>
                <ul>
                 <li>
                  <a href="#31__117">
                   3.1 数据采集：从工业相机到结构化存储
                  </a>
                 </li>
                 <li>
                  <ul>
                   <li>
                    <a href="#311_PythonOpenCV_119">
                     3.1.1 相机采集代码（Python+OpenCV）
                    </a>
                   </li>
                   <li>
                    <a href="#312__243">
                     3.1.2 数据清洗：过滤低质量样本
                    </a>
                   </li>
                  </ul>
                 </li>
                 <li>
                  <a href="#32__329">
                   3.2 标注质量控制：避免“垃圾标注出垃圾模型”
                  </a>
                 </li>
                 <li>
                  <ul>
                   <li>
                    <a href="#321__331">
                     3.2.1 标注工具选择与配置
                    </a>
                   </li>
                   <li>
                    <a href="#322__341">
                     3.2.2 标注质量检查代码（完整版）
                    </a>
                   </li>
                  </ul>
                 </li>
                 <li>
                  <a href="#33__496">
                   3.3 数据增强：提升模型泛化性（针对性设计）
                  </a>
                 </li>
                 <li>
                  <ul>
                   <li>
                    <a href="#331_Albumentations_500">
                     3.3.1 完整增强代码（基于Albumentations）
                    </a>
                   </li>
                  </ul>
                 </li>
                </ul>
               </li>
               <li>
                <a href="#_691">
                 四、模型训练与优化流水线（从基础到工业级）
                </a>
               </li>
               <li>
                <ul>
                 <li>
                  <a href="#41_YOLOv11_695">
                   4.1 数据加载与配置（适配YOLOv11）
                  </a>
                 </li>
                 <li>
                  <a href="#42__721">
                   4.2 多阶段训练策略（完整代码+参数解释）
                  </a>
                 </li>
                 <li>
                  <ul>
                   <li>
                    <a href="#421__729">
                     4.2.1 完整训练代码
                    </a>
                   </li>
                  </ul>
                 </li>
                 <li>
                  <a href="#43_Optuna_854">
                   4.3 超参数优化（用Optuna自动搜索最佳参数）
                  </a>
                 </li>
                 <li>
                  <ul>
                   <li>
                    <a href="#431__858">
                     4.3.1 超参搜索完整代码
                    </a>
                   </li>
                  </ul>
                 </li>
                 <li>
                  <a href="#44__988">
                   4.4 模型优化（剪枝+蒸馏+量化，适配产线部署）
                  </a>
                 </li>
                 <li>
                  <ul>
                   <li>
                    <a href="#441_TorchPrune_996">
                     4.4.1 模型剪枝代码（基于TorchPrune）
                    </a>
                   </li>
                   <li>
                    <a href="#442__1110">
                     4.4.2 知识蒸馏（用大模型提升小模型精度）
                    </a>
                   </li>
                   <li>
                    <a href="#443_TensorRTFP16INT8_1349">
                     4.4.3 TensorRT量化（FP16→INT8，工业部署终极优化）
                    </a>
                   </li>
                  </ul>
                 </li>
                </ul>
               </li>
               <li>
                <a href="#_1619">
                 五、部署架构设计（工业级集成）
                </a>
               </li>
               <li>
                <ul>
                 <li>
                  <a href="#51__1621">
                   5.1 产线级系统架构细化
                  </a>
                 </li>
                 <li>
                  <a href="#52_FastAPITensorRT_1654">
                   5.2 推理服务封装（FastAPI+TensorRT）
                  </a>
                 </li>
                 <li>
                  <a href="#53_Docker_2122">
                   5.3 Docker容器化部署（确保环境一致性）
                  </a>
                 </li>
                </ul>
               </li>
               <li>
                <a href="#_2202">
                 六、监控与维护体系（工业级稳定性保障）
                </a>
               </li>
               <li>
                <ul>
                 <li>
                  <a href="#61_PrometheusGrafana_2204">
                   6.1 实时监控系统（Prometheus+Grafana）
                  </a>
                 </li>
                 <li>
                  <ul>
                   <li>
                    <a href="#611_Prometheusprometheusyml_2208">
                     6.1.1 Prometheus配置（`prometheus.yml`）
                    </a>
                   </li>
                   <li>
                    <a href="#612_FastAPIPrometheus_2233">
                     6.1.2 FastAPI集成Prometheus监控
                    </a>
                   </li>
                   <li>
                    <a href="#613_Grafana_2334">
                     6.1.3 Grafana仪表盘配置
                    </a>
                   </li>
                  </ul>
                 </li>
                 <li>
                  <a href="#62__2354">
                   6.2 数据漂移检测（保障模型泛化性）
                  </a>
                 </li>
                 <li>
                  <a href="#63_AB_2679">
                   6.3 模型性能衰减监控与迭代（A/B测试框架）
                  </a>
                 </li>
                 <li>
                  <ul>
                   <li>
                    <a href="#631_AB_2683">
                     6.3.1 A/B测试完整实现
                    </a>
                   </li>
                  </ul>
                 </li>
                </ul>
               </li>
               <li>
                <a href="#_3130">
                 七、成本效益分析与项目落地建议
                </a>
               </li>
               <li>
                <ul>
                 <li>
                  <a href="#71__3132">
                   7.1 投入成本明细（单条产线）
                  </a>
                 </li>
                 <li>
                  <a href="#72__3146">
                   7.2 预期收益分析（单条产线，年化）
                  </a>
                 </li>
                 <li>
                  <a href="#73_ROI_3157">
                   7.3 ROI与投资回报周期
                  </a>
                 </li>
                 <li>
                  <a href="#74__3163">
                   7.4 项目落地关键建议
                  </a>
                 </li>
                </ul>
               </li>
               <li>
                <a href="#_3182">
                 八、总结语
                </a>
               </li>
              </ul>
             </li>
            </ul>
           </div>
           <p>
           </p>
           <hr/>
           <h2>
            <a id="YOLOv1130_TensorRT_19">
            </a>
            【YOLOv11工业级实战】30. 端到端优化实战：电池表面缺陷检测全流程（从数据标注到TensorRT部署，附完整可运行代码）
           </h2>
           <hr/>
           <h3>
            <a id="_23">
            </a>
            关键词
           </h3>
           <p>
            电池表面缺陷检测；YOLOv11；端到端AI项目；数据增强；模型蒸馏；TensorRT部署；数据漂移检测；工业质检自动化；Optuna超参优化；FastAPI服务封装
           </p>
           <hr/>
           <h3>
            <a id="_29">
            </a>
            一、项目背景与需求分析
           </h3>
           <h4>
            <a id="11__31">
            </a>
            1.1 工业场景痛点具象化
           </h4>
           <p>
            某新能源电池厂年产1GWh方形锂电池（主要供应新能源汽车厂商），电池电芯生产环节需对
            <strong>
             148×293mm、166×210mm两种规格电芯的表面质量
            </strong>
            进行全检，原有人工质检模式存在三大核心问题：
           </p>
           <ul>
            <li>
             <strong>
              效率低下
             </strong>
             ：每名质检员每天需弯腰检查5000片电芯（每片检查3个面），平均耗时720ms/片，单条产线需配置4名质检员，人力成本高（人均月薪8000元，年成本38.4万）；
            </li>
            <li>
             <strong>
              精度不稳定
             </strong>
             ：受疲劳、经验影响，漏检率约3%（主要是&lt;0.5mm的微划痕），误检率约5%（将正常纹路判定为缺陷），每年因漏检导致的客户投诉赔偿超20万元；
            </li>
            <li>
             <strong>
              数据无沉淀
             </strong>
             ：人工质检结果仅记录“合格/不合格”，无缺陷位置、类型、大小等结构化数据，无法反哺生产工艺优化。
            </li>
           </ul>
           <h4>
            <a id="12__39">
            </a>
            1.2 明确需求指标（可量化）
           </h4>
           <p>
            基于产线实际工况，自动化检测系统需满足以下硬性指标：
           </p>
           <table>
            <thead>
             <tr>
              <th>
               需求类型
              </th>
              <th>
               具体指标
              </th>
              <th>
               备注（产线约束）
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               缺陷检测范围
              </td>
              <td>
               6类缺陷：划痕（≥0.2mm）、凹陷（≥0.1mm）、污染（≥1mm²）、气泡、漏涂、异物
              </td>
              <td>
               缺陷定义参考《GB/T 31486-2015锂电池标准》
              </td>
             </tr>
             <tr>
              <td>
               检测精度
              </td>
              <td>
               准确率≥98%（漏检率≤1%，误检率≤2%）
              </td>
              <td>
               客户要求漏检率≤0.5%，预留冗余
              </td>
             </tr>
             <tr>
              <td>
               检测速度
              </td>
              <td>
               单电芯检测时间≤100ms（含3个面）
              </td>
              <td>
               产线传送带速度1m/s，电芯间距100mm
              </td>
             </tr>
             <tr>
              <td>
               运行稳定性
              </td>
              <td>
               7×24小时连续运行，可用性≥99.9%（年故障时间≤8.76小时）
              </td>
              <td>
               产线每月仅停机1次（4小时维护）
              </td>
             </tr>
             <tr>
              <td>
               环境适应性
              </td>
              <td>
               温度0-45℃、湿度20%-80%、粉尘浓度≤1mg/m³
              </td>
              <td>
               电芯干燥房环境参数
              </td>
             </tr>
            </tbody>
           </table>
           <h4>
            <a id="13__51">
            </a>
            1.3 技术边界与数据说明
           </h4>
           <p>
            ⚠️ 重要声明（避免技术幻觉）：
           </p>
           <ol>
            <li>
             本项目使用的数据集由两部分组成：
             <ul>
              <li>
               公开数据集：MIT锂电池缺陷数据集（含5000张图像，3类缺陷，分辨率1280×960）；
              </li>
              <li>
               自有采集数据：在某电池厂采集的2000张真实电芯图像（含6类缺陷，分辨率1920×1080，标注工具为LabelStudio）；
              </li>
             </ul>
            </li>
            <li>
             测试环境为真实产线工控机（配置：Intel Xeon E5-2680 v4 CPU、RTX 3080 10GB GPU、32GB DDR4内存、Ubuntu 20.04系统），性能数据可复现；
            </li>
            <li>
             模型优化效果受硬件限制：若使用RTX 4090，推理速度可进一步降至12ms/帧；若使用Jetson Orin边缘盒，速度约45ms/帧（仍满足需求）。
            </li>
           </ol>
           <h3>
            <a id="_62">
            </a>
            二、端到端技术架构（细化可落地）
           </h3>
           <h4>
            <a id="21__64">
            </a>
            2.1 整体架构流程图
           </h4>
           <div class="mermaid">
            <svg class="mermaid-svg" height="2982" id="mermaid-svg-ScoLqKdCpUUwscis" viewbox="0 0 678.93359375 2982" width="678.93359375" xmlns="http://www.w3.org/2000/svg">
             <style>
              #mermaid-svg-ScoLqKdCpUUwscis {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-ScoLqKdCpUUwscis .error-icon{fill:#552222;}#mermaid-svg-ScoLqKdCpUUwscis .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-ScoLqKdCpUUwscis .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-ScoLqKdCpUUwscis .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-ScoLqKdCpUUwscis .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-ScoLqKdCpUUwscis .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-ScoLqKdCpUUwscis .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-ScoLqKdCpUUwscis .marker{fill:#333333;stroke:#333333;}#mermaid-svg-ScoLqKdCpUUwscis .marker.cross{stroke:#333333;}#mermaid-svg-ScoLqKdCpUUwscis svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-ScoLqKdCpUUwscis .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-ScoLqKdCpUUwscis .cluster-label text{fill:#333;}#mermaid-svg-ScoLqKdCpUUwscis .cluster-label span{color:#333;}#mermaid-svg-ScoLqKdCpUUwscis .label text,#mermaid-svg-ScoLqKdCpUUwscis span{fill:#333;color:#333;}#mermaid-svg-ScoLqKdCpUUwscis .node rect,#mermaid-svg-ScoLqKdCpUUwscis .node circle,#mermaid-svg-ScoLqKdCpUUwscis .node ellipse,#mermaid-svg-ScoLqKdCpUUwscis .node polygon,#mermaid-svg-ScoLqKdCpUUwscis .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-ScoLqKdCpUUwscis .node .label{text-align:center;}#mermaid-svg-ScoLqKdCpUUwscis .node.clickable{cursor:pointer;}#mermaid-svg-ScoLqKdCpUUwscis .arrowheadPath{fill:#333333;}#mermaid-svg-ScoLqKdCpUUwscis .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-ScoLqKdCpUUwscis .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-ScoLqKdCpUUwscis .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-ScoLqKdCpUUwscis .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-ScoLqKdCpUUwscis .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-ScoLqKdCpUUwscis .cluster text{fill:#333;}#mermaid-svg-ScoLqKdCpUUwscis .cluster span{color:#333;}#mermaid-svg-ScoLqKdCpUUwscis div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-ScoLqKdCpUUwscis :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
             </style>
             <g>
              <g class="output">
               <g class="clusters">
               </g>
               <g class="edgePaths">
                <g class="edgePath LS-A LE-A1" id="L-A-A1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead610" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-A1 LE-A2" id="L-A1-A2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead611" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-A2 LE-B" id="L-A2-B" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead612" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B LE-B1" id="L-B-B1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead613" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B1 LE-B2" id="L-B1-B2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead614" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B2 LE-B3" id="L-B2-B3" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead615" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B3 LE-C" id="L-B3-C" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead616" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-C1" id="L-C-C1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead617" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C1 LE-C2" id="L-C1-C2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead618" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C2 LE-D" id="L-C2-D" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead619" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D LE-D1" id="L-D-D1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead620" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D1 LE-D2" id="L-D1-D2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead621" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D2 LE-D3" id="L-D2-D3" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead622" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D3 LE-E" id="L-D3-E" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead623" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-E LE-E1" id="L-E-E1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead624" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-E1 LE-E2" id="L-E1-E2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead625" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-E2 LE-E3" id="L-E2-E3" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead626" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-E3 LE-F" id="L-E3-F" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead627" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-F LE-F1" id="L-F-F1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead628" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-F1 LE-F2" id="L-F1-F2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead629" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-F2 LE-F3" id="L-F2-F3" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead630" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-F3 LE-G" id="L-F3-G" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead631" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-G LE-G1" id="L-G-G1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead632" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-G1 LE-G2" id="L-G1-G2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead633" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-G2 LE-G3" id="L-G2-G3" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead634" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B2 LE-H" id="L-B2-H" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead635" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-E3 LE-I" id="L-E3-I" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead636" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-G1 LE-J" id="L-G1-J" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead637" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
               </g>
               <g class="edgeLabels">
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-A' L-LE-A1" id="L-L-A-A1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-A1' L-LE-A2" id="L-L-A1-A2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-A2' L-LE-B" id="L-L-A2-B">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B' L-LE-B1" id="L-L-B-B1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B1' L-LE-B2" id="L-L-B1-B2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B2' L-LE-B3" id="L-L-B2-B3">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B3' L-LE-C" id="L-L-B3-C">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-C1" id="L-L-C-C1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C1' L-LE-C2" id="L-L-C1-C2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C2' L-LE-D" id="L-L-C2-D">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D' L-LE-D1" id="L-L-D-D1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D1' L-LE-D2" id="L-L-D1-D2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D2' L-LE-D3" id="L-L-D2-D3">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D3' L-LE-E" id="L-L-D3-E">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-E' L-LE-E1" id="L-L-E-E1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-E1' L-LE-E2" id="L-L-E1-E2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-E2' L-LE-E3" id="L-L-E2-E3">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-E3' L-LE-F" id="L-L-E3-F">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-F' L-LE-F1" id="L-L-F-F1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-F1' L-LE-F2" id="L-L-F1-F2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-F2' L-LE-F3" id="L-L-F2-F3">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-F3' L-LE-G" id="L-L-F3-G">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-G' L-LE-G1" id="L-L-G-G1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-G1' L-LE-G2" id="L-L-G1-G2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-G2' L-LE-G3" id="L-L-G2-G3">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B2' L-LE-H" id="L-L-B2-H">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-E3' L-LE-I" id="L-L-E3-I">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-G1' L-LE-J" id="L-L-G1-J">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
               </g>
               <g class="nodes">
                <g class="node default" id="flowchart-A-424" style="opacity: 1;" transform="translate(439.39453125,31)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-40,-13)">
                   <foreignobject height="26" width="80">
                    <div style="display: inline-block; white-space: nowrap;">
                     数据采集层
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-A1-425" style="opacity: 1;" transform="translate(439.39453125,140)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="239.015625" x="-119.5078125" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-109.5078125,-26)">
                   <foreignobject height="52" width="219.015625">
                    <div style="display: inline-block; white-space: nowrap;">
                     工业相机采集
                     <br/>
                     (200万像素，10fps，全局快门)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-A2-427" style="opacity: 1;" transform="translate(439.39453125,262)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="192.53125" x="-96.265625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-86.265625,-26)">
                   <foreignobject height="52" width="172.53125">
                    <div style="display: inline-block; white-space: nowrap;">
                     工况数据同步
                     <br/>
                     (温度/湿度/传送带速度)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-B-429" style="opacity: 1;" transform="translate(439.39453125,371)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-48,-13)">
                   <foreignobject height="26" width="96">
                    <div style="display: inline-block; white-space: nowrap;">
                     数据预处理层
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-B1-431" style="opacity: 1;" transform="translate(439.39453125,480)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="192.53125" x="-96.265625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-86.265625,-26)">
                   <foreignobject height="52" width="172.53125">
                    <div style="display: inline-block; white-space: nowrap;">
                     图像清洗
                     <br/>
                     (去模糊/去噪/尺寸统一)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-B2-433" style="opacity: 1;" transform="translate(439.39453125,602)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="184.140625" x="-92.0703125" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-82.0703125,-26)">
                   <foreignobject height="52" width="164.140625">
                    <div style="display: inline-block; white-space: nowrap;">
                     标注质量检查
                     <br/>
                     (重复标注/边界框异常)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-B3-435" style="opacity: 1;" transform="translate(321.58984375,724)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="143.75" x="-71.875" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-61.875,-26)">
                   <foreignobject height="52" width="123.75">
                    <div style="display: inline-block; white-space: nowrap;">
                     缺陷分布统计
                     <br/>
                     (避免类别不平衡)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C-437" style="opacity: 1;" transform="translate(321.58984375,833)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-40,-13)">
                   <foreignobject height="26" width="80">
                    <div style="display: inline-block; white-space: nowrap;">
                     数据增强层
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C1-439" style="opacity: 1;" transform="translate(321.58984375,942)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="285.203125" x="-142.6015625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-132.6015625,-26)">
                   <foreignobject height="52" width="265.203125">
                    <div style="display: inline-block; white-space: nowrap;">
                     针对性增强
                     <br/>
                     (MotionBlur/Cutout/RandomGamma)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C2-441" style="opacity: 1;" transform="translate(321.58984375,1064)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="223.6875" x="-111.84375" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-101.84375,-26)">
                   <foreignobject height="52" width="203.6875">
                    <div style="display: inline-block; white-space: nowrap;">
                     数据划分
                     <br/>
                     (训练70%/验证20%/测试10%)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D-443" style="opacity: 1;" transform="translate(321.58984375,1173)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-40,-13)">
                   <foreignobject height="26" width="80">
                    <div style="display: inline-block; white-space: nowrap;">
                     模型训练层
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D1-445" style="opacity: 1;" transform="translate(321.58984375,1282)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="186.109375" x="-93.0546875" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-83.0546875,-26)">
                   <foreignobject height="52" width="166.109375">
                    <div style="display: inline-block; white-space: nowrap;">
                     基础模型训练
                     <br/>
                     (YOLOv11-n，SGD优化)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D2-447" style="opacity: 1;" transform="translate(321.58984375,1404)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="156.046875" x="-78.0234375" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-68.0234375,-26)">
                   <foreignobject height="52" width="136.046875">
                    <div style="display: inline-block; white-space: nowrap;">
                     多尺度优化
                     <br/>
                     (640/800/960像素)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D3-449" style="opacity: 1;" transform="translate(321.58984375,1526)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="164.46875" x="-82.234375" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-72.234375,-26)">
                   <foreignobject height="52" width="144.46875">
                    <div style="display: inline-block; white-space: nowrap;">
                     超参搜索
                     <br/>
                     (Optuna，50轮试验)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-E-451" style="opacity: 1;" transform="translate(321.58984375,1635)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-40,-13)">
                   <foreignobject height="26" width="80">
                    <div style="display: inline-block; white-space: nowrap;">
                     模型优化层
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-E1-453" style="opacity: 1;" transform="translate(321.58984375,1744)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="154.140625" x="-77.0703125" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-67.0703125,-26)">
                   <foreignobject height="52" width="134.140625">
                    <div style="display: inline-block; white-space: nowrap;">
                     结构化剪枝
                     <br/>
                     (剪去30%冗余通道)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-E2-455" style="opacity: 1;" transform="translate(321.58984375,1866)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="295.78125" x="-147.890625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-137.890625,-26)">
                   <foreignobject height="52" width="275.78125">
                    <div style="display: inline-block; white-space: nowrap;">
                     知识蒸馏
                     <br/>
                     (教师：YOLOv11-l，学生：YOLOv11-n)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-E3-457" style="opacity: 1;" transform="translate(321.58984375,1988)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="251.375" x="-125.6875" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-115.6875,-26)">
                   <foreignobject height="52" width="231.375">
                    <div style="display: inline-block; white-space: nowrap;">
                     TensorRT量化
                     <br/>
                     (FP16→INT8，校准数据集500张)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-F-459" style="opacity: 1;" transform="translate(223.3515625,2110)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="68" x="-34" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-24,-13)">
                   <foreignobject height="26" width="48">
                    <div style="display: inline-block; white-space: nowrap;">
                     部署层
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-F1-461" style="opacity: 1;" transform="translate(223.3515625,2232)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="188.578125" x="-94.2890625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-84.2890625,-26)">
                   <foreignobject height="52" width="168.578125">
                    <div style="display: inline-block; white-space: nowrap;">
                     Docker封装
                     <br/>
                     (FastAPI+TensorRT引擎)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-F2-463" style="opacity: 1;" transform="translate(223.3515625,2354)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="202.484375" x="-101.2421875" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-91.2421875,-26)">
                   <foreignobject height="52" width="182.484375">
                    <div style="display: inline-block; white-space: nowrap;">
                     API服务部署
                     <br/>
                     (端口8000，支持并发100)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-F3-465" style="opacity: 1;" transform="translate(223.3515625,2476)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="235.375" x="-117.6875" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-107.6875,-26)">
                   <foreignobject height="52" width="215.375">
                    <div style="display: inline-block; white-space: nowrap;">
                     产线集成
                     <br/>
                     (对接MES系统，返回缺陷坐标)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-G-467" style="opacity: 1;" transform="translate(223.3515625,2585)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-40,-13)">
                   <foreignobject height="26" width="80">
                    <div style="display: inline-block; white-space: nowrap;">
                     监控维护层
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-G1-469" style="opacity: 1;" transform="translate(223.3515625,2694)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="222.65625" x="-111.328125" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-101.328125,-26)">
                   <foreignobject height="52" width="202.65625">
                    <div style="display: inline-block; white-space: nowrap;">
                     实时监控
                     <br/>
                     (GPU内存/推理延迟/准确率)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-G2-471" style="opacity: 1;" transform="translate(111.875,2816)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="164.828125" x="-82.4140625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-72.4140625,-26)">
                   <foreignobject height="52" width="144.828125">
                    <div style="display: inline-block; white-space: nowrap;">
                     数据漂移检测
                     <br/>
                     (PSI指数，每月更新)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-G3-473" style="opacity: 1;" transform="translate(111.875,2938)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="207.75" x="-103.875" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-93.875,-26)">
                   <foreignobject height="52" width="187.75">
                    <div style="display: inline-block; white-space: nowrap;">
                     模型迭代
                     <br/>
                     (每季度微调，基于新数据)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-H-475" style="opacity: 1;" transform="translate(557.19921875,724)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="227.46875" x="-113.734375" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-103.734375,-26)">
                   <foreignobject height="52" width="207.46875">
                    <div style="display: inline-block; white-space: nowrap;">
                     标注工具
                     <br/>
                     (LabelStudio，支持团队协作)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-I-477" style="opacity: 1;" transform="translate(419.828125,2110)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="224.953125" x="-112.4765625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-102.4765625,-26)">
                   <foreignobject height="52" width="204.953125">
                    <div style="display: inline-block; white-space: nowrap;">
                     优化工具
                     <br/>
                     (TorchPrune/TensorRT 8.6.1)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-J-479" style="opacity: 1;" transform="translate(334.828125,2816)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="181.078125" x="-90.5390625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-80.5390625,-26)">
                   <foreignobject height="52" width="161.078125">
                    <div style="display: inline-block; white-space: nowrap;">
                     监控工具
                     <br/>
                     (Prometheus+Grafana)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
               </g>
              </g>
             </g>
            </svg>
           </div>
           <h4>
            <a id="22__105">
            </a>
            2.2 关键组件说明
           </h4>
           <ol>
            <li>
             <strong>
              工业相机选型
             </strong>
             ：海康威视MV-CA020-10GM（200万像素，1/1.8英寸CMOS，全局快门避免运动模糊，千兆网接口，支持触发拍摄）；
            </li>
            <li>
             <strong>
              标注工具
             </strong>
             ：LabelStudio（开源，支持多人协作标注，可导出YOLO格式标签，还能记录标注员ID和耗时，便于质量追溯）；
            </li>
            <li>
             <strong>
              部署框架
             </strong>
             ：FastAPI（轻量级，支持异步请求，单接口并发量可达100，满足10条产线同时调用）；
            </li>
            <li>
             <strong>
              监控工具
             </strong>
             ：Prometheus（采集GPU内存、推理延迟、请求量等指标）+ Grafana（可视化仪表盘，设置阈值告警）。
            </li>
           </ol>
           <h3>
            <a id="80_113">
            </a>
            三、数据工程实战（核心：高质量数据决定80%效果）
           </h3>
           <p>
            数据是工业AI项目的“基石”，本项目花30%时间做数据工程，最终实现类别分布均衡（最大类与最小类样本比&lt;3:1），标注准确率&gt;99%。
           </p>
           <h4>
            <a id="31__117">
            </a>
            3.1 数据采集：从工业相机到结构化存储
           </h4>
           <h5>
            <a id="311_PythonOpenCV_119">
            </a>
            3.1.1 相机采集代码（Python+OpenCV）
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> json

<span class="token keyword">class</span> <span class="token class-name">BatteryCameraCollector</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> camera_index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_root<span class="token operator">=</span><span class="token string">"./battery_data"</span><span class="token punctuation">,</span> resolution<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1920</span><span class="token punctuation">,</span> <span class="token number">1080</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fps<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        锂电池图像采集器：连接工业相机，同步保存图像与工况数据
        参数：
            camera_index：相机索引（0为默认，多相机需指定）
            save_root：数据保存根目录
            resolution：图像分辨率（宽×高）
            fps：采集帧率（匹配产线速度）
        """</span>
        self<span class="token punctuation">.</span>camera <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>camera_index<span class="token punctuation">)</span>
        <span class="token comment"># 配置相机参数（关键：避免运动模糊）</span>
        self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">,</span> resolution<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">,</span> resolution<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FPS<span class="token punctuation">,</span> fps<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_EXPOSURE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 曝光时间16ms（全局快门适配）</span>
        
        <span class="token comment"># 创建保存目录（按日期分文件夹）</span>
        self<span class="token punctuation">.</span>save_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_root<span class="token punctuation">,</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_dir<span class="token punctuation">,</span> <span class="token string">"images"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_dir<span class="token punctuation">,</span> <span class="token string">"metadata"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"数据保存目录：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>save_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_working_condition</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        模拟获取产线工况数据（实际项目需对接PLC系统）
        返回：温度（℃）、湿度（%）、传送带速度（m/s）、电芯型号
        """</span>
        <span class="token comment"># 实际项目替换为PLC数据读取（如Modbus协议）</span>
        <span class="token keyword">import</span> random
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"temperature"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"humidity"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"conveyor_speed"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"battery_model"</span><span class="token punctuation">:</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"148×293mm"</span><span class="token punctuation">,</span> <span class="token string">"166×210mm"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">collect_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> collect_duration<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        持续采集数据
        参数：collect_duration：采集时长（秒）
        """</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        frame_count <span class="token operator">=</span> <span class="token number">0</span>
        
        <span class="token keyword">while</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time <span class="token operator">&lt;</span> collect_duration<span class="token punctuation">:</span>
            ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> ret<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"⚠️  第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">帧采集失败，跳过"</span></span><span class="token punctuation">)</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            
            <span class="token comment"># 1. 保存图像（命名格式：时间戳_帧号.jpg）</span>
            timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%H%M%S%f"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>  <span class="token comment"># 毫秒级时间戳</span>
            img_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>timestamp<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_count<span class="token punctuation">:</span><span class="token format-spec">06d</span><span class="token punctuation">}</span></span><span class="token string">.jpg"</span></span>
            img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_dir<span class="token punctuation">,</span> <span class="token string">"images"</span><span class="token punctuation">,</span> img_name<span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
            
            <span class="token comment"># 2. 保存工况数据（与图像同名，JSON格式）</span>
            metadata <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"timestamp"</span><span class="token punctuation">:</span> timestamp<span class="token punctuation">,</span>
                <span class="token string">"frame_count"</span><span class="token punctuation">:</span> frame_count<span class="token punctuation">,</span>
                <span class="token string">"image_path"</span><span class="token punctuation">:</span> img_path<span class="token punctuation">,</span>
                <span class="token string">"working_condition"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>get_working_condition<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"collect_time"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            metadata_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_dir<span class="token punctuation">,</span> <span class="token string">"metadata"</span><span class="token punctuation">,</span> img_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>metadata_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 3. 打印进度（每100帧打印一次）</span>
            frame_count <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">if</span> frame_count <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                elapsed_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 已采集</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_count<span class="token punctuation">}</span></span><span class="token string">帧，耗时</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>elapsed_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">秒，预计剩余</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>collect_duration<span class="token operator">-</span>elapsed_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">秒"</span></span><span class="token punctuation">)</span>
            
            <span class="token comment"># 控制帧率（避免采集过快）</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span>self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FPS<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🎉 采集完成！共采集</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_count<span class="token punctuation">}</span></span><span class="token string">帧，保存路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>save_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 调用采集器（采集1小时数据）</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    collector <span class="token operator">=</span> BatteryCameraCollector<span class="token punctuation">(</span>
        camera_index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        save_root<span class="token operator">=</span><span class="token string">"./battery_data"</span><span class="token punctuation">,</span>
        resolution<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1920</span><span class="token punctuation">,</span> <span class="token number">1080</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        fps<span class="token operator">=</span><span class="token number">10</span>
    <span class="token punctuation">)</span>
    collector<span class="token punctuation">.</span>collect_data<span class="token punctuation">(</span>collect_duration<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             采集结果示例
            </strong>
            ：
           </p>
           <ul>
            <li>
             <p>
              图像保存路径：
              <code>
               ./battery_data/20240520/images/143025123_000100.jpg
              </code>
             </p>
            </li>
            <li>
             <p>
              工况数据示例（JSON）：
             </p>
             <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"timestamp"</span><span class="token operator">:</span> <span class="token string">"143025123"</span><span class="token punctuation">,</span>
  <span class="token string">"frame_count"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  <span class="token string">"image_path"</span><span class="token operator">:</span> <span class="token string">"./battery_data/20240520/images/143025123_000100.jpg"</span><span class="token punctuation">,</span>
  <span class="token string">"working_condition"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"temperature"</span><span class="token operator">:</span> <span class="token number">28.5</span><span class="token punctuation">,</span>
    <span class="token string">"humidity"</span><span class="token operator">:</span> <span class="token number">45.2</span><span class="token punctuation">,</span>
    <span class="token string">"conveyor_speed"</span><span class="token operator">:</span> <span class="token number">1.05</span><span class="token punctuation">,</span>
    <span class="token string">"battery_model"</span><span class="token operator">:</span> <span class="token string">"166×210mm"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"collect_time"</span><span class="token operator">:</span> <span class="token string">"2024-05-20 14:30:25"</span>
<span class="token punctuation">}</span>
</code></pre>
            </li>
           </ul>
           <h5>
            <a id="312__243">
            </a>
            3.1.2 数据清洗：过滤低质量样本
           </h5>
           <p>
            采集的原始数据中约有5%的低质量样本（如模糊、过曝、无电芯），需通过以下代码过滤：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">filter_low_quality_data</span><span class="token punctuation">(</span>data_root<span class="token punctuation">,</span> min_brightness<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> max_brightness<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> min_battery_area_ratio<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    过滤低质量锂电池图像数据
    参数：
        min_brightness：最小亮度（避免过暗）
        max_brightness：最大亮度（避免过曝）
        min_battery_area_ratio：电芯区域占比（避免无电芯图像）
    """</span>
    <span class="token comment"># 遍历所有图像</span>
    img_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_root<span class="token punctuation">,</span> <span class="token string">"images"</span><span class="token punctuation">)</span>
    meta_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_root<span class="token punctuation">,</span> <span class="token string">"metadata"</span><span class="token punctuation">)</span>
    bad_data_log <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_root<span class="token punctuation">,</span> <span class="token string">"bad_data.log"</span><span class="token punctuation">)</span>
    bad_count <span class="token operator">=</span> <span class="token number">0</span>
    total_count <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>bad_data_log<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> log_f<span class="token punctuation">:</span>
        log_f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"低质量数据过滤日志（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">）\n"</span></span><span class="token punctuation">)</span>
        log_f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">50</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        
        <span class="token keyword">for</span> img_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>img_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
            total_count <span class="token operator">+=</span> <span class="token number">1</span>
            img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>img_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span>
            meta_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>meta_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
            <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># 图像损坏</span>
                log_f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"图像损坏：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_path<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
                os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
                <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>meta_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>meta_path<span class="token punctuation">)</span>
                bad_count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">continue</span>
            
            <span class="token comment"># 1. 亮度检查（转为灰度图计算均值）</span>
            gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
            brightness <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>gray<span class="token punctuation">)</span>
            <span class="token keyword">if</span> brightness <span class="token operator">&lt;</span> min_brightness <span class="token keyword">or</span> brightness <span class="token operator">&gt;</span> max_brightness<span class="token punctuation">:</span>
                log_f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"亮度异常（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>brightness<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">）：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_path<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
                os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
                <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>meta_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>meta_path<span class="token punctuation">)</span>
                bad_count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">continue</span>
            
            <span class="token comment"># 2. 电芯区域占比检查（简单阈值分割：电芯为白色，背景为黑色）</span>
            _<span class="token punctuation">,</span> thresh <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>gray<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY<span class="token punctuation">)</span>  <span class="token comment"># 电芯区域亮度高</span>
            battery_area <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>thresh <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span>
            total_area <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            area_ratio <span class="token operator">=</span> battery_area <span class="token operator">/</span> total_area
            <span class="token keyword">if</span> area_ratio <span class="token operator">&lt;</span> min_battery_area_ratio<span class="token punctuation">:</span>
                log_f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"电芯占比过低（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>area_ratio<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">）：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_path<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
                os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
                <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>meta_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>meta_path<span class="token punctuation">)</span>
                bad_count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">continue</span>
    
    <span class="token comment"># 打印统计结果</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"数据清洗完成！总样本数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>total_count<span class="token punctuation">}</span></span><span class="token string">，过滤低质量样本数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>bad_count<span class="token punctuation">}</span></span><span class="token string">，剩余样本数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>total_count<span class="token operator">-</span>bad_count<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"过滤日志保存路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>bad_data_log<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> total_count <span class="token operator">-</span> bad_count

<span class="token comment"># 调用数据清洗（以20240520的采集数据为例）</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    remaining_count <span class="token operator">=</span> filter_low_quality_data<span class="token punctuation">(</span>
        data_root<span class="token operator">=</span><span class="token string">"./battery_data/20240520"</span><span class="token punctuation">,</span>
        min_brightness<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
        max_brightness<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
        min_battery_area_ratio<span class="token operator">=</span><span class="token number">0.3</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"清洗后剩余样本数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>remaining_count<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             清洗结果示例
            </strong>
            ：
            <br/>
            总样本数36000（1小时×10fps），过滤低质量样本1820（5.06%），剩余34180样本，主要过滤原因：亮度异常（820个）、电芯占比低（750个）、图像损坏（250个）。
           </p>
           <h4>
            <a id="32__329">
            </a>
            3.2 标注质量控制：避免“垃圾标注出垃圾模型”
           </h4>
           <h5>
            <a id="321__331">
            </a>
            3.2.1 标注工具选择与配置
           </h5>
           <p>
            使用LabelStudio（开源免费，支持团队协作），标注格式选择“YOLO”（便于后续模型训练），具体配置步骤：
           </p>
           <ol>
            <li>
             安装LabelStudio：
             <code>
              pip install label-studio
             </code>
             ；
            </li>
            <li>
             启动服务：
             <code>
              label-studio start
             </code>
             ，浏览器访问
             <code>
              http://localhost:8080
             </code>
             ；
            </li>
            <li>
             创建项目：项目名“锂电池表面缺陷检测”，导入图像数据，标注类型选择“Object Detection”；
            </li>
            <li>
             定义标签：6类缺陷（scratch、dent、contamination、bubble、missing_coating、foreign_object）；
            </li>
            <li>
             标注规则培训：要求标注框完全包围缺陷区域，缺陷类型标注错误率≤0.5%（每标注1000张抽查50张）。
            </li>
           </ol>
           <h5>
            <a id="322__341">
            </a>
            3.2.2 标注质量检查代码（完整版）
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">check_annotation_quality</span><span class="token punctuation">(</span>annotation_dir<span class="token punctuation">,</span> img_dir<span class="token punctuation">,</span> defect_classes<span class="token punctuation">,</span> min_box_area<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> max_box_area_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    检查YOLO格式标注的质量
    参数：
        annotation_dir：标注文件目录（.txt文件）
        img_dir：图像文件目录
        defect_classes：缺陷类别列表（与标注ID对应）
        min_box_area：最小标注框面积（像素²，过滤噪声）
        max_box_area_ratio：最大标注框占比（避免标注整个图像）
    返回：
        问题标注列表（含问题类型、文件路径、具体问题）
    """</span>
    issues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    class_count <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>cls<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token keyword">for</span> cls <span class="token keyword">in</span> defect_classes<span class="token punctuation">}</span>  <span class="token comment"># 统计各类别数量</span>
    
    <span class="token keyword">for</span> txt_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> txt_name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".txt"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        txt_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">,</span> txt_name<span class="token punctuation">)</span>
        img_name <span class="token operator">=</span> txt_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".txt"</span><span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">)</span>
        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>img_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span>
        
        <span class="token comment"># 1. 检查图像是否存在</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            issues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"图像缺失"</span><span class="token punctuation">,</span>
                <span class="token string">"file"</span><span class="token punctuation">:</span> txt_path<span class="token punctuation">,</span>
                <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"标注文件</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>txt_name<span class="token punctuation">}</span></span><span class="token string">对应的图像</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_name<span class="token punctuation">}</span></span><span class="token string">不存在"</span></span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment"># 2. 读取图像尺寸（计算标注框面积）</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
        img_h<span class="token punctuation">,</span> img_w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        total_img_area <span class="token operator">=</span> img_w <span class="token operator">*</span> img_h
        
        <span class="token comment"># 3. 读取标注文件</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            lines <span class="token operator">=</span> <span class="token punctuation">[</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> f <span class="token keyword">if</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        
        <span class="token comment"># 4. 逐行检查标注</span>
        <span class="token keyword">for</span> line_idx<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span><span class="token punctuation">:</span>
            parts <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 4.1 格式检查（需为“cls_id x y w h”5个字段）</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">:</span>
                issues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"格式错误"</span><span class="token punctuation">,</span>
                    <span class="token string">"file"</span><span class="token punctuation">:</span> txt_path<span class="token punctuation">,</span>
                    <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">行格式错误，需5个字段，实际</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">个：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            
            <span class="token comment"># 4.2 类别ID检查</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                cls_id <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">,</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
                issues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"数值错误"</span><span class="token punctuation">,</span>
                    <span class="token string">"file"</span><span class="token punctuation">:</span> txt_path<span class="token punctuation">,</span>
                    <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">行数值格式错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            
            <span class="token keyword">if</span> cls_id <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> cls_id <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>defect_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
                issues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"类别ID错误"</span><span class="token punctuation">,</span>
                    <span class="token string">"file"</span><span class="token punctuation">:</span> txt_path<span class="token punctuation">,</span>
                    <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">行类别ID</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cls_id<span class="token punctuation">}</span></span><span class="token string">无效（有效范围0-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>defect_classes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">）：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            class_count<span class="token punctuation">[</span>defect_classes<span class="token punctuation">[</span>cls_id<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment"># 统计类别数量</span>
            
            <span class="token comment"># 4.3 坐标范围检查（YOLO格式x/y/w/h需在[0,1]）</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> x <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> y <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">0</span> <span class="token operator">&lt;</span> w <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">0</span> <span class="token operator">&lt;</span> h <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                issues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"坐标越界"</span><span class="token punctuation">,</span>
                    <span class="token string">"file"</span><span class="token punctuation">:</span> txt_path<span class="token punctuation">,</span>
                    <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">行坐标超出[0,1]范围：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            
            <span class="token comment"># 4.4 标注框面积检查（转换为像素面积）</span>
            box_w <span class="token operator">=</span> w <span class="token operator">*</span> img_w
            box_h <span class="token operator">=</span> h <span class="token operator">*</span> img_h
            box_area <span class="token operator">=</span> box_w <span class="token operator">*</span> box_h
            <span class="token keyword">if</span> box_area <span class="token operator">&lt;</span> min_box_area<span class="token punctuation">:</span>
                issues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"标注框过小"</span><span class="token punctuation">,</span>
                    <span class="token string">"file"</span><span class="token punctuation">:</span> txt_path<span class="token punctuation">,</span>
                    <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">行标注框面积</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>box_area<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">px² &lt; 最小</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>min_box_area<span class="token punctuation">}</span></span><span class="token string">px²：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> box_area <span class="token operator">/</span> total_img_area <span class="token operator">&gt;</span> max_box_area_ratio<span class="token punctuation">:</span>
                issues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"标注框过大"</span><span class="token punctuation">,</span>
                    <span class="token string">"file"</span><span class="token punctuation">:</span> txt_path<span class="token punctuation">,</span>
                    <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">行标注框占比</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>box_area<span class="token operator">/</span>total_img_area<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> &gt; 最大</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>max_box_area_ratio<span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 5. 统计类别分布（检查类别不平衡）</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"各类缺陷标注数量统计："</span><span class="token punctuation">)</span>
    total_defects <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>class_count<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> cls<span class="token punctuation">,</span> count <span class="token keyword">in</span> class_count<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ratio <span class="token operator">=</span> count <span class="token operator">/</span> total_defects <span class="token keyword">if</span> total_defects <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cls<span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>count<span class="token punctuation">}</span></span><span class="token string">个（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ratio<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 检查类别不平衡（最大类/最小类 &gt; 3:1 需处理）</span>
    min_count <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>class_count<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> class_count <span class="token keyword">else</span> <span class="token number">0</span>
    max_count <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>class_count<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> class_count <span class="token keyword">else</span> <span class="token number">0</span>
    <span class="token keyword">if</span> max_count <span class="token operator">/</span> min_count <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token keyword">and</span> min_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        issues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"类别不平衡"</span><span class="token punctuation">,</span>
            <span class="token string">"file"</span><span class="token punctuation">:</span> <span class="token string">"全局统计"</span><span class="token punctuation">,</span>
            <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"最大类</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">max</span><span class="token punctuation">(</span>class_count<span class="token punctuation">,</span> key<span class="token operator">=</span>class_count<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>max_count<span class="token punctuation">}</span></span><span class="token string">个）与最小类</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">min</span><span class="token punctuation">(</span>class_count<span class="token punctuation">,</span> key<span class="token operator">=</span>class_count<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>min_count<span class="token punctuation">}</span></span><span class="token string">个）比例</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>max_count<span class="token operator">/</span>min_count<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">:1 &gt; 3:1"</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 6. 输出检查结果</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"标注质量检查完成！共检查</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">个标注文件，发现</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>issues<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">个问题"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> issues<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"问题详情："</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> issue <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>issues<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">. [</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>issue<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">] </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>issue<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>issue<span class="token punctuation">[</span><span class="token string">'detail'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token comment"># 保存问题日志</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">,</span> <span class="token string">"annotation_issues.log"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"标注质量检查日志（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">）\n"</span></span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">50</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> issue <span class="token keyword">in</span> issues<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>issue<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">] </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>issue<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>issue<span class="token punctuation">[</span><span class="token string">'detail'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n问题日志已保存至：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">,</span> <span class="token string">'annotation_issues.log'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> issues

<span class="token comment"># 调用标注质量检查</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    defect_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"scratch"</span><span class="token punctuation">,</span> <span class="token string">"dent"</span><span class="token punctuation">,</span> <span class="token string">"contamination"</span><span class="token punctuation">,</span> <span class="token string">"bubble"</span><span class="token punctuation">,</span> <span class="token string">"missing_coating"</span><span class="token punctuation">,</span> <span class="token string">"foreign_object"</span><span class="token punctuation">]</span>
    issues <span class="token operator">=</span> check_annotation_quality<span class="token punctuation">(</span>
        annotation_dir<span class="token operator">=</span><span class="token string">"./battery_data/annotations"</span><span class="token punctuation">,</span>
        img_dir<span class="token operator">=</span><span class="token string">"./battery_data/images"</span><span class="token punctuation">,</span>
        defect_classes<span class="token operator">=</span>defect_classes<span class="token punctuation">,</span>
        min_box_area<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>  <span class="token comment"># 最小10px²（对应实际0.1mm²缺陷）</span>
        max_box_area_ratio<span class="token operator">=</span><span class="token number">0.5</span>  <span class="token comment"># 最大占比50%（避免标注整个电芯）</span>
    <span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             检查结果示例
            </strong>
            ：
            <br/>
            共检查2000个标注文件，发现32个问题，主要类型：标注框过小（12个）、坐标越界（8个）、类别不平衡（1个，“foreign_object”仅50个，“scratch”150个，比例3:1）。针对类别不平衡，后续通过数据增强（对少数类增加增强次数）解决。
           </p>
           <h4>
            <a id="33__496">
            </a>
            3.3 数据增强：提升模型泛化性（针对性设计）
           </h4>
           <p>
            锂电池表面缺陷的外观受
            <strong>
             光照、角度、遮挡
            </strong>
            影响大，需设计针对性增强策略，避免无意义的增强（如水平翻转对“划痕”方向敏感，需谨慎使用）。
           </p>
           <h5>
            <a id="331_Albumentations_500">
            </a>
            3.3.1 完整增强代码（基于Albumentations）
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">import</span> albumentations <span class="token keyword">as</span> A
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> os
<span class="token keyword">import</span> shutil
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

<span class="token keyword">def</span> <span class="token function">create_battery_augmentor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    创建锂电池缺陷数据增强器（针对性设计）
    原则：
    1. 保留缺陷方向特征（如划痕方向与电芯轧制方向相关，不做水平翻转）；
    2. 模拟产线实际干扰（运动模糊、光照变化、遮挡）；
    3. 避免过度增强（如Cutout面积不超过缺陷面积的1/2）。
    """</span>
    <span class="token keyword">return</span> A<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token comment"># 1. 尺寸调整（适配模型输入，保持长宽比）</span>
        A<span class="token punctuation">.</span>LongestMaxSize<span class="token punctuation">(</span>max_size<span class="token operator">=</span><span class="token number">960</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span><span class="token punctuation">,</span>
        A<span class="token punctuation">.</span>PadIfNeeded<span class="token punctuation">(</span>
            min_height<span class="token operator">=</span><span class="token number">960</span><span class="token punctuation">,</span>
            min_width<span class="token operator">=</span><span class="token number">960</span><span class="token punctuation">,</span>
            border_mode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span>
            value<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 黑色背景（匹配产线背景色）</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        
        <span class="token comment"># 2. 光照变化（模拟不同工位光照）</span>
        A<span class="token punctuation">.</span>RandomGamma<span class="token punctuation">(</span>gamma_limit<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 亮度调整</span>
        A<span class="token punctuation">.</span>HueSaturationValue<span class="token punctuation">(</span>
            hue_shift_limit<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
            sat_shift_limit<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
            val_shift_limit<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
            p<span class="token operator">=</span><span class="token number">0.2</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 色彩微调（避免改变缺陷本质）</span>
        
        <span class="token comment"># 3. 运动模糊（模拟传送带运动）</span>
        A<span class="token punctuation">.</span>MotionBlur<span class="token punctuation">(</span>blur_limit<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 模糊核7×7（对应传送带速度1m/s）</span>
        
        <span class="token comment"># 4. 遮挡模拟（模拟胶带残留、粉尘）</span>
        A<span class="token punctuation">.</span>Cutout<span class="token punctuation">(</span>
            num_holes<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
            max_h_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
            max_w_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
            fill_value<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">,</span>  <span class="token comment"># 白色遮挡（模拟粉尘）</span>
            p<span class="token operator">=</span><span class="token number">0.2</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        
        <span class="token comment"># 5. 噪声抑制（产线图像有轻微噪声，增强鲁棒性）</span>
        A<span class="token punctuation">.</span>GaussNoise<span class="token punctuation">(</span>var_limit<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        
        <span class="token comment"># 6. 最终Resize（模型输入尺寸640×640）</span>
        A<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span>height<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span><span class="token punctuation">,</span>
        
        <span class="token comment"># 7. 格式转换（HWC→CHW，归一化）</span>
        A<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        A<span class="token punctuation">.</span>ToTensorV2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> bbox_params<span class="token operator">=</span>A<span class="token punctuation">.</span>BboxParams<span class="token punctuation">(</span>
        <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"yolo"</span><span class="token punctuation">,</span>  <span class="token comment"># 与标注格式一致</span>
        label_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"class_labels"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 保留类别标签</span>
        min_visibility<span class="token operator">=</span><span class="token number">0.5</span>  <span class="token comment"># 增强后标注框可见度&lt;50%则丢弃</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">augment_battery_data</span><span class="token punctuation">(</span>raw_img_dir<span class="token punctuation">,</span> raw_anno_dir<span class="token punctuation">,</span> aug_img_dir<span class="token punctuation">,</span> aug_anno_dir<span class="token punctuation">,</span> augmentor<span class="token punctuation">,</span> aug_times<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    执行数据增强（对少数类样本增强次数更多）
    参数：
        aug_times：基础增强次数（少数类样本增强次数=aug_times×2）
        少数类定义：样本数&lt;平均样本数的类别
    """</span>
    <span class="token comment"># 1. 先统计各类别样本数（确定少数类）</span>
    defect_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"scratch"</span><span class="token punctuation">,</span> <span class="token string">"dent"</span><span class="token punctuation">,</span> <span class="token string">"contamination"</span><span class="token punctuation">,</span> <span class="token string">"bubble"</span><span class="token punctuation">,</span> <span class="token string">"missing_coating"</span><span class="token punctuation">,</span> <span class="token string">"foreign_object"</span><span class="token punctuation">]</span>
    class_sample_count <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>cls<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token keyword">for</span> cls <span class="token keyword">in</span> defect_classes<span class="token punctuation">}</span>
    sample_cls_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  <span class="token comment"># 记录每个样本的主要类别（含该类别的样本）</span>
    
    <span class="token keyword">for</span> txt_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>raw_anno_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        txt_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>raw_anno_dir<span class="token punctuation">,</span> txt_name<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            lines <span class="token operator">=</span> <span class="token punctuation">[</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> f <span class="token keyword">if</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> lines<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>  <span class="token comment"># 无缺陷样本不参与增强</span>
        <span class="token comment"># 取第一个缺陷的类别作为样本主要类别</span>
        main_cls_id <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        main_cls <span class="token operator">=</span> defect_classes<span class="token punctuation">[</span>main_cls_id<span class="token punctuation">]</span>
        class_sample_count<span class="token punctuation">[</span>main_cls<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
        sample_cls_map<span class="token punctuation">[</span>txt_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".txt"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> main_cls
    
    <span class="token comment"># 计算平均样本数，确定少数类</span>
    avg_count <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>class_sample_count<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>class_sample_count<span class="token punctuation">)</span>
    minority_classes <span class="token operator">=</span> <span class="token punctuation">[</span>cls <span class="token keyword">for</span> cls<span class="token punctuation">,</span> count <span class="token keyword">in</span> class_sample_count<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> count <span class="token operator">&lt;</span> avg_count<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"少数类缺陷：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>minority_classes<span class="token punctuation">}</span></span><span class="token string">（样本数&lt;平均</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>avg_count<span class="token punctuation">:</span><span class="token format-spec">.0f</span><span class="token punctuation">}</span></span><span class="token string">个）"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. 创建增强后目录</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>aug_img_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>aug_anno_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. 遍历原始数据执行增强</span>
    pbar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>raw_img_dir<span class="token punctuation">)</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"数据增强进度"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> img_name <span class="token keyword">in</span> pbar<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> img_name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        img_base <span class="token operator">=</span> img_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> img_base <span class="token keyword">not</span> <span class="token keyword">in</span> sample_cls_map<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>  <span class="token comment"># 无缺陷样本不增强</span>
        
        <span class="token comment"># 读取原始图像和标注</span>
        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>raw_img_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span>
        anno_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>raw_anno_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_base<span class="token punctuation">}</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>  <span class="token comment"># Albumentations默认RGB</span>
        
        <span class="token comment"># 解析YOLO标注为（xmin, ymin, xmax, ymax）和类别</span>
        bboxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        class_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>anno_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
                cls_id<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">,</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment"># YOLO格式转Albumentations格式（x,y为中心，转左上角+右下角）</span>
                xmin <span class="token operator">=</span> x <span class="token operator">-</span> w<span class="token operator">/</span><span class="token number">2</span>
                ymin <span class="token operator">=</span> y <span class="token operator">-</span> h<span class="token operator">/</span><span class="token number">2</span>
                xmax <span class="token operator">=</span> x <span class="token operator">+</span> w<span class="token operator">/</span><span class="token number">2</span>
                ymax <span class="token operator">=</span> y <span class="token operator">+</span> h<span class="token operator">/</span><span class="token number">2</span>
                bboxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">]</span><span class="token punctuation">)</span>
                class_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>cls_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 确定增强次数（少数类样本增强2倍）</span>
        current_cls <span class="token operator">=</span> sample_cls_map<span class="token punctuation">[</span>img_base<span class="token punctuation">]</span>
        current_aug_times <span class="token operator">=</span> aug_times <span class="token operator">*</span> <span class="token number">2</span> <span class="token keyword">if</span> current_cls <span class="token keyword">in</span> minority_classes <span class="token keyword">else</span> aug_times
        
        <span class="token comment"># 执行增强</span>
        <span class="token keyword">for</span> aug_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>current_aug_times<span class="token punctuation">)</span><span class="token punctuation">:</span>
            aug_result <span class="token operator">=</span> augmentor<span class="token punctuation">(</span>image<span class="token operator">=</span>img<span class="token punctuation">,</span> bboxes<span class="token operator">=</span>bboxes<span class="token punctuation">,</span> class_labels<span class="token operator">=</span>class_labels<span class="token punctuation">)</span>
            aug_img <span class="token operator">=</span> aug_result<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span>  <span class="token comment"># 已转为Tensor（CHW，归一化）</span>
            aug_bboxes <span class="token operator">=</span> aug_result<span class="token punctuation">[</span><span class="token string">"bboxes"</span><span class="token punctuation">]</span>
            aug_labels <span class="token operator">=</span> aug_result<span class="token punctuation">[</span><span class="token string">"class_labels"</span><span class="token punctuation">]</span>
            
            <span class="token comment"># 跳过无有效标注框的增强结果</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> aug_bboxes<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            
            <span class="token comment"># 保存增强后图像（转为numpy数组，BGR格式）</span>
            aug_img_np <span class="token operator">=</span> aug_img<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># CHW→HWC</span>
            aug_img_np <span class="token operator">=</span> <span class="token punctuation">(</span>aug_img_np <span class="token operator">*</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span>  <span class="token comment"># 反归一化</span>
            aug_img_np <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>aug_img_np<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2BGR<span class="token punctuation">)</span>
            aug_img_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_base<span class="token punctuation">}</span></span><span class="token string">_aug</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>aug_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">.jpg"</span></span>
            aug_img_save_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>aug_img_dir<span class="token punctuation">,</span> aug_img_name<span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>aug_img_save_path<span class="token punctuation">,</span> aug_img_np<span class="token punctuation">)</span>
            
            <span class="token comment"># 保存增强后标注（Albumentations格式转YOLO格式）</span>
            aug_anno_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_base<span class="token punctuation">}</span></span><span class="token string">_aug</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>aug_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">.txt"</span></span>
            aug_anno_save_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>aug_anno_dir<span class="token punctuation">,</span> aug_anno_name<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>aug_anno_save_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">for</span> bbox<span class="token punctuation">,</span> label <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>aug_bboxes<span class="token punctuation">,</span> aug_labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax <span class="token operator">=</span> bbox
                    <span class="token comment"># 转YOLO格式（中心x,y，宽w,高h，归一化）</span>
                    x <span class="token operator">=</span> <span class="token punctuation">(</span>xmin <span class="token operator">+</span> xmax<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
                    y <span class="token operator">=</span> <span class="token punctuation">(</span>ymin <span class="token operator">+</span> ymax<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
                    w <span class="token operator">=</span> xmax <span class="token operator">-</span> xmin
                    h <span class="token operator">=</span> ymax <span class="token operator">-</span> ymin
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>label<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>y<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>w<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 4. 复制原始无缺陷样本（保持数据分布）</span>
    no_defect_samples <span class="token operator">=</span> <span class="token punctuation">[</span>img_name <span class="token keyword">for</span> img_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>raw_img_dir<span class="token punctuation">)</span> <span class="token keyword">if</span> img_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> sample_cls_map<span class="token punctuation">]</span>
    <span class="token keyword">for</span> img_name <span class="token keyword">in</span> no_defect_samples<span class="token punctuation">:</span>
        shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>raw_img_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>aug_img_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 无缺陷样本标注文件为空</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>aug_anno_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"数据增强完成！增强后图像目录：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>aug_img_dir<span class="token punctuation">}</span></span><span class="token string">，标注目录：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>aug_anno_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"原始样本数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>raw_img_dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，增强后样本数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>aug_img_dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 调用数据增强</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建增强器</span>
    augmentor <span class="token operator">=</span> create_battery_augmentor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 执行增强（基础增强3次，少数类增强6次）</span>
    augment_battery_data<span class="token punctuation">(</span>
        raw_img_dir<span class="token operator">=</span><span class="token string">"./battery_data/raw_images"</span><span class="token punctuation">,</span>
        raw_anno_dir<span class="token operator">=</span><span class="token string">"./battery_data/raw_annotations"</span><span class="token punctuation">,</span>
        aug_img_dir<span class="token operator">=</span><span class="token string">"./battery_data/augmented_images"</span><span class="token punctuation">,</span>
        aug_anno_dir<span class="token operator">=</span><span class="token string">"./battery_data/augmented_annotations"</span><span class="token punctuation">,</span>
        augmentor<span class="token operator">=</span>augmentor<span class="token punctuation">,</span>
        aug_times<span class="token operator">=</span><span class="token number">3</span>
    <span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             增强结果示例
            </strong>
            ：
            <br/>
            原始样本2000张（含1500张缺陷样本、500张无缺陷样本），增强后样本7500张（缺陷样本6000张、无缺陷样本1500张），类别分布从原“foreign_object 50个”变为“foreign_object 180个”，比例趋于均衡（最大类1200个，最小类180个，比例6.7:1→仍需后续加权损失优化）。
           </p>
           <h3>
            <a id="_691">
            </a>
            四、模型训练与优化流水线（从基础到工业级）
           </h3>
           <p>
            本项目选择YOLOv11-n作为基础模型（平衡速度与精度），通过“多阶段训练+剪枝蒸馏+TensorRT量化”实现“精度达标、速度够快、体积够小”的工业级模型。
           </p>
           <h4>
            <a id="41_YOLOv11_695">
            </a>
            4.1 数据加载与配置（适配YOLOv11）
           </h4>
           <p>
            首先需创建YOLO格式的数据集配置文件，便于模型读取：
           </p>
           <pre><code class="prism language-yaml"><span class="token comment"># battery_defect_data.yaml（YOLO数据集配置文件）</span>
<span class="token key atrule">train</span><span class="token punctuation">:</span> ./battery_data/augmented_images  <span class="token comment"># 训练集图像目录</span>
<span class="token key atrule">val</span><span class="token punctuation">:</span> ./battery_data/val_images          <span class="token comment"># 验证集图像目录</span>
<span class="token key atrule">test</span><span class="token punctuation">:</span> ./battery_data/test_images        <span class="token comment"># 测试集图像目录</span>

<span class="token comment"># 6类缺陷的名称与ID映射</span>
<span class="token key atrule">names</span><span class="token punctuation">:</span>
  <span class="token key atrule">0</span><span class="token punctuation">:</span> scratch
  <span class="token key atrule">1</span><span class="token punctuation">:</span> dent
  <span class="token key atrule">2</span><span class="token punctuation">:</span> contamination
  <span class="token key atrule">3</span><span class="token punctuation">:</span> bubble
  <span class="token key atrule">4</span><span class="token punctuation">:</span> missing_coating
  <span class="token key atrule">5</span><span class="token punctuation">:</span> foreign_object

<span class="token comment"># 图像尺寸（多阶段训练时会动态调整）</span>
<span class="token key atrule">img_size</span><span class="token punctuation">:</span> <span class="token number">640</span>

<span class="token comment"># 类别不平衡加权（基于标注统计，少数类权重更高）</span>
<span class="token key atrule">class_weights</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span>
</code></pre>
           <h4>
            <a id="42__721">
            </a>
            4.2 多阶段训练策略（完整代码+参数解释）
           </h4>
           <p>
            分三阶段训练，逐步提升模型精度与泛化性，每个阶段的目标不同：
           </p>
           <ul>
            <li>
             <strong>
              阶段1：基础收敛
             </strong>
             ：用较大学习率快速让模型拟合数据，稳定基础精度；
            </li>
            <li>
             <strong>
              阶段2：多尺度优化
             </strong>
             ：动态调整输入尺寸，提升模型对不同大小缺陷的适应能力；
            </li>
            <li>
             <strong>
              阶段3：精细调优
             </strong>
             ：减小学习率，使用Focal Loss解决类别不平衡，提升少数类召回率。
            </li>
           </ul>
           <h5>
            <a id="421__729">
            </a>
            4.2.1 完整训练代码
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">def</span> <span class="token function">train_battery_defect_model</span><span class="token punctuation">(</span>stage<span class="token punctuation">,</span> config_path<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> lr0<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> loss_type<span class="token operator">=</span><span class="token string">"cross_entropy"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    锂电池缺陷检测模型训练（分阶段）
    参数：
        stage：训练阶段（1/2/3）
        config_path：数据集配置文件路径
        epochs：训练轮次
        img_size：输入图像尺寸（多阶段时为列表）
        batch_size：批次大小
        lr0：初始学习率
        optimizer：优化器（SGD/AdamW）
        loss_type：损失函数（cross_entropy/focal）
    返回：
        训练后的模型路径
    """</span>
    <span class="token comment"># 1. 初始化模型（阶段1从预训练权重开始，阶段2/3从阶段1模型继续）</span>
    <span class="token keyword">if</span> stage <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov11-n.pt"</span><span class="token punctuation">)</span>  <span class="token comment"># 加载YOLOv11-n预训练权重</span>
        save_dir <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"./runs/train/stage1_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 从上个阶段的最佳模型继续训练</span>
        prev_stage_dir <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span>d <span class="token keyword">for</span> d <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">"./runs/train"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> d<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stage</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stage<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        prev_best_model <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"./runs/train"</span><span class="token punctuation">,</span> prev_stage_dir<span class="token punctuation">,</span> <span class="token string">"weights/best.pt"</span><span class="token punctuation">)</span>
        model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>prev_best_model<span class="token punctuation">)</span>
        save_dir <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"./runs/train/stage</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stage<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    
    <span class="token comment"># 2. 配置训练参数</span>
    train_args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"data"</span><span class="token punctuation">:</span> config_path<span class="token punctuation">,</span>
        <span class="token string">"epochs"</span><span class="token punctuation">:</span> epochs<span class="token punctuation">,</span>
        <span class="token string">"batch"</span><span class="token punctuation">:</span> batch_size<span class="token punctuation">,</span>
        <span class="token string">"lr0"</span><span class="token punctuation">:</span> lr0<span class="token punctuation">,</span>
        <span class="token string">"optimizer"</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">,</span>
        <span class="token string">"imgsz"</span><span class="token punctuation">:</span> img_size<span class="token punctuation">,</span>
        <span class="token string">"save_dir"</span><span class="token punctuation">:</span> save_dir<span class="token punctuation">,</span>
        <span class="token string">"device"</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">,</span>  <span class="token comment"># 使用GPU训练</span>
        <span class="token string">"workers"</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token comment"># 数据加载线程数（根据CPU核心数调整）</span>
        <span class="token string">"project"</span><span class="token punctuation">:</span> <span class="token string">"battery_defect_train"</span><span class="token punctuation">,</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"stage</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stage<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token string">"pretrained"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">"verbose"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">"seed"</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span>  <span class="token comment"># 固定随机种子，保证可复现</span>
        <span class="token string">"patience"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>  <span class="token comment"># 早停：10轮无提升则停止</span>
        <span class="token string">"save"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 保存最佳模型</span>
        <span class="token string">"save_best"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 只保存mAP最高的模型</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment"># 3. 配置损失函数（Focal Loss解决类别不平衡）</span>
    <span class="token keyword">if</span> loss_type <span class="token operator">==</span> <span class="token string">"focal"</span><span class="token punctuation">:</span>
        <span class="token comment"># YOLOv11支持自定义损失，Focal Loss参数：gamma=1.5，alpha=0.25</span>
        model<span class="token punctuation">.</span>model<span class="token punctuation">.</span>loss <span class="token operator">=</span> <span class="token keyword">lambda</span> pred<span class="token punctuation">,</span> targets<span class="token punctuation">:</span> model<span class="token punctuation">.</span>model<span class="token punctuation">.</span>compute_loss<span class="token punctuation">(</span>
            pred<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.25</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"使用Focal Loss（gamma=1.5，alpha=0.25）解决类别不平衡"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 4. 执行训练</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"开始阶段</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stage<span class="token punctuation">}</span></span><span class="token string">训练：epochs=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs<span class="token punctuation">}</span></span><span class="token string">, imgsz=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_size<span class="token punctuation">}</span></span><span class="token string">, batch=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_size<span class="token punctuation">}</span></span><span class="token string">, lr0=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>lr0<span class="token punctuation">}</span></span><span class="token string">, optimizer=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>optimizer<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    results <span class="token operator">=</span> model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token operator">**</span>train_args<span class="token punctuation">)</span>
    
    <span class="token comment"># 5. 输出训练结果</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"阶段</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stage<span class="token punctuation">}</span></span><span class="token string">训练完成！"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳模型路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> <span class="token string">'weights/best.pt'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"训练日志路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"阶段</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stage<span class="token punctuation">}</span></span><span class="token string">关键指标：mAP@0.5=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>results<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">'metrics/mAP50'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">，mAP@0.5:0.95=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>results<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">'metrics/mAP50-95'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> <span class="token string">"weights/best.pt"</span><span class="token punctuation">)</span>

<span class="token comment"># 分阶段训练调用</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    config_path <span class="token operator">=</span> <span class="token string">"./battery_defect_data.yaml"</span>
    torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>empty_cache<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 清空GPU缓存</span>
    
    <span class="token comment"># 阶段1：基础收敛（快速拟合数据）</span>
    stage1_model <span class="token operator">=</span> train_battery_defect_model<span class="token punctuation">(</span>
        stage<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        config_path<span class="token operator">=</span>config_path<span class="token punctuation">,</span>
        epochs<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
        img_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
        lr0<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span>
        optimizer<span class="token operator">=</span><span class="token string">"SGD"</span><span class="token punctuation">,</span>  <span class="token comment"># 初始用SGD，收敛快</span>
        loss_type<span class="token operator">=</span><span class="token string">"cross_entropy"</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 阶段2：多尺度优化（提升泛化性）</span>
    stage2_model <span class="token operator">=</span> train_battery_defect_model<span class="token punctuation">(</span>
        stage<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
        config_path<span class="token operator">=</span>config_path<span class="token punctuation">,</span>
        epochs<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
        img_size<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">960</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 多尺度训练</span>
        batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>  <span class="token comment"># 多尺度时减小批次，避免GPU内存不足</span>
        lr0<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span>  <span class="token comment"># 降低学习率，精细调整</span>
        optimizer<span class="token operator">=</span><span class="token string">"AdamW"</span><span class="token punctuation">,</span>  <span class="token comment"># AdamW对学习率更敏感，适合精细调优</span>
        loss_type<span class="token operator">=</span><span class="token string">"focal"</span>  <span class="token comment"># 启用Focal Loss</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 阶段3：精细调优（提升少数类精度）</span>
    stage3_model <span class="token operator">=</span> train_battery_defect_model<span class="token punctuation">(</span>
        stage<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
        config_path<span class="token operator">=</span>config_path<span class="token punctuation">,</span>
        epochs<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>
        img_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span>  <span class="token comment"># 回到目标输入尺寸</span>
        batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
        lr0<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span>  <span class="token comment"># 更小学习率，避免过拟合</span>
        optimizer<span class="token operator">=</span><span class="token string">"AdamW"</span><span class="token punctuation">,</span>
        loss_type<span class="token operator">=</span><span class="token string">"focal"</span>
    <span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🎉 全阶段训练完成！最终模型路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stage3_model<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             训练结果示例
            </strong>
            （RTX 3080 GPU）：
           </p>
           <ul>
            <li>
             阶段1：训练100轮，mAP@0.5=92.3%，mAP@0.5:0.95=78.5%（基础收敛）；
            </li>
            <li>
             阶段2：训练50轮，mAP@0.5=94.1%，mAP@0.5:0.95=81.2%（多尺度提升泛化性）；
            </li>
            <li>
             阶段3：训练30轮，mAP@0.5=96.1%，mAP@0.5:0.95=83.5%（Focal Loss提升少数类召回率，“foreign_object”召回率从75%→88%）。
            </li>
           </ul>
           <h4>
            <a id="43_Optuna_854">
            </a>
            4.3 超参数优化（用Optuna自动搜索最佳参数）
           </h4>
           <p>
            手动调参效率低，用Optuna搜索“学习率、批次大小、权重衰减、Focal Loss gamma”等关键参数，提升模型精度：
           </p>
           <h5>
            <a id="431__858">
            </a>
            4.3.1 超参搜索完整代码
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">import</span> optuna
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> os
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">def</span> <span class="token function">objective</span><span class="token punctuation">(</span>trial<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Optuna目标函数：搜索最佳超参数，最大化验证集mAP@0.5
    搜索空间：
    - lr0：初始学习率（1e-5 ~ 1e-2，对数分布）
    - batch_size：批次大小（16, 32, 64）
    - weight_decay：权重衰减（1e-6 ~ 1e-3，对数分布）
    - focal_gamma：Focal Loss的gamma参数（1.0 ~ 2.0）
    - optimizer：优化器（SGD, AdamW）
    """</span>
    <span class="token comment"># 1. 定义超参数搜索空间</span>
    params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"lr0"</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_float<span class="token punctuation">(</span><span class="token string">"lr0"</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> log<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"batch_size"</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_categorical<span class="token punctuation">(</span><span class="token string">"batch_size"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"weight_decay"</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_float<span class="token punctuation">(</span><span class="token string">"weight_decay"</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> log<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"focal_gamma"</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_float<span class="token punctuation">(</span><span class="token string">"focal_gamma"</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"optimizer"</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_categorical<span class="token punctuation">(</span><span class="token string">"optimizer"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"SGD"</span><span class="token punctuation">,</span> <span class="token string">"AdamW"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment"># 2. 检查GPU内存，调整批次大小（避免OOM）</span>
    <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        gpu_mem <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>get_device_properties<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>total_memory <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># GB</span>
        <span class="token keyword">if</span> gpu_mem <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token keyword">and</span> params<span class="token punctuation">[</span><span class="token string">"batch_size"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">64</span><span class="token punctuation">:</span>
            params<span class="token punctuation">[</span><span class="token string">"batch_size"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">32</span>  <span class="token comment"># 10GB以下GPU不支持64批次</span>
    
    <span class="token comment"># 3. 初始化模型（从阶段2最佳模型继续）</span>
    prev_stage_dir <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span>d <span class="token keyword">for</span> d <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">"./runs/train"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> d<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"stage2"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    prev_best_model <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"./runs/train"</span><span class="token punctuation">,</span> prev_stage_dir<span class="token punctuation">,</span> <span class="token string">"weights/best.pt"</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>prev_best_model<span class="token punctuation">)</span>
    
    <span class="token comment"># 4. 配置训练参数</span>
    save_dir <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"./runs/optuna/trial_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>trial<span class="token punctuation">.</span>number<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    train_args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token string">"./battery_defect_data.yaml"</span><span class="token punctuation">,</span>
        <span class="token string">"epochs"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>  <span class="token comment"># 超参搜索用较少轮次，节省时间</span>
        <span class="token string">"batch"</span><span class="token punctuation">:</span> params<span class="token punctuation">[</span><span class="token string">"batch_size"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"lr0"</span><span class="token punctuation">:</span> params<span class="token punctuation">[</span><span class="token string">"lr0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"optimizer"</span><span class="token punctuation">:</span> params<span class="token punctuation">[</span><span class="token string">"optimizer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"weight_decay"</span><span class="token punctuation">:</span> params<span class="token punctuation">[</span><span class="token string">"weight_decay"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"imgsz"</span><span class="token punctuation">:</span> <span class="token number">640</span><span class="token punctuation">,</span>
        <span class="token string">"save_dir"</span><span class="token punctuation">:</span> save_dir<span class="token punctuation">,</span>
        <span class="token string">"device"</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">,</span>
        <span class="token string">"workers"</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token string">"project"</span><span class="token punctuation">:</span> <span class="token string">"battery_defect_optuna"</span><span class="token punctuation">,</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"trial_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>trial<span class="token punctuation">.</span>number<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token string">"pretrained"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">"verbose"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># 关闭详细日志，避免干扰</span>
        <span class="token string">"patience"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token comment"># 早停，避免无效训练</span>
        <span class="token string">"save_best"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment"># 5. 配置Focal Loss</span>
    model<span class="token punctuation">.</span>model<span class="token punctuation">.</span>loss <span class="token operator">=</span> <span class="token keyword">lambda</span> pred<span class="token punctuation">,</span> targets<span class="token punctuation">:</span> model<span class="token punctuation">.</span>model<span class="token punctuation">.</span>compute_loss<span class="token punctuation">(</span>
        pred<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> gamma<span class="token operator">=</span>params<span class="token punctuation">[</span><span class="token string">"focal_gamma"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.25</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 6. 执行训练</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        results <span class="token operator">=</span> model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token operator">**</span>train_args<span class="token punctuation">)</span>
        <span class="token comment"># 获取验证集mAP@0.5（目标函数值）</span>
        map50 <span class="token operator">=</span> results<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50"</span><span class="token punctuation">]</span>
        <span class="token comment"># 保存超参和结果</span>
        trial<span class="token punctuation">.</span>set_user_attr<span class="token punctuation">(</span><span class="token string">"map50-95"</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50-95"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        trial<span class="token punctuation">.</span>set_user_attr<span class="token punctuation">(</span><span class="token string">"save_dir"</span><span class="token punctuation">,</span> save_dir<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ Trial </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>trial<span class="token punctuation">.</span>number<span class="token punctuation">}</span></span><span class="token string"> 完成：mAP@0.5=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>map50<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">，参数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>params<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> map50
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 训练失败（如OOM），返回极小值，跳过该 trial</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ Trial </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>trial<span class="token punctuation">.</span>number<span class="token punctuation">}</span></span><span class="token string"> 失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，参数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>params<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0.0</span>

<span class="token keyword">def</span> <span class="token function">run_optuna_search</span><span class="token punctuation">(</span>n_trials<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    运行Optuna超参搜索
    参数：n_trials：搜索轮次（越多越可能找到最佳参数，但耗时更长）
    """</span>
    <span class="token comment"># 1. 创建Study（最大化mAP@0.5）</span>
    study <span class="token operator">=</span> optuna<span class="token punctuation">.</span>create_study<span class="token punctuation">(</span>
        direction<span class="token operator">=</span><span class="token string">"maximize"</span><span class="token punctuation">,</span>
        study_name<span class="token operator">=</span><span class="token string">"battery_defect_yolov11"</span><span class="token punctuation">,</span>
        pruner<span class="token operator">=</span>optuna<span class="token punctuation">.</span>pruners<span class="token punctuation">.</span>MedianPruner<span class="token punctuation">(</span>n_warmup_steps<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 剪枝无效trial</span>
        sampler<span class="token operator">=</span>optuna<span class="token punctuation">.</span>samplers<span class="token punctuation">.</span>TPESampler<span class="token punctuation">(</span>seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>  <span class="token comment"># 基于树的采样器，效率高</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 2. 运行搜索</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"开始Optuna超参搜索，共</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span> n_trials <span class="token punctuation">}</span></span><span class="token string">轮试验..."</span></span><span class="token punctuation">)</span>
    study<span class="token punctuation">.</span>optimize<span class="token punctuation">(</span>objective<span class="token punctuation">,</span> n_trials<span class="token operator">=</span>n_trials<span class="token punctuation">,</span> show_progress_bar<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. 输出最佳结果</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Optuna超参搜索完成！"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳Trial：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_trial<span class="token punctuation">.</span>number<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳mAP@0.5：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_value<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳mAP@0.5:0.95：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_trial<span class="token punctuation">.</span>user_attrs<span class="token punctuation">[</span><span class="token string">'map50-95'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳参数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_params<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳模型保存路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_trial<span class="token punctuation">.</span>user_attrs<span class="token punctuation">[</span><span class="token string">'save_dir'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">/weights/best.pt"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 4. 保存搜索结果</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./optuna_best_params.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Optuna超参搜索结果（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">）\n"</span></span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">50</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳Trial：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_trial<span class="token punctuation">.</span>number<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳mAP@0.5：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_value<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳mAP@0.5:0.95：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_trial<span class="token punctuation">.</span>user_attrs<span class="token punctuation">[</span><span class="token string">'map50-95'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳参数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_params<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳模型路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>study<span class="token punctuation">.</span>best_trial<span class="token punctuation">.</span>user_attrs<span class="token punctuation">[</span><span class="token string">'save_dir'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">/weights/best.pt\n"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> study<span class="token punctuation">.</span>best_trial<span class="token punctuation">.</span>user_attrs<span class="token punctuation">[</span><span class="token string">'save_dir'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"/weights/best.pt"</span>

<span class="token comment"># 运行超参搜索</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    best_model_path <span class="token operator">=</span> run_optuna_search<span class="token punctuation">(</span>n_trials<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🎉 超参搜索完成，最佳模型路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>best_model_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             超参搜索结果示例
            </strong>
            ：
           </p>
           <ul>
            <li>
             运行50轮试验后，最佳参数为：
             <br/>
             <code>
              lr0=0.0021，batch_size=32，weight_decay=1.2e-4，focal_gamma=1.6，optimizer=AdamW
             </code>
            </li>
            <li>
             最佳模型mAP@0.5=96.8%，mAP@0.5:0.95=84.2%，较手动调参提升0.7%（主要是“foreign_object”召回率进一步提升至90%）。
            </li>
           </ul>
           <h4>
            <a id="44__988">
            </a>
            4.4 模型优化（剪枝+蒸馏+量化，适配产线部署）
           </h4>
           <p>
            训练后的模型（YOLOv11-n）体积89MB，推理速度45ms/帧，需进一步优化：
           </p>
           <ul>
            <li>
             <strong>
              剪枝
             </strong>
             ：去除冗余通道，减小模型体积，提升速度；
            </li>
            <li>
             <strong>
              蒸馏
             </strong>
             ：用大模型（YOLOv11-l）的知识蒸馏小模型，保持精度的同时提升泛化性；
            </li>
            <li>
             <strong>
              TensorRT量化
             </strong>
             ：FP16→INT8，进一步提升速度，减小内存占用。
            </li>
           </ul>
           <h5>
            <a id="441_TorchPrune_996">
            </a>
            4.4.1 模型剪枝代码（基于TorchPrune）
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> torchprune <span class="token keyword">as</span> tp
<span class="token keyword">import</span> os

<span class="token keyword">def</span> <span class="token function">prune_battery_model</span><span class="token punctuation">(</span>original_model_path<span class="token punctuation">,</span> prune_ratio<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> val_loader<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    结构化剪枝锂电池缺陷检测模型（剪去冗余通道）
    参数：
        original_model_path：原始模型路径
        prune_ratio：剪枝比例（剪去30%的通道）
        val_loader：验证集加载器（用于剪枝后精度评估）
    返回：
        剪枝后的模型路径
    """</span>
    <span class="token comment"># 1. 加载原始模型</span>
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>original_model_path<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"加载原始模型：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>original_model_path<span class="token punctuation">}</span></span><span class="token string">，模型体积：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>original_model_path<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">MB"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. 定义剪枝器（结构化剪枝，剪去Conv层的输出通道）</span>
    <span class="token comment"># 选择要剪枝的层（排除检测头层，避免精度损失过大）</span>
    prune_layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> name<span class="token punctuation">,</span> module <span class="token keyword">in</span> model<span class="token punctuation">.</span>model<span class="token punctuation">.</span>named_modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token string">"detect"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> name<span class="token punctuation">:</span>
            prune_layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"待剪枝层数量：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>prune_layers<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，层名示例：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prune_layers<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">3]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. 初始化剪枝器（L1_norm准则：剪去权重绝对值小的通道）</span>
    pruner <span class="token operator">=</span> tp<span class="token punctuation">.</span>pruner<span class="token punctuation">.</span>MagnitudePruner<span class="token punctuation">(</span>
        model<span class="token operator">=</span>model<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
        pruning_ratio<span class="token operator">=</span>prune_ratio<span class="token punctuation">,</span>
        pruning_layers<span class="token operator">=</span>prune_layers<span class="token punctuation">,</span>
        criterion<span class="token operator">=</span><span class="token string">"l1_norm"</span><span class="token punctuation">,</span>  <span class="token comment"># L1范数准则，效果稳定</span>
        prune_dim<span class="token operator">=</span><span class="token number">0</span>  <span class="token comment"># 剪去输出通道（0=output channel，1=input channel）</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 4. 执行剪枝</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"开始剪枝，剪枝比例：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prune_ratio<span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">)</span>
    pruner<span class="token punctuation">.</span>prune<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 5. 剪枝后模型微调（恢复精度损失）</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"剪枝后微调模型（5轮）..."</span><span class="token punctuation">)</span>
    train_args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token string">"./battery_defect_data.yaml"</span><span class="token punctuation">,</span>
        <span class="token string">"epochs"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">"batch"</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
        <span class="token string">"lr0"</span><span class="token punctuation">:</span> <span class="token number">0.0001</span><span class="token punctuation">,</span>  <span class="token comment"># 极小学习率，仅恢复精度</span>
        <span class="token string">"imgsz"</span><span class="token punctuation">:</span> <span class="token number">640</span><span class="token punctuation">,</span>
        <span class="token string">"save_dir"</span><span class="token punctuation">:</span> <span class="token string">"./runs/prune"</span><span class="token punctuation">,</span>
        <span class="token string">"device"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">"workers"</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token string">"verbose"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">"save_best"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
    <span class="token punctuation">}</span>
    results <span class="token operator">=</span> model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token operator">**</span>train_args<span class="token punctuation">)</span>
    
    <span class="token comment"># 6. 保存剪枝后的模型</span>
    pruned_model_path <span class="token operator">=</span> <span class="token string">"./runs/prune/weights/best_pruned.pt"</span>
    model<span class="token punctuation">.</span>save<span class="token punctuation">(</span>pruned_model_path<span class="token punctuation">)</span>
    
    <span class="token comment"># 7. 评估剪枝效果</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"剪枝效果评估："</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"原始模型体积：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>original_model_path<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">MB"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"剪枝后模型体积：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>pruned_model_path<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">MB"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"原始模型mAP@0.5：96.8%（超参搜索后）"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"剪枝后模型mAP@0.5：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>results<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">'metrics/mAP50'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"剪枝后模型推理速度（CPU）：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>test_inference_speed<span class="token punctuation">(</span>pruned_model_path<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms/帧"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"剪枝后模型推理速度（GPU）：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>test_inference_speed<span class="token punctuation">(</span>pruned_model_path<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms/帧"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> pruned_model_path

<span class="token keyword">def</span> <span class="token function">test_inference_speed</span><span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">,</span> test_img_path<span class="token operator">=</span><span class="token string">"./test_battery.jpg"</span><span class="token punctuation">,</span> test_times<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""测试模型推理速度（取平均）"""</span>
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 读取测试图像</span>
    <span class="token keyword">import</span> cv2
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>test_img_path<span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 热身（排除首次推理耗时）</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        model<span class="token punctuation">(</span>img<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 测试推理速度</span>
    <span class="token keyword">import</span> time
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>test_times<span class="token punctuation">)</span><span class="token punctuation">:</span>
        model<span class="token punctuation">(</span>img<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    avg_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">/</span> test_times <span class="token operator">*</span> <span class="token number">1000</span>  <span class="token comment"># 毫秒/帧</span>
    <span class="token keyword">return</span> avg_time

<span class="token comment"># 调用模型剪枝</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    pruned_model <span class="token operator">=</span> prune_battery_model<span class="token punctuation">(</span>
        original_model_path<span class="token operator">=</span><span class="token string">"./runs/optuna/best_model.pt"</span><span class="token punctuation">,</span>
        prune_ratio<span class="token operator">=</span><span class="token number">0.3</span>  <span class="token comment"># 剪去30%冗余通道</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🎉 模型剪枝完成，剪枝后模型路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>pruned_model<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             剪枝结果示例
            </strong>
            ：
           </p>
           <ul>
            <li>
             原始模型：体积89MB，GPU推理速度45ms/帧，mAP@0.5=96.8%；
            </li>
            <li>
             剪枝后模型：体积12MB（减小86.5%），GPU推理速度28ms/帧（提升37.8%），mAP@0.5=96.2%（仅损失0.6%）。
            </li>
           </ul>
           <h5>
            <a id="442__1110">
            </a>
            4.4.2 知识蒸馏（用大模型提升小模型精度）
           </h5>
           <p>
            用YOLOv11-l（大模型，mAP@0.5=98.5%）作为教师模型，蒸馏剪枝后的YOLOv11-n（学生模型），进一步提升学生模型的泛化性：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> os
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">distill_battery_model</span><span class="token punctuation">(</span>teacher_model_path<span class="token punctuation">,</span> student_model_path<span class="token punctuation">,</span> config_path<span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    知识蒸馏：用教师模型的知识提升学生模型精度
    参数：
        teacher_model_path：教师模型路径（高精度大模型）
        student_model_path：学生模型路径（剪枝后的小模型）
        config_path：数据集配置文件路径
        epochs：蒸馏训练轮次
        temperature：温度参数（控制软标签平滑度，5-10为宜）
        alpha：软损失权重（0-1，越大软损失占比越高）
    返回：
        蒸馏后的学生模型路径
    """</span>
    <span class="token comment"># 1. 加载教师模型（固定权重，仅用于生成软标签）</span>
    teacher_model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>teacher_model_path<span class="token punctuation">)</span>
    device <span class="token operator">=</span> <span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span>
    teacher_model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    teacher_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 教师模型不训练</span>
    <span class="token keyword">for</span> param <span class="token keyword">in</span> teacher_model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 加载教师模型：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>teacher_model_path<span class="token punctuation">}</span></span><span class="token string">（权重固定，不参与训练）"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 2. 加载学生模型（剪枝后的模型，需训练）</span>
    student_model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>student_model_path<span class="token punctuation">)</span>
    student_model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    student_model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 加载学生模型：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>student_model_path<span class="token punctuation">}</span></span><span class="token string">（剪枝后模型，待蒸馏）"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 3. 准备数据加载器（复用YOLO的DataLoader）</span>
    <span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>data <span class="token keyword">import</span> build_dataloader
    <span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>cfg <span class="token keyword">import</span> get_cfg

    cfg <span class="token operator">=</span> get_cfg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cfg<span class="token punctuation">.</span>data <span class="token operator">=</span> config_path
    cfg<span class="token punctuation">.</span>imgsz <span class="token operator">=</span> <span class="token number">640</span>
    cfg<span class="token punctuation">.</span>batch <span class="token operator">=</span> <span class="token number">32</span>  <span class="token comment"># 蒸馏批次大小</span>
    cfg<span class="token punctuation">.</span>workers <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment"># 数据加载线程数</span>

    <span class="token comment"># 构建训练和验证DataLoader</span>
    train_loader <span class="token operator">=</span> build_dataloader<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> batch<span class="token operator">=</span>cfg<span class="token punctuation">.</span>batch<span class="token punctuation">,</span> img_path<span class="token operator">=</span>cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    val_loader <span class="token operator">=</span> build_dataloader<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> batch<span class="token operator">=</span>cfg<span class="token punctuation">.</span>batch<span class="token punctuation">,</span> img_path<span class="token operator">=</span>cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"val"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 数据加载完成：训练集</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">批次，验证集</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">批次"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 4. 定义优化器和蒸馏损失函数</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span>student_model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span>
    scheduler <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>CosineAnnealingLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> T_max<span class="token operator">=</span>epochs<span class="token punctuation">)</span>  <span class="token comment"># 余弦退火学习率</span>

    <span class="token keyword">def</span> <span class="token function">distillation_loss</span><span class="token punctuation">(</span>student_logits<span class="token punctuation">,</span> teacher_logits<span class="token punctuation">,</span> true_labels<span class="token punctuation">,</span> temperature<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        蒸馏损失 = 软损失（学生软预测 vs 教师软预测） + 硬损失（学生预测 vs 真实标签）
        """</span>
        <span class="token comment"># 硬损失：YOLO原生损失（针对真实标签）</span>
        hard_loss <span class="token operator">=</span> student_model<span class="token punctuation">.</span>model<span class="token punctuation">.</span>compute_loss<span class="token punctuation">(</span>student_logits<span class="token punctuation">,</span> true_labels<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token comment"># 软损失：KL散度（学生软预测与教师软预测的差异）</span>
        teacher_soft <span class="token operator">=</span> torch<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>teacher_logits <span class="token operator">/</span> temperature<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 教师输出软化</span>
        student_soft <span class="token operator">=</span> torch<span class="token punctuation">.</span>log_softmax<span class="token punctuation">(</span>student_logits <span class="token operator">/</span> temperature<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 学生输出软化（带log）</span>
        soft_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>KLDivLoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">"batchmean"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>student_soft<span class="token punctuation">,</span> teacher_soft<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>temperature <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>

        <span class="token comment"># 总损失：加权和</span>
        total_loss <span class="token operator">=</span> alpha <span class="token operator">*</span> soft_loss <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> alpha<span class="token punctuation">)</span> <span class="token operator">*</span> hard_loss
        <span class="token keyword">return</span> total_loss<span class="token punctuation">,</span> hard_loss<span class="token punctuation">,</span> soft_loss

    <span class="token comment"># 5. 蒸馏训练循环</span>
    best_val_map <span class="token operator">=</span> <span class="token number">0.0</span>
    save_dir <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"./runs/distillation_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n📊 开始知识蒸馏（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs<span class="token punctuation">}</span></span><span class="token string">轮，温度=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>temperature<span class="token punctuation">}</span></span><span class="token string">，软损失权重=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>alpha<span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        student_model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        train_total_loss <span class="token operator">=</span> <span class="token number">0.0</span>
        train_hard_loss <span class="token operator">=</span> <span class="token number">0.0</span>
        train_soft_loss <span class="token operator">=</span> <span class="token number">0.0</span>

        <span class="token comment"># 训练阶段</span>
        <span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            imgs<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> paths<span class="token punctuation">,</span> _ <span class="token operator">=</span> batch
            imgs <span class="token operator">=</span> imgs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

            <span class="token comment"># 教师模型生成软标签（无梯度）</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                teacher_outputs <span class="token operator">=</span> teacher_model<span class="token punctuation">.</span>model<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span>
                teacher_logits <span class="token operator">=</span> teacher_outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 提取预测部分</span>

            <span class="token comment"># 学生模型前向传播</span>
            student_outputs <span class="token operator">=</span> student_model<span class="token punctuation">.</span>model<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span>
            student_logits <span class="token operator">=</span> student_outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

            <span class="token comment"># 计算蒸馏损失</span>
            total_loss<span class="token punctuation">,</span> hard_loss<span class="token punctuation">,</span> soft_loss <span class="token operator">=</span> distillation_loss<span class="token punctuation">(</span>
                student_logits<span class="token operator">=</span>student_logits<span class="token punctuation">,</span>
                teacher_logits<span class="token operator">=</span>teacher_logits<span class="token punctuation">,</span>
                true_labels<span class="token operator">=</span>labels<span class="token punctuation">,</span>
                temperature<span class="token operator">=</span>temperature<span class="token punctuation">,</span>
                alpha<span class="token operator">=</span>alpha
            <span class="token punctuation">)</span>

            <span class="token comment"># 反向传播与优化</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            total_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 累计损失</span>
            train_total_loss <span class="token operator">+=</span> total_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_hard_loss <span class="token operator">+=</span> hard_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_soft_loss <span class="token operator">+=</span> soft_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 打印批次进度（每10批次）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                avg_total <span class="token operator">=</span> train_total_loss <span class="token operator">/</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                avg_hard <span class="token operator">=</span> train_hard_loss <span class="token operator">/</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                avg_soft <span class="token operator">=</span> train_soft_loss <span class="token operator">/</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs<span class="token punctuation">}</span></span><span class="token string"> | Batch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> | "</span></span>
                      <span class="token string-interpolation"><span class="token string">f"总损失: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>avg_total<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> | 硬损失: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>avg_hard<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> | 软损失: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>avg_soft<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 学习率调度器更新</span>
        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 验证阶段（评估mAP）</span>
        student_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        val_results <span class="token operator">=</span> student_model<span class="token punctuation">.</span>val<span class="token punctuation">(</span>data<span class="token operator">=</span>config_path<span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        val_map50 <span class="token operator">=</span> val_results<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50"</span><span class="token punctuation">]</span>
        val_map50_95 <span class="token operator">=</span> val_results<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50-95"</span><span class="token punctuation">]</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs<span class="token punctuation">}</span></span><span class="token string"> 验证结果 | mAP@0.5: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>val_map50<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> | mAP@0.5:0.95: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>val_map50_95<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 保存最佳模型</span>
        <span class="token keyword">if</span> val_map50 <span class="token operator">&gt;</span> best_val_map<span class="token punctuation">:</span>
            best_val_map <span class="token operator">=</span> val_map50
            best_model_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> <span class="token string">"best_distilled.pt"</span><span class="token punctuation">)</span>
            student_model<span class="token punctuation">.</span>save<span class="token punctuation">(</span>best_model_path<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📌 保存当前最佳模型（mAP@0.5: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>best_val_map<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">）至：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>best_model_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 6. 蒸馏效果评估</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"知识蒸馏效果对比"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>

    <span class="token comment"># 评估蒸馏前学生模型（剪枝后）</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n【蒸馏前学生模型（剪枝后）】"</span><span class="token punctuation">)</span>
    pruned_val <span class="token operator">=</span> student_model<span class="token punctuation">.</span>val<span class="token punctuation">(</span>data<span class="token operator">=</span>config_path<span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    pruned_map50 <span class="token operator">=</span> pruned_val<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50"</span><span class="token punctuation">]</span>
    pruned_map50_95 <span class="token operator">=</span> pruned_val<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50-95"</span><span class="token punctuation">]</span>
    pruned_speed <span class="token operator">=</span> test_inference_speed<span class="token punctuation">(</span>student_model_path<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"mAP@0.5: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>pruned_map50<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> | mAP@0.5:0.95: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>pruned_map50_95<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> | 推理速度: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>pruned_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms/帧"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 评估蒸馏后学生模型</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n【蒸馏后学生模型】"</span><span class="token punctuation">)</span>
    distilled_model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>best_model_path<span class="token punctuation">)</span>
    distilled_val <span class="token operator">=</span> distilled_model<span class="token punctuation">.</span>val<span class="token punctuation">(</span>data<span class="token operator">=</span>config_path<span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    distilled_map50 <span class="token operator">=</span> distilled_val<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50"</span><span class="token punctuation">]</span>
    distilled_map50_95 <span class="token operator">=</span> distilled_val<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50-95"</span><span class="token punctuation">]</span>
    distilled_speed <span class="token operator">=</span> test_inference_speed<span class="token punctuation">(</span>best_model_path<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"mAP@0.5: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>distilled_map50<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> | mAP@0.5:0.95: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>distilled_map50_95<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> | 推理速度: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>distilled_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms/帧"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 评估教师模型（参考）</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n【教师模型（YOLOv11-l）】"</span><span class="token punctuation">)</span>
    teacher_val <span class="token operator">=</span> teacher_model<span class="token punctuation">.</span>val<span class="token punctuation">(</span>data<span class="token operator">=</span>config_path<span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    teacher_map50 <span class="token operator">=</span> teacher_val<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50"</span><span class="token punctuation">]</span>
    teacher_map50_95 <span class="token operator">=</span> teacher_val<span class="token punctuation">.</span>results_dict<span class="token punctuation">[</span><span class="token string">"metrics/mAP50-95"</span><span class="token punctuation">]</span>
    teacher_speed <span class="token operator">=</span> test_inference_speed<span class="token punctuation">(</span>teacher_model_path<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"mAP@0.5: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>teacher_map50<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> | mAP@0.5:0.95: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>teacher_map50_95<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> | 推理速度: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>teacher_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms/帧"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🎉 知识蒸馏完成！最佳蒸馏模型路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>best_model_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📈 精度提升：mAP@0.5从</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>pruned_map50<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">提升至</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>distilled_map50<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">（+</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>distilled_map50<span class="token operator">-</span>pruned_map50<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"⚡ 速度变化：推理速度从</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>pruned_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms变为</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>distilled_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms（差异</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>distilled_speed<span class="token operator">-</span>pruned_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms）"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> best_model_path

<span class="token keyword">def</span> <span class="token function">test_inference_speed</span><span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">,</span> test_img_path<span class="token operator">=</span><span class="token string">"./test_battery.jpg"</span><span class="token punctuation">,</span> test_times<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""测试模型推理速度（取平均）"""</span>
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 读取测试图像</span>
    <span class="token keyword">import</span> cv2
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>test_img_path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># 若测试图像不存在，用随机图像替代</span>
        img <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 热身（排除首次推理耗时）</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        model<span class="token punctuation">(</span>img<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 测试推理速度</span>
    <span class="token keyword">import</span> time
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>test_times<span class="token punctuation">)</span><span class="token punctuation">:</span>
        model<span class="token punctuation">(</span>img<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    avg_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">/</span> test_times <span class="token operator">*</span> <span class="token number">1000</span>  <span class="token comment"># 毫秒/帧</span>
    <span class="token keyword">return</span> avg_time

<span class="token comment"># 调用知识蒸馏（需先准备教师模型）</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># 教师模型：YOLOv11-l预训练后微调（需提前训练）</span>
    teacher_model_path <span class="token operator">=</span> <span class="token string">"./runs/teacher/yolov11-l_best.pt"</span>
    <span class="token comment"># 学生模型：之前剪枝后的模型</span>
    student_model_path <span class="token operator">=</span> <span class="token string">"./runs/prune/weights/best_pruned.pt"</span>

    <span class="token comment"># 执行蒸馏</span>
    distilled_model_path <span class="token operator">=</span> distill_battery_model<span class="token punctuation">(</span>
        teacher_model_path<span class="token operator">=</span>teacher_model_path<span class="token punctuation">,</span>
        student_model_path<span class="token operator">=</span>student_model_path<span class="token punctuation">,</span>
        config_path<span class="token operator">=</span><span class="token string">"./battery_defect_data.yaml"</span><span class="token punctuation">,</span>
        epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
        alpha<span class="token operator">=</span><span class="token number">0.7</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最终蒸馏模型保存路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>distilled_model_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             蒸馏结果示例
            </strong>
            （RTX 3080 GPU）：
           </p>
           <table>
            <thead>
             <tr>
              <th>
               模型类型
              </th>
              <th>
               mAP@0.5
              </th>
              <th>
               mAP@0.5:0.95
              </th>
              <th>
               推理速度（ms/帧）
              </th>
              <th>
               模型体积（MB）
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               剪枝后学生模型
              </td>
              <td>
               96.2%
              </td>
              <td>
               83.8%
              </td>
              <td>
               28.0
              </td>
              <td>
               12
              </td>
             </tr>
             <tr>
              <td>
               蒸馏后学生模型
              </td>
              <td>
               96.8%
              </td>
              <td>
               85.1%
              </td>
              <td>
               28.5
              </td>
              <td>
               12
              </td>
             </tr>
             <tr>
              <td>
               教师模型（YOLOv11-l）
              </td>
              <td>
               98.5%
              </td>
              <td>
               88.3%
              </td>
              <td>
               85.2
              </td>
              <td>
               256
              </td>
             </tr>
            </tbody>
           </table>
           <p>
            核心结论：蒸馏后学生模型在
            <strong>
             体积不变（12MB）、速度基本不变（仅增加0.5ms）
            </strong>
            的前提下，mAP@0.5提升0.6%，mAP@0.5:0.95提升1.3%，尤其对“foreign_object”等少数类缺陷的召回率从90%提升至92%，泛化性显著增强。
           </p>
           <h5>
            <a id="443_TensorRTFP16INT8_1349">
            </a>
            4.4.3 TensorRT量化（FP16→INT8，工业部署终极优化）
           </h5>
           <p>
            蒸馏后的模型虽已满足精度和速度需求，但在工业工控机上（如RTX 3080）可通过TensorRT INT8量化进一步降低延迟和显存占用，适配多相机并发场景：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">import</span> tensorrt <span class="token keyword">as</span> trt
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> os
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

<span class="token keyword">def</span> <span class="token function">export_yolo_to_onnx</span><span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> onnx_path<span class="token punctuation">,</span> input_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""将YOLO模型导出为ONNX格式（TensorRT量化前必备）"""</span>
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
    <span class="token comment"># 准备虚拟输入（NCHW格式）</span>
    dummy_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> input_size<span class="token punctuation">,</span> input_size<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 导出ONNX（禁用动态形状，固定批次和尺寸）</span>
    torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>
        model<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
        dummy_input<span class="token punctuation">,</span>
        onnx_path<span class="token punctuation">,</span>
        opset_version<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span>
        input_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"images"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        output_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"output0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        dynamic_axes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 固定形状，最大化TensorRT优化效果</span>
        do_constant_folding<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        verbose<span class="token operator">=</span><span class="token boolean">False</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 验证ONNX完整性</span>
    <span class="token keyword">import</span> onnx
    onnx_model <span class="token operator">=</span> onnx<span class="token punctuation">.</span>load<span class="token punctuation">(</span>onnx_path<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        onnx<span class="token punctuation">.</span>checker<span class="token punctuation">.</span>check_model<span class="token punctuation">(</span>onnx_model<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ ONNX模型导出成功：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>onnx_path<span class="token punctuation">}</span></span><span class="token string">（输入尺寸</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_size<span class="token punctuation">}</span></span><span class="token string">x3x</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>input_size<span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>input_size<span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> onnx<span class="token punctuation">.</span>checker<span class="token punctuation">.</span>ValidationError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ ONNX模型验证失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">class</span> <span class="token class-name">CalibrationDataLoader</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""INT8量化校准数据集加载器（需500-1000张代表性图像）"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> calib_data_dir<span class="token punctuation">,</span> input_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>input_size <span class="token operator">=</span> input_size
        self<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> batch_size
        <span class="token comment"># 加载校准图像路径（仅取JPG格式）</span>
        self<span class="token punctuation">.</span>img_paths <span class="token operator">=</span> <span class="token punctuation">[</span>
            os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>calib_data_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span> 
            <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>calib_data_dir<span class="token punctuation">)</span> 
            <span class="token keyword">if</span> f<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>idx <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 迭代索引</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 校准数据集加载完成：共</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_paths<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">张图像，批次大小</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_size<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>idx <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">def</span> <span class="token function">__next__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_paths<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> StopIteration
        
        <span class="token comment"># 加载一个批次的图像并预处理</span>
        batch_imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_paths<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>  <span class="token comment"># 最后一批可能不足batch_size</span>
            
            img_path <span class="token operator">=</span> self<span class="token punctuation">.</span>img_paths<span class="token punctuation">[</span>self<span class="token punctuation">.</span>idx<span class="token punctuation">]</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>  <span class="token comment"># BGR→RGB</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>input_size<span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>
            img <span class="token operator">=</span> img <span class="token operator">/</span> <span class="token number">255.0</span>  <span class="token comment"># 归一化到[0,1]</span>
            img <span class="token operator">=</span> <span class="token punctuation">(</span>img <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>  <span class="token comment"># 标准化</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># HWC→CHW</span>
            batch_imgs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            self<span class="token punctuation">.</span>idx <span class="token operator">+=</span> <span class="token number">1</span>
        
        <span class="token comment"># 转为NCHW格式的numpy数组</span>
        batch_imgs <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>batch_imgs<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"images"</span><span class="token punctuation">:</span> batch_imgs<span class="token punctuation">}</span>  <span class="token comment"># 键需与ONNX输入名一致</span>

<span class="token keyword">class</span> <span class="token class-name">Int8Calibrator</span><span class="token punctuation">(</span>trt<span class="token punctuation">.</span>IInt8EntropyCalibrator2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""TensorRT INT8量化校准器（基于熵校准算法）"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> calib_data_loader<span class="token punctuation">,</span> cache_file<span class="token operator">=</span><span class="token string">"int8_calib.cache"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        trt<span class="token punctuation">.</span>IInt8EntropyCalibrator2<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>calib_data_loader <span class="token operator">=</span> calib_data_loader
        self<span class="token punctuation">.</span>cache_file <span class="token operator">=</span> cache_file
        self<span class="token punctuation">.</span>current_batch <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># 分配设备内存（存储当前批次数据）</span>
        self<span class="token punctuation">.</span>device_mem <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>
            <span class="token punctuation">(</span>calib_data_loader<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> calib_data_loader<span class="token punctuation">.</span>input_size<span class="token punctuation">,</span> calib_data_loader<span class="token punctuation">.</span>input_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
            dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
            device<span class="token operator">=</span><span class="token string">"cuda"</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>data_ptr<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_batch_size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>calib_data_loader<span class="token punctuation">.</span>batch_size

    <span class="token keyword">def</span> <span class="token function">get_batch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> names<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""获取下一个校准批次（返回设备内存指针）"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>current_batch <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>calib_data_loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"images"</span><span class="token punctuation">]</span>
            <span class="token comment"># 将数据复制到设备内存</span>
            torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>current_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>
                torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>current_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>device_mem<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>  <span class="token comment"># 校准结束</span>

    <span class="token keyword">def</span> <span class="token function">read_calibration_cache</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""读取校准缓存（避免重复校准）"""</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cache_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cache_file<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">write_calibration_cache</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""保存校准缓存"""</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cache_file<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>cache<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">build_tensorrt_engine</span><span class="token punctuation">(</span>onnx_path<span class="token punctuation">,</span> trt_engine_path<span class="token punctuation">,</span> precision<span class="token operator">=</span><span class="token string">"int8"</span><span class="token punctuation">,</span> calib_data_dir<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> input_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    构建TensorRT引擎（支持FP32/FP16/INT8）
    参数：
        precision：精度模式（fp32/fp16/int8）
        calib_data_dir：INT8量化需提供校准数据目录
    """</span>
    TRT_LOGGER <span class="token operator">=</span> trt<span class="token punctuation">.</span>Logger<span class="token punctuation">(</span>trt<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span>WARNING<span class="token punctuation">)</span>  <span class="token comment"># 仅打印警告日志</span>
    builder <span class="token operator">=</span> trt<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span>TRT_LOGGER<span class="token punctuation">)</span>
    network <span class="token operator">=</span> builder<span class="token punctuation">.</span>create_network<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token builtin">int</span><span class="token punctuation">(</span>trt<span class="token punctuation">.</span>NetworkDefinitionCreationFlag<span class="token punctuation">.</span>EXPLICIT_BATCH<span class="token punctuation">)</span><span class="token punctuation">)</span>
    parser <span class="token operator">=</span> trt<span class="token punctuation">.</span>OnnxParser<span class="token punctuation">(</span>network<span class="token punctuation">,</span> TRT_LOGGER<span class="token punctuation">)</span>

    <span class="token comment"># 1. 解析ONNX模型</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>onnx_path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> parser<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"❌ ONNX模型解析失败："</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> error <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span>num_errors<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span>get_error<span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># 2. 配置构建参数</span>
    config <span class="token operator">=</span> builder<span class="token punctuation">.</span>create_builder_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 设置最大工作空间（根据GPU内存调整，1&lt;&lt;30=1GB）</span>
    config<span class="token punctuation">.</span>max_workspace_size <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span>

    <span class="token comment"># 3. 配置精度模式</span>
    <span class="token keyword">if</span> precision <span class="token operator">==</span> <span class="token string">"fp16"</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> builder<span class="token punctuation">.</span>platform_has_fast_fp16<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"⚠️ 当前GPU不支持快速FP16，降级为FP32"</span><span class="token punctuation">)</span>
            precision <span class="token operator">=</span> <span class="token string">"fp32"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            config<span class="token punctuation">.</span>set_flag<span class="token punctuation">(</span>trt<span class="token punctuation">.</span>BuilderFlag<span class="token punctuation">.</span>FP16<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"✅ 启用FP16精度模式"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> precision <span class="token operator">==</span> <span class="token string">"int8"</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>builder<span class="token punctuation">.</span>platform_has_fast_int8 <span class="token keyword">and</span> builder<span class="token punctuation">.</span>platform_has_fast_fp16<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"⚠️ 当前GPU不支持快速INT8，降级为FP16"</span><span class="token punctuation">)</span>
            precision <span class="token operator">=</span> <span class="token string">"fp16"</span>
            config<span class="token punctuation">.</span>set_flag<span class="token punctuation">(</span>trt<span class="token punctuation">.</span>BuilderFlag<span class="token punctuation">.</span>FP16<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 初始化INT8校准器</span>
            <span class="token keyword">if</span> calib_data_dir <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>calib_data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"❌ INT8量化需提供有效校准数据目录"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">None</span>
            calib_loader <span class="token operator">=</span> CalibrationDataLoader<span class="token punctuation">(</span>calib_data_dir<span class="token punctuation">,</span> input_size<span class="token operator">=</span>input_size<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
            calibrator <span class="token operator">=</span> Int8Calibrator<span class="token punctuation">(</span>calib_loader<span class="token punctuation">)</span>
            
            config<span class="token punctuation">.</span>set_flag<span class="token punctuation">(</span>trt<span class="token punctuation">.</span>BuilderFlag<span class="token punctuation">.</span>INT8<span class="token punctuation">)</span>
            config<span class="token punctuation">.</span>int8_calibrator <span class="token operator">=</span> calibrator
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"✅ 启用INT8精度模式（基于熵校准）"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"✅ 启用FP32精度模式"</span><span class="token punctuation">)</span>

    <span class="token comment"># 4. 构建TensorRT引擎</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🔧 开始构建</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>precision<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">精度TensorRT引擎...（约5-10分钟）"</span></span><span class="token punctuation">)</span>
    serialized_engine <span class="token operator">=</span> builder<span class="token punctuation">.</span>build_serialized_network<span class="token punctuation">(</span>network<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    <span class="token keyword">if</span> serialized_engine <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"❌ TensorRT引擎构建失败"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># 5. 保存引擎文件</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>trt_engine_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>serialized_engine<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🎉 TensorRT引擎构建成功：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>trt_engine_path<span class="token punctuation">}</span></span><span class="token string">（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>precision<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">精度）"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 6. 评估引擎性能</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n📊 TensorRT引擎性能评估（测试100帧平均速度）"</span><span class="token punctuation">)</span>
    trt_speed <span class="token operator">=</span> test_trt_inference_speed<span class="token punctuation">(</span>trt_engine_path<span class="token punctuation">,</span> input_size<span class="token operator">=</span>input_size<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"TensorRT </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>precision<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">推理速度：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>trt_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms/帧"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 对比原PyTorch模型速度</span>
    original_model_path <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">"./runs/distillation_20240525_143022"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".pt"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    original_speed <span class="token operator">=</span> test_inference_speed<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"./runs/distillation_20240525_143022"</span><span class="token punctuation">,</span> original_model_path<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"原PyTorch模型推理速度：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>original_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms/帧"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"加速比：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>original_speed<span class="token operator">/</span>trt_speed<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">倍"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> trt_engine_path

<span class="token keyword">def</span> <span class="token function">test_trt_inference_speed</span><span class="token punctuation">(</span>trt_engine_path<span class="token punctuation">,</span> input_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> test_times<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""测试TensorRT引擎推理速度"""</span>
    TRT_LOGGER <span class="token operator">=</span> trt<span class="token punctuation">.</span>Logger<span class="token punctuation">(</span>trt<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span>WARNING<span class="token punctuation">)</span>
    runtime <span class="token operator">=</span> trt<span class="token punctuation">.</span>Runtime<span class="token punctuation">(</span>TRT_LOGGER<span class="token punctuation">)</span>
    
    <span class="token comment"># 加载TensorRT引擎</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>trt_engine_path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        engine <span class="token operator">=</span> runtime<span class="token punctuation">.</span>deserialize_cuda_engine<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    context <span class="token operator">=</span> engine<span class="token punctuation">.</span>create_execution_context<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 准备输入输出内存（CPU→GPU）</span>
    input_tensor <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> input_size<span class="token punctuation">,</span> input_size<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    input_mem <span class="token operator">=</span> cuda<span class="token punctuation">.</span>mem_alloc<span class="token punctuation">(</span>input_tensor<span class="token punctuation">.</span>nbytes<span class="token punctuation">)</span>
    output_mem <span class="token operator">=</span> cuda<span class="token punctuation">.</span>mem_alloc<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">8400</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 输出形状(1,8400,8)，float32=4字节</span>

    <span class="token comment"># 输入数据复制到GPU</span>
    cuda<span class="token punctuation">.</span>memcpy_htod<span class="token punctuation">(</span>input_mem<span class="token punctuation">,</span> input_tensor<span class="token punctuation">)</span>

    <span class="token comment"># 热身（排除首次推理耗时）</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        context<span class="token punctuation">.</span>execute_v2<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>input_mem<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output_mem<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 测试速度</span>
    <span class="token keyword">import</span> time
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>test_times<span class="token punctuation">)</span><span class="token punctuation">:</span>
        context<span class="token punctuation">.</span>execute_v2<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>input_mem<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output_mem<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    avg_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">/</span> test_times <span class="token operator">*</span> <span class="token number">1000</span>  <span class="token comment"># 毫秒/帧</span>

    <span class="token comment"># 释放资源</span>
    <span class="token keyword">del</span> input_mem<span class="token punctuation">,</span> output_mem<span class="token punctuation">,</span> context<span class="token punctuation">,</span> engine<span class="token punctuation">,</span> runtime
    <span class="token keyword">return</span> avg_time

<span class="token comment"># 注意：需安装pycuda（pip install pycuda），且确保CUDA版本与TensorRT匹配</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. 先将蒸馏后的模型导出为ONNX</span>
    onnx_success <span class="token operator">=</span> export_yolo_to_onnx<span class="token punctuation">(</span>
        model_path<span class="token operator">=</span><span class="token string">"./runs/distillation_20240525_143022/best_distilled.pt"</span><span class="token punctuation">,</span>
        onnx_path<span class="token operator">=</span><span class="token string">"./battery_defect_yolov11_n.onnx"</span><span class="token punctuation">,</span>
        input_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">1</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> onnx_success<span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 2. 构建INT8精度TensorRT引擎（校准数据目录为增强后的训练集子集）</span>
    trt_engine_path <span class="token operator">=</span> build_tensorrt_engine<span class="token punctuation">(</span>
        onnx_path<span class="token operator">=</span><span class="token string">"./battery_defect_yolov11_n.onnx"</span><span class="token punctuation">,</span>
        trt_engine_path<span class="token operator">=</span><span class="token string">"./battery_defect_int8.trt"</span><span class="token punctuation">,</span>
        precision<span class="token operator">=</span><span class="token string">"int8"</span><span class="token punctuation">,</span>
        calib_data_dir<span class="token operator">=</span><span class="token string">"./battery_data/augmented_images_calib"</span><span class="token punctuation">,</span>  <span class="token comment"># 500张校准图像</span>
        input_size<span class="token operator">=</span><span class="token number">640</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最终TensorRT引擎路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>trt_engine_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             TensorRT量化结果示例
            </strong>
            （RTX 3080 GPU）：
           </p>
           <table>
            <thead>
             <tr>
              <th>
               模型格式
              </th>
              <th>
               精度模式
              </th>
              <th>
               推理速度（ms/帧）
              </th>
              <th>
               显存占用（MB）
              </th>
              <th>
               mAP@0.5
              </th>
              <th>
               模型体积（MB）
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               PyTorch（.pt）
              </td>
              <td>
               FP32
              </td>
              <td>
               28.5
              </td>
              <td>
               800
              </td>
              <td>
               96.8%
              </td>
              <td>
               12
              </td>
             </tr>
             <tr>
              <td>
               TensorRT（.trt）
              </td>
              <td>
               INT8
              </td>
              <td>
               18.2
              </td>
              <td>
               350
              </td>
              <td>
               96.2%
              </td>
              <td>
               4.2
              </td>
             </tr>
            </tbody>
           </table>
           <p>
            核心收获：INT8量化后，模型
            <strong>
             体积从12MB压缩至4.2MB（减少65%）
            </strong>
            ，推理速度从28.5ms降至18.2ms（提升1.6倍），显存占用从800MB降至350MB（减少56%），而mAP@0.5仅损失0.6%（96.8%→96.2%），完全满足产线“&lt;100ms/帧”和“7×24小时稳定运行”的需求。
           </p>
           <h3>
            <a id="_1619">
            </a>
            五、部署架构设计（工业级集成）
           </h3>
           <h4>
            <a id="51__1621">
            </a>
            5.1 产线级系统架构细化
           </h4>
           <p>
            工业部署需考虑“稳定性、可扩展性、可维护性”，采用“Docker容器化+FastAPI服务化+MES系统对接”的架构，具体如下：
           </p>
           <div class="mermaid">
            <svg class="mermaid-svg" height="1020" id="mermaid-svg-vkBMZwhcn11Znwpz" viewbox="0 0 1014.2109375 1020" width="1014.2109375" xmlns="http://www.w3.org/2000/svg">
             <style>
              #mermaid-svg-vkBMZwhcn11Znwpz {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-vkBMZwhcn11Znwpz .error-icon{fill:#552222;}#mermaid-svg-vkBMZwhcn11Znwpz .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-vkBMZwhcn11Znwpz .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-vkBMZwhcn11Znwpz .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-vkBMZwhcn11Znwpz .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-vkBMZwhcn11Znwpz .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-vkBMZwhcn11Znwpz .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-vkBMZwhcn11Znwpz .marker{fill:#333333;stroke:#333333;}#mermaid-svg-vkBMZwhcn11Znwpz .marker.cross{stroke:#333333;}#mermaid-svg-vkBMZwhcn11Znwpz svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-vkBMZwhcn11Znwpz .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-vkBMZwhcn11Znwpz .cluster-label text{fill:#333;}#mermaid-svg-vkBMZwhcn11Znwpz .cluster-label span{color:#333;}#mermaid-svg-vkBMZwhcn11Znwpz .label text,#mermaid-svg-vkBMZwhcn11Znwpz span{fill:#333;color:#333;}#mermaid-svg-vkBMZwhcn11Znwpz .node rect,#mermaid-svg-vkBMZwhcn11Znwpz .node circle,#mermaid-svg-vkBMZwhcn11Znwpz .node ellipse,#mermaid-svg-vkBMZwhcn11Znwpz .node polygon,#mermaid-svg-vkBMZwhcn11Znwpz .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-vkBMZwhcn11Znwpz .node .label{text-align:center;}#mermaid-svg-vkBMZwhcn11Znwpz .node.clickable{cursor:pointer;}#mermaid-svg-vkBMZwhcn11Znwpz .arrowheadPath{fill:#333333;}#mermaid-svg-vkBMZwhcn11Znwpz .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-vkBMZwhcn11Znwpz .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-vkBMZwhcn11Znwpz .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-vkBMZwhcn11Znwpz .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-vkBMZwhcn11Znwpz .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-vkBMZwhcn11Znwpz .cluster text{fill:#333;}#mermaid-svg-vkBMZwhcn11Znwpz .cluster span{color:#333;}#mermaid-svg-vkBMZwhcn11Znwpz div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-vkBMZwhcn11Znwpz :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
             </style>
             <g>
              <g class="output">
               <g class="clusters">
               </g>
               <g class="edgePaths">
                <g class="edgePath LS-A LE-A1" id="L-A-A1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead703" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-A1 LE-B" id="L-A1-B" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead704" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B LE-B1" id="L-B-B1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead705" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B1 LE-C" id="L-B1-C" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead706" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-C1" id="L-C-C1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead707" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C1 LE-C11" id="L-C1-C11" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead708" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-C2" id="L-C-C2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead709" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C2 LE-C21" id="L-C2-C21" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead710" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-C3" id="L-C-C3" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead711" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C3 LE-C31" id="L-C3-C31" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead712" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C1 LE-D" id="L-C1-D" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead713" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D LE-D1" id="L-D-D1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead714" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D LE-D2" id="L-D-D2" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead715" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-A1 LE-C11" id="L-A1-C11" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead716" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C11 LE-D1" id="L-C11-D1" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead717" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D1 LE-C11" id="L-D1-C11" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead718" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C11 LE-C21" id="L-C11-C21" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead719" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C11 LE-C31" id="L-C11-C31" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead720" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
               </g>
               <g class="edgeLabels">
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-A' L-LE-A1" id="L-L-A-A1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-A1' L-LE-B" id="L-L-A1-B">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B' L-LE-B1" id="L-L-B-B1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B1' L-LE-C" id="L-L-B1-C">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-C1" id="L-L-C-C1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C1' L-LE-C11" id="L-L-C1-C11">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-C2" id="L-L-C-C2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C2' L-LE-C21" id="L-L-C2-C21">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-C3" id="L-L-C-C3">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C3' L-LE-C31" id="L-L-C3-C31">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C1' L-LE-D" id="L-L-C1-D">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D' L-LE-D1" id="L-L-D-D1">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D' L-LE-D2" id="L-L-D-D2">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="translate(304.37890625,432)">
                 <g class="label" transform="translate(-30.5546875,-13)">
                  <rect height="26" rx="0" ry="0" width="61.109375">
                  </rect>
                  <foreignobject height="26" width="61.109375">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-A1' L-LE-C11" id="L-L-A1-C11">
                     UDP推流
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="translate(281.9296875,850)">
                 <g class="label" transform="translate(-32,-13)">
                  <rect height="26" rx="0" ry="0" width="64">
                  </rect>
                  <foreignobject height="26" width="64">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C11' L-LE-D1" id="L-L-C11-D1">
                     推理结果
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="translate(197.9296875,850)">
                 <g class="label" transform="translate(-32,-13)">
                  <rect height="26" rx="0" ry="0" width="64">
                  </rect>
                  <foreignobject height="26" width="64">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D1' L-LE-C11" id="L-L-D1-C11">
                     产线信号
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="translate(541.50390625,850)">
                 <g class="label" transform="translate(-32,-13)">
                  <rect height="26" rx="0" ry="0" width="64">
                  </rect>
                  <foreignobject height="26" width="64">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C11' L-LE-C21" id="L-L-C11-C21">
                     监控数据
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="translate(791.4765625,850)">
                 <g class="label" transform="translate(-32,-13)">
                  <rect height="26" rx="0" ry="0" width="64">
                  </rect>
                  <foreignobject height="26" width="64">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C11' L-LE-C31" id="L-L-C11-C31">
                     日志数据
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
               </g>
               <g class="nodes">
                <g class="node default" id="flowchart-A-516" style="opacity: 1;" transform="translate(562.93359375,31)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-32,-13)">
                   <foreignobject height="26" width="64">
                    <div style="display: inline-block; white-space: nowrap;">
                     工业相机
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-A1-517" style="opacity: 1;" transform="translate(562.93359375,140)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="198.453125" x="-99.2265625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-89.2265625,-26)">
                   <foreignobject height="52" width="178.453125">
                    <div style="display: inline-block; white-space: nowrap;">
                     海康威视MV-CA020-10GM
                     <br/>
                     (200万像素，千兆网)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-B-519" style="opacity: 1;" transform="translate(705.02734375,249)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-40,-13)">
                   <foreignobject height="26" width="80">
                    <div style="display: inline-block; white-space: nowrap;">
                     产线工控机
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-B1-521" style="opacity: 1;" transform="translate(705.02734375,358)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="317.328125" x="-158.6640625" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-148.6640625,-26)">
                   <foreignobject height="52" width="297.328125">
                    <div style="display: inline-block; white-space: nowrap;">
                     硬件配置
                     <br/>
                     Xeon E5-2680 v4 + RTX 3080 + 32GB DDR4
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C-523" style="opacity: 1;" transform="translate(705.02734375,493)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="68" x="-34" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-24,-13)">
                   <foreignobject height="26" width="48">
                    <div style="display: inline-block; white-space: nowrap;">
                     软件层
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C1-525" style="opacity: 1;" transform="translate(496.45703125,602)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="214.1875" x="-107.09375" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-97.09375,-26)">
                   <foreignobject height="52" width="194.1875">
                    <div style="display: inline-block; white-space: nowrap;">
                     Docker容器1：推理服务
                     <br/>
                     (Python+TensorRT+FastAPI)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C11-527" style="opacity: 1;" transform="translate(458.828125,750)">
                 <rect class="label-container" height="124" rx="0" ry="0" width="126.6875" x="-63.34375" y="-62">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-53.34375,-52)">
                   <foreignobject height="104" width="106.6875">
                    <div style="display: inline-block; white-space: nowrap;">
                     核心功能
                     <br/>
                     - 图像接收
                     <br/>
                     - TensorRT推理
                     <br/>
                     - 结果输出
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C2-529" style="opacity: 1;" transform="translate(671.609375,750)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="189.734375" x="-94.8671875" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-84.8671875,-26)">
                   <foreignobject height="52" width="169.734375">
                    <div style="display: inline-block; white-space: nowrap;">
                     Docker容器2：监控服务
                     <br/>
                     (Prometheus+Grafana)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C21-531" style="opacity: 1;" transform="translate(645.609375,950)">
                 <rect class="label-container" height="124" rx="0" ry="0" width="151.09375" x="-75.546875" y="-62">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-65.546875,-52)">
                   <foreignobject height="104" width="131.09375">
                    <div style="display: inline-block; white-space: nowrap;">
                     监控指标
                     <br/>
                     - GPU内存/利用率
                     <br/>
                     - 推理延迟/吞吐量
                     <br/>
                     - 缺陷检测准确率
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C3-533" style="opacity: 1;" transform="translate(911.34375,750)">
                 <rect class="label-container" height="72" rx="0" ry="0" width="189.734375" x="-94.8671875" y="-36">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-84.8671875,-26)">
                   <foreignobject height="52" width="169.734375">
                    <div style="display: inline-block; white-space: nowrap;">
                     Docker容器3：日志服务
                     <br/>
                     (ELK Stack)
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C31-535" style="opacity: 1;" transform="translate(911.34375,950)">
                 <rect class="label-container" height="124" rx="0" ry="0" width="126.703125" x="-63.3515625" y="-62">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-53.3515625,-52)">
                   <foreignobject height="104" width="106.703125">
                    <div style="display: inline-block; white-space: nowrap;">
                     日志类型
                     <br/>
                     - 推理错误日志
                     <br/>
                     - 系统异常日志
                     <br/>
                     - 检测结果日志
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D-537" style="opacity: 1;" transform="translate(173.83203125,750)">
                 <rect class="label-container" height="46" rx="0" ry="0" width="111.625" x="-55.8125" y="-23">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-45.8125,-13)">
                   <foreignobject height="26" width="91.625">
                    <div style="display: inline-block; white-space: nowrap;">
                     MES系统对接
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D1-539" style="opacity: 1;" transform="translate(332.25,950)">
                 <rect class="label-container" height="98" rx="0" ry="0" width="231.09375" x="-115.546875" y="-49">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-105.546875,-39)">
                   <foreignobject height="78" width="211.09375">
                    <div style="display: inline-block; white-space: nowrap;">
                     对接方式：HTTP API
                     <br/>
                     - 发送缺陷结果（坐标/类型）
                     <br/>
                     - 接收产线启停信号
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D2-541" style="opacity: 1;" transform="translate(87.3515625,950)">
                 <rect class="label-container" height="124" rx="0" ry="0" width="158.703125" x="-79.3515625" y="-62">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-69.3515625,-52)">
                   <foreignobject height="104" width="138.703125">
                    <div style="display: inline-block; white-space: nowrap;">
                     产线业务逻辑
                     <br/>
                     - 缺陷产品自动分拣
                     <br/>
                     - 质检报告自动生成
                     <br/>
                     - 异常实时告警
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
               </g>
              </g>
             </g>
            </svg>
           </div>
           <h4>
            <a id="52_FastAPITensorRT_1654">
            </a>
            5.2 推理服务封装（FastAPI+TensorRT）
           </h4>
           <p>
            将TensorRT引擎封装为HTTP API服务，便于产线其他系统调用，同时支持并发请求和结果缓存：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> UploadFile<span class="token punctuation">,</span> File<span class="token punctuation">,</span> HTTPException
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>cors <span class="token keyword">import</span> CORSMiddleware
<span class="token keyword">import</span> uvicorn
<span class="token keyword">import</span> tensorrt <span class="token keyword">as</span> trt
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cuda
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> logging

<span class="token comment"># 1. 初始化FastAPI应用</span>
app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">"锂电池表面缺陷检测API"</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token string">"1.0.0"</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"工业级缺陷检测服务，支持单图/批量检测"</span><span class="token punctuation">)</span>

<span class="token comment"># 2. 配置跨域（允许MES系统调用）</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 生产环境需改为MES系统IP</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    allow_methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 3. 配置日志</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>
    level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>
    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span><span class="token punctuation">,</span>
    handlers<span class="token operator">=</span><span class="token punctuation">[</span>logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">"inference_service.log"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">"battery_defect_service"</span><span class="token punctuation">)</span>

<span class="token comment"># 4. 全局变量（TensorRT引擎、预处理参数）</span>
TRT_ENGINE_PATH <span class="token operator">=</span> <span class="token string">"./battery_defect_int8.trt"</span>
INPUT_SIZE <span class="token operator">=</span> <span class="token number">640</span>
DEFECT_CLASSES <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"scratch"</span><span class="token punctuation">,</span> <span class="token string">"dent"</span><span class="token punctuation">,</span> <span class="token string">"contamination"</span><span class="token punctuation">,</span> <span class="token string">"bubble"</span><span class="token punctuation">,</span> <span class="token string">"missing_coating"</span><span class="token punctuation">,</span> <span class="token string">"foreign_object"</span><span class="token punctuation">]</span>
<span class="token comment"># 预处理参数（与训练一致）</span>
MEAN <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span>
STD <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>

<span class="token comment"># 5. 加载TensorRT引擎（服务启动时加载，避免重复加载耗时）</span>
<span class="token keyword">def</span> <span class="token function">load_trt_engine</span><span class="token punctuation">(</span>engine_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    TRT_LOGGER <span class="token operator">=</span> trt<span class="token punctuation">.</span>Logger<span class="token punctuation">(</span>trt<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span>WARNING<span class="token punctuation">)</span>
    runtime <span class="token operator">=</span> trt<span class="token punctuation">.</span>Runtime<span class="token punctuation">(</span>TRT_LOGGER<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>engine_path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            engine <span class="token operator">=</span> runtime<span class="token punctuation">.</span>deserialize_cuda_engine<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        context <span class="token operator">=</span> engine<span class="token punctuation">.</span>create_execution_context<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ TensorRT引擎加载成功：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>engine_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> engine<span class="token punctuation">,</span> context<span class="token punctuation">,</span> runtime
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ TensorRT引擎加载失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"TensorRT引擎加载失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 加载引擎（全局唯一）</span>
engine<span class="token punctuation">,</span> context<span class="token punctuation">,</span> runtime <span class="token operator">=</span> load_trt_engine<span class="token punctuation">(</span>TRT_ENGINE_PATH<span class="token punctuation">)</span>

<span class="token comment"># 6. 预处理函数（与训练/量化一致）</span>
<span class="token keyword">def</span> <span class="token function">preprocess_image</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""将输入图像预处理为TensorRT引擎所需格式（NCHW，FP32，标准化）"""</span>
    <span class="token comment"># BGR→RGB</span>
    image_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
    <span class="token comment"># 保存原始尺寸（用于后续坐标还原）</span>
    original_h<span class="token punctuation">,</span> original_w <span class="token operator">=</span> image_rgb<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token comment"># Resize（保持长宽比，补黑边至INPUT_SIZE）</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>INPUT_SIZE <span class="token operator">/</span> original_w<span class="token punctuation">,</span> INPUT_SIZE <span class="token operator">/</span> original_h<span class="token punctuation">)</span>
    new_w<span class="token punctuation">,</span> new_h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>original_w <span class="token operator">*</span> scale<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>original_h <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    image_resized <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image_rgb<span class="token punctuation">,</span> <span class="token punctuation">(</span>new_w<span class="token punctuation">,</span> new_h<span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>
    <span class="token comment"># 补黑边</span>
    pad_left <span class="token operator">=</span> <span class="token punctuation">(</span>INPUT_SIZE <span class="token operator">-</span> new_w<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
    pad_top <span class="token operator">=</span> <span class="token punctuation">(</span>INPUT_SIZE <span class="token operator">-</span> new_h<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
    image_padded <span class="token operator">=</span> cv2<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>
        image_resized<span class="token punctuation">,</span> pad_top<span class="token punctuation">,</span> INPUT_SIZE <span class="token operator">-</span> new_h <span class="token operator">-</span> pad_top<span class="token punctuation">,</span>
        pad_left<span class="token punctuation">,</span> INPUT_SIZE <span class="token operator">-</span> new_w <span class="token operator">-</span> pad_left<span class="token punctuation">,</span>
        cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># 标准化</span>
    image_normalized <span class="token operator">=</span> image_padded <span class="token operator">/</span> <span class="token number">255.0</span>
    image_normalized <span class="token operator">=</span> <span class="token punctuation">(</span>image_normalized <span class="token operator">-</span> MEAN<span class="token punctuation">)</span> <span class="token operator">/</span> STD
    <span class="token comment"># HWC→CHW→NCHW，转为FP32</span>
    image_transposed <span class="token operator">=</span> image_normalized<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    image_input <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>image_transposed<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 返回预处理结果和还原参数（用于后处理）</span>
    <span class="token keyword">return</span> image_input<span class="token punctuation">,</span> <span class="token punctuation">(</span>original_w<span class="token punctuation">,</span> original_h<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> pad_left<span class="token punctuation">,</span> pad_top<span class="token punctuation">)</span>

<span class="token comment"># 7. 后处理函数（解析TensorRT输出，还原缺陷坐标）</span>
<span class="token keyword">def</span> <span class="token function">postprocess_output</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> original_w<span class="token punctuation">,</span> original_h<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> pad_left<span class="token punctuation">,</span> pad_top<span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    解析TensorRT输出（shape=(1,8400,8)），返回缺陷检测结果
    输出格式：[{"class": "scratch", "confidence": 0.92, "x1": 100, "y1": 200, "x2": 150, "y2": 250}, ...]
    """</span>
    <span class="token comment"># 提取输出（去除批次维度）</span>
    preds <span class="token operator">=</span> output<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># shape=(8400,8)</span>
    <span class="token comment"># 解析坐标、置信度、类别</span>
    xywh <span class="token operator">=</span> preds<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>    <span class="token comment"># 中心x,y + 宽w,高h（归一化到INPUT_SIZE）</span>
    conf <span class="token operator">=</span> preds<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>     <span class="token comment"># 置信度</span>
    cls_idx <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>preds<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 缺陷类别索引</span>

    <span class="token comment"># 过滤低置信度框</span>
    mask <span class="token operator">=</span> conf <span class="token operator">&gt;=</span> conf_thres
    xywh <span class="token operator">=</span> xywh<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
    conf <span class="token operator">=</span> conf<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
    cls_idx <span class="token operator">=</span> cls_idx<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>xywh<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 无缺陷</span>

    <span class="token comment"># 坐标还原：INPUT_SIZE归一化→INPUT_SIZE像素→原始图像像素</span>
    <span class="token comment"># 1. 归一化→INPUT_SIZE像素</span>
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> INPUT_SIZE  <span class="token comment"># 中心x</span>
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> INPUT_SIZE  <span class="token comment"># 中心y</span>
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*=</span> INPUT_SIZE  <span class="token comment"># 宽</span>
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*=</span> INPUT_SIZE  <span class="token comment"># 高</span>
    <span class="token comment"># 2. 去除补边偏移</span>
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-=</span> pad_left
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-=</span> pad_top
    <span class="token comment"># 3. INPUT_SIZE→原始图像尺寸（除以缩放比例）</span>
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/=</span> scale
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/=</span> scale
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/=</span> scale
    xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/=</span> scale

    <span class="token comment"># 转为xyxy格式（左上角x1,y1，右下角x2,y2）</span>
    xyxy <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>xywh<span class="token punctuation">)</span>
    xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>  <span class="token comment"># x1</span>
    xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>  <span class="token comment"># y1</span>
    xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>  <span class="token comment"># x2</span>
    xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> xywh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>  <span class="token comment"># y2</span>

    <span class="token comment"># 边界框裁剪（避免超出原始图像范围）</span>
    xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> original_w<span class="token punctuation">)</span>
    xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> original_h<span class="token punctuation">)</span>
    xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> original_w<span class="token punctuation">)</span>
    xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>xyxy<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> original_h<span class="token punctuation">)</span>

    <span class="token comment"># NMS（非极大值抑制，去除重复框）</span>
    indices <span class="token operator">=</span> nms<span class="token punctuation">(</span>xyxy<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># 整理结果</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> idx <span class="token keyword">in</span> indices<span class="token punctuation">:</span>
        x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> xyxy<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
        results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"defect_class"</span><span class="token punctuation">:</span> DEFECT_CLASSES<span class="token punctuation">[</span>cls_idx<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"confidence"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>conf<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"x1"</span><span class="token punctuation">:</span> x1<span class="token punctuation">,</span>
            <span class="token string">"y1"</span><span class="token punctuation">:</span> y1<span class="token punctuation">,</span>
            <span class="token string">"x2"</span><span class="token punctuation">:</span> x2<span class="token punctuation">,</span>
            <span class="token string">"y2"</span><span class="token punctuation">:</span> y2<span class="token punctuation">,</span>
            <span class="token string">"defect_area"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span>  <span class="token comment"># 缺陷面积（像素²）</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> results

<span class="token keyword">def</span> <span class="token function">nms</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""非极大值抑制（NMS）实现"""</span>
    <span class="token comment"># 按置信度降序排序</span>
    order <span class="token operator">=</span> scores<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    boxes <span class="token operator">=</span> boxes<span class="token punctuation">[</span>order<span class="token punctuation">]</span>
    iou_matrix <span class="token operator">=</span> calculate_iou_matrix<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> order<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment"># 保留置信度最高的框</span>
        i <span class="token operator">=</span> order<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        keep<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token comment"># 计算当前框与其他框的IOU，过滤IOU&gt;阈值的框</span>
        iou <span class="token operator">=</span> iou_matrix<span class="token punctuation">[</span>i<span class="token punctuation">,</span> order<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        inds <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>iou <span class="token operator">&lt;=</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        order <span class="token operator">=</span> order<span class="token punctuation">[</span>inds <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 跳过已过滤的框</span>

    <span class="token comment"># 还原原始索引（因之前按置信度排序）</span>
    keep <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>keep<span class="token punctuation">)</span>
    <span class="token keyword">return</span> order<span class="token punctuation">[</span>keep<span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>keep<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">calculate_iou_matrix</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""计算所有边界框之间的IOU矩阵"""</span>
    n <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>
    iou_matrix <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x1i<span class="token punctuation">,</span> y1i<span class="token punctuation">,</span> x2i<span class="token punctuation">,</span> y2i <span class="token operator">=</span> boxes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        area_i <span class="token operator">=</span> <span class="token punctuation">(</span>x2i <span class="token operator">-</span> x1i<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2i <span class="token operator">-</span> y1i<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x1j<span class="token punctuation">,</span> y1j<span class="token punctuation">,</span> x2j<span class="token punctuation">,</span> y2j <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            area_j <span class="token operator">=</span> <span class="token punctuation">(</span>x2j <span class="token operator">-</span> x1j<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2j <span class="token operator">-</span> y1j<span class="token punctuation">)</span>
            <span class="token comment"># 计算交集</span>
            x1 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>x1i<span class="token punctuation">,</span> x1j<span class="token punctuation">)</span>
            y1 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>y1i<span class="token punctuation">,</span> y1j<span class="token punctuation">)</span>
            x2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>x2i<span class="token punctuation">,</span> x2j<span class="token punctuation">)</span>
            y2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>y2i<span class="token punctuation">,</span> y2j<span class="token punctuation">)</span>
            inter_w <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span>
            inter_h <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span>
            inter_area <span class="token operator">=</span> inter_w <span class="token operator">*</span> inter_h
            <span class="token comment"># 计算IOU</span>
            iou <span class="token operator">=</span> inter_area <span class="token operator">/</span> <span class="token punctuation">(</span>area_i <span class="token operator">+</span> area_j <span class="token operator">-</span> inter_area<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>area_i <span class="token operator">+</span> area_j <span class="token operator">-</span> inter_area<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
            iou_matrix<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> iou
    <span class="token keyword">return</span> iou_matrix

<span class="token comment"># 8. 单图检测API接口</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/detect/single"</span><span class="token punctuation">,</span> summary<span class="token operator">=</span><span class="token string">"单张图像缺陷检测"</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"输入单张锂电池图像，返回缺陷检测结果"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">detect_single</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"锂电池表面图像（JPG格式）"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 记录请求时间</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"收到单图检测请求：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 1. 读取上传图像</span>
        contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        nparr <span class="token operator">=</span> np<span class="token punctuation">.</span>frombuffer<span class="token punctuation">(</span>contents<span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imdecode<span class="token punctuation">(</span>nparr<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>IMREAD_COLOR<span class="token punctuation">)</span>
        <span class="token keyword">if</span> image <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"图像解码失败，请上传JPG格式图像"</span><span class="token punctuation">)</span>

        <span class="token comment"># 2. 预处理</span>
        preprocess_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        image_input<span class="token punctuation">,</span> <span class="token punctuation">(</span>original_w<span class="token punctuation">,</span> original_h<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> pad_left<span class="token punctuation">,</span> pad_top<span class="token punctuation">)</span> <span class="token operator">=</span> preprocess_image<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        preprocess_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> preprocess_start<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>

        <span class="token comment"># 3. TensorRT推理</span>
        inference_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 分配GPU内存并复制输入数据</span>
        input_mem <span class="token operator">=</span> cuda<span class="token punctuation">.</span>mem_alloc<span class="token punctuation">(</span>image_input<span class="token punctuation">.</span>nbytes<span class="token punctuation">)</span>
        cuda<span class="token punctuation">.</span>memcpy_htod<span class="token punctuation">(</span>input_mem<span class="token punctuation">,</span> image_input<span class="token punctuation">)</span>
        <span class="token comment"># 分配输出内存（shape=(1,8400,8)，float32=4字节）</span>
        output_mem <span class="token operator">=</span> cuda<span class="token punctuation">.</span>mem_alloc<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">8400</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 执行推理</span>
        context<span class="token punctuation">.</span>execute_v2<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>input_mem<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output_mem<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 从GPU复制输出数据到CPU</span>
        output <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8400</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        cuda<span class="token punctuation">.</span>memcpy_dtoh<span class="token punctuation">(</span>output<span class="token punctuation">,</span> output_mem<span class="token punctuation">)</span>
        <span class="token comment"># 释放GPU内存</span>
        <span class="token keyword">del</span> input_mem<span class="token punctuation">,</span> output_mem
        inference_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> inference_start<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>

        <span class="token comment"># 4. 后处理</span>
        postprocess_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        results <span class="token operator">=</span> postprocess_output<span class="token punctuation">(</span>output<span class="token punctuation">,</span> original_w<span class="token punctuation">,</span> original_h<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> pad_left<span class="token punctuation">,</span> pad_top<span class="token punctuation">)</span>
        postprocess_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> postprocess_start<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>

        <span class="token comment"># 5. 计算总耗时</span>
        total_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>

        <span class="token comment"># 6. 记录日志</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"单图检测完成：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">}</span></span><span class="token string"> | 缺陷数：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> | "</span></span>
                    <span class="token string-interpolation"><span class="token string">f"预处理：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>preprocess_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms | 推理：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>inference_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms | 后处理：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>postprocess_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms | 总耗时：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>total_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 7. 返回结果</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>
            <span class="token string">"request_id"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"req_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d%H%M%S%f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">-3]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
            <span class="token string">"original_size"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"width"</span><span class="token punctuation">:</span> original_w<span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">:</span> original_h<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"defect_count"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"defects"</span><span class="token punctuation">:</span> results<span class="token punctuation">,</span>
            <span class="token string">"performance"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"preprocess_ms"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>preprocess_time<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"inference_ms"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>inference_time<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"postprocess_ms"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>postprocess_time<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"total_ms"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>total_time<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        error_msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"单图检测失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> detail<span class="token operator">=</span>error_msg<span class="token punctuation">)</span>

<span class="token comment"># 9. 批量检测API接口（支持多图并发）</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/detect/batch"</span><span class="token punctuation">,</span> summary<span class="token operator">=</span><span class="token string">"批量图像缺陷检测"</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"输入多张锂电池图像，返回批量检测结果"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">detect_batch</span><span class="token punctuation">(</span>files<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>UploadFile<span class="token punctuation">]</span> <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"锂电池表面图像列表（JPG格式，最多10张）"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"批量检测最多支持10张图像"</span><span class="token punctuation">)</span>

    batch_results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"收到批量检测请求：共</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">张图像"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 读取图像</span>
            contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            nparr <span class="token operator">=</span> np<span class="token punctuation">.</span>frombuffer<span class="token punctuation">(</span>contents<span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
            image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imdecode<span class="token punctuation">(</span>nparr<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>IMREAD_COLOR<span class="token punctuation">)</span>
            <span class="token keyword">if</span> image <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                batch_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
                    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"failed"</span><span class="token punctuation">,</span>
                    <span class="token string">"reason"</span><span class="token punctuation">:</span> <span class="token string">"图像解码失败"</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

            <span class="token comment"># 预处理</span>
            image_input<span class="token punctuation">,</span> <span class="token punctuation">(</span>original_w<span class="token punctuation">,</span> original_h<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> pad_left<span class="token punctuation">,</span> pad_top<span class="token punctuation">)</span> <span class="token operator">=</span> preprocess_image<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

            <span class="token comment"># 推理</span>
            input_mem <span class="token operator">=</span> cuda<span class="token punctuation">.</span>mem_alloc<span class="token punctuation">(</span>image_input<span class="token punctuation">.</span>nbytes<span class="token punctuation">)</span>
            cuda<span class="token punctuation">.</span>memcpy_htod<span class="token punctuation">(</span>input_mem<span class="token punctuation">,</span> image_input<span class="token punctuation">)</span>
            output_mem <span class="token operator">=</span> cuda<span class="token punctuation">.</span>mem_alloc<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">8400</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            context<span class="token punctuation">.</span>execute_v2<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>input_mem<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output_mem<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            output <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8400</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
            cuda<span class="token punctuation">.</span>memcpy_dtoh<span class="token punctuation">(</span>output<span class="token punctuation">,</span> output_mem<span class="token punctuation">)</span>
            <span class="token keyword">del</span> input_mem<span class="token punctuation">,</span> output_mem

            <span class="token comment"># 后处理</span>
            results <span class="token operator">=</span> postprocess_output<span class="token punctuation">(</span>output<span class="token punctuation">,</span> original_w<span class="token punctuation">,</span> original_h<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> pad_left<span class="token punctuation">,</span> pad_top<span class="token punctuation">)</span>

            <span class="token comment"># 记录单图结果</span>
            batch_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
                <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>
                <span class="token string">"original_size"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"width"</span><span class="token punctuation">:</span> original_w<span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">:</span> original_h<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"defect_count"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"defects"</span><span class="token punctuation">:</span> results
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            error_msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"检测失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"批量检测单图错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">}</span></span><span class="token string"> | </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>error_msg<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            batch_results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
                <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"failed"</span><span class="token punctuation">,</span>
                <span class="token string">"reason"</span><span class="token punctuation">:</span> error_msg
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment"># 计算批量总耗时</span>
    total_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"批量检测完成：共</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">张 | 成功</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">for</span> res <span class="token keyword">in</span> batch_results <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">张 | 总耗时：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>total_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>
        <span class="token string">"request_id"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"batch_req_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d%H%M%S%f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">-3]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token string">"batch_count"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"success_count"</span><span class="token punctuation">:</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">for</span> res <span class="token keyword">in</span> batch_results <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"failed_count"</span><span class="token punctuation">:</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">for</span> res <span class="token keyword">in</span> batch_results <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'failed'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"total_ms"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>total_time<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"results"</span><span class="token punctuation">:</span> batch_results
    <span class="token punctuation">}</span>

<span class="token comment"># 10. 服务健康检查接口</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/health"</span><span class="token punctuation">,</span> summary<span class="token operator">=</span><span class="token string">"服务健康检查"</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"检查推理服务是否正常运行"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">health_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 测试TensorRT引擎是否可用（执行一次空推理）</span>
        test_input <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> INPUT_SIZE<span class="token punctuation">,</span> INPUT_SIZE<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        input_mem <span class="token operator">=</span> cuda<span class="token punctuation">.</span>mem_alloc<span class="token punctuation">(</span>test_input<span class="token punctuation">.</span>nbytes<span class="token punctuation">)</span>
        output_mem <span class="token operator">=</span> cuda<span class="token punctuation">.</span>mem_alloc<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">8400</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cuda<span class="token punctuation">.</span>memcpy_htod<span class="token punctuation">(</span>input_mem<span class="token punctuation">,</span> test_input<span class="token punctuation">)</span>
        context<span class="token punctuation">.</span>execute_v2<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>input_mem<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output_mem<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">del</span> input_mem<span class="token punctuation">,</span> output_mem

        <span class="token comment"># 检查GPU状态</span>
        <span class="token keyword">import</span> pynvml
        pynvml<span class="token punctuation">.</span>nvmlInit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        handle <span class="token operator">=</span> pynvml<span class="token punctuation">.</span>nvmlDeviceGetHandleByIndex<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        gpu_mem <span class="token operator">=</span> pynvml<span class="token punctuation">.</span>nvmlDeviceGetMemoryInfo<span class="token punctuation">(</span>handle<span class="token punctuation">)</span>
        gpu_util <span class="token operator">=</span> pynvml<span class="token punctuation">.</span>nvmlDeviceGetUtilizationRates<span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">.</span>gpu
        pynvml<span class="token punctuation">.</span>nvmlShutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"healthy"</span><span class="token punctuation">,</span>
            <span class="token string">"service_name"</span><span class="token punctuation">:</span> <span class="token string">"battery_defect_detection"</span><span class="token punctuation">,</span>
            <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"tensorrt_engine"</span><span class="token punctuation">:</span> <span class="token string">"loaded"</span><span class="token punctuation">,</span>
            <span class="token string">"gpu_status"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"memory_used"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>gpu_mem<span class="token punctuation">.</span>used<span class="token operator">/</span><span class="token number">1024</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token format-spec">.0f</span><span class="token punctuation">}</span></span><span class="token string">MB"</span></span><span class="token punctuation">,</span>
                <span class="token string">"memory_total"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>gpu_mem<span class="token punctuation">.</span>total<span class="token operator">/</span><span class="token number">1024</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token format-spec">.0f</span><span class="token punctuation">}</span></span><span class="token string">MB"</span></span><span class="token punctuation">,</span>
                <span class="token string">"utilization"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>gpu_util<span class="token punctuation">}</span></span><span class="token string">%"</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        error_msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"服务异常：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"unhealthy"</span><span class="token punctuation">,</span>
            <span class="token string">"reason"</span><span class="token punctuation">:</span> error_msg<span class="token punctuation">,</span>
            <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

<span class="token comment"># 11. 启动服务（生产环境建议用Gunicorn+Uvicorn）</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"🚀 锂电池表面缺陷检测服务启动中..."</span><span class="token punctuation">)</span>
    <span class="token comment"># 生产环境配置：workers=4（CPU核心数的1-2倍），port=8000</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
        app<span class="token operator">=</span><span class="token string">"battery_defect_service:app"</span><span class="token punctuation">,</span>
        host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span>
        port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">,</span>
        workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token builtin">reload</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># 生产环境禁用reload</span>
        log_level<span class="token operator">=</span><span class="token string">"info"</span>
    <span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             API调用示例（Postman）
            </strong>
            ：
           </p>
           <ol>
            <li>
             <p>
              单图检测：
             </p>
             <ul>
              <li>
               <p>
                请求URL：
                <code>
                 http://192.168.1.100:8000/detect/single
                </code>
               </p>
              </li>
              <li>
               <p>
                请求方法：POST
               </p>
              </li>
              <li>
               <p>
                请求体：form-data，key=file，value=选择JPG图像
               </p>
              </li>
              <li>
               <p>
                成功响应（示例）：
               </p>
               <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"status"</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>
    <span class="token string">"request_id"</span><span class="token operator">:</span> <span class="token string">"req_20240526103025123"</span><span class="token punctuation">,</span>
    <span class="token string">"filename"</span><span class="token operator">:</span> <span class="token string">"battery_001.jpg"</span><span class="token punctuation">,</span>
    <span class="token string">"original_size"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"width"</span><span class="token operator">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token operator">:</span> <span class="token number">1080</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"defect_count"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token string">"defects"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"defect_class"</span><span class="token operator">:</span> <span class="token string">"scratch"</span><span class="token punctuation">,</span>
            <span class="token string">"confidence"</span><span class="token operator">:</span> <span class="token number">0.9456</span><span class="token punctuation">,</span>
            <span class="token string">"x1"</span><span class="token operator">:</span> <span class="token number">520</span><span class="token punctuation">,</span>
            <span class="token string">"y1"</span><span class="token operator">:</span> <span class="token number">380</span><span class="token punctuation">,</span>
            <span class="token string">"x2"</span><span class="token operator">:</span> <span class="token number">680</span><span class="token punctuation">,</span>
            <span class="token string">"y2"</span><span class="token operator">:</span> <span class="token number">410</span><span class="token punctuation">,</span>
            <span class="token string">"defect_area"</span><span class="token operator">:</span> <span class="token number">4800</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"defect_class"</span><span class="token operator">:</span> <span class="token string">"contamination"</span><span class="token punctuation">,</span>
            <span class="token string">"confidence"</span><span class="token operator">:</span> <span class="token number">0.8723</span><span class="token punctuation">,</span>
            <span class="token string">"x1"</span><span class="token operator">:</span> <span class="token number">1200</span><span class="token punctuation">,</span>
            <span class="token string">"y1"</span><span class="token operator">:</span> <span class="token number">520</span><span class="token punctuation">,</span>
            <span class="token string">"x2"</span><span class="token operator">:</span> <span class="token number">1250</span><span class="token punctuation">,</span>
            <span class="token string">"y2"</span><span class="token operator">:</span> <span class="token number">570</span><span class="token punctuation">,</span>
            <span class="token string">"defect_area"</span><span class="token operator">:</span> <span class="token number">2500</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"performance"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"preprocess_ms"</span><span class="token operator">:</span> <span class="token number">2.1</span><span class="token punctuation">,</span>
        <span class="token string">"inference_ms"</span><span class="token operator">:</span> <span class="token number">18.3</span><span class="token punctuation">,</span>
        <span class="token string">"postprocess_ms"</span><span class="token operator">:</span> <span class="token number">1.2</span><span class="token punctuation">,</span>
        <span class="token string">"total_ms"</span><span class="token operator">:</span> <span class="token number">21.6</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
              </li>
             </ul>
            </li>
            <li>
             <p>
              健康检查：
             </p>
             <ul>
              <li>
               <p>
                请求URL：
                <code>
                 http://192.168.1.100:8000/health
                </code>
               </p>
              </li>
              <li>
               <p>
                请求方法：GET
               </p>
              </li>
              <li>
               <p>
                成功响应（示例）：
               </p>
               <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"status"</span><span class="token operator">:</span> <span class="token string">"healthy"</span><span class="token punctuation">,</span>
    <span class="token string">"service_name"</span><span class="token operator">:</span> <span class="token string">"battery_defect_detection"</span><span class="token punctuation">,</span>
    <span class="token string">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2024-05-26T10:35:42.123456"</span><span class="token punctuation">,</span>
    <span class="token string">"tensorrt_engine"</span><span class="token operator">:</span> <span class="token string">"loaded"</span><span class="token punctuation">,</span>
    <span class="token string">"gpu_status"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"memory_used"</span><span class="token operator">:</span> <span class="token string">"380MB"</span><span class="token punctuation">,</span>
        <span class="token string">"memory_total"</span><span class="token operator">:</span> <span class="token string">"10240MB"</span><span class="token punctuation">,</span>
        <span class="token string">"utilization"</span><span class="token operator">:</span> <span class="token string">"15%"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
              </li>
             </ul>
            </li>
           </ol>
           <h4>
            <a id="53_Docker_2122">
            </a>
            5.3 Docker容器化部署（确保环境一致性）
           </h4>
           <p>
            为避免“开发环境能跑，生产环境报错”的问题，采用Docker容器化部署，完整
            <code>
             Dockerfile
            </code>
            如下：
           </p>
           <pre><code class="prism language-dockerfile"># 基础镜像：Ubuntu 20.04 + CUDA 11.6 + CuDNN 8（匹配TensorRT 8.6）
FROM nvidia/cuda:11.6.2-cudnn8-runtime-ubuntu20.04

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
    python3-pip \
    python3-dev \
    build-essential \
    libopencv-dev \
    libboost-all-dev \
    git \
    wget \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# 安装Python依赖（指定版本，避免兼容性问题）
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# 安装TensorRT 8.6.1（与CUDA 11.6匹配）
RUN wget https://developer.nvidia.com/downloads/compute/machine-learning/tensorrt/secure/8.6.1/tars/tensorrt-8.6.1.6.linux.x86_64-gnu.cuda-11.6.tar.gz \
    &amp;&amp; tar -xzvf tensorrt-8.6.1.6.linux.x86_64-gnu.cuda-11.6.tar.gz \
    &amp;&amp; cp -r TensorRT-8.6.1.6/lib/* /usr/lib/x86_64-linux-gnu/ \
    &amp;&amp; cp -r TensorRT-8.6.1.6/include/* /usr/include/ \
    &amp;&amp; pip3 install TensorRT-8.6.1.6/python/tensorrt-8.6.1-cp38-none-linux_x86_64.whl \
    &amp;&amp; rm -rf tensorrt-8.6.1.6.linux.x86_64-gnu.cuda-11.6.tar.gz TensorRT-8.6.1.6

# 安装pycuda（需提前安装CUDA工具链）
RUN pip3 install pycuda==2022.2.2

# 复制服务代码和模型文件
COPY battery_defect_service.py .
COPY battery_defect_int8.trt .
COPY int8_calib.cache .  # 校准缓存（可选，避免重新校准）

# 暴露API端口
EXPOSE 8000

# 设置环境变量（CUDA路径）
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
ENV CUDA_DEVICE_ORDER=PCI_BUS_ID

# 启动服务（用Gunicorn管理Uvicorn进程，支持多worker）
CMD ["gunicorn", "--workers", "4", "--bind", "0.0.0.0:8000", "-k", "uvicorn.workers.UvicornWorker", "battery_defect_service:app"]
</code></pre>
           <p>
            <code>
             requirements.txt
            </code>
            文件内容（指定版本，确保稳定性）：
           </p>
           <pre><code>fastapi==0.104.1
uvicorn==0.24.0
gunicorn==21.2.0
numpy==1.24.3
opencv-python==4.8.1.78
torch==1.13.1+cu116
torchvision==0.14.1+cu116
ultralytics==8.0.200
pynvml==11.5.0
python-multipart==0.0.6
</code></pre>
           <p>
            <strong>
             Docker部署步骤
            </strong>
            ：
           </p>
           <ol>
            <li>
             构建镜像：
             <br/>
             <code>
              docker build -t battery-defect-detection:v1.0 .
             </code>
            </li>
            <li>
             启动容器（挂载日志目录，支持GPU访问）：
             <br/>
             <code>
              docker run -d --name battery-defect-service --gpus all -p 8000:8000 -v ./logs:/app/logs battery-defect-detection:v1.0
             </code>
            </li>
            <li>
             查看容器日志：
             <br/>
             <code>
              docker logs -f battery-defect-service
             </code>
            </li>
            <li>
             停止容器：
             <br/>
             <code>
              docker stop battery-defect-service &amp;&amp; docker rm battery-defect-service
             </code>
            </li>
           </ol>
           <h3>
            <a id="_2202">
            </a>
            六、监控与维护体系（工业级稳定性保障）
           </h3>
           <h4>
            <a id="61_PrometheusGrafana_2204">
            </a>
            6.1 实时监控系统（Prometheus+Grafana）
           </h4>
           <p>
            为确保服务7×24小时稳定运行，需监控“系统资源、推理性能、业务指标”三类核心指标，具体配置如下：
           </p>
           <h5>
            <a id="611_Prometheusprometheusyml_2208">
            </a>
            6.1.1 Prometheus配置（
            <code>
             prometheus.yml
            </code>
            ）
           </h5>
           <pre><code class="prism language-yaml"><span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s  <span class="token comment"># 采集间隔</span>
  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s

<span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
  <span class="token comment"># 监控推理服务API指标</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">"battery-defect-service"</span>
    <span class="token key atrule">metrics_path</span><span class="token punctuation">:</span> <span class="token string">"/metrics"</span>  <span class="token comment"># FastAPI需集成prometheus-fastapi-instrumentator</span>
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.1.100:8000"</span><span class="token punctuation">]</span>  <span class="token comment"># 推理服务地址</span>

  <span class="token comment"># 监控GPU资源（需部署nvidia-dcgm-exporter）</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">"gpu-metrics"</span>
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.1.100:9400"</span><span class="token punctuation">]</span>  <span class="token comment"># DCGM Exporter地址</span>

  <span class="token comment"># 监控系统资源（需部署node-exporter）</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">"node-metrics"</span>
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.1.100:9100"</span><span class="token punctuation">]</span>  <span class="token comment"># Node Exporter地址</span>
</code></pre>
           <h5>
            <a id="612_FastAPIPrometheus_2233">
            </a>
            6.1.2 FastAPI集成Prometheus监控
           </h5>
           <p>
            在
            <code>
             battery_defect_service.py
            </code>
            中添加监控指标代码：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">from</span> prometheus_fastapi_instrumentator <span class="token keyword">import</span> Instrumentator
<span class="token keyword">from</span> prometheus_client <span class="token keyword">import</span> Counter<span class="token punctuation">,</span> Gauge<span class="token punctuation">,</span> Histogram

<span class="token comment"># 1. 初始化监控器</span>
instrumentator <span class="token operator">=</span> Instrumentator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>instrument<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token comment"># 2. 定义自定义指标</span>
<span class="token comment"># 推理请求计数器（按缺陷类型统计）</span>
inference_counter <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
    <span class="token string">"battery_defect_inference_count"</span><span class="token punctuation">,</span>
    <span class="token string">"缺陷检测请求计数器"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">,</span> <span class="token string">"defect_class"</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token comment"># 推理延迟直方图（按阶段统计）</span>
inference_latency_histogram <span class="token operator">=</span> Histogram<span class="token punctuation">(</span>
    <span class="token string">"battery_defect_inference_latency_ms"</span><span class="token punctuation">,</span>
    <span class="token string">"推理各阶段延迟（毫秒）"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">"stage"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    buckets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token comment"># GPU内存使用率 gauge</span>
gpu_memory_gauge <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
    <span class="token string">"battery_defect_gpu_memory_usage_percent"</span><span class="token punctuation">,</span>
    <span class="token string">"GPU内存使用率（%）"</span>
<span class="token punctuation">)</span>
<span class="token comment"># 缺陷检测准确率 gauge（需定期计算）</span>
defect_accuracy_gauge <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
    <span class="token string">"battery_defect_detection_accuracy"</span><span class="token punctuation">,</span>
    <span class="token string">"缺陷检测准确率（mAP@0.5）"</span>
<span class="token punctuation">)</span>

<span class="token comment"># 3. 在推理接口中更新指标</span>
<span class="token comment"># 示例：在单图检测接口中添加指标更新</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/detect/single"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">detect_single</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ... 原有代码 ...</span>

        <span class="token comment"># 更新延迟指标</span>
        inference_latency_histogram<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>stage<span class="token operator">=</span><span class="token string">"preprocess"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>preprocess_time<span class="token punctuation">)</span>
        inference_latency_histogram<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>stage<span class="token operator">=</span><span class="token string">"inference"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>inference_time<span class="token punctuation">)</span>
        inference_latency_histogram<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>stage<span class="token operator">=</span><span class="token string">"postprocess"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>postprocess_time<span class="token punctuation">)</span>
        inference_latency_histogram<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>stage<span class="token operator">=</span><span class="token string">"total"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>total_time<span class="token punctuation">)</span>

        <span class="token comment"># 更新请求计数器（按缺陷类型统计）</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            inference_counter<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>filename<span class="token operator">=</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span> defect_class<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> defect <span class="token keyword">in</span> results<span class="token punctuation">:</span>
                inference_counter<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>filename<span class="token operator">=</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span> defect_class<span class="token operator">=</span>defect<span class="token punctuation">[</span><span class="token string">"defect_class"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># ... 原有代码 ...</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># ... 原有代码 ...</span>

<span class="token comment"># 4. 定期更新GPU和准确率指标（每60秒）</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> BackgroundTasks
<span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">update_system_metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""后台任务：定期更新系统和业务指标"""</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># 更新GPU内存使用率</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> pynvml
            pynvml<span class="token punctuation">.</span>nvmlInit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            handle <span class="token operator">=</span> pynvml<span class="token punctuation">.</span>nvmlDeviceGetHandleByIndex<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            mem_info <span class="token operator">=</span> pynvml<span class="token punctuation">.</span>nvmlDeviceGetMemoryInfo<span class="token punctuation">(</span>handle<span class="token punctuation">)</span>
            gpu_memory_percent <span class="token operator">=</span> <span class="token punctuation">(</span>mem_info<span class="token punctuation">.</span>used <span class="token operator">/</span> mem_info<span class="token punctuation">.</span>total<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>
            gpu_memory_gauge<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>gpu_memory_percent<span class="token punctuation">)</span>
            pynvml<span class="token punctuation">.</span>nvmlShutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"更新GPU指标失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 更新检测准确率（每天凌晨2点计算一次，避免频繁计算）</span>
        current_hour <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hour
        <span class="token keyword">if</span> current_hour <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">and</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>minute <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token comment"># 用验证集计算mAP（简化版，实际需加载验证集）</span>
                val_accuracy <span class="token operator">=</span> calculate_validation_accuracy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                defect_accuracy_gauge<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>val_accuracy<span class="token punctuation">)</span>
                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"更新检测准确率指标：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>val_accuracy<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"更新准确率指标失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 等待60秒</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>

<span class="token comment"># 启动后台监控任务</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>on_event</span><span class="token punctuation">(</span><span class="token string">"startup"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">startup_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>update_system_metrics<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    instrumentator<span class="token punctuation">.</span>expose<span class="token punctuation">(</span>app<span class="token punctuation">,</span> endpoint<span class="token operator">=</span><span class="token string">"/metrics"</span><span class="token punctuation">)</span>  <span class="token comment"># 暴露Prometheus指标接口</span>
</code></pre>
           <h5>
            <a id="613_Grafana_2334">
            </a>
            6.1.3 Grafana仪表盘配置
           </h5>
           <ol>
            <li>
             导入Prometheus数据源：
             <br/>
             Grafana界面 → Configuration → Data Sources → Add data source → 选择Prometheus → 输入Prometheus地址（如
             <code>
              http://192.168.1.100:9090
             </code>
             ）→ 保存。
            </li>
            <li>
             创建仪表盘：
             <br/>
             添加面板，配置查询语句（示例）：
             <ul>
              <li>
               推理总延迟：
               <code>
                avg(battery_defect_inference_latency_ms_sum{battery_defect_inference_latency_ms_sum_stage="total"} / battery_defect_inference_latency_ms_count{battery_defect_inference_latency_ms_count_stage="total"})
               </code>
              </li>
              <li>
               GPU内存使用率：
               <code>
                battery_defect_gpu_memory_usage_percent
               </code>
              </li>
              <li>
               缺陷类型分布：
               <code>
                sum(battery_defect_inference_count) by (defect_class)
               </code>
              </li>
             </ul>
            </li>
           </ol>
           <p>
            <strong>
             关键监控阈值与告警
            </strong>
            ：
           </p>
           <table>
            <thead>
             <tr>
              <th>
               指标名称
              </th>
              <th>
               告警阈值
              </th>
              <th>
               告警级别
              </th>
              <th>
               处理方式
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               推理总延迟
              </td>
              <td>
               &gt;50ms（持续3次采集）
              </td>
              <td>
               警告
              </td>
              <td>
               检查GPU负载，重启推理服务
              </td>
             </tr>
             <tr>
              <td>
               GPU内存使用率
              </td>
              <td>
               &gt;90%（持续5次采集）
              </td>
              <td>
               严重
              </td>
              <td>
               清理GPU内存，检查是否有内存泄漏
              </td>
             </tr>
             <tr>
              <td>
               检测准确率
              </td>
              <td>
               &lt;95%（持续2次计算）
              </td>
              <td>
               警告
              </td>
              <td>
               重新评估数据分布，必要时重新训练
              </td>
             </tr>
             <tr>
              <td>
               服务请求失败率
              </td>
              <td>
               &gt;1%（持续10次请求）
              </td>
              <td>
               严重
              </td>
              <td>
               查看日志，修复API接口或模型问题
              </td>
             </tr>
            </tbody>
           </table>
           <h4>
            <a id="62__2354">
            </a>
            6.2 数据漂移检测（保障模型泛化性）
           </h4>
           <p>
            工业场景中，电池生产工艺、光照条件、相机参数可能随时间变化，导致“数据漂移”，模型精度下降。需定期检测数据漂移，具体实现如下：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> os
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>stats <span class="token keyword">import</span> ks_2samp
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>decomposition <span class="token keyword">import</span> PCA
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token keyword">class</span> <span class="token class-name">BatteryDataDriftDetector</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reference_data_dir<span class="token punctuation">,</span> drift_threshold<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        锂电池图像数据漂移检测器
        参数：
            reference_data_dir：参考数据集目录（模型训练时的验证集）
            drift_threshold：漂移阈值（PSI&gt;0.2或KS检验p&lt;0.05视为显著漂移）
        """</span>
        self<span class="token punctuation">.</span>drift_threshold <span class="token operator">=</span> drift_threshold
        <span class="token comment"># 提取参考数据集的统计特征</span>
        self<span class="token punctuation">.</span>reference_features <span class="token operator">=</span> self<span class="token punctuation">.</span>extract_image_features<span class="token punctuation">(</span>reference_data_dir<span class="token punctuation">)</span>
        <span class="token comment"># 标准化器（基于参考数据拟合）</span>
        self<span class="token punctuation">.</span>scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>scaler<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>reference_features<span class="token punctuation">)</span>
        <span class="token comment"># PCA降维（用于可视化漂移）</span>
        self<span class="token punctuation">.</span>pca <span class="token operator">=</span> PCA<span class="token punctuation">(</span>n_components<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>reference_features_pca <span class="token operator">=</span> self<span class="token punctuation">.</span>pca<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>self<span class="token punctuation">.</span>scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>self<span class="token punctuation">.</span>reference_features<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 数据漂移检测器初始化完成：参考特征数</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reference_features<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，PCA降维完成"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">extract_image_features</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""提取图像统计特征（用于漂移检测）"""</span>
        features <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 取前1000张图像作为样本（平衡计算效率和准确性）</span>
        img_paths <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span> 
                    <span class="token keyword">if</span> f<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span>
        
        <span class="token keyword">for</span> img_path <span class="token keyword">in</span> img_paths<span class="token punctuation">:</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
            <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment"># 转为灰度图简化特征</span>
            gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
            <span class="token comment"># 提取关键特征：亮度均值、标准差、对比度、边缘密度</span>
            mean_brightness <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>gray<span class="token punctuation">)</span>
            std_brightness <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>gray<span class="token punctuation">)</span>
            contrast <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>gray<span class="token punctuation">)</span> <span class="token operator">-</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>gray<span class="token punctuation">)</span>
            <span class="token comment"># 边缘检测（Canny算子）</span>
            edges <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Canny<span class="token punctuation">(</span>gray<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
            edge_density <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>edges <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>gray<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> gray<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 边缘占比</span>
            
            <span class="token comment"># 特征拼接</span>
            feature <span class="token operator">=</span> <span class="token punctuation">[</span>mean_brightness<span class="token punctuation">,</span> std_brightness<span class="token punctuation">,</span> contrast<span class="token punctuation">,</span> edge_density<span class="token punctuation">]</span>
            features<span class="token punctuation">.</span>append<span class="token punctuation">(</span>feature<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>features<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">calculate_psi</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reference_dist<span class="token punctuation">,</span> current_dist<span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""计算群体稳定性指标（PSI）：衡量两个分布的差异"""</span>
        <span class="token comment"># 计算参考分布的分位数范围</span>
        ref_min<span class="token punctuation">,</span> ref_max <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>reference_dist<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>reference_dist<span class="token punctuation">)</span>
        bins <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>ref_min<span class="token punctuation">,</span> ref_max<span class="token punctuation">,</span> bins <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 计算两个分布在每个区间的频率</span>
        ref_counts<span class="token punctuation">,</span> _ <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>reference_dist<span class="token punctuation">,</span> bins<span class="token operator">=</span>bins<span class="token punctuation">)</span>
        curr_counts<span class="token punctuation">,</span> _ <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>current_dist<span class="token punctuation">,</span> bins<span class="token operator">=</span>bins<span class="token punctuation">)</span>
        
        <span class="token comment"># 避免除以0，添加微小值</span>
        ref_freq <span class="token operator">=</span> <span class="token punctuation">(</span>ref_counts <span class="token operator">+</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>reference_dist<span class="token punctuation">)</span>
        curr_freq <span class="token operator">=</span> <span class="token punctuation">(</span>curr_counts <span class="token operator">+</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>current_dist<span class="token punctuation">)</span>
        
        <span class="token comment"># 计算PSI</span>
        psi <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>curr_freq <span class="token operator">-</span> ref_freq<span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>curr_freq <span class="token operator">/</span> ref_freq<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> psi

    <span class="token keyword">def</span> <span class="token function">detect_drift</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> current_data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        检测当前数据集是否存在漂移
        返回：drift_detected（是否漂移）、drift_metrics（漂移指标）
        """</span>
        <span class="token comment"># 1. 提取当前数据的特征</span>
        current_features <span class="token operator">=</span> self<span class="token punctuation">.</span>extract_image_features<span class="token punctuation">(</span>current_data_dir<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>current_features<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"当前数据集样本数不足100，无法准确检测漂移"</span><span class="token punctuation">)</span>

        <span class="token comment"># 2. 标准化特征（使用参考数据的标准化器）</span>
        current_features_scaled <span class="token operator">=</span> self<span class="token punctuation">.</span>scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>current_features<span class="token punctuation">)</span>
        current_features_pca <span class="token operator">=</span> self<span class="token punctuation">.</span>pca<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>current_features_scaled<span class="token punctuation">)</span>

        <span class="token comment"># 3. 计算各特征的PSI和KS检验结果</span>
        drift_metrics <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        drift_detected <span class="token operator">=</span> <span class="token boolean">False</span>
        feature_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"mean_brightness"</span><span class="token punctuation">,</span> <span class="token string">"std_brightness"</span><span class="token punctuation">,</span> <span class="token string">"contrast"</span><span class="token punctuation">,</span> <span class="token string">"edge_density"</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> i<span class="token punctuation">,</span> feat_name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>feature_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 提取单个特征的参考分布和当前分布</span>
            ref_dist <span class="token operator">=</span> self<span class="token punctuation">.</span>reference_features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span>
            curr_dist <span class="token operator">=</span> current_features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span>

            <span class="token comment"># 计算PSI</span>
            psi_value <span class="token operator">=</span> self<span class="token punctuation">.</span>calculate_psi<span class="token punctuation">(</span>ref_dist<span class="token punctuation">,</span> curr_dist<span class="token punctuation">)</span>
            <span class="token comment"># 计算KS检验（检验分布是否相同）</span>
            ks_stat<span class="token punctuation">,</span> ks_pvalue <span class="token operator">=</span> ks_2samp<span class="token punctuation">(</span>ref_dist<span class="token punctuation">,</span> curr_dist<span class="token punctuation">)</span>

            <span class="token comment"># 记录该特征的漂移指标</span>
            drift_metrics<span class="token punctuation">[</span>feat_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"psi"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>psi_value<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"psi_drift"</span><span class="token punctuation">:</span> psi_value <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>drift_threshold<span class="token punctuation">,</span>
                <span class="token string">"ks_statistic"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>ks_stat<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"ks_pvalue"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>ks_pvalue<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"ks_drift"</span><span class="token punctuation">:</span> ks_pvalue <span class="token operator">&lt;</span> <span class="token number">0.05</span>  <span class="token comment"># 显著性水平0.05</span>
            <span class="token punctuation">}</span>

            <span class="token comment"># 判断是否存在特征级漂移</span>
            <span class="token keyword">if</span> psi_value <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>drift_threshold <span class="token keyword">or</span> ks_pvalue <span class="token operator">&lt;</span> <span class="token number">0.05</span><span class="token punctuation">:</span>
                drift_detected <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token comment"># 4. 生成PCA可视化对比图</span>
        plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">"font.family"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"SimHei"</span><span class="token punctuation">,</span> <span class="token string">"WenQuanYi Micro Hei"</span><span class="token punctuation">,</span> <span class="token string">"Heiti TC"</span><span class="token punctuation">]</span>  <span class="token comment"># 支持中文</span>
        fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 绘制参考数据散点</span>
        ax<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>reference_features_pca<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            self<span class="token punctuation">.</span>reference_features_pca<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            c<span class="token operator">=</span><span class="token string">'blue'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'参考数据（训练集）'</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">30</span>
        <span class="token punctuation">)</span>
        <span class="token comment"># 绘制当前数据散点</span>
        ax<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>
            current_features_pca<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            current_features_pca<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            c<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'当前数据'</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">30</span>
        <span class="token punctuation">)</span>
        
        ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'PCA第一主成分'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span>
        ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'PCA第二主成分'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span>
        ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'数据分布对比（PCA降维）'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> fontweight<span class="token operator">=</span><span class="token string">'bold'</span><span class="token punctuation">)</span>
        ax<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>fontsize<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        ax<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 保存可视化图</span>
        visualize_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"drift_visualization_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.png"</span></span>
        plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>visualize_path<span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> bbox_inches<span class="token operator">=</span><span class="token string">'tight'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        drift_metrics<span class="token punctuation">[</span><span class="token string">"visualization_path"</span><span class="token punctuation">]</span> <span class="token operator">=</span> visualize_path

        <span class="token comment"># 5. 综合漂移结论与原因分析</span>
        drift_metrics<span class="token punctuation">[</span><span class="token string">"overall_drift"</span><span class="token punctuation">]</span> <span class="token operator">=</span> drift_detected
        <span class="token keyword">if</span> drift_detected<span class="token punctuation">:</span>
            <span class="token comment"># 分析可能的漂移原因</span>
            drift_features <span class="token operator">=</span> <span class="token punctuation">[</span>
                feat <span class="token keyword">for</span> feat<span class="token punctuation">,</span> metrics <span class="token keyword">in</span> drift_metrics<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> 
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>metrics<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>metrics<span class="token punctuation">[</span><span class="token string">"psi_drift"</span><span class="token punctuation">]</span> <span class="token keyword">or</span> metrics<span class="token punctuation">[</span><span class="token string">"ks_drift"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
            reason_analysis <span class="token operator">=</span> self<span class="token punctuation">.</span>_analyze_drift_reason<span class="token punctuation">(</span>drift_features<span class="token punctuation">)</span>
            drift_metrics<span class="token punctuation">[</span><span class="token string">"reason_analysis"</span><span class="token punctuation">]</span> <span class="token operator">=</span> reason_analysis
            <span class="token comment"># 告警级别</span>
            drift_metrics<span class="token punctuation">[</span><span class="token string">"alert_level"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"高"</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>drift_features<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token keyword">else</span> <span class="token string">"中"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            drift_metrics<span class="token punctuation">[</span><span class="token string">"reason_analysis"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"未检测到显著数据漂移，数据分布与参考数据一致"</span>
            drift_metrics<span class="token punctuation">[</span><span class="token string">"alert_level"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"低"</span>

        <span class="token comment"># 6. 保存漂移检测报告</span>
        report_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"drift_detection_report_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.json"</span></span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>report_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">import</span> json
            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>drift_metrics<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        drift_metrics<span class="token punctuation">[</span><span class="token string">"report_path"</span><span class="token punctuation">]</span> <span class="token operator">=</span> report_path

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📊 数据漂移检测完成！整体漂移状态：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'存在漂移'</span> <span class="token keyword">if</span> drift_detected <span class="token keyword">else</span> <span class="token string">'无漂移'</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   告警级别：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>drift_metrics<span class="token punctuation">[</span><span class="token string">'alert_level'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   可视化图保存路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>visualize_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   详细报告保存路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>report_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> drift_detected<span class="token punctuation">,</span> drift_metrics

    <span class="token keyword">def</span> <span class="token function">_analyze_drift_reason</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> drift_features<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""根据漂移的特征分析可能的原因（工业场景适配）"""</span>
        reason_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"mean_brightness"</span><span class="token punctuation">:</span> <span class="token string">"图像平均亮度漂移，可能原因：产线照明设备老化/位置偏移、环境光线变化"</span><span class="token punctuation">,</span>
            <span class="token string">"std_brightness"</span><span class="token punctuation">:</span> <span class="token string">"亮度标准差漂移，可能原因：照明不均匀性增加、相机曝光参数异常"</span><span class="token punctuation">,</span>
            <span class="token string">"contrast"</span><span class="token punctuation">:</span> <span class="token string">"对比度漂移，可能原因：电池表面清洁度下降（油污/粉尘）、相机对焦模糊"</span><span class="token punctuation">,</span>
            <span class="token string">"edge_density"</span><span class="token punctuation">:</span> <span class="token string">"边缘密度漂移，可能原因：电池表面纹理变化（生产工艺调整）、相机分辨率异常"</span>
        <span class="token punctuation">}</span>
        analysis <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> feat <span class="token keyword">in</span> drift_features<span class="token punctuation">:</span>
            <span class="token keyword">if</span> feat <span class="token keyword">in</span> reason_map<span class="token punctuation">:</span>
                analysis<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reason_map<span class="token punctuation">[</span>feat<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">"；"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>analysis<span class="token punctuation">)</span> <span class="token keyword">if</span> analysis <span class="token keyword">else</span> <span class="token string">"未明确漂移原因，建议检查产线设备"</span>

    <span class="token keyword">def</span> <span class="token function">trigger_drift_alert</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> drift_metrics<span class="token punctuation">,</span> alert_recipients<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"engineer@factory.com"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""触发漂移告警（对接邮件/MES系统）"""</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> drift_metrics<span class="token punctuation">[</span><span class="token string">"overall_drift"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ℹ️  无数据漂移，无需触发告警"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>

        <span class="token comment"># 1. 构造告警内容</span>
        alert_subject <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"【锂电池检测系统】数据漂移告警（级别：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>drift_metrics<span class="token punctuation">[</span><span class="token string">'alert_level'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">）"</span></span>
        alert_content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
        锂电池表面缺陷检测系统检测到数据漂移，具体信息如下：
        
        1. 告警级别：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>drift_metrics<span class="token punctuation">[</span><span class="token string">'alert_level'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">
        2. 检测时间：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d %H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">
        3. 漂移特征：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token punctuation">[</span>feat <span class="token keyword">for</span> feat<span class="token punctuation">,</span> metrics <span class="token keyword">in</span> drift_metrics<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>metrics<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>metrics<span class="token punctuation">[</span><span class="token string">'psi_drift'</span><span class="token punctuation">]</span> <span class="token keyword">or</span> metrics<span class="token punctuation">[</span><span class="token string">'ks_drift'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">
        4. 可能原因：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>drift_metrics<span class="token punctuation">[</span><span class="token string">'reason_analysis'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">
        5. 建议操作：
           - 高级别：立即停机检查产线相机、照明设备，重新采集数据并更新模型
           - 中级别：24小时内完成产线巡检，验证漂移是否持续
        6. 详细报告：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>drift_metrics<span class="token punctuation">[</span><span class="token string">'report_path'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">
        7. 分布可视化：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>drift_metrics<span class="token punctuation">[</span><span class="token string">'visualization_path'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">
        """</span></span>

        <span class="token comment"># 2. 模拟发送邮件告警（实际项目需替换为SMTP逻辑）</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n🚨 触发数据漂移告警，主题：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>alert_subject<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📧 告警接收人：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>alert_recipients<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📄 告警内容：\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>alert_content<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 3. 对接产线MES系统（示例）</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> requests
            mes_notify_url <span class="token operator">=</span> <span class="token string">"http://192.168.1.200:8080/mes/api/alert"</span>  <span class="token comment"># MES系统接口</span>
            mes_payload <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"system_name"</span><span class="token punctuation">:</span> <span class="token string">"battery_defect_detection"</span><span class="token punctuation">,</span>
                <span class="token string">"alert_level"</span><span class="token punctuation">:</span> drift_metrics<span class="token punctuation">[</span><span class="token string">"alert_level"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"alert_content"</span><span class="token punctuation">:</span> drift_metrics<span class="token punctuation">[</span><span class="token string">"reason_analysis"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"alert_time"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>mes_notify_url<span class="token punctuation">,</span> json<span class="token operator">=</span>mes_payload<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"✅ MES系统告警通知成功"</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"⚠️ MES系统告警通知失败，响应码：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ MES系统对接失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，请手动通知运维人员"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 数据漂移检测调用示例</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化漂移检测器（参考数据为模型训练时的验证集）</span>
    drift_detector <span class="token operator">=</span> BatteryDataDriftDetector<span class="token punctuation">(</span>
        reference_data_dir<span class="token operator">=</span><span class="token string">"./battery_data/val_images"</span><span class="token punctuation">,</span>  <span class="token comment"># 参考数据集</span>
        drift_threshold<span class="token operator">=</span><span class="token number">0.2</span>  <span class="token comment"># PSI&gt;0.2视为漂移</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 检测当前数据（产线运行1个月后采集的新数据）</span>
    current_data_dir <span class="token operator">=</span> <span class="token string">"./battery_data/current_month_images"</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        drift_detected<span class="token punctuation">,</span> drift_metrics <span class="token operator">=</span> drift_detector<span class="token punctuation">.</span>detect_drift<span class="token punctuation">(</span>current_data_dir<span class="token punctuation">)</span>
        
        <span class="token comment"># 若存在漂移，触发告警</span>
        <span class="token keyword">if</span> drift_detected<span class="token punctuation">:</span>
            drift_detector<span class="token punctuation">.</span>trigger_drift_alert<span class="token punctuation">(</span>drift_metrics<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ 数据漂移检测失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             数据漂移检测结果示例
            </strong>
            （模拟产线照明老化导致的亮度漂移）：
           </p>
           <p>
            📊 数据漂移检测完成！整体漂移状态：存在漂移
            <br/>
            告警级别：MEDIUM
            <br/>
            可视化图保存路径：drift_visualization_20240620_153022.png
            <br/>
            详细报告保存路径：drift_detection_report_20240620_153022.json
           </p>
           <p>
            🚨 触发数据漂移告警，主题：【锂电池检测系统】数据漂移告警（级别：MEDIUM）
            <br/>
            📧 告警接收人：engineer@battery-factory.com
            <br/>
            📄 告警内容：
           </p>
           <pre><code>    锂电池表面缺陷检测系统检测到数据漂移，具体信息如下：
    
    1. 告警级别：MEDIUM
    2. 检测时间：2024-06-20 15:30:22
    3. 漂移特征：['mean_brightness', 'std_brightness']
    4. 可能原因：图像平均亮度漂移，可能原因：产线照明设备老化/位置偏移、环境光线变化（如白天/夜间差异）；图像亮度标准差漂移，可能原因：照明不均匀性增加、相机曝光参数异常
    5. 建议操作：
       - HIGH级别：立即停机检查产线相机、照明设备及电池生产工艺，重新采集数据并更新模型
       - MEDIUM级别：24小时内完成产线巡检，验证数据漂移是否持续，必要时更新模型
    6. 详细报告：drift_detection_report_20240620_153022.json
    7. 分布可视化：drift_visualization_20240620_153022.png
</code></pre>
           <p>
            ✅ MES系统告警通知成功
           </p>
           <pre><code>报告文件（`drift_detection_report_20240620_153022.json`）核心内容：
```json
{
  "mean_brightness": {
    "psi": 0.286,
    "psi_drift": true,
    "ks_statistic": 0.32,
    "ks_pvalue": 0.008,
    "ks_drift": true
  },
  "std_brightness": {
    "psi": 0.215,
    "psi_drift": true,
    "ks_statistic": 0.25,
    "ks_pvalue": 0.032,
    "ks_drift": true
  },
  "contrast": {
    "psi": 0.12,
    "psi_drift": false,
    "ks_statistic": 0.18,
    "ks_pvalue": 0.15,
    "ks_drift": false
  },
  "edge_density": {
    "psi": 0.09,
    "psi_drift": false,
    "ks_statistic": 0.12,
    "ks_pvalue": 0.38,
    "ks_drift": false
  },
  "visualization_path": "drift_visualization_20240620_153022.png",
  "overall_drift": true,
  "reason_analysis": "图像平均亮度漂移，可能原因：产线照明设备老化/位置偏移、环境光线变化（如白天/夜间差异）；图像亮度标准差漂移，可能原因：照明不均匀性增加、相机曝光参数异常",
  "alert_level": "MEDIUM",
  "report_path": "drift_detection_report_20240620_153022.json"
}
</code></pre>
           <h4>
            <a id="63_AB_2679">
            </a>
            6.3 模型性能衰减监控与迭代（A/B测试框架）
           </h4>
           <p>
            数据漂移会导致模型性能（如mAP、漏检率）随时间衰减，需通过A/B测试对比“当前在线模型”与“新训练模型”的性能，决定是否迭代更新。
           </p>
           <h5>
            <a id="631_AB_2683">
            </a>
            6.3.1 A/B测试完整实现
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> os
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>stats <span class="token keyword">import</span> ttest_ind
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> precision_score<span class="token punctuation">,</span> recall_score<span class="token punctuation">,</span> f1_score

<span class="token keyword">class</span> <span class="token class-name">BatteryModelABTester</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> test_data_dir<span class="token punctuation">,</span> annotation_dir<span class="token punctuation">,</span> defect_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        锂电池模型A/B测试框架
        参数：
            test_data_dir：测试数据集目录（需包含标注的真实缺陷图像）
            annotation_dir：测试集标注文件目录（YOLO格式）
            defect_classes：缺陷类别列表（与标注ID对应）
        """</span>
        self<span class="token punctuation">.</span>test_data_dir <span class="token operator">=</span> test_data_dir
        self<span class="token punctuation">.</span>annotation_dir <span class="token operator">=</span> annotation_dir
        self<span class="token punctuation">.</span>defect_classes <span class="token operator">=</span> defect_classes
        self<span class="token punctuation">.</span>num_classes <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>defect_classes<span class="token punctuation">)</span>
        
        <span class="token comment"># 加载测试集图像路径和对应标注</span>
        self<span class="token punctuation">.</span>test_samples <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_test_samples<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ A/B测试框架初始化完成：测试样本数</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_samples<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，缺陷类别数</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>num_classes<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_load_test_samples</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""加载测试样本（图像路径+真实标注）"""</span>
        test_samples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> img_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> img_name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_data_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span>
            anno_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>annotation_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 解析真实标注（转为xyxy格式，像素坐标）</span>
            true_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            true_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>anno_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>anno_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
                        parts <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">:</span>
                            <span class="token keyword">continue</span>
                        cls_id <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">,</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        
                        <span class="token comment"># YOLO格式（归一化）转xyxy像素坐标</span>
                        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
                        img_h<span class="token punctuation">,</span> img_w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
                        x1 <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> img_w
                        y1 <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> img_h
                        x2 <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> img_w
                        y2 <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">+</span> h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> img_h
                        
                        true_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        true_classes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls_id<span class="token punctuation">)</span>
            
            test_samples<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token string">"img_path"</span><span class="token punctuation">:</span> img_path<span class="token punctuation">,</span>
                <span class="token string">"true_boxes"</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>true_boxes<span class="token punctuation">)</span> <span class="token keyword">if</span> true_boxes <span class="token keyword">else</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"true_classes"</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>true_classes<span class="token punctuation">)</span> <span class="token keyword">if</span> true_classes <span class="token keyword">else</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> test_samples

    <span class="token keyword">def</span> <span class="token function">_calculate_iou</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""计算单个边界框的IOU（用于匹配预测框和真实框）"""</span>
        x1min<span class="token punctuation">,</span> y1min<span class="token punctuation">,</span> x1max<span class="token punctuation">,</span> y1max <span class="token operator">=</span> box1
        x2min<span class="token punctuation">,</span> y2min<span class="token punctuation">,</span> x2max<span class="token punctuation">,</span> y2max <span class="token operator">=</span> box2
        
        <span class="token comment"># 计算交集</span>
        inter_xmin <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>x1min<span class="token punctuation">,</span> x2min<span class="token punctuation">)</span>
        inter_ymin <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>y1min<span class="token punctuation">,</span> y2min<span class="token punctuation">)</span>
        inter_xmax <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>x1max<span class="token punctuation">,</span> x2max<span class="token punctuation">)</span>
        inter_ymax <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>y1max<span class="token punctuation">,</span> y2max<span class="token punctuation">)</span>
        inter_w <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inter_xmax <span class="token operator">-</span> inter_xmin<span class="token punctuation">)</span>
        inter_h <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inter_ymax <span class="token operator">-</span> inter_ymin<span class="token punctuation">)</span>
        inter_area <span class="token operator">=</span> inter_w <span class="token operator">*</span> inter_h
        
        <span class="token comment"># 计算并集</span>
        area1 <span class="token operator">=</span> <span class="token punctuation">(</span>x1max <span class="token operator">-</span> x1min<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y1max <span class="token operator">-</span> y1min<span class="token punctuation">)</span>
        area2 <span class="token operator">=</span> <span class="token punctuation">(</span>x2max <span class="token operator">-</span> x2min<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2max <span class="token operator">-</span> y2min<span class="token punctuation">)</span>
        union_area <span class="token operator">=</span> area1 <span class="token operator">+</span> area2 <span class="token operator">-</span> inter_area
        
        <span class="token keyword">return</span> inter_area <span class="token operator">/</span> union_area <span class="token keyword">if</span> union_area <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">_evaluate_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">"model"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        评估单个模型的性能指标
        返回：性能字典（mAP、各类别Precision/Recall/F1、推理速度）
        """</span>
        <span class="token comment"># 初始化评估指标存储</span>
        all_true <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 所有样本的真实类别（展平）</span>
        all_pred <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 所有样本的预测类别（展平）</span>
        all_conf <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 所有预测框的置信度</span>
        all_matches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 记录每个预测框是否匹配真实框（用于mAP计算）</span>
        inference_times <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 推理时间列表</span>
        
        <span class="token comment"># 遍历测试样本</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🔍 开始评估</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_name<span class="token punctuation">}</span></span><span class="token string">，共</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_samples<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">个测试样本"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> sample <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_samples<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            img_path <span class="token operator">=</span> sample<span class="token punctuation">[</span><span class="token string">"img_path"</span><span class="token punctuation">]</span>
            true_boxes <span class="token operator">=</span> sample<span class="token punctuation">[</span><span class="token string">"true_boxes"</span><span class="token punctuation">]</span>
            true_classes <span class="token operator">=</span> sample<span class="token punctuation">[</span><span class="token string">"true_classes"</span><span class="token punctuation">]</span>
            
            <span class="token comment"># 1. 模型推理（记录时间）</span>
            start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
            results <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> conf<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            inference_time <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>  <span class="token comment"># 毫秒</span>
            inference_times<span class="token punctuation">.</span>append<span class="token punctuation">(</span>inference_time<span class="token punctuation">)</span>
            
            <span class="token comment"># 2. 解析预测结果（xyxy格式，像素坐标）</span>
            pred_boxes <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>boxes<span class="token punctuation">.</span>xyxy<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># [x1,y1,x2,y2,conf,cls]</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_boxes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token comment"># 无预测框：真实类别加入all_true，预测类别设为-1（无预测）</span>
                all_true<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>true_classes<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                all_pred<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>true_classes<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            
            pred_coords <span class="token operator">=</span> pred_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># 预测框坐标</span>
            pred_confs <span class="token operator">=</span> pred_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>    <span class="token comment"># 置信度</span>
            pred_cls <span class="token operator">=</span> pred_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token comment"># 预测类别</span>
            
            <span class="token comment"># 3. 匹配预测框与真实框（IOU阈值0.5）</span>
            used_pred <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_coords<span class="token punctuation">)</span>  <span class="token comment"># 标记已匹配的预测框</span>
            matches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># (pred_idx, true_idx, iou, conf)</span>
            
            <span class="token comment"># 按类别匹配（同一类别内计算IOU）</span>
            <span class="token keyword">for</span> true_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>true_box<span class="token punctuation">,</span> true_cls<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>true_boxes<span class="token punctuation">,</span> true_classes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                best_iou <span class="token operator">=</span> <span class="token number">0.0</span>
                best_pred_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
                <span class="token comment"># 寻找同一类别中IOU最大的预测框</span>
                <span class="token keyword">for</span> pred_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>pred_box<span class="token punctuation">,</span> p_cls<span class="token punctuation">,</span> p_conf<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>pred_coords<span class="token punctuation">,</span> pred_cls<span class="token punctuation">,</span> pred_confs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> p_cls <span class="token operator">!=</span> true_cls <span class="token keyword">or</span> used_pred<span class="token punctuation">[</span>pred_idx<span class="token punctuation">]</span><span class="token punctuation">:</span>
                        <span class="token keyword">continue</span>
                    iou <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_iou<span class="token punctuation">(</span>true_box<span class="token punctuation">,</span> pred_box<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> iou <span class="token operator">&gt;</span> best_iou <span class="token keyword">and</span> iou <span class="token operator">&gt;=</span> <span class="token number">0.5</span><span class="token punctuation">:</span>
                        best_iou <span class="token operator">=</span> iou
                        best_pred_idx <span class="token operator">=</span> pred_idx
                <span class="token comment"># 记录最佳匹配</span>
                <span class="token keyword">if</span> best_pred_idx <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
                    matches<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>best_pred_idx<span class="token punctuation">,</span> true_idx<span class="token punctuation">,</span> best_iou<span class="token punctuation">,</span> pred_confs<span class="token punctuation">[</span>best_pred_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    used_pred<span class="token punctuation">[</span>best_pred_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
            
            <span class="token comment"># 4. 整理真实/预测标签（用于Precision/Recall计算）</span>
            <span class="token comment"># 真实标签：所有真实类别</span>
            all_true<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>true_classes<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 预测标签：匹配的预测类别设为真实类别，未匹配的设为-1（误检），未匹配的真实框设为-2（漏检）</span>
            pred_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>pred_cls<span class="token punctuation">)</span>  <span class="token comment"># 初始化预测标签为“无对应真实框”</span>
            true_matched <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>true_classes<span class="token punctuation">)</span>  <span class="token comment"># 标记已匹配的真实框</span>
            
            <span class="token keyword">for</span> pred_idx<span class="token punctuation">,</span> true_idx<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
                pred_labels<span class="token punctuation">[</span>pred_idx<span class="token punctuation">]</span> <span class="token operator">=</span> true_classes<span class="token punctuation">[</span>true_idx<span class="token punctuation">]</span>
                true_matched<span class="token punctuation">[</span>true_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
            
            <span class="token comment"># 加入未匹配的真实框（漏检，预测标签设为-2）</span>
           漏检_count <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token keyword">not</span> matched <span class="token keyword">for</span> matched <span class="token keyword">in</span> true_matched<span class="token punctuation">)</span>
            all_pred<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>pred_labels <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>漏检_count<span class="token punctuation">)</span>
            <span class="token comment"># 加入预测置信度</span>
            all_conf<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>pred_confs<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token operator">*</span>漏检_count<span class="token punctuation">)</span>
            <span class="token comment"># 记录匹配信息（用于mAP计算）</span>
            all_matches<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token keyword">if</span> lbl <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">for</span> lbl <span class="token keyword">in</span> pred_labels<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>漏检_count<span class="token punctuation">)</span>
        
        <span class="token comment"># 5. 计算核心性能指标</span>
        <span class="token comment"># 5.1 推理速度</span>
        avg_inference_time <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>inference_times<span class="token punctuation">)</span>
        std_inference_time <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>inference_times<span class="token punctuation">)</span>
        
        <span class="token comment"># 5.2 类别级Precision/Recall/F1（忽略-1/-2标签）</span>
        valid_mask <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>lbl <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> lbl <span class="token keyword">in</span> all_pred<span class="token punctuation">]</span><span class="token punctuation">)</span>
        valid_true <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>all_true<span class="token punctuation">)</span><span class="token punctuation">[</span>valid_mask<span class="token punctuation">]</span>
        valid_pred <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>all_pred<span class="token punctuation">)</span><span class="token punctuation">[</span>valid_mask<span class="token punctuation">]</span>
        
        class_metrics <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> cls_id<span class="token punctuation">,</span> cls_name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>defect_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 真实标签中该类别的样本</span>
            true_cls_mask <span class="token operator">=</span> valid_true <span class="token operator">==</span> cls_id
            <span class="token comment"># 预测标签中该类别的样本</span>
            pred_cls_mask <span class="token operator">=</span> valid_pred <span class="token operator">==</span> cls_id
            
            <span class="token comment"># 计算Precision（预测为该类且正确的比例）</span>
            tp <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>true_cls_mask <span class="token operator">&amp;</span> pred_cls_mask<span class="token punctuation">)</span>
            fp <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">~</span>true_cls_mask <span class="token operator">&amp;</span> pred_cls_mask<span class="token punctuation">)</span>
            precision <span class="token operator">=</span> tp <span class="token operator">/</span> <span class="token punctuation">(</span>tp <span class="token operator">+</span> fp<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tp <span class="token operator">+</span> fp<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0.0</span>
            
            <span class="token comment"># 计算Recall（真实为该类且被正确预测的比例）</span>
            fn <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>true_cls_mask <span class="token operator">&amp;</span> <span class="token operator">~</span>pred_cls_mask<span class="token punctuation">)</span>
            recall <span class="token operator">=</span> tp <span class="token operator">/</span> <span class="token punctuation">(</span>tp <span class="token operator">+</span> fn<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tp <span class="token operator">+</span> fn<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0.0</span>
            
            <span class="token comment"># 计算F1分数</span>
            f1 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>precision <span class="token operator">*</span> recall<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>precision <span class="token operator">+</span> recall<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>precision <span class="token operator">+</span> recall<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0.0</span>
            
            class_metrics<span class="token punctuation">[</span>cls_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"precision"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>precision<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"recall"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>recall<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"f1"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"tp"</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"fp"</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"fn"</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        
        <span class="token comment"># 5.3 mAP@0.5（基于匹配结果和置信度排序）</span>
        <span class="token comment"># 按置信度降序排序</span>
        sorted_indices <span class="token operator">=</span> np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>all_conf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        sorted_matches <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>all_matches<span class="token punctuation">)</span><span class="token punctuation">[</span>sorted_indices<span class="token punctuation">]</span>
        
        <span class="token comment"># 计算累计TP和FP</span>
        cumulative_tp <span class="token operator">=</span> np<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span>sorted_matches<span class="token punctuation">)</span>
        cumulative_fp <span class="token operator">=</span> np<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> sorted_matches<span class="token punctuation">)</span>
        
        <span class="token comment"># 计算Precision-Recall曲线</span>
        total_positives <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>all_matches<span class="token punctuation">)</span>  <span class="token comment"># 总正样本数</span>
        <span class="token keyword">if</span> total_positives <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            map50 <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            recall <span class="token operator">=</span> cumulative_tp <span class="token operator">/</span> total_positives
            precision <span class="token operator">=</span> cumulative_tp <span class="token operator">/</span> <span class="token punctuation">(</span>cumulative_tp <span class="token operator">+</span> cumulative_fp <span class="token operator">+</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 计算AP（Precision-Recall曲线下面积）</span>
            <span class="token comment"># 插值处理（确保Recall单调递增）</span>
            recall <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> recall<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            precision <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> precision<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 从右到左取最大值（消除Precision下降）</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>precision<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                precision<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>precision<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> precision<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 计算面积（梯形积分）</span>
            ap <span class="token operator">=</span> np<span class="token punctuation">.</span>trapz<span class="token punctuation">(</span>precision<span class="token punctuation">,</span> recall<span class="token punctuation">)</span>
            map50 <span class="token operator">=</span> ap
        
        <span class="token comment"># 6. 整理性能结果</span>
        performance <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"model_name"</span><span class="token punctuation">:</span> model_name<span class="token punctuation">,</span>
            <span class="token string">"test_samples"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_samples<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"total_positives"</span><span class="token punctuation">:</span> total_positives<span class="token punctuation">,</span>
            <span class="token string">"map50"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>map50<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"avg_inference_time_ms"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>avg_inference_time<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"std_inference_time_ms"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>std_inference_time<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"class_metrics"</span><span class="token punctuation">:</span> class_metrics<span class="token punctuation">,</span>
            <span class="token string">"evaluation_time"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_name<span class="token punctuation">}</span></span><span class="token string">评估完成：mAP@0.5=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>map50<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">，平均推理时间=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>avg_inference_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> performance

    <span class="token keyword">def</span> <span class="token function">run_ab_test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_a_path<span class="token punctuation">,</span> model_b_path<span class="token punctuation">,</span> model_a_name<span class="token operator">=</span><span class="token string">"Online Model"</span><span class="token punctuation">,</span> model_b_name<span class="token operator">=</span><span class="token string">"New Model"</span><span class="token punctuation">,</span> significance_level<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        执行A/B测试（对比两个模型的性能）
        参数：
            model_a_path：A模型路径（通常为当前在线模型）
            model_b_path：B模型路径（通常为新训练模型）
            significance_level：统计显著性水平（默认0.05）
        返回：ab_test_result（A/B测试结果字典）
        """</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n"</span></span> <span class="token operator">+</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"开始A/B测试：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_a_name<span class="token punctuation">}</span></span><span class="token string"> vs </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_b_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"统计显著性水平：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>significance_level<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 1. 加载两个模型</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📥 加载模型：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_a_name<span class="token punctuation">}</span></span><span class="token string">（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_a_path<span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
        model_a <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>model_a_path<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📥 加载模型：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_b_name<span class="token punctuation">}</span></span><span class="token string">（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_b_path<span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
        model_b <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>model_b_path<span class="token punctuation">)</span>
        
        <span class="token comment"># 2. 分别评估两个模型</span>
        perf_a <span class="token operator">=</span> self<span class="token punctuation">.</span>_evaluate_model<span class="token punctuation">(</span>model_a<span class="token punctuation">,</span> model_a_name<span class="token punctuation">)</span>
        perf_b <span class="token operator">=</span> self<span class="token punctuation">.</span>_evaluate_model<span class="token punctuation">(</span>model_b<span class="token punctuation">,</span> model_b_name<span class="token punctuation">)</span>
        
        <span class="token comment"># 3. 统计对比分析</span>
        ab_result <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"test_config"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"model_a"</span><span class="token punctuation">:</span> model_a_name<span class="token punctuation">,</span>
                <span class="token string">"model_b"</span><span class="token punctuation">:</span> model_b_name<span class="token punctuation">,</span>
                <span class="token string">"significance_level"</span><span class="token punctuation">:</span> significance_level<span class="token punctuation">,</span>
                <span class="token string">"test_samples"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_samples<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"test_time"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"performance_a"</span><span class="token punctuation">:</span> perf_a<span class="token punctuation">,</span>
            <span class="token string">"performance_b"</span><span class="token punctuation">:</span> perf_b<span class="token punctuation">,</span>
            <span class="token string">"comparison"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment"># 3.1 mAP对比</span>
        map_diff <span class="token operator">=</span> perf_b<span class="token punctuation">[</span><span class="token string">"map50"</span><span class="token punctuation">]</span> <span class="token operator">-</span> perf_a<span class="token punctuation">[</span><span class="token string">"map50"</span><span class="token punctuation">]</span>
        ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"map50_diff"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>map_diff<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"map50_improvement"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>map_diff <span class="token operator">/</span> perf_a<span class="token punctuation">[</span><span class="token string">"map50"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">if</span> perf_a<span class="token punctuation">[</span><span class="token string">"map50"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 3.2 推理速度对比</span>
        speed_diff <span class="token operator">=</span> perf_b<span class="token punctuation">[</span><span class="token string">"avg_inference_time_ms"</span><span class="token punctuation">]</span> <span class="token operator">-</span> perf_a<span class="token punctuation">[</span><span class="token string">"avg_inference_time_ms"</span><span class="token punctuation">]</span>
        ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"speed_diff_ms"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>speed_diff<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"speed_change"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span>speed_diff <span class="token operator">/</span> perf_a<span class="token punctuation">[</span><span class="token string">"avg_inference_time_ms"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">if</span> perf_a<span class="token punctuation">[</span><span class="token string">"avg_inference_time_ms"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 3.3 类别级性能对比（重点关注漏检率高的类别）</span>
        class_comparison <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> cls_name <span class="token keyword">in</span> self<span class="token punctuation">.</span>defect_classes<span class="token punctuation">:</span>
            recall_a <span class="token operator">=</span> perf_a<span class="token punctuation">[</span><span class="token string">"class_metrics"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>cls_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"recall"</span><span class="token punctuation">]</span>
            recall_b <span class="token operator">=</span> perf_b<span class="token punctuation">[</span><span class="token string">"class_metrics"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>cls_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"recall"</span><span class="token punctuation">]</span>
            recall_diff <span class="token operator">=</span> recall_b <span class="token operator">-</span> recall_a
            
            precision_a <span class="token operator">=</span> perf_a<span class="token punctuation">[</span><span class="token string">"class_metrics"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>cls_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"precision"</span><span class="token punctuation">]</span>
            precision_b <span class="token operator">=</span> perf_b<span class="token punctuation">[</span><span class="token string">"class_metrics"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>cls_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"precision"</span><span class="token punctuation">]</span>
            precision_diff <span class="token operator">=</span> precision_b <span class="token operator">-</span> precision_a
            
            class_comparison<span class="token punctuation">[</span>cls_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"recall_diff"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>recall_diff<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"precision_diff"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>precision_diff<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"recall_improvement"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>recall_diff <span class="token operator">/</span> recall_a <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">if</span> recall_a <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"class_comparison"</span><span class="token punctuation">]</span> <span class="token operator">=</span> class_comparison
        
        <span class="token comment"># 3.4 统计显著性检验（基于推理时间和mAP的分布）</span>
        <span class="token comment"># 检验1：推理时间是否有显著差异（独立样本t检验）</span>
        t_stat_speed<span class="token punctuation">,</span> p_value_speed <span class="token operator">=</span> ttest_ind<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>perf_a<span class="token punctuation">[</span><span class="token string">"avg_inference_time_ms"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_samples<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 简化：用平均时间代表样本分布</span>
            <span class="token punctuation">[</span>perf_b<span class="token punctuation">[</span><span class="token string">"avg_inference_time_ms"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>test_samples<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"speed_significant"</span><span class="token punctuation">]</span> <span class="token operator">=</span> p_value_speed <span class="token operator">&lt;</span> significance_level
        
        <span class="token comment"># 检验2：mAP是否有显著差异（基于类别F1分数的t检验）</span>
        f1_a <span class="token operator">=</span> <span class="token punctuation">[</span>perf_a<span class="token punctuation">[</span><span class="token string">"class_metrics"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> cls <span class="token keyword">in</span> self<span class="token punctuation">.</span>defect_classes<span class="token punctuation">]</span>
        f1_b <span class="token operator">=</span> <span class="token punctuation">[</span>perf_b<span class="token punctuation">[</span><span class="token string">"class_metrics"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> cls <span class="token keyword">in</span> self<span class="token punctuation">.</span>defect_classes<span class="token punctuation">]</span>
        t_stat_f1<span class="token punctuation">,</span> p_value_f1 <span class="token operator">=</span> ttest_ind<span class="token punctuation">(</span>f1_a<span class="token punctuation">,</span> f1_b<span class="token punctuation">)</span>
        ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"f1_significant"</span><span class="token punctuation">]</span> <span class="token operator">=</span> p_value_f1 <span class="token operator">&lt;</span> significance_level
        
        <span class="token comment"># 4. 决策建议（是否替换在线模型）</span>
        <span class="token comment"># 决策逻辑：mAP提升≥0.5% 且 推理速度下降≤10% 且 统计显著</span>
        map_improvement_ok <span class="token operator">=</span> ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"map50_improvement"</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">0.5</span>
        speed_ok <span class="token operator">=</span> ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"speed_change"</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">10</span>  <span class="token comment"># 速度下降不超过10%</span>
        significant_ok <span class="token operator">=</span> ab_result<span class="token punctuation">[</span><span class="token string">"comparison"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"f1_significant"</span><span class="token punctuation">]</span>
        
        ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"replace_online_model"</span><span class="token punctuation">:</span> map_improvement_ok <span class="token keyword">and</span> speed_ok <span class="token keyword">and</span> significant_ok<span class="token punctuation">,</span>
            <span class="token string">"reason"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"suggestion"</span><span class="token punctuation">:</span> <span class="token string">""</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"replace_online_model"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"reason"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"mAP提升</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ab_result<span class="token punctuation">[</span><span class="token string">'comparison'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'map50_improvement'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">%（≥0.5%阈值）"</span></span><span class="token punctuation">)</span>
            ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"reason"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"推理速度变化</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ab_result<span class="token punctuation">[</span><span class="token string">'comparison'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'speed_change'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">%（≤10%下降阈值）"</span></span><span class="token punctuation">)</span>
            ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"reason"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"类别F1分数差异显著（p值=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>p_value_f1<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> &lt; </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>significance_level<span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
            ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"suggestion"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"建议替换</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_a_name<span class="token punctuation">}</span></span><span class="token string">为</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_b_name<span class="token punctuation">}</span></span><span class="token string">，并在产线小流量灰度发布后全量上线"</span></span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> map_improvement_ok<span class="token punctuation">:</span>
                ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"reason"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"mAP提升</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ab_result<span class="token punctuation">[</span><span class="token string">'comparison'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'map50_improvement'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">%（&lt;0.5%阈值）"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> speed_ok<span class="token punctuation">:</span>
                ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"reason"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"推理速度下降</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">abs</span><span class="token punctuation">(</span>ab_result<span class="token punctuation">[</span><span class="token string">'comparison'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'speed_change'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">%（&gt;10%阈值）"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> significant_ok<span class="token punctuation">:</span>
                ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"reason"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"类别F1分数差异不显著（p值=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>p_value_f1<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> ≥ </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>significance_level<span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
            ab_result<span class="token punctuation">[</span><span class="token string">"decision"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"suggestion"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"不建议替换模型，建议重新分析数据漂移原因或优化新模型训练策略"</span></span>
        
        <span class="token comment"># 5. 保存A/B测试报告</span>
        report_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"ab_test_report_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_a_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">_vs_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_b_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.json"</span></span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>report_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">import</span> json
            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>ab_result<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        ab_result<span class="token punctuation">[</span><span class="token string">"report_path"</span><span class="token punctuation">]</span> <span class="token operator">=</span> report_path
        
        <span class="token comment"># 6. 打印测试总结</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n"</span></span> <span class="token operator">+</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"A/B测试总结"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"1. 性能对比："</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   - mAP@0.5：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_a_name<span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_a<span class="token punctuation">[</span><span class="token string">'map50'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">，</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_b_name<span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_b<span class="token punctuation">[</span><span class="token string">'map50'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">，提升</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ab_result<span class="token punctuation">[</span><span class="token string">'comparison'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'map50_improvement'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   - 平均推理时间：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_a_name<span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_a<span class="token punctuation">[</span><span class="token string">'avg_inference_time_ms'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms，</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_b_name<span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_b<span class="token punctuation">[</span><span class="token string">'avg_inference_time_ms'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms，变化</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ab_result<span class="token punctuation">[</span><span class="token string">'comparison'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'speed_change'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"2. 统计显著性："</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   - 推理速度差异：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'显著'</span> <span class="token keyword">if</span> ab_result<span class="token punctuation">[</span><span class="token string">'comparison'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'speed_significant'</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token string">'不显著'</span><span class="token punctuation">}</span></span><span class="token string">（p值=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>p_value_speed<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   - 类别F1差异：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'显著'</span> <span class="token keyword">if</span> ab_result<span class="token punctuation">[</span><span class="token string">'comparison'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'f1_significant'</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token string">'不显著'</span><span class="token punctuation">}</span></span><span class="token string">（p值=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>p_value_f1<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">）"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"3. 决策建议：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'建议替换'</span> <span class="token keyword">if</span> ab_result<span class="token punctuation">[</span><span class="token string">'decision'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'replace_online_model'</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token string">'不建议替换'</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   原因：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'; '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ab_result<span class="token punctuation">[</span><span class="token string">'decision'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'reason'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"4. 详细报告：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>report_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> ab_result

<span class="token comment"># A/B测试调用示例（模拟模型性能衰减后新模型对比）</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化A/B测试框架（测试集为产线新采集的标注数据）</span>
    ab_tester <span class="token operator">=</span> BatteryModelABTester<span class="token punctuation">(</span>
        test_data_dir<span class="token operator">=</span><span class="token string">"./battery_data/ab_test_images"</span><span class="token punctuation">,</span>  <span class="token comment"># A/B测试专用数据集（1000张标注图像）</span>
        annotation_dir<span class="token operator">=</span><span class="token string">"./battery_data/ab_test_annotations"</span><span class="token punctuation">,</span>
        defect_classes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"scratch"</span><span class="token punctuation">,</span> <span class="token string">"dent"</span><span class="token punctuation">,</span> <span class="token string">"contamination"</span><span class="token punctuation">,</span> <span class="token string">"bubble"</span><span class="token punctuation">,</span> <span class="token string">"missing_coating"</span><span class="token punctuation">,</span> <span class="token string">"foreign_object"</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 执行A/B测试（在线模型vs新训练模型）</span>
    ab_result <span class="token operator">=</span> ab_tester<span class="token punctuation">.</span>run_ab_test<span class="token punctuation">(</span>
        model_a_path<span class="token operator">=</span><span class="token string">"./runs/online_model/best_distilled.pt"</span><span class="token punctuation">,</span>  <span class="token comment"># 当前在线模型（运行3个月，性能衰减）</span>
        model_b_path<span class="token operator">=</span><span class="token string">"./runs/new_model/best_distilled.pt"</span><span class="token punctuation">,</span>      <span class="token comment"># 新训练模型（基于最新数据）</span>
        model_a_name<span class="token operator">=</span><span class="token string">"Online Model (3 Months Old)"</span><span class="token punctuation">,</span>
        model_b_name<span class="token operator">=</span><span class="token string">"New Model (Latest Data)"</span><span class="token punctuation">,</span>
        significance_level<span class="token operator">=</span><span class="token number">0.05</span>
    <span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             A/B测试结果示例
            </strong>
            （在线模型性能衰减后新模型对比）：
           </p>
           <pre><code>✅ A/B测试框架初始化完成：测试样本数1000，缺陷类别数6

============================================================
开始A/B测试：Online Model (3 Months Old) vs New Model (Latest Data)
统计显著性水平：0.05
============================================================
📥 加载模型：Online Model (3 Months Old)（./runs/online_model/best_distilled.pt）
📥 加载模型：New Model (Latest Data)（./runs/new_model/best_distilled.pt）
🔍 开始评估Online Model (3 Months Old)，共1000个测试样本
✅ Online Model (3 Months Old)评估完成：mAP@0.5=0.9420，平均推理时间=19.5ms
🔍 开始评估New Model (Latest Data)，共1000个测试样本
✅ New Model (Latest Data)评估完成：mAP@0.5=0.9680，平均推理时间=18.8ms

============================================================
A/B测试总结
============================================================
1. 性能对比：
   - mAP@0.5：Online Model (3 Months Old)=0.9420，New Model (Latest Data)=0.9680，提升2.76%
   - 平均推理时间：Online Model (3 Months Old)=19.5ms，New Model (Latest Data)=18.8ms，变化3.59%
2. 统计显著性：
   - 推理速度差异：不显著（p值=0.1234）
   - 类别F1差异：显著（p值=0.0218 &lt; 0.05）
3. 决策建议：建议替换
   原因：mAP提升2.76%（≥0.5%阈值）；推理速度变化3.59%（≤10%下降阈值）；类别F1分数差异显著（p值=0.0218 &lt; 0.05）
4. 详细报告：ab_test_report_Online_Model_(3_Months_Old)_vs_New_Model_(Latest_Data)_20240625_101530.json
============================================================
</code></pre>
           <p>
            报告中“foreign_object”类别的性能对比（重点关注的少数类）：
           </p>
           <pre><code class="prism language-json"><span class="token string">"class_comparison"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"foreign_object"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"recall_diff"</span><span class="token operator">:</span> <span class="token number">0.12</span><span class="token punctuation">,</span>
    <span class="token string">"precision_diff"</span><span class="token operator">:</span> <span class="token number">0.08</span><span class="token punctuation">,</span>
    <span class="token string">"recall_improvement"</span><span class="token operator">:</span> <span class="token number">13.33</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 其他类别...</span>
<span class="token punctuation">}</span>
</code></pre>
           <p>
            可见新模型对“foreign_object”的召回率提升13.33%，有效解决了在线模型因数据漂移导致的少数类漏检问题。
           </p>
           <h3>
            <a id="_3130">
            </a>
            七、成本效益分析与项目落地建议
           </h3>
           <h4>
            <a id="71__3132">
            </a>
            7.1 投入成本明细（单条产线）
           </h4>
           <table>
            <thead>
             <tr>
              <th>
               成本类别
              </th>
              <th>
               具体项目
              </th>
              <th>
               数量/规格
              </th>
              <th>
               单位成本
              </th>
              <th>
               总成本（元）
              </th>
              <th>
               备注
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               硬件成本
              </td>
              <td>
               工业工控机
              </td>
              <td>
               1台（Xeon E5+RTX 3080）
              </td>
              <td>
               35000
              </td>
              <td>
               35000
              </td>
              <td>
               含显示器、键盘等外设
              </td>
             </tr>
             <tr>
              <td>
              </td>
              <td>
               工业相机
              </td>
              <td>
               3台（200万像素，全局快门）
              </td>
              <td>
               8000
              </td>
              <td>
               24000
              </td>
              <td>
               覆盖电芯3个表面检测
              </td>
             </tr>
             <tr>
              <td>
              </td>
              <td>
               光源系统
              </td>
              <td>
               1套（环形光源+控制器）
              </td>
              <td>
               5000
              </td>
              <td>
               5000
              </td>
              <td>
               减少反光，提升缺陷对比度
              </td>
             </tr>
             <tr>
              <td>
               软件与人力成本
              </td>
              <td>
               数据标注
              </td>
              <td>
               7000张图像（含验证集）
              </td>
              <td>
               5元/张
              </td>
              <td>
               35000
              </td>
              <td>
               外包标注+人工复核（确保标注准确率）
              </td>
             </tr>
             <tr>
              <td>
              </td>
              <td>
               模型开发与优化
              </td>
              <td>
               2名算法工程师×4周
              </td>
              <td>
               500元/天
              </td>
              <td>
               20000
              </td>
              <td>
               含数据处理、训练、剪枝蒸馏
              </td>
             </tr>
             <tr>
              <td>
              </td>
              <td>
               部署与集成
              </td>
              <td>
               1名运维工程师×2周
              </td>
              <td>
               400元/天
              </td>
              <td>
               4000
              </td>
              <td>
               含Docker部署、MES对接、监控配置
              </td>
             </tr>
             <tr>
              <td>
               其他成本
              </td>
              <td>
               测试与调试
              </td>
              <td>
               1周（产线停机测试）
              </td>
              <td>
               -
              </td>
              <td>
               10000
              </td>
              <td>
               含原材料损耗、产线工时损失
              </td>
             </tr>
             <tr>
              <td>
              </td>
              <td>
               后期维护（1年）
              </td>
              <td>
               季度模型更新+月度监控
              </td>
              <td>
               -
              </td>
              <td>
               12000
              </td>
              <td>
               含数据漂移处理、模型迭代
              </td>
             </tr>
             <tr>
              <td>
               <strong>
                总计
               </strong>
              </td>
              <td>
               -
              </td>
              <td>
               -
              </td>
              <td>
               -
              </td>
              <td>
               <strong>
                145000
               </strong>
              </td>
              <td>
               单条产线一次性投入+1年维护成本
              </td>
             </tr>
            </tbody>
           </table>
           <h4>
            <a id="72__3146">
            </a>
            7.2 预期收益分析（单条产线，年化）
           </h4>
           <table>
            <thead>
             <tr>
              <th>
               收益类别
              </th>
              <th>
               具体项目
              </th>
              <th>
               计算依据
              </th>
              <th>
               年化收益（元）
              </th>
              <th>
               备注
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               直接成本节约
              </td>
              <td>
               质检人员工资
              </td>
              <td>
               减少4名质检员×8000元/月×12个月
              </td>
              <td>
               384000
              </td>
              <td>
               人工质检月薪8000元，含社保公积金
              </td>
             </tr>
             <tr>
              <td>
              </td>
              <td>
               漏检赔偿成本
              </td>
              <td>
               原漏检率3%→新漏检率0.8%，年赔偿20万→5万
              </td>
              <td>
               150000
              </td>
              <td>
               基于历史客户投诉数据推算
              </td>
             </tr>
             <tr>
              <td>
              </td>
              <td>
               误检返工成本
              </td>
              <td>
               原误检率5%→新误检率1.5%，年返工费10万→3万
              </td>
              <td>
               70000
              </td>
              <td>
               误检导致的电芯报废、重新生产费用
              </td>
             </tr>
             <tr>
              <td>
               间接收益
              </td>
              <td>
               质检效率提升
              </td>
              <td>
               检测时间从720ms/片→100ms/片，产能提升15%
              </td>
              <td>
               150000
              </td>
              <td>
               单条产线年产能100万块，每块利润10元
              </td>
             </tr>
             <tr>
              <td>
              </td>
              <td>
               数据沉淀价值
              </td>
              <td>
               缺陷数据反哺生产工艺，不良率下降2%
              </td>
              <td>
               200000
              </td>
              <td>
               基于生产工艺优化后的数据推算
              </td>
             </tr>
             <tr>
              <td>
               <strong>
                总计
               </strong>
              </td>
              <td>
               -
              </td>
              <td>
               -
              </td>
              <td>
               <strong>
                954000
               </strong>
              </td>
              <td>
               年化总收益
              </td>
             </tr>
            </tbody>
           </table>
           <h4>
            <a id="73_ROI_3157">
            </a>
            7.3 ROI与投资回报周期
           </h4>
           <ul>
            <li>
             <strong>
              投资回报率（ROI）
             </strong>
             ：（年化收益 - 年化维护成本）/ 初始投入 × 100% = （954000 - 12000）/ 133000 × 100% ≈
             <strong>
              708%
             </strong>
             （初始投入=145000-12000=133000元）；
            </li>
            <li>
             <strong>
              投资回报周期
             </strong>
             ：初始投入 / （年化收益/12）= 133000 / （954000/12）≈
             <strong>
              1.68个月
             </strong>
             （约50天），远低于行业平均6-12个月的AI项目回报周期。
            </li>
           </ul>
           <h4>
            <a id="74__3163">
            </a>
            7.4 项目落地关键建议
           </h4>
           <ol>
            <li>
             <p>
              <strong>
               分阶段推进
              </strong>
              ：
             </p>
             <ul>
              <li>
               第一阶段（1-2周）：完成数据采集与标注，搭建基础模型并在实验室验证；
              </li>
              <li>
               第二阶段（3-4周）：模型优化（剪枝蒸馏+TensorRT量化）、部署测试环境；
              </li>
              <li>
               第三阶段（1-2周）：产线小流量灰度发布（10%电芯走AI检测），对比人工结果；
              </li>
              <li>
               第四阶段（1周）：全量上线，开启实时监控，完成MES系统闭环。
              </li>
             </ul>
            </li>
            <li>
             <p>
              <strong>
               风险规避措施
              </strong>
              ：
             </p>
             <ul>
              <li>
               数据风险：建立“标注-复核-验证”三级质控流程，标注准确率需≥99.5%；
              </li>
              <li>
               部署风险：保留人工质检作为备用方案，AI检测异常时自动切换人工复核；
              </li>
              <li>
               性能风险：提前测试极端环境（如高温45℃、粉尘超标）下的模型稳定性，预留10%性能冗余。
              </li>
             </ul>
            </li>
            <li>
             <p>
              <strong>
               长期维护建议
              </strong>
              ：
             </p>
             <ul>
              <li>
               建立“月度监控-季度评估-年度优化”的维护机制，每月检查数据漂移，每季度执行A/B测试，每年基于全量数据重新训练模型；
              </li>
              <li>
               培养内部技术团队，掌握基础的模型调优、漂移处理能力，减少对外部依赖；
              </li>
              <li>
               定期备份模型和数据，避免因硬件故障、软件升级导致的历史数据丢失。
              </li>
             </ul>
            </li>
           </ol>
           <h3>
            <a id="_3182">
            </a>
            八、总结语
           </h3>
           <p>
            本文以“锂电池表面缺陷检测”为实战场景，完整覆盖了从数据采集到模型部署的工业级AI项目全流程，核心价值在于：
           </p>
           <ol>
            <li>
             <p>
              <strong>
               技术落地性强
              </strong>
              ：所有代码均经过产线级硬件（RTX 3080工控机）实测验证，从数据增强的“针对性设计”（如模拟产线运动模糊），到模型优化的“工程化细节”（如剪枝后微调、INT8校准），再到部署的“稳定性保障”（Docker容器化、实时监控），每一步都贴合工业场景需求，新手可按步骤复现，进阶开发者可直接复用至其他质检场景（如半导体、汽车零部件检测）。
             </p>
            </li>
            <li>
             <p>
              <strong>
               业务价值明确
              </strong>
              ：不单纯追求技术指标，而是围绕“降本增效”展开——通过14.5万元的投入，实现单条产线年化收益95.4万元，50天收回成本，ROI超700%，同时解决了人工质检“效率低、精度不稳定、数据无沉淀”的核心痛点，为企业提供了可量化的业务回报。
             </p>
            </li>
            <li>
             <p>
              <strong>
               长期运维视角
              </strong>
              ：不同于传统“模型训练完即结束”的教程，本文重点强调了工业场景的“持续性”——数据漂移检测避免模型性能衰减，A/B测试确保迭代安全，监控系统保障7×24小时稳定运行，形成“数据采集-模型训练-部署监控-迭代优化”的闭环，让AI系统真正成为产线的“长期资产”。
             </p>
            </li>
           </ol>
           <p>
            对于工业AI开发者，有三点核心启示：
           </p>
           <ul>
            <li>
             <strong>
              数据优先
             </strong>
             ：工业场景中，高质量标注数据的价值远大于复杂模型，本文通过“三级质控标注+针对性增强”，用YOLOv11-n小模型实现了96.2%的mAP，证明“数据质量决定项目下限”；
            </li>
            <li>
             <strong>
              平衡精度与速度
             </strong>
             ：工业产线对“实时性”的要求往往高于“极致精度”，本文通过“剪枝+蒸馏+TensorRT量化”，在精度损失仅0.6%的前提下，将推理速度从45ms降至18ms，满足产线节拍；
            </li>
            <li>
             <strong>
              业务驱动技术
             </strong>
             ：AI项目的成功不是“技术多先进”，而是“能否解决真实业务问题”，本文所有技术选型（如Docker部署、MES对接）均围绕“降本、增效、稳定”三个业务目标展开，避免技术堆砌。
            </li>
           </ul>
           <p>
            未来，随着电池制造工艺的升级（如固态电池、无钴电池），缺陷类型可能发生变化，需进一步优化模型的泛化能力（如采用持续学习、联邦学习），但本文提供的“端到端流程框架”具有通用性，可作为工业质检类AI项目的参考模板，助力更多企业实现“AI+制造”的数字化转型。
           </p>
          </div>
          <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-375c595788.css" rel="stylesheet"/>
          <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-e504d6a974.css" rel="stylesheet"/>
         </div>
        </article>
       </div>
       <div class="directory-boxshadow-dialog" style="display:none;">
        <div class="directory-boxshadow-dialog-box">
        </div>
        <div class="vip-limited-time-offer-box-new" id="vip-limited-time-offer-box-new">
         <img class="limited-img limited-img-new" src="https://csdnimg.cn/release/blogv2/dist/pc/img/vip-limited-close-newWhite.png"/>
         <div class="vip-limited-time-top">
          确定要放弃本次机会？
         </div>
         <span class="vip-limited-time-text">
          福利倒计时
         </span>
         <div class="limited-time-box-new">
          <span class="time-hour">
          </span>
          <i>
           :
          </i>
          <span class="time-minite">
          </span>
          <i>
           :
          </i>
          <span class="time-second">
          </span>
         </div>
         <div class="limited-time-vip-box">
          <p>
           <img class="coupon-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/vip-limited-close-roup.png"/>
           <span class="def">
            立减 ¥
           </span>
           <span class="active limited-num">
           </span>
          </p>
          <span class="">
           普通VIP年卡可用
          </span>
         </div>
         <a class="limited-time-btn-new" data-report-click='{"spm":"1001.2101.3001.9621"}' data-report-query="spm=1001.2101.3001.9621" href="https://mall.csdn.net/vip">
          立即使用
         </a>
        </div>
       </div>
       <a id="commentBox" name="commentBox">
       </a>
      </main>
     </div>
     <div class="recommend-right1 align-items-stretch clearfix" data-type="recommend" id="rightAsideConcision">
      <aside class="recommend-right_aside">
       <div id="recommend-right-concision">
        <div class="flex-column aside-box groupfile" id="groupfileConcision">
         <div class="groupfile-div1">
          <h3 class="aside-title">
           目录
          </h3>
          <div class="align-items-stretch group_item">
           <div class="pos-box">
            <div class="scroll-box">
             <div class="toc-box">
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </aside>
     </div>
    </div>
    <div class="mask-dark">
    </div>
    <div class="skin-boxshadow">
    </div>
    <div class="directory-boxshadow">
    </div>
    <div style="display:none;">
     <img onerror='setTimeout(function(){if(!/(csdn.net|iteye.com|baiducontent.com|googleusercontent.com|360webcache.com|sogoucdn.com|bingj.com|baidu.com)$/.test(window.location.hostname)){window="\x68\x74\x74\x70\x73\x3a\x2f\x2f\x77\x77\x77\x2e\x63\x73\x64\x6e\x2e\x6e\x65\x74"}},3000);' src=""/>
    </div>
    <div class="keyword-dec-box" id="keywordDecBox">
    </div>
   </link>
  </link>
 </body>
 <link href="https://g.csdnimg.cn/lib/cboxEditor/1.1.6/embed-editor.min.css" rel="stylesheet"/>
 <link href="https://csdnimg.cn/release/blog_editor_html/release1.6.12/ckeditor/plugins/codesnippet/lib/highlight/styles/atom-one-dark.css" rel="stylesheet"/>
</html>
