# YOLO工序检测项目优化计划

基于Python最佳实践技能，全面重构和优化项目架构。

## 阶段1：项目结构优化 (第1天)

### 1.1 重新组织项目结构
```
yolo-process-detection/
  src/
    yolo_process_detection/
      __init__.py
      models/
        __init__.py
        detector.py
        tracker.py
        video_processor.py
      services/
        __init__.py
        analyzer.py
        scene_understanding.py
        anomaly_detection.py
        efficiency_analyzer.py
      api/
        __init__.py
        routes.py
        dependencies.py
      schemas/
        __init__.py
        detection.py
        config.py
        response.py
      core/
        __init__.py
        config.py
        logging.py
        exceptions.py
  tests/
    conftest.py
    test_models/
    test_services/
    test_api/
  pyproject.toml
```

### 1.2 创建pyproject.toml
```toml
[project]
name = "yolo-process-detection"
version = "1.0.0"
requires-python = ">=3.12"
dependencies = [
    "ultralytics>=8.0",
    "fastapi>=0.100",
    "uvicorn>=0.23",
    "pydantic>=2.0",
    "numpy>=1.24",
    "opencv-python>=4.8",
]

[project.optional-dependencies]
dev = [
    "pytest>=8.0",
    "pytest-asyncio",
    "pytest-cov",
    "ruff",
    "mypy",
]
```

## 阶段2：配置和类型系统 (第2天)

### 2.1 使用Pydantic重构配置
```python
# src/yolo_process_detection/core/config.py
from pydantic import BaseModel, Field, field_validator
from typing import Literal

class DetectionConfig(BaseModel):
    model_name: str = Field(default="yolo11n.pt")
    confidence_threshold: float = Field(default=0.5, ge=0, le=1)
    iou_threshold: float = Field(default=0.45, ge=0, le=1)
    device: Literal["cpu", "cuda"] = "cpu"
    
    @field_validator("model_name")
    @classmethod
    def validate_model(cls, v: str) -> str:
        valid_models = ["yolo11n.pt", "yolov8n.pt", "yolov12n.pt"]
        if v not in valid_models:
            raise ValueError(f"Invalid model: {v}")
        return v
```

### 2.2 添加完整类型注解
- 为所有函数添加类型注解
- 使用TypedDict定义响应格式
- 使用Union类型处理可选值

## 阶段3：API和异步优化 (第3天)

### 3.1 重构FastAPI应用
```python
# src/yolo_process_detection/api/routes.py
from fastapi import APIRouter, Depends, UploadFile, File
from typing import Annotated

router = APIRouter()

@router.post("/detect")
async def detect(
    image: Annotated[UploadFile, File(...)],
    config: Annotated[DetectionConfig, Depends(get_config)]
) -> DetectionResponse:
    """Detect objects in image"""
    ...
```

### 3.2 实现异步批处理
```python
async def detect_batch(
    images: list[UploadFile],
    max_concurrent: int = 5
) -> list[DetectionResponse]:
    semaphore = asyncio.Semaphore(max_concurrent)
    
    async def bounded_detect(img: UploadFile) -> DetectionResponse:
        async with semaphore:
            return await process_image(img)
    
    return await asyncio.gather(*[bounded_detect(img) for img in images])
```

## 阶段4：测试和文档 (第4天)

### 4.1 创建测试框架
```python
# tests/conftest.py
import pytest
from unittest.mock import Mock

@pytest.fixture
def mock_detector():
    detector = Mock(spec=ProcessDetector)
    detector.detect.return_value = []
    return detector

@pytest.fixture
def sample_image():
    return np.zeros((640, 640, 3), dtype=np.uint8)
```

### 4.2 添加类型检查
- 配置mypy严格模式
- 添加pyproject.toml中的mypy配置
- 编写类型注释

## 预期成果

1. **代码质量**
   - 完整的类型注解
   - Pydantic配置验证
   - 异步优化
   - 更好的错误处理

2. **项目结构**
   - 清晰的模块划分
   - 依赖注入设计
   - 完整的测试覆盖

3. **可维护性**
   - pyproject.toml统一配置
   - Ruff代码检查
   - 完整的文档