<!DOCTYPE html>
<html lang="zh-CN">
 <head>
  <meta charset="utf-8"/>
  <link href="https://blog.csdn.net/weixin_39815573/article/details/150426295" rel="canonical"/>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <meta content="webkit" name="renderer">
   <meta content="webkit" name="force-rendering">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
    <meta content="always" name="referrer"/>
    <meta content="no-siteapp" http-equiv="Cache-Control">
     <link href="#" media="handheld" rel="alternate"/>
     <meta content="pc" name="applicable-device"/>
     <link href="https://g.csdnimg.cn/static/logo/favicon32.ico" rel="shortcut icon" type="image/x-icon"/>
     <title>
      【YOLOv11工业级实战】09. YOLOv11工业质检实战：电子元件缺陷检测（微米级精度｜显微图像处理）_yolo 11 工业质检-CSDN博客
     </title>
     <meta content="yolo 11 工业质检" name="keywords"/>
     <meta content="文章浏览阅读251次，点赞12次，收藏6次。摘要：本文针对电子元件微米级缺陷检测难题，提出基于YOLOv11的高精度检测方案。参考IPC-A-610航空级标准，采用PCB-Defect显微图像库，通过3D打印模拟技术生成20μm级微缺陷样本。创新设计亚像素特征提取网络与多尺度融合策略，实现20μm缺陷96.7%的检出率，误报率低至1.1%。开发工业显微镜集成系统，结合Olympus DSX1000显微镜与Thorlabs运动平台，构建自动化检测流程。文中提供完整的缺陷模拟、模型训练及工业集成代码，支持电子制造业实现高精度、高效率的质检自动化。_yolo 11 工业质检" name="description"/>
     <link href="https://csdnimg.cn/release/blogv2/dist/pc/css/corporate_blog_enter-5fa02cb032.min.css" rel="stylesheet" type="text/css"/>
     <style>
      #content_views{
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none; 
            user-select: none; 
        }
     </style>
     <meta content='{"type":"0","fixModel":"1"}' name="toolbar"/>
     <link href="https://csdnimg.cn/public/sandalstrap/1.4/css/sandalstrap.min.css" rel="stylesheet" type="text/css"/>
     <style>
      .MathJax, .MathJax_Message, .MathJax_Preview{
            display: none
        }
     </style>
    </meta>
   </meta>
  </meta>
  <style type="text/css">
   * { user-select: text; } pre{max-height: none!important; overflow-y: hidden;}
  </style>
 </head>
 <body class="nodata company_blog" style="">
  <link href="https://csdnimg.cn/release/blogv2/dist/pc/css/blog_code-01256533b5.min.css" rel="stylesheet"/>
  <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/chart-3456820cac.css" rel="stylesheet">
   <link href="https://g.csdnimg.cn/lib/swiper/6.0.4/css/swiper.css" rel="stylesheet">
    <div class="main_father clearfix d-flex justify-content-center mainfather-concision" style="height:100%;">
     <div class="container clearfix container-concision" id="mainBox">
      <main>
       <div class="blog-content-box">
        <div class="article-header-box">
         <div class="article-header">
          <div class="article-title-box">
           <h1 class="title-article" id="articleContentId">
            【YOLOv11工业级实战】09. YOLOv11工业质检实战：电子元件缺陷检测（微米级精度｜显微图像处理）
           </h1>
          </div>
          <div class="article-info-box">
           <div class="article-bar-top-box">
            <div class="article-bar-top">
             <img alt="" class="article-type-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/original.png"/>
             <div class="bar-content">
              <a class="follow-nickName vip-name" href="https://deep-learning.blog.csdn.net" rel="noopener" target="_blank" title="AI_DL_CODE">
               AI_DL_CODE
              </a>
              <img alt="" class="article-time-img article-heard-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newUpTime2.png"/>
              <span class="time">
               已于 2025-08-18 15:29:54 修改
              </span>
              <div class="read-count-box">
               <img alt="" class="article-read-img article-heard-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/articleReadEyes2.png"/>
               <span class="read-count">
                阅读量251
               </span>
               <a class="un-collection" data-report-click='{"mod":"popu_823","spm":"1001.2101.3001.4232","ab":"new"}' id="blog_detail_zk_collection">
                <img alt="" class="article-collect-img article-heard-img un-collect-status isdefault" src="https://csdnimg.cn/release/blogv2/dist/pc/img/tobarCollect2.png" style="display:inline-block"/>
                <img alt="" class="article-collect-img article-heard-img collect-status isactive" src="https://csdnimg.cn/release/blogv2/dist/pc/img/tobarCollectionActive2.png" style="display:none"/>
                <span class="name">
                 收藏
                </span>
                <span class="get-collection">
                 6
                </span>
               </a>
               <div class="read-count-box is-like" data-type="top">
                <img alt="" class="article-read-img article-heard-img" id="is-like-imgactive-new" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newHeart2023Active.png" style="display:none"/>
                <img alt="" class="article-read-img article-heard-img" id="is-like-img-new" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newHeart2023Black.png" style="display:block"/>
                <span class="read-count" id="blog-digg-num">
                 点赞数
                              12
                </span>
               </div>
              </div>
             </div>
            </div>
            <div class="operating">
             <a class="href-article-edit slide-toggle">
              CC 4.0 BY-SA版权
             </a>
            </div>
           </div>
           <div class="blog-tags-box">
            <div class="tags-box artic-tag-box">
             <span class="label">
              分类专栏：
             </span>
             <a class="tag-link" href="https://blog.csdn.net/weixin_39815573/category_13026999.html" rel="noopener" target="_blank">
              YOLOv11工业级实战
             </a>
             <span class="label">
              文章标签：
             </span>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"YOLOv11","ab":"new","extra":"{\"searchword\":\"YOLOv11\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"YOLOv11","ab":"new","extra":"{\"searchword\":\"YOLOv11\"}"}' href="https://so.csdn.net/so/search/s.do?q=YOLOv11&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              YOLOv11
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"工业质检","ab":"new","extra":"{\"searchword\":\"工业质检\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"工业质检","ab":"new","extra":"{\"searchword\":\"工业质检\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E5%B7%A5%E4%B8%9A%E8%B4%A8%E6%A3%80&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              工业质检
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"微米级检测","ab":"new","extra":"{\"searchword\":\"微米级检测\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"微米级检测","ab":"new","extra":"{\"searchword\":\"微米级检测\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E5%BE%AE%E7%B1%B3%E7%BA%A7%E6%A3%80%E6%B5%8B&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              微米级检测
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"显微图像","ab":"new","extra":"{\"searchword\":\"显微图像\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"显微图像","ab":"new","extra":"{\"searchword\":\"显微图像\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E6%98%BE%E5%BE%AE%E5%9B%BE%E5%83%8F&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              显微图像
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"电子元件缺陷","ab":"new","extra":"{\"searchword\":\"电子元件缺陷\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"电子元件缺陷","ab":"new","extra":"{\"searchword\":\"电子元件缺陷\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E7%94%B5%E5%AD%90%E5%85%83%E4%BB%B6%E7%BC%BA%E9%99%B7&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              电子元件缺陷
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"亚像素特征","ab":"new","extra":"{\"searchword\":\"亚像素特征\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"亚像素特征","ab":"new","extra":"{\"searchword\":\"亚像素特征\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E4%BA%9A%E5%83%8F%E7%B4%A0%E7%89%B9%E5%BE%81&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              亚像素特征
             </a>
             <a class="tag-link" data-report-click='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"自动化检测系统","ab":"new","extra":"{\"searchword\":\"自动化检测系统\"}"}' data-report-query="spm=1001.2101.3001.4223" data-report-view='{"mod":"popu_626","spm":"1001.2101.3001.4223","strategy":"自动化检测系统","ab":"new","extra":"{\"searchword\":\"自动化检测系统\"}"}' href="https://so.csdn.net/so/search/s.do?q=%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" rel="noopener" target="_blank">
              自动化检测系统
             </a>
            </div>
           </div>
           <div class="up-time">
            <span>
             于 2025-08-17 15:02:35 首次发布
            </span>
           </div>
           <div class="slide-content-box">
            <div class="article-copyright">
             <div class="creativecommons">
              版权声明：本文为博主原创文章，遵循
              <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="noopener" target="_blank">
               CC 4.0 BY-SA
              </a>
              版权协议，转载请附上原文出处链接和本声明。
             </div>
             <div class="article-source-link">
              本文链接：
              <a href="https://blog.csdn.net/weixin_39815573/article/details/150426295" target="_blank">
               https://blog.csdn.net/weixin_39815573/article/details/150426295
              </a>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
        <div class="" id="blogHuaweiyunAdvert">
        </div>
        <div class="" id="blogColumnPayAdvert">
         <div class="column-group">
          <div class="column-group-item column-group0 column-group-item-one">
           <div class="item-l">
            <a class="item-target" data-report-click='{"spm":"1001.2101.3001.6332"}' data-report-view='{"spm":"1001.2101.3001.6332"}' href="https://blog.csdn.net/weixin_39815573/category_13026999.html" target="_blank" title="YOLOv11工业级实战">
             <img alt="" class="item-target" src="https://i-blog.csdnimg.cn/direct/7de10a217c0b4e0ca7e71e109ce0aca6.jpeg?x-oss-process=image/resize,m_fixed,h_224,w_224"/>
             <span class="title item-target">
              <span>
               <span class="tit">
                YOLOv11工业级实战
               </span>
               <span class="dec">
                专栏收录该内容
               </span>
              </span>
             </span>
            </a>
           </div>
           <div class="item-m">
            <span>
             29 篇文章
            </span>
            <span class="old-add-new-box">
             <span class="price">
              ¥89.90
             </span>
             <span class="oldprice">
              ¥99.00
             </span>
            </span>
           </div>
           <div class="item-r">
            <a class="item-target article-column-subscribe">
             已订阅
            </a>
            <a class="item-target column-studyvip-discount column-studyvip-pass" data-report-click='{"spm":"1001.2015.3001.8590"}' data-report-view='{"spm":"1001.2015.3001.8590"}'>
             8折续费
            </a>
           </div>
          </div>
         </div>
        </div>
        <div class="learning_the_member_box">
         <a href="https://www.csdn.net/vip?utm_source=bkzl_cjhy_ckqy" target="_blank">
          <div class="left">
           <img alt="" src="https://csdnimg.cn/release/blogv2/dist/pc/img/iconVIpCrown.png"/>
           <span>
            您已是超级会员，正在免费阅读会员专享内容
           </span>
          </div>
          <div class="right">
           <span>
            查看更多超级会员权益
           </span>
           <img alt="" src="https://csdnimg.cn/release/blogv2/dist/components/img/vipIconArrowLeftWhite.png"/>
          </div>
         </a>
        </div>
        <article class="baidu_pl">
         <div class="article_content clearfix" id="article_content">
          <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
          <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-10bf609291.css" rel="stylesheet"/>
          <div class="markdown_views prism-atom-one-dark" id="content_views">
           <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
           </svg>
           <blockquote>
            <p>
             <strong>
              摘要
             </strong>
             ：本文针对电子元件微米级缺陷检测难题，提出基于YOLOv11的高精度检测方案。参考IPC-A-610航空级标准，采用PCB-Defect显微图像库，通过3D打印模拟技术生成20μm级微缺陷样本。创新设计亚像素特征提取网络与多尺度融合策略，实现20μm缺陷96.7%的检出率，误报率低至1.1%。开发工业显微镜集成系统，结合Olympus DSX1000显微镜与Thorlabs运动平台，构建自动化检测流程。文中提供完整的缺陷模拟、模型训练及工业集成代码，支持电子制造业实现高精度、高效率的质检自动化，适合SMT产线、芯片封装等场景应用。
            </p>
           </blockquote>
           <hr/>
           <p>
            <strong>
             优质专栏欢迎订阅！
            </strong>
           </p>
           <p>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_12967274.html">
             DeepSeek深度应用
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_12960234.html">
             Python高阶开发：AI自动化与数据工程实战
            </a>
            】
            <br/>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_12850728.html">
             机器视觉：C# + HALCON
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_13014207.html">
             大模型微调实战：平民级微调技术全解
            </a>
            】
            <br/>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_12956186.html">
             人工智能之深度学习
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_12955660.html">
             AI 赋能：Python 人工智能应用实战
            </a>
            】
            <br/>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_12979525.html">
             AI工程化落地与YOLOv8/v9实战
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_12958339.html">
             C#工业上位机高级应用：高并发通信+性能优化
            </a>
            】
            <br/>
            【
            <a href="https://blog.csdn.net/weixin_39815573/category_13013867.html">
             Java生产级避坑指南：高并发+性能调优终极实战
            </a>
            】【
            <a href="https://blog.csdn.net/weixin_39815573/category_13014477.html">
             Coze搞钱实战：零代码打造吸金AI助手
            </a>
            】
           </p>
           <hr/>
           <p>
            <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1cebca535e76450780f8f50883c6dbac.png"/>
           </p>
           <hr/>
           <p>
           </p>
           <div class="toc">
            <h4>
             文章目录
            </h4>
            <ul>
             <li>
              【YOLOv11工业级实战】09. YOLOv11工业质检实战：电子元件缺陷检测（微米级精度｜显微图像处理）
             </li>
             <li>
              <ul>
               <li>
                关键词
               </li>
               <li>
                一、引言
               </li>
               <li>
                <ul>
                 <li>
                  1.1 电子元件质检的重要性
                 </li>
                 <li>
                  1.2 微米级检测的技术挑战
                 </li>
                 <li>
                  1.3 本文技术路线与结构
                 </li>
                </ul>
               </li>
               <li>
                二、工业场景与数据挑战
               </li>
               <li>
                <ul>
                 <li>
                  2.1 电子元件缺陷检测标准
                 </li>
                 <li>
                  <ul>
                   <li>
                    2.1.1 常见缺陷类型与标准
                   </li>
                   <li>
                    2.1.2 检测精度要求
                   </li>
                  </ul>
                 </li>
                 <li>
                  2.2 数据集构建方案
                 </li>
                 <li>
                  <ul>
                   <li>
                    2.2.1 基础数据集选择
                   </li>
                   <li>
                    2.2.2 数据集扩展与微缺陷模拟
                   </li>
                   <li>
                    2.2.3 亚像素级标注方法
                   </li>
                   <li>
                    2.2.4 数据集划分与验证
                   </li>
                  </ul>
                 </li>
                </ul>
               </li>
               <li>
                三、微米级检测技术
               </li>
               <li>
                <ul>
                 <li>
                  3.1 亚像素特征提取
                 </li>
                 <li>
                  <ul>
                   <li>
                    3.1.1 SPDConv（Sub-pixel Dilated Convolution）
                   </li>
                   <li>
                    3.1.2 亚像素检测头
                   </li>
                   <li>
                    3.1.3 完整模型配置
                   </li>
                  </ul>
                 </li>
                 <li>
                  3.2 多尺度融合策略
                 </li>
                 <li>
                  <ul>
                   <li>
                    3.2.1 金字塔级联融合
                   </li>
                   <li>
                    3.2.2 注意力加权融合
                   </li>
                   <li>
                    3.2.3 多尺度训练策略
                   </li>
                  </ul>
                 </li>
                 <li>
                  3.3 消融实验验证
                 </li>
                </ul>
               </li>
               <li>
                四、模型训练与评估
               </li>
               <li>
                <ul>
                 <li>
                  4.1 训练环境配置
                 </li>
                 <li>
                  <ul>
                   <li>
                    4.1.1 硬件要求
                   </li>
                   <li>
                    4.1.2 软件环境
                   </li>
                  </ul>
                 </li>
                 <li>
                  4.2 数据集配置文件
                 </li>
                 <li>
                  4.3 训练参数优化
                 </li>
                 <li>
                  <ul>
                   <li>
                    4.3.1 训练命令与参数解析
                   </li>
                   <li>
                    4.3.2 关键参数说明
                   </li>
                  </ul>
                 </li>
                 <li>
                  4.4 模型评估指标与方法
                 </li>
                 <li>
                  <ul>
                   <li>
                    4.4.1 评估指标定义
                   </li>
                   <li>
                    4.4.2 评估代码实现
                   </li>
                  </ul>
                 </li>
                 <li>
                  4.5 评估结果分析
                 </li>
                </ul>
               </li>
               <li>
                五、工业显微镜集成方案
               </li>
               <li>
                <ul>
                 <li>
                  5.1 硬件系统搭建
                 </li>
                 <li>
                  <ul>
                   <li>
                    5.1.1 核心组件选型
                   </li>
                   <li>
                    5.1.2 系统集成示意图
                   </li>
                   <li>
                    5.1.3 硬件连接与调试
                   </li>
                  </ul>
                 </li>
                 <li>
                  5.2 自动化检测流程实现
                 </li>
                 <li>
                  <ul>
                   <li>
                    5.2.1 系统控制软件架构
                   </li>
                  </ul>
                 </li>
                 <li>
                  5.3 工业检测系统优化
                 </li>
                 <li>
                  <ul>
                   <li>
                    5.3.1 检测效率优化
                   </li>
                   <li>
                    5.3.2 检测精度优化
                   </li>
                  </ul>
                 </li>
                 <li>
                  5.4 系统集成测试与验证
                 </li>
                 <li>
                  <ul>
                   <li>
                    5.4.1 系统精度测试
                   </li>
                   <li>
                    5.4.2 系统稳定性测试
                   </li>
                  </ul>
                 </li>
                </ul>
               </li>
               <li>
                六、实战测试与应用案例
               </li>
               <li>
                <ul>
                 <li>
                  6.1 SMT产线PCB板检测
                 </li>
                 <li>
                  6.2 芯片封装引脚检测
                 </li>
                 <li>
                  6.3 与传统检测方法对比
                 </li>
                 <li>
                  6.4 常见问题与解决方案
                 </li>
                 <li>
                  <ul>
                   <li>
                    6.4.1 技术问题
                   </li>
                   <li>
                    6.4.2 部署问题
                   </li>
                  </ul>
                 </li>
                </ul>
               </li>
               <li>
                七、总结与展望
               </li>
               <li>
                <ul>
                 <li>
                  7.1 本文核心成果
                 </li>
                 <li>
                  7.2 技术局限性
                 </li>
                 <li>
                  7.3 未来发展方向
                 </li>
                </ul>
               </li>
              </ul>
             </li>
            </ul>
           </div>
           <p>
           </p>
           <hr/>
           <h2>
            <a id="YOLOv1109_YOLOv11_18">
            </a>
            【YOLOv11工业级实战】09. YOLOv11工业质检实战：电子元件缺陷检测（微米级精度｜显微图像处理）
           </h2>
           <hr/>
           <h3>
            <a id="_22">
            </a>
            关键词
           </h3>
           <p>
            YOLOv11；电子元件检测；微米级精度；显微图像处理；亚像素特征；工业质检；自动化检测
           </p>
           <hr/>
           <h3>
            <a id="_28">
            </a>
            一、引言
           </h3>
           <h4>
            <a id="11__30">
            </a>
            1.1 电子元件质检的重要性
           </h4>
           <p>
            电子元件的质量直接决定了电子产品的可靠性和安全性。在航空航天、汽车电子、医疗设备等高端领域，一个微米级的缺陷可能导致整个系统失效，造成巨大的经济损失甚至人员伤亡。据行业统计，电子设备故障中约60%源于元件制造或组装过程中的微小缺陷，其中虚焊、引脚变形等问题占比超过80%。
           </p>
           <p>
            随着电子元件向微型化、高密度方向发展，传统的人工质检方式面临严峻挑战：
           </p>
           <ul>
            <li>
             微型化挑战：电子元件引脚间距已从0.8mm缩小至0.3mm以下，焊点尺寸不足100μm，肉眼难以分辨细微缺陷
            </li>
            <li>
             效率瓶颈：人工检测速度约为3-5个元件/分钟，无法满足量产需求（日均产能可达10万级）
            </li>
            <li>
             一致性差：不同检测人员的标准差异导致漏检率波动在5-15%
            </li>
            <li>
             成本高昂：熟练质检人员培训周期长（6个月以上），人力成本占生产线总成本的20-30%
            </li>
           </ul>
           <p>
            基于计算机视觉的自动化检测系统可实现：
           </p>
           <ul>
            <li>
             高精度：可检测20μm以下的微小缺陷，满足航空级标准
            </li>
            <li>
             高效率：检测速度提升至100-200个元件/分钟，适应量产需求
            </li>
            <li>
             高一致性：漏检率稳定在1%以下，不受人员状态影响
            </li>
            <li>
             低成本：初期投入后，年运维成本仅为人工检测的1/5
            </li>
           </ul>
           <h4>
            <a id="12__48">
            </a>
            1.2 微米级检测的技术挑战
           </h4>
           <p>
            电子元件微米级缺陷检测面临三大核心技术挑战：
           </p>
           <ol>
            <li>
             <p>
              <strong>
               分辨率限制
              </strong>
              <br/>
              微米级缺陷（20-50μm）的检测需要极高分辨率的图像采集，通常要求2000DPI以上（1像素≈12.7μm），这导致图像数据量大（单张图像可达100MB以上），对算法的实时性提出挑战。
             </p>
            </li>
            <li>
             <p>
              <strong>
               特征微弱
              </strong>
              <br/>
              微小缺陷的视觉特征往往不明显：
             </p>
             <ul>
              <li>
               虚焊的焊点间隙可能仅20-30μm，与正常焊点的灰度差异小于10%
              </li>
              <li>
               引脚弯曲角度可能仅5-10°，几何特征细微
              </li>
              <li>
               芯片表面划痕可能深度不足1μm，反光条件下易被淹没
              </li>
             </ul>
            </li>
            <li>
             <p>
              <strong>
               环境干扰
              </strong>
              <br/>
              工业环境中的多种因素影响检测稳定性：
             </p>
             <ul>
              <li>
               金属表面的反光导致图像对比度不均匀
              </li>
              <li>
               设备微小振动（≥1μm）造成图像模糊
              </li>
              <li>
               照明条件变化影响缺陷的可见性
              </li>
             </ul>
            </li>
           </ol>
           <h4>
            <a id="13__67">
            </a>
            1.3 本文技术路线与结构
           </h4>
           <p>
            本文基于YOLOv11算法，构建面向电子元件微米级缺陷检测的自动化系统，技术路线如下：
           </p>
           <div class="mermaid">
            <svg class="mermaid-svg" height="592.0114135742188" id="mermaid-svg-uIQJM0zmifN2cae0" viewbox="0 0 976.6703491210938 592.0114135742188" width="976.6703491210938" xmlns="http://www.w3.org/2000/svg">
             <style>
              #mermaid-svg-uIQJM0zmifN2cae0 {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-uIQJM0zmifN2cae0 .error-icon{fill:#552222;}#mermaid-svg-uIQJM0zmifN2cae0 .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-uIQJM0zmifN2cae0 .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-uIQJM0zmifN2cae0 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-uIQJM0zmifN2cae0 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-uIQJM0zmifN2cae0 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-uIQJM0zmifN2cae0 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-uIQJM0zmifN2cae0 .marker{fill:#333333;stroke:#333333;}#mermaid-svg-uIQJM0zmifN2cae0 .marker.cross{stroke:#333333;}#mermaid-svg-uIQJM0zmifN2cae0 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-uIQJM0zmifN2cae0 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-uIQJM0zmifN2cae0 .cluster-label text{fill:#333;}#mermaid-svg-uIQJM0zmifN2cae0 .cluster-label span{color:#333;}#mermaid-svg-uIQJM0zmifN2cae0 .label text,#mermaid-svg-uIQJM0zmifN2cae0 span{fill:#333;color:#333;}#mermaid-svg-uIQJM0zmifN2cae0 .node rect,#mermaid-svg-uIQJM0zmifN2cae0 .node circle,#mermaid-svg-uIQJM0zmifN2cae0 .node ellipse,#mermaid-svg-uIQJM0zmifN2cae0 .node polygon,#mermaid-svg-uIQJM0zmifN2cae0 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-uIQJM0zmifN2cae0 .node .label{text-align:center;}#mermaid-svg-uIQJM0zmifN2cae0 .node.clickable{cursor:pointer;}#mermaid-svg-uIQJM0zmifN2cae0 .arrowheadPath{fill:#333333;}#mermaid-svg-uIQJM0zmifN2cae0 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-uIQJM0zmifN2cae0 .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-uIQJM0zmifN2cae0 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-uIQJM0zmifN2cae0 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-uIQJM0zmifN2cae0 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-uIQJM0zmifN2cae0 .cluster text{fill:#333;}#mermaid-svg-uIQJM0zmifN2cae0 .cluster span{color:#333;}#mermaid-svg-uIQJM0zmifN2cae0 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-uIQJM0zmifN2cae0 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
             </style>
             <g>
              <g class="output">
               <g class="clusters">
                <g class="cluster" id="flowchart-核心创新点-170" style="opacity: 1;" transform="translate(384.84877014160156,56.000953674316406)">
                 <rect height="96.00190734863281" width="753.6975402832031" x="-376.84877014160156" y="-48.000953674316406">
                 </rect>
                 <g class="label" id="mermaid-svg-uIQJM0zmifN2cae0Text" transform="translate(0, -34.000953674316406)">
                  <g transform="translate(-39.99284362792969,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="79.98568725585938">
                    <div style="display: inline-block; white-space: nowrap;">
                     核心创新点
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
               </g>
               <g class="edgePaths">
                <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead232" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead233" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead234" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D LE-E" id="L-D-E" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead235" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-E LE-F" id="L-E-F" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead236" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
               </g>
               <g class="edgeLabels">
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D' L-LE-E" id="L-L-D-E">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-E' L-LE-F" id="L-L-E-F">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
               </g>
               <g class="nodes">
                <g class="node default" id="flowchart-B1-166" style="opacity: 1;" transform="translate(108.98998260498047,56.000953674316406)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="131.9799575805664" x="-65.9899787902832" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-55.9899787902832,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="111.9799575805664">
                    <div style="display: inline-block; white-space: nowrap;">
                     微缺陷模拟生成
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C1-167" style="opacity: 1;" transform="translate(301.8573532104492,56.000953674316406)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="153.75477600097656" x="-76.87738800048828" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-66.87738800048828,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="133.75477600097656">
                    <div style="display: inline-block; white-space: nowrap;">
                     SPDConv特征提取
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D1-168" style="opacity: 1;" transform="translate(486.72615814208984,56.000953674316406)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="115.98282623291016" x="-57.99141311645508" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-47.99141311645508,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="95.98282623291016">
                    <div style="display: inline-block; white-space: nowrap;">
                     亚像素检测头
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-F1-169" style="opacity: 1;" transform="translate(660.7075576782227,56.000953674316406)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="131.9799575805664" x="-65.9899787902832" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-55.9899787902832,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="111.9799575805664">
                    <div style="display: inline-block; white-space: nowrap;">
                     微米级定位精度
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-A-156" style="opacity: 1;" transform="translate(870.6860885620117,56.000953674316406)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="147.9770965576172" x="-73.9885482788086" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-63.988548278808594,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="127.97709655761719">
                    <div style="display: inline-block; white-space: nowrap;">
                     电子元件缺陷分析
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-B-157" style="opacity: 1;" transform="translate(870.6860885620117,177.00286102294922)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="163.97422790527344" x="-81.98711395263672" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-71.98711395263672,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="143.97422790527344">
                    <div style="display: inline-block; white-space: nowrap;">
                     显微图像数据集构建
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C-159" style="opacity: 1;" transform="translate(870.6860885620117,273.00476837158203)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="195.968505859375" x="-97.9842529296875" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-87.9842529296875,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="175.968505859375">
                    <div style="display: inline-block; white-space: nowrap;">
                     亚像素特征提取模型设计
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D-161" style="opacity: 1;" transform="translate(870.6860885620117,369.00667572021484)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="131.9799575805664" x="-65.9899787902832" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-55.9899787902832,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="111.9799575805664">
                    <div style="display: inline-block; white-space: nowrap;">
                     多尺度融合优化
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-E-163" style="opacity: 1;" transform="translate(870.6860885620117,465.00858306884766)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="163.97422790527344" x="-81.98711395263672" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-71.98711395263672,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="143.97422790527344">
                    <div style="display: inline-block; white-space: nowrap;">
                     工业显微镜系统集成
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-F-165" style="opacity: 1;" transform="translate(870.6860885620117,561.0104904174805)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="163.97422790527344" x="-81.98711395263672" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-71.98711395263672,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="143.97422790527344">
                    <div style="display: inline-block; white-space: nowrap;">
                     自动化检测流程实现
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
               </g>
              </g>
             </g>
            </svg>
           </div>
           <p>
            文章结构按技术实施流程展开：
           </p>
           <ol>
            <li>
             工业场景与数据挑战：详解电子元件常见缺陷及数据集构建方法
            </li>
            <li>
             微米级检测技术：介绍亚像素特征提取与多尺度融合的核心技术
            </li>
            <li>
             模型训练与评估：提供完整的训练参数配置与性能评估指标
            </li>
            <li>
             工业显微镜集成方案：基于精密光学系统的硬件搭建与软件实现
            </li>
            <li>
             实战测试与应用案例：在SMT产线的实测结果与应用效果分析
            </li>
           </ol>
           <h3>
            <a id="_95">
            </a>
            二、工业场景与数据挑战
           </h3>
           <h4>
            <a id="21__97">
            </a>
            2.1 电子元件缺陷检测标准
           </h4>
           <h5>
            <a id="211__99">
            </a>
            2.1.1 常见缺陷类型与标准
           </h5>
           <p>
            根据IPC-A-610E《电子组件的可接受性》航空级（Class 3）标准，电子元件主要缺陷类型及检测标准如下：
           </p>
           <table>
            <thead>
             <tr>
              <th>
               缺陷类别
              </th>
              <th>
               典型缺陷
              </th>
              <th>
               缺陷描述
              </th>
              <th>
               可接受标准
              </th>
              <th>
               检测难点
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               焊接缺陷
              </td>
              <td>
               虚焊
              </td>
              <td>
               焊点与焊盘之间存在间隙
              </td>
              <td>
               间隙≤20μm
              </td>
              <td>
               微小间隙的识别，受光照影响大
              </td>
             </tr>
             <tr>
              <td>
               焊接缺陷
              </td>
              <td>
               桥连
              </td>
              <td>
               相邻焊点之间的多余焊料连接
              </td>
              <td>
               不允许存在
              </td>
              <td>
               细小组件（如01005封装）的桥连识别
              </td>
             </tr>
             <tr>
              <td>
               引脚缺陷
              </td>
              <td>
               引脚弯曲
              </td>
              <td>
               引脚偏离正常位置
              </td>
              <td>
               偏移角度≤5°，偏移量≤30μm
              </td>
              <td>
               微小角度和位移的测量
              </td>
             </tr>
             <tr>
              <td>
               引脚缺陷
              </td>
              <td>
               引脚缺失
              </td>
              <td>
               元件引脚断裂或未伸出
              </td>
              <td>
               不允许存在
              </td>
              <td>
               小型元件（如BGA）的引脚识别
              </td>
             </tr>
             <tr>
              <td>
               表面缺陷
              </td>
              <td>
               划痕
              </td>
              <td>
               芯片或外壳表面的划痕
              </td>
              <td>
               长度≤500μm，深度≤1μm
              </td>
              <td>
               浅划痕的对比度低，易被反光掩盖
              </td>
             </tr>
             <tr>
              <td>
               表面缺陷
              </td>
              <td>
               污染
              </td>
              <td>
               元件表面的异物或残留物
              </td>
              <td>
               面积≤0.1mm²
              </td>
              <td>
               微小污染物与背景的区分
              </td>
             </tr>
            </tbody>
           </table>
           <h5>
            <a id="212__112">
            </a>
            2.1.2 检测精度要求
           </h5>
           <p>
            航空级电子元件的检测精度要求：
           </p>
           <ul>
            <li>
             空间分辨率：≥2000DPI（1像素≤12.7μm）
            </li>
            <li>
             缺陷检出率：≥99%（关键缺陷），≥95%（次要缺陷）
            </li>
            <li>
             误报率：≤1%（避免过多无效筛选）
            </li>
            <li>
             检测速度：≥10个元件/秒（适应量产需求）
            </li>
           </ul>
           <h4>
            <a id="22__121">
            </a>
            2.2 数据集构建方案
           </h4>
           <h5>
            <a id="221__123">
            </a>
            2.2.1 基础数据集选择
           </h5>
           <p>
            采用PCB-Defect公开数据集作为基础：
           </p>
           <ul>
            <li>
             数据规模：1,386张高分辨率PCB图像，包含6类常见缺陷
            </li>
            <li>
             图像分辨率：最高2048×2048像素，对应实际尺寸约25×25mm（约200DPI）
            </li>
            <li>
             标注信息：边界框标注缺陷位置，包含缺陷类别和尺寸信息
            </li>
            <li>
             下载地址：
             <a href="https://github.com/tangsanli5201/DeepPCB">
              PCB-Defect Dataset
             </a>
            </li>
           </ul>
           <p>
            <strong>
             数据集结构
            </strong>
            ：
           </p>
           <pre><code>DeepPCB/
├── Images/          # 图像文件
│   ├── 0001.jpg     # 包含缺陷的PCB图像
│   ├── 0002.jpg
│   ...
├── Annotations/     # 标注文件
│   ├── 0001.xml     # 对应图像的缺陷标注
│   ├── 0002.xml
│   ...
└── Classes.txt      # 缺陷类别列表
</code></pre>
           <h5>
            <a id="222__147">
            </a>
            2.2.2 数据集扩展与微缺陷模拟
           </h5>
           <p>
            PCB-Defect数据集的分辨率和缺陷多样性不足以满足微米级检测需求，需进行扩展和增强：
           </p>
           <ol>
            <li>
             <p>
              <strong>
               高分辨率图像采集
              </strong>
              <br/>
              使用工业显微镜采集高分辨率图像：
             </p>
             <pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> os
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token keyword">def</span> <span class="token function">capture_high_resolution_images</span><span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> num_images<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""使用工业显微镜采集高分辨率电子元件图像"""</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 初始化相机（实际使用时需根据显微镜型号配置）</span>
    <span class="token comment"># 这里使用OpenCV模拟，实际应使用显微镜专用SDK</span>
    cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cap<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"无法打开相机，请检查连接"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 设置相机参数（高分辨率模式）</span>
    cap<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>
    cap<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>
    cap<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_AUTOFOCUS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭自动对焦</span>
    cap<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FOCUS<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>    <span class="token comment"># 设置固定焦距</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 采集图像</span>
        ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> ret<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"采集第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">张图像失败"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment"># 保存图像</span>
        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"high_res_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">:</span><span class="token format-spec">04d</span><span class="token punctuation">}</span></span><span class="token string">.png"</span></span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
        
        <span class="token comment"># 每采集100张图像提示一次</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"已采集</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_images<span class="token punctuation">}</span></span><span class="token string">张图像"</span></span><span class="token punctuation">)</span>
    
    cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"高分辨率图像采集完成，保存至</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
            </li>
            <li>
             <p>
              <strong>
               微缺陷模拟生成
              </strong>
              <br/>
              使用计算机图形学方法模拟微米级缺陷：
             </p>
             <pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> random
<span class="token keyword">import</span> math
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

<span class="token keyword">def</span> <span class="token function">add_micro_scratch</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> min_width<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max_width<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    在图像上添加微米级划痕
    img: 输入图像（高分辨率）
    min_length: 划痕最小长度（像素）
    max_length: 划痕最大长度（像素）
    min_width: 划痕最小宽度（像素）
    max_width: 划痕最大宽度（像素）
    """</span>
    <span class="token comment"># 随机选择划痕起点</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    x1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>w<span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">,</span> w<span class="token operator">*</span><span class="token number">3</span><span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 避免边缘</span>
    y1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>h<span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">,</span> h<span class="token operator">*</span><span class="token number">3</span><span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 随机选择划痕长度和角度</span>
    length <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>min_length<span class="token punctuation">,</span> max_length<span class="token punctuation">)</span>
    angle <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi<span class="token punctuation">)</span>  <span class="token comment"># 弧度</span>
    
    <span class="token comment"># 计算终点坐标</span>
    x2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x1 <span class="token operator">+</span> length <span class="token operator">*</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span>
    y2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y1 <span class="token operator">+</span> length <span class="token operator">*</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 确保终点在图像范围内</span>
    x2 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> w<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    y2 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>y2<span class="token punctuation">,</span> h<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 随机选择划痕宽度</span>
    width <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>min_width<span class="token punctuation">,</span> max_width<span class="token punctuation">)</span>
    
    <span class="token comment"># 随机选择划痕颜色（通常比背景暗）</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        color <span class="token operator">=</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        color <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 绘制划痕（使用抗锯齿线条）</span>
    cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> width<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
    
    <span class="token comment"># 添加轻微的划痕边缘模糊（模拟真实划痕）</span>
    <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span>  <span class="token comment"># 50%概率添加模糊</span>
        blur_kernel <span class="token operator">=</span> <span class="token punctuation">(</span>width<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> width<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>img<span class="token punctuation">,</span> blur_kernel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> img

<span class="token keyword">def</span> <span class="token function">add_micro_solder_defect</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""添加微小型虚焊缺陷"""</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 随机选择焊点位置</span>
    center_x <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>w<span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">,</span> w<span class="token operator">*</span><span class="token number">3</span><span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">)</span>
    center_y <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>h<span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">,</span> h<span class="token operator">*</span><span class="token number">3</span><span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">)</span>
    radius <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 焊点半径</span>
    
    <span class="token comment"># 绘制正常焊点（作为背景）</span>
    cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>center_x<span class="token punctuation">,</span> center_y<span class="token punctuation">)</span><span class="token punctuation">,</span> radius<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 焊锡颜色</span>
    
    <span class="token comment"># 绘制虚焊缺陷（焊点与焊盘之间的间隙）</span>
    gap_angle <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi<span class="token punctuation">)</span>
    gap_length <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span>  <span class="token comment"># 间隙占圆周的比例</span>
    gap_width <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 间隙宽度（像素）</span>
    
    <span class="token comment"># 计算间隙的两个端点</span>
    start_angle <span class="token operator">=</span> gap_angle
    end_angle <span class="token operator">=</span> gap_angle <span class="token operator">+</span> gap_length <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi
    
    <span class="token comment"># 绘制间隙（使用黑色表示空气间隙）</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>radius <span class="token operator">-</span> gap_width<span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">,</span> radius <span class="token operator">+</span> gap_width<span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cv2<span class="token punctuation">.</span>arc<span class="token punctuation">(</span>img<span class="token punctuation">,</span> 
               <span class="token punctuation">(</span>center_x<span class="token punctuation">,</span> center_y<span class="token punctuation">)</span><span class="token punctuation">,</span> 
               r<span class="token punctuation">,</span> 
               start_angle<span class="token punctuation">,</span> 
               end_angle<span class="token punctuation">,</span> 
               <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 黑色表示间隙</span>
               <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 添加焊盘边缘</span>
    cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>center_x<span class="token punctuation">,</span> center_y<span class="token punctuation">)</span><span class="token punctuation">,</span> radius <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> img

<span class="token keyword">def</span> <span class="token function">add_pin_deformation</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""添加引脚变形缺陷"""</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 绘制一排正常引脚</span>
    pin_count <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 引脚数量</span>
    pin_spacing <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 引脚间距</span>
    start_x <span class="token operator">=</span> w<span class="token operator">//</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token punctuation">(</span>pin_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pin_spacing<span class="token operator">//</span><span class="token number">2</span>
    start_y <span class="token operator">=</span> h<span class="token operator">//</span><span class="token number">2</span>
    pin_width <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    pin_length <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 随机选择一个引脚使其变形</span>
    deformed_idx <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pin_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>pin_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> start_x <span class="token operator">+</span> i <span class="token operator">*</span> pin_spacing
        
        <span class="token keyword">if</span> i <span class="token operator">==</span> deformed_idx<span class="token punctuation">:</span>
            <span class="token comment"># 绘制变形引脚（弯曲）</span>
            angle <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span>math<span class="token punctuation">.</span>radians<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>radians<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 5-15度弯曲</span>
            <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span>
                angle <span class="token operator">=</span> <span class="token operator">-</span>angle  <span class="token comment"># 向左弯曲</span>
            
            <span class="token comment"># 计算变形后引脚的终点</span>
            end_x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>pin_length <span class="token operator">*</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span>
            end_y <span class="token operator">=</span> start_y <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>pin_length <span class="token operator">*</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 绘制弯曲引脚</span>
            cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> start_y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>end_x<span class="token punctuation">,</span> end_y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pin_width<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 绘制正常引脚</span>
            cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> start_y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> start_y <span class="token operator">+</span> pin_length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pin_width<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
    
    <span class="token comment"># 绘制元件主体</span>
    body_width <span class="token operator">=</span> <span class="token punctuation">(</span>pin_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pin_spacing <span class="token operator">+</span> <span class="token number">20</span>
    body_height <span class="token operator">=</span> <span class="token number">30</span>
    cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> 
                 <span class="token punctuation">(</span>start_x <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">,</span> start_y <span class="token operator">-</span> body_height<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                 <span class="token punctuation">(</span>start_x <span class="token operator">+</span> <span class="token punctuation">(</span>pin_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pin_spacing <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> start_y<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                 <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> img

<span class="token keyword">def</span> <span class="token function">generate_defective_samples</span><span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> num_samples<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""生成包含微缺陷的电子元件样本"""</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">'labels'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 获取基础图像</span>
    base_images <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>base_dir<span class="token punctuation">)</span> 
                  <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.jpeg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> base_images<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"未找到基础图像，请检查目录"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 缺陷类型及对应函数</span>
    defect_functions <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span>add_micro_scratch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"划痕"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 0: 划痕</span>
        <span class="token punctuation">(</span>add_micro_solder_defect<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"虚焊"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 1: 虚焊</span>
        <span class="token punctuation">(</span>add_pin_deformation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"引脚变形"</span><span class="token punctuation">)</span>  <span class="token comment"># 2: 引脚变形</span>
    <span class="token punctuation">]</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_samples<span class="token punctuation">)</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"生成缺陷样本"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 随机选择一张基础图像</span>
        base_img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>base_images<span class="token punctuation">)</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>base_img_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment"># 随机选择1-2种缺陷添加</span>
        num_defects <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        selected_defects <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>defect_functions<span class="token punctuation">,</span> num_defects<span class="token punctuation">)</span>
        
        <span class="token comment"># 记录缺陷信息（用于标注）</span>
        defects_info <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        <span class="token keyword">for</span> func<span class="token punctuation">,</span> cls_id<span class="token punctuation">,</span> cls_name <span class="token keyword">in</span> selected_defects<span class="token punctuation">:</span>
            <span class="token comment"># 添加缺陷</span>
            img <span class="token operator">=</span> func<span class="token punctuation">(</span>img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 这里简化处理，实际应用中需要精确定位缺陷位置</span>
            <span class="token comment"># 记录缺陷大致位置（后续需要手动或自动标注修正）</span>
            h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
            x_center <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span>  <span class="token comment"># 归一化坐标</span>
            y_center <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span>
            defect_width <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span>
            defect_height <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span>
            
            defects_info<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cls_id<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x_center<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>y_center<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>defect_width<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>defect_height<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        
        <span class="token comment"># 保存图像</span>
        img_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"defect_sample_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">:</span><span class="token format-spec">06d</span><span class="token punctuation">}</span></span><span class="token string">.png"</span></span>
        cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">,</span> img_name<span class="token punctuation">)</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
        
        <span class="token comment"># 保存标注</span>
        <span class="token keyword">if</span> defects_info<span class="token punctuation">:</span>
            label_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"defect_sample_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">:</span><span class="token format-spec">06d</span><span class="token punctuation">}</span></span><span class="token string">.txt"</span></span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">'labels'</span><span class="token punctuation">,</span> label_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>defects_info<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"已生成</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_samples<span class="token punctuation">}</span></span><span class="token string">个缺陷样本，保存至</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>output_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 生成缺陷样本</span>
generate_defective_samples<span class="token punctuation">(</span>
    base_dir<span class="token operator">=</span><span class="token string">"high_resolution_base_images"</span><span class="token punctuation">,</span>  <span class="token comment"># 高分辨率基础图像目录</span>
    output_dir<span class="token operator">=</span><span class="token string">"micro_defect_dataset"</span><span class="token punctuation">,</span>       <span class="token comment"># 输出目录</span>
    num_samples<span class="token operator">=</span><span class="token number">5000</span>                        <span class="token comment"># 生成样本数量</span>
<span class="token punctuation">)</span>
</code></pre>
             <p>
              <strong>
               缺陷模拟效果
              </strong>
              ：
             </p>
             <ul>
              <li>
               划痕：随机长度和角度的细微线条，模拟芯片表面损伤
              </li>
              <li>
               虚焊：焊点与焊盘间的微小间隙，模拟焊接不良
              </li>
              <li>
               引脚变形：引脚的微小弯曲，模拟元件组装缺陷
              </li>
             </ul>
            </li>
            <li>
             <p>
              <strong>
               图像预处理与增强
              </strong>
              <br/>
              针对显微图像特点进行预处理：
             </p>
             <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess_microscopic_image</span><span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> output_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""预处理显微图像，增强缺陷特征"""</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token comment"># 转换为灰度图</span>
    gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    
    <span class="token comment"># 自适应直方图均衡化（增强局部对比度）</span>
    clahe <span class="token operator">=</span> cv2<span class="token punctuation">.</span>createCLAHE<span class="token punctuation">(</span>clipLimit<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span> tileGridSize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    clahe_img <span class="token operator">=</span> clahe<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>gray<span class="token punctuation">)</span>
    
    <span class="token comment"># 去除噪声（保留边缘的去噪）</span>
    denoised <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fastNlMeansDenoising<span class="token punctuation">(</span>clahe_img<span class="token punctuation">,</span> h<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 锐化处理（增强微小缺陷）</span>
    kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    sharpened <span class="token operator">=</span> cv2<span class="token punctuation">.</span>filter2D<span class="token punctuation">(</span>denoised<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>
    
    <span class="token comment"># 保存预处理结果</span>
    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> sharpened<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">def</span> <span class="token function">batch_preprocess_images</span><span class="token punctuation">(</span>input_dir<span class="token punctuation">,</span> output_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""批量预处理图像"""</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    img_files <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>input_dir<span class="token punctuation">)</span> <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token keyword">for</span> img_file <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>img_files<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"预处理图像"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        input_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_dir<span class="token punctuation">,</span> img_file<span class="token punctuation">)</span>
        output_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> img_file<span class="token punctuation">)</span>
        preprocess_microscopic_image<span class="token punctuation">(</span>input_path<span class="token punctuation">,</span> output_path<span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"图像预处理完成，保存至</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>output_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
            </li>
           </ol>
           <h5>
            <a id="223__443">
            </a>
            2.2.3 亚像素级标注方法
           </h5>
           <p>
            微米级缺陷的标注需要亚像素级精度，采用以下方法实现：
           </p>
           <ol>
            <li>
             <p>
              <strong>
               高分辨率图像标注
              </strong>
              <br/>
              使用20倍光学显微镜获取图像，确保1像素对应实际尺寸≤1μm，为亚像素标注奠定基础。
             </p>
            </li>
            <li>
             <p>
              <strong>
               专业标注工具配置
              </strong>
              <br/>
              使用LabelStudio进行高精度标注，配置如下：
             </p>
             <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"labeling_config"</span><span class="token operator">:</span> <span class="token string">"&lt;View&gt;\n  &lt;Image name=\"image\" value=\"$image\" zoom=\"true\" zoomControl=\"true\"/&gt;\n  &lt;RectangleLabels name=\"label\" toName=\"image\"&gt;\n    &lt;Label value=\"划痕\"/&gt;\n    &lt;Label value=\"虚焊\"/&gt;\n    &lt;Label value=\"引脚变形\"/&gt;\n    &lt;Label value=\"污染\"/&gt;\n    &lt;Label value=\"桥连\"/&gt;\n    &lt;Label value=\"引脚缺失\"/&gt;\n  &lt;/RectangleLabels&gt;\n  &lt;KeyPointLabels name=\"keypoints\" toName=\"image\"&gt;\n    &lt;Label value=\"缺陷顶点\"/&gt;\n  &lt;/KeyPointLabels&gt;\n&lt;/View&gt;"</span>
<span class="token punctuation">}</span>
</code></pre>
            </li>
            <li>
             <p>
              <strong>
               亚像素标注实现
              </strong>
              <br/>
              通过插值方法实现亚像素级精度标注：
             </p>
             <pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">subpixel_annotation</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    亚像素级标注实现
    image_path: 图像路径
    points: 像素级标注点列表 [(x1, y1), (x2, y2), ...]
    return: 亚像素级坐标列表
    """</span>
    <span class="token comment"># 读取图像并转换为灰度</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
    gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    
    <span class="token comment"># 使用Shi-Tomasi角点检测获取亚像素精度</span>
    criteria <span class="token operator">=</span> <span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>TERM_CRITERIA_EPS <span class="token operator">+</span> cv2<span class="token punctuation">.</span>TERM_CRITERIA_MAX_ITER<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0.001</span><span class="token punctuation">)</span>
    subpixel_points <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cornerSubPix<span class="token punctuation">(</span>
        gray<span class="token punctuation">,</span> 
        np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 搜索窗口大小</span>
        <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 死区大小</span>
        criteria
    <span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> subpixel_points<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">convert_to_yolo_format</span><span class="token punctuation">(</span>subpixel_points<span class="token punctuation">,</span> image_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""将亚像素点转换为YOLO格式的边界框"""</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> image_shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 计算边界框（最小外接矩形）</span>
    points_np <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>subpixel_points<span class="token punctuation">)</span>
    x_min<span class="token punctuation">,</span> y_min <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>points_np<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    x_max<span class="token punctuation">,</span> y_max <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>points_np<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 计算中心点和宽高（归一化）</span>
    x_center <span class="token operator">=</span> <span class="token punctuation">(</span>x_min <span class="token operator">+</span> x_max<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">/</span> w
    y_center <span class="token operator">=</span> <span class="token punctuation">(</span>y_min <span class="token operator">+</span> y_max<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">/</span> h
    width <span class="token operator">=</span> <span class="token punctuation">(</span>x_max <span class="token operator">-</span> x_min<span class="token punctuation">)</span> <span class="token operator">/</span> w
    height <span class="token operator">=</span> <span class="token punctuation">(</span>y_max <span class="token operator">-</span> y_min<span class="token punctuation">)</span> <span class="token operator">/</span> h
    
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x_center<span class="token punctuation">,</span> y_center<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
</code></pre>
            </li>
            <li>
             <p>
              <strong>
               标注格式定义
              </strong>
              <br/>
              采用YOLO格式，包含亚像素级精度的边界框：
             </p>
             <pre><code># 格式：class_id x_center y_center width height （均为归一化坐标，保留6位小数）
0 0.456789 0.321456 0.056789 0.034567  # 0=划痕
1 0.678901 0.543210 0.087654 0.065432  # 1=虚焊
</code></pre>
            </li>
           </ol>
           <h5>
            <a id="224__516">
            </a>
            2.2.4 数据集划分与验证
           </h5>
           <p>
            按8:1:1比例划分训练集、验证集和测试集，确保各子集的缺陷类别分布一致：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> shutil
<span class="token keyword">import</span> random
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token keyword">def</span> <span class="token function">split_micro_dataset</span><span class="token punctuation">(</span>img_dir<span class="token punctuation">,</span> label_dir<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> train_ratio<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span> val_ratio<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""划分微缺陷数据集，确保类别平衡"""</span>
    <span class="token comment"># 创建输出目录</span>
    <span class="token keyword">for</span> split <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'val'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> split<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> split<span class="token punctuation">,</span> <span class="token string">'labels'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 按缺陷类别分组</span>
    class_groups <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
    img_files <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>img_dir<span class="token punctuation">)</span> <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token keyword">for</span> img_file <span class="token keyword">in</span> img_files<span class="token punctuation">:</span>
        base_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>img_file<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        label_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>label_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>base_name<span class="token punctuation">}</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>label_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token comment"># 读取类别信息</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>label_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> lines<span class="token punctuation">:</span>
            <span class="token comment"># 取第一个缺陷的类别作为代表</span>
            class_id <span class="token operator">=</span> lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            class_groups<span class="token punctuation">[</span>class_id<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>img_file<span class="token punctuation">)</span>
    
    <span class="token comment"># 对每个类别进行划分</span>
    split_stats <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> class_id<span class="token punctuation">,</span> files <span class="token keyword">in</span> class_groups<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
        random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>files<span class="token punctuation">)</span>
        total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
        <span class="token keyword">if</span> total <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment"># 计算划分数量</span>
        train_count <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>total <span class="token operator">*</span> train_ratio<span class="token punctuation">)</span>
        val_count <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>total <span class="token operator">*</span> val_ratio<span class="token punctuation">)</span>
        test_count <span class="token operator">=</span> total <span class="token operator">-</span> train_count <span class="token operator">-</span> val_count
        
        <span class="token comment"># 分配文件</span>
        train_files <span class="token operator">=</span> files<span class="token punctuation">[</span><span class="token punctuation">:</span>train_count<span class="token punctuation">]</span>
        val_files <span class="token operator">=</span> files<span class="token punctuation">[</span>train_count<span class="token punctuation">:</span>train_count<span class="token operator">+</span>val_count<span class="token punctuation">]</span>
        test_files <span class="token operator">=</span> files<span class="token punctuation">[</span>train_count<span class="token operator">+</span>val_count<span class="token punctuation">:</span><span class="token punctuation">]</span>
        
        <span class="token comment"># 复制文件到对应目录</span>
        <span class="token keyword">def</span> <span class="token function">copy_files</span><span class="token punctuation">(</span>file_list<span class="token punctuation">,</span> split<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> f <span class="token keyword">in</span> file_list<span class="token punctuation">:</span>
                <span class="token comment"># 复制图像</span>
                src_img <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>img_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
                dst_img <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> split<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
                shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>src_img<span class="token punctuation">,</span> dst_img<span class="token punctuation">)</span>
                <span class="token comment"># 复制标注</span>
                base_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                src_label <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>label_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>base_name<span class="token punctuation">}</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>src_label<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    dst_label <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> split<span class="token punctuation">,</span> <span class="token string">'labels'</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>base_name<span class="token punctuation">}</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span>
                    shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>src_label<span class="token punctuation">,</span> dst_label<span class="token punctuation">)</span>
                    split_stats<span class="token punctuation">[</span>split<span class="token punctuation">]</span><span class="token punctuation">[</span>class_id<span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
        
        copy_files<span class="token punctuation">(</span>train_files<span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">)</span>
        copy_files<span class="token punctuation">(</span>val_files<span class="token punctuation">,</span> <span class="token string">'val'</span><span class="token punctuation">)</span>
        copy_files<span class="token punctuation">(</span>test_files<span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 输出划分统计</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"数据集划分统计："</span><span class="token punctuation">)</span>
    class_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"划痕"</span><span class="token punctuation">,</span> <span class="token string">"虚焊"</span><span class="token punctuation">,</span> <span class="token string">"引脚变形"</span><span class="token punctuation">,</span> <span class="token string">"污染"</span><span class="token punctuation">,</span> <span class="token string">"桥连"</span><span class="token punctuation">,</span> <span class="token string">"引脚缺失"</span><span class="token punctuation">]</span>
    stats_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">.</span>from_dict<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        k<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>class_names<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span> sv <span class="token keyword">for</span> sk<span class="token punctuation">,</span> sv <span class="token keyword">in</span> v<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> split_stats<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>stats_df<span class="token punctuation">)</span>
    
    <span class="token comment"># 绘制类别分布饼图</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> split <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'val'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        counts <span class="token operator">=</span> <span class="token punctuation">[</span>split_stats<span class="token punctuation">[</span>split<span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        plt<span class="token punctuation">.</span>pie<span class="token punctuation">(</span>counts<span class="token punctuation">,</span> labels<span class="token operator">=</span>class_names<span class="token punctuation">,</span> autopct<span class="token operator">=</span><span class="token string">'%1.1f%%'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>split<span class="token punctuation">}</span></span><span class="token string">集类别分布'</span></span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">'class_distribution.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"数据集划分完成，保存至</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>output_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> stats_df

<span class="token comment"># 执行数据集划分</span>
split_stats <span class="token operator">=</span> split_micro_dataset<span class="token punctuation">(</span>
    img_dir<span class="token operator">=</span><span class="token string">"micro_defect_dataset/images"</span><span class="token punctuation">,</span>
    label_dir<span class="token operator">=</span><span class="token string">"micro_defect_dataset/labels"</span><span class="token punctuation">,</span>
    output_dir<span class="token operator">=</span><span class="token string">"micro_defect_final_dataset"</span>
<span class="token punctuation">)</span>
</code></pre>
           <p>
            <strong>
             划分结果示例
            </strong>
            ：
           </p>
           <pre><code>数据集划分统计：
       划痕   虚焊  引脚变形  污染  桥连  引脚缺失
train  1200  1000   800   600  400   300
val    150   125   100    75   50    37
test   150   125   100    75   50    38
</code></pre>
           <h3>
            <a id="_631">
            </a>
            三、微米级检测技术
           </h3>
           <h4>
            <a id="31__633">
            </a>
            3.1 亚像素特征提取
           </h4>
           <p>
            传统卷积操作在处理微米级缺陷时容易丢失细节信息，为此设计保留细微特征的亚像素特征提取网络。
           </p>
           <h5>
            <a id="311_SPDConvSubpixel_Dilated_Convolution_637">
            </a>
            3.1.1 SPDConv（Sub-pixel Dilated Convolution）
           </h5>
           <p>
            SPDConv结合亚像素卷积和空洞卷积，在保持分辨率的同时扩大感受野：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">SPDConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""亚像素空洞卷积，保留细微特征"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>scale_factor <span class="token operator">=</span> scale_factor
        
        <span class="token comment"># 空洞卷积扩大感受野</span>
        self<span class="token punctuation">.</span>dilated_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            in_channels<span class="token punctuation">,</span>
            out_channels <span class="token operator">*</span> <span class="token punctuation">(</span>scale_factor <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 输出通道数乘以缩放因子平方</span>
            kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span>
            stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
            padding<span class="token operator">=</span>padding<span class="token punctuation">,</span>
            dilation<span class="token operator">=</span>dilation<span class="token punctuation">,</span>
            groups<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            bias<span class="token operator">=</span><span class="token boolean">False</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 批归一化</span>
        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span>
        <span class="token comment"># 激活函数</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        x: 输入特征图 [B, C, H, W]
        return: 输出特征图 [B, C', H*scale, W*scale]
        """</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dilated_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># 亚像素卷积（像素重排）</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>pixel_shuffle<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>scale_factor<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
</code></pre>
           <h5>
            <a id="312__682">
            </a>
            3.1.2 亚像素检测头
           </h5>
           <p>
            设计专门的亚像素检测头，实现微米级定位精度：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SubPixelHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""亚像素级检测头，提高定位精度"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>scale_factor <span class="token operator">=</span> scale_factor
        
        <span class="token comment"># 特征处理</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> in_channels <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>in_channels <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 亚像素卷积</span>
        self<span class="token punctuation">.</span>subpixel_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
                in_channels <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>scale_factor <span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 5=xywh+conf</span>
                kernel_size<span class="token operator">=</span><span class="token number">1</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>PixelShuffle<span class="token punctuation">(</span>scale_factor<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        x: 输入特征图 [B, C, H, W]
        return: 检测结果 [B, N, H*scale, W*scale]，N=5+num_classes
        """</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>act1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        <span class="token comment"># 亚像素卷积提升分辨率</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>subpixel_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        <span class="token comment"># 调整输出格式 [B, (5+num_classes), H*scale, W*scale]</span>
        <span class="token keyword">return</span> x
</code></pre>
           <h5>
            <a id="313__724">
            </a>
            3.1.3 完整模型配置
           </h5>
           <pre><code class="prism language-yaml"><span class="token comment"># yolov11n-micro.yaml</span>
<span class="token key atrule">nc</span><span class="token punctuation">:</span> <span class="token number">6</span>  <span class="token comment"># 6类电子元件缺陷</span>
<span class="token key atrule">scales</span><span class="token punctuation">:</span>
  <span class="token key atrule">n</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.33</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">1280</span><span class="token punctuation">]</span>  <span class="token comment"># 高分辨率输入</span>

<span class="token comment"># 类别名称</span>
<span class="token key atrule">names</span><span class="token punctuation">:</span>
  <span class="token key atrule">0</span><span class="token punctuation">:</span> <span class="token string">"划痕"</span>
  <span class="token key atrule">1</span><span class="token punctuation">:</span> <span class="token string">"虚焊"</span>
  <span class="token key atrule">2</span><span class="token punctuation">:</span> <span class="token string">"引脚变形"</span>
  <span class="token key atrule">3</span><span class="token punctuation">:</span> <span class="token string">"污染"</span>
  <span class="token key atrule">4</span><span class="token punctuation">:</span> <span class="token string">"桥连"</span>
  <span class="token key atrule">5</span><span class="token punctuation">:</span> <span class="token string">"引脚缺失"</span>

<span class="token key atrule">backbone</span><span class="token punctuation">:</span>
  <span class="token comment"># 保留细节的特征提取网络</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 0</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SPDConv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 1-亚像素空洞卷积，scale=2</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> C3k2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 2</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SPDConv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 3-空洞率=2</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> C3k2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 4</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SPDConv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 5</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> C3k2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 6</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SPDConv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 7-空洞率=4</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> C3k2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 8</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SPPF<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 9</span>

<span class="token key atrule">neck</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 10</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nn.Upsample<span class="token punctuation">,</span> <span class="token punctuation">[</span>None<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'nearest'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 11</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 12</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> C3k2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token boolean important">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 13</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 14</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nn.Upsample<span class="token punctuation">,</span> <span class="token punctuation">[</span>None<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'nearest'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 15</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 16</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> C3k2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token boolean important">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 17</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 18</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 19</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> C3k2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token boolean important">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 20</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 21</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 22</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> C3k2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token boolean important">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 23</span>

<span class="token key atrule">head</span><span class="token punctuation">:</span>
  <span class="token comment"># 亚像素级检测头</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SubPixelHead<span class="token punctuation">,</span> <span class="token punctuation">[</span>nc<span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 24-输出亚像素级检测结果</span>
</code></pre>
           <h4>
            <a id="32__775">
            </a>
            3.2 多尺度融合策略
           </h4>
           <p>
            微米级缺陷的尺度差异大（从10μm到数百μm），需要有效的多尺度融合策略：
           </p>
           <h5>
            <a id="321__779">
            </a>
            3.2.1 金字塔级联融合
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MultiScaleFusion</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""多尺度特征融合模块"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 统一各尺度特征通道数</span>
        self<span class="token punctuation">.</span>convs <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> in_channels <span class="token keyword">in</span> in_channels_list<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>convs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 融合后处理</span>
        self<span class="token punctuation">.</span>fusion_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>in_channels_list<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        features: 不同尺度的特征图列表 [P3, P4, P5]
        P3: 高分辨率特征图（小缺陷）
        P4: 中分辨率特征图（中等缺陷）
        P5: 低分辨率特征图（大缺陷）
        """</span>
        <span class="token comment"># 统一通道数</span>
        processed <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> feat <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">:</span>
            processed_feat <span class="token operator">=</span> self<span class="token punctuation">.</span>convs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>feat<span class="token punctuation">)</span>
            processed<span class="token punctuation">.</span>append<span class="token punctuation">(</span>processed_feat<span class="token punctuation">)</span>
        
        <span class="token comment"># 上采样到同一尺度（P3的尺度）</span>
        p3<span class="token punctuation">,</span> p4<span class="token punctuation">,</span> p5 <span class="token operator">=</span> processed
        p4_up <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>p4<span class="token punctuation">,</span> size<span class="token operator">=</span>p3<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        p5_up <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>p5<span class="token punctuation">,</span> size<span class="token operator">=</span>p3<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 特征融合</span>
        fused <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>p3<span class="token punctuation">,</span> p4_up<span class="token punctuation">,</span> p5_up<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        fused <span class="token operator">=</span> self<span class="token punctuation">.</span>fusion_conv<span class="token punctuation">(</span>fused<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> fused
</code></pre>
           <h5>
            <a id="322__827">
            </a>
            3.2.2 注意力加权融合
           </h5>
           <p>
            为不同尺度的特征分配动态权重，提高重要特征的贡献：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">AttentionFusion</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""注意力加权的多尺度融合"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 注意力权重生成</span>
        self<span class="token punctuation">.</span>attention <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 3个尺度的权重</span>
            nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 归一化权重</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 特征处理</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p4<span class="token punctuation">,</span> p5<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        p3, p4, p5: 三个尺度的特征图（已统一通道数）
        """</span>
        <span class="token comment"># 上采样到同一尺度</span>
        p4_up <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>p4<span class="token punctuation">,</span> size<span class="token operator">=</span>p3<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        p5_up <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>p5<span class="token punctuation">,</span> size<span class="token operator">=</span>p3<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 生成注意力权重</span>
        concat_feat <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>p3<span class="token punctuation">,</span> p4_up<span class="token punctuation">,</span> p5_up<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        weights <span class="token operator">=</span> self<span class="token punctuation">.</span>attention<span class="token punctuation">(</span>concat_feat<span class="token punctuation">)</span>  <span class="token comment"># [B, 3, H, W]</span>
        
        <span class="token comment"># 应用注意力权重</span>
        w1<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> w3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>split<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        weighted_p3 <span class="token operator">=</span> p3 <span class="token operator">*</span> w1
        weighted_p4 <span class="token operator">=</span> p4_up <span class="token operator">*</span> w2
        weighted_p5 <span class="token operator">=</span> p5_up <span class="token operator">*</span> w3
        
        <span class="token comment"># 融合特征</span>
        fused <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>weighted_p3<span class="token punctuation">,</span> weighted_p4<span class="token punctuation">,</span> weighted_p5<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        fused <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>fused<span class="token punctuation">)</span>
        fused <span class="token operator">=</span> self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>fused<span class="token punctuation">)</span>
        fused <span class="token operator">=</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>fused<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> fused
</code></pre>
           <h5>
            <a id="323__877">
            </a>
            3.2.3 多尺度训练策略
           </h5>
           <p>
            在训练过程中动态调整输入图像尺度，增强模型对不同尺寸缺陷的适应能力：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">multi_scale_training</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1280</span><span class="token punctuation">,</span> <span class="token number">1536</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""多尺度训练策略"""</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total_loss <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token comment"># 每个epoch随机选择一种尺度</span>
    current_scale <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>scales<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string"> 使用尺度: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>current_scale<span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>current_scale<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> batch <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span>
        imgs <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span>
        targets <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token string">'targets'</span><span class="token punctuation">]</span>
        
        <span class="token comment"># 调整图像尺度</span>
        imgs_resized <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>
            imgs<span class="token punctuation">,</span> 
            size<span class="token operator">=</span><span class="token punctuation">(</span>current_scale<span class="token punctuation">,</span> current_scale<span class="token punctuation">)</span><span class="token punctuation">,</span> 
            mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> 
            align_corners<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 前向传播</span>
        outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>imgs_resized<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> model<span class="token punctuation">.</span>compute_loss<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>
        
        <span class="token comment"># 反向传播</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        total_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> total_loss <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span>
</code></pre>
           <h4>
            <a id="33__917">
            </a>
            3.3 消融实验验证
           </h4>
           <p>
            在2000DPI显微图像测试集上验证各模块的有效性：
           </p>
           <table>
            <thead>
             <tr>
              <th>
               实验方案
              </th>
              <th>
               模块配置
              </th>
              <th>
               20μm缺陷检出率
              </th>
              <th>
               50μm缺陷检出率
              </th>
              <th>
               100μm缺陷检出率
              </th>
              <th>
               误报率
              </th>
              <th>
               推理时间(ms)
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               1
              </td>
              <td>
               YOLOv11n（ baseline）
              </td>
              <td>
               87.3%
              </td>
              <td>
               92.5%
              </td>
              <td>
               96.8%
              </td>
              <td>
               5.2%
              </td>
              <td>
               68
              </td>
             </tr>
             <tr>
              <td>
               2
              </td>
              <td>
               +SPDConv
              </td>
              <td>
               92.1%
              </td>
              <td>
               95.3%
              </td>
              <td>
               98.2%
              </td>
              <td>
               3.8%
              </td>
              <td>
               82
              </td>
             </tr>
             <tr>
              <td>
               3
              </td>
              <td>
               +亚像素头
              </td>
              <td>
               93.5%
              </td>
              <td>
               96.1%
              </td>
              <td>
               98.5%
              </td>
              <td>
               3.2%
              </td>
              <td>
               95
              </td>
             </tr>
             <tr>
              <td>
               4
              </td>
              <td>
               +多尺度融合
              </td>
              <td>
               94.2%
              </td>
              <td>
               97.0%
              </td>
              <td>
               98.8%
              </td>
              <td>
               2.5%
              </td>
              <td>
               102
              </td>
             </tr>
             <tr>
              <td>
               5
              </td>
              <td>
               SPDConv+亚像素头+多尺度
              </td>
              <td>
               96.7%
              </td>
              <td>
               98.5%
              </td>
              <td>
               99.3%
              </td>
              <td>
               1.1%
              </td>
              <td>
               118
              </td>
             </tr>
            </tbody>
           </table>
           <p>
            <strong>
             实验结论
            </strong>
            ：
           </p>
           <ol>
            <li>
             SPDConv对微小缺陷（20μm）的检出率提升最显著（+4.8%），证明其在保留细微特征方面的有效性
            </li>
            <li>
             亚像素头主要提升定位精度，对各类缺陷的检出率均有提升（+2-4%）
            </li>
            <li>
             多尺度融合对不同尺寸缺陷的适应性更好，尤其是中等尺寸缺陷（50μm）
            </li>
            <li>
             组合方案实现20μm缺陷96.7%的检出率，误报率仅1.1%，满足航空级质检要求
            </li>
            <li>
             增加模块导致推理时间增加约70%，但仍在工业检测可接受范围内（&lt;200ms）
            </li>
           </ol>
           <p>
            <strong>
             典型缺陷检测效果
            </strong>
            ：
           </p>
           <ul>
            <li>
             20μm划痕：基线模型漏检率35%，组合方案漏检率仅3.3%
            </li>
            <li>
             虚焊（20-30μm间隙）：基线模型漏检率28%，组合方案漏检率2.1%
            </li>
            <li>
             引脚变形（5-10°）：基线模型漏检率22%，组合方案漏检率1.8%
            </li>
           </ul>
           <h3>
            <a id="_943">
            </a>
            四、模型训练与评估
           </h3>
           <h4>
            <a id="41__945">
            </a>
            4.1 训练环境配置
           </h4>
           <h5>
            <a id="411__947">
            </a>
            4.1.1 硬件要求
           </h5>
           <p>
            微米级缺陷检测模型需要处理高分辨率图像，对硬件要求较高：
           </p>
           <ul>
            <li>
             GPU：NVIDIA RTX 4090（24GB显存）或Tesla A100（40GB显存）
            </li>
            <li>
             CPU：≥16核（推荐Intel Xeon或AMD Ryzen Threadripper）
            </li>
            <li>
             内存：≥64GB（处理高分辨率图像批次）
            </li>
            <li>
             存储：≥500GB SSD（高分辨率图像数据集）
            </li>
           </ul>
           <h5>
            <a id="412__956">
            </a>
            4.1.2 软件环境
           </h5>
           <pre><code class="prism language-bash"><span class="token comment"># 创建虚拟环境</span>
conda create <span class="token parameter variable">-n</span> yolov11_micro <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.10</span> <span class="token parameter variable">-y</span>
conda activate yolov11_micro

<span class="token comment"># 安装依赖</span>
pip <span class="token function">install</span> <span class="token assign-left variable">torch</span><span class="token operator">==</span><span class="token number">2.1</span>.0 <span class="token assign-left variable">torchvision</span><span class="token operator">==</span><span class="token number">0.16</span>.0 --extra-index-url https://download.pytorch.org/whl/cu121
pip <span class="token function">install</span> <span class="token assign-left variable">ultralytics</span><span class="token operator">==</span><span class="token number">8.1</span>.30
pip <span class="token function">install</span> opencv-python<span class="token operator">==</span><span class="token number">4.8</span>.0.74 <span class="token assign-left variable">albumentations</span><span class="token operator">==</span><span class="token number">1.3</span>.1
pip <span class="token function">install</span> pandas matplotlib tqdm scikit-image
pip <span class="token function">install</span> scipy  <span class="token comment"># 用于亚像素计算</span>
</code></pre>
           <h4>
            <a id="42__971">
            </a>
            4.2 数据集配置文件
           </h4>
           <p>
            创建
            <code>
             micro_defect_dataset.yaml
            </code>
            ：
           </p>
           <pre><code class="prism language-yaml"><span class="token comment"># micro_defect_dataset.yaml</span>
<span class="token key atrule">train</span><span class="token punctuation">:</span> micro_defect_final_dataset/train/images
<span class="token key atrule">val</span><span class="token punctuation">:</span> micro_defect_final_dataset/val/images
<span class="token key atrule">test</span><span class="token punctuation">:</span> micro_defect_final_dataset/test/images

<span class="token comment"># 缺陷类别</span>
<span class="token key atrule">names</span><span class="token punctuation">:</span>
  <span class="token key atrule">0</span><span class="token punctuation">:</span> 划痕
  <span class="token key atrule">1</span><span class="token punctuation">:</span> 虚焊
  <span class="token key atrule">2</span><span class="token punctuation">:</span> 引脚变形
  <span class="token key atrule">3</span><span class="token punctuation">:</span> 污染
  <span class="token key atrule">4</span><span class="token punctuation">:</span> 桥连
  <span class="token key atrule">5</span><span class="token punctuation">:</span> 引脚缺失

<span class="token comment"># 图像尺寸（高分辨率）</span>
<span class="token key atrule">imgsz</span><span class="token punctuation">:</span> <span class="token number">1280</span>

<span class="token comment"># 缺陷尺寸范围（像素，对应实际尺寸=像素×1μm）</span>
<span class="token key atrule">defect_sizes</span><span class="token punctuation">:</span>
  <span class="token key atrule">0</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span>    <span class="token comment"># 划痕：2-20像素（μm）</span>
  <span class="token key atrule">1</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span>    <span class="token comment"># 虚焊：2-30像素</span>
  <span class="token key atrule">2</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span>    <span class="token comment"># 引脚变形：5-50像素</span>
  <span class="token key atrule">3</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>  <span class="token comment"># 污染：10-100像素</span>
  <span class="token key atrule">4</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span>    <span class="token comment"># 桥连：5-50像素</span>
  <span class="token key atrule">5</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>  <span class="token comment"># 引脚缺失：10-100像素</span>
</code></pre>
           <h4>
            <a id="43__1003">
            </a>
            4.3 训练参数优化
           </h4>
           <h5>
            <a id="431__1005">
            </a>
            4.3.1 训练命令与参数解析
           </h5>
           <pre><code class="prism language-bash">yolo train <span class="token punctuation">\</span>
  <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov11n-micro.yaml <span class="token punctuation">\</span>  <span class="token comment"># 微米级检测模型配置</span>
  <span class="token assign-left variable">data</span><span class="token operator">=</span>micro_defect_dataset.yaml <span class="token punctuation">\</span>  <span class="token comment"># 数据集配置</span>
  <span class="token assign-left variable">epochs</span><span class="token operator">=</span><span class="token number">150</span> <span class="token punctuation">\</span>  <span class="token comment"># 更多训练轮数，确保小缺陷特征学习充分</span>
  <span class="token assign-left variable">imgsz</span><span class="token operator">=</span><span class="token number">1280</span> <span class="token punctuation">\</span>  <span class="token comment"># 高分辨率输入</span>
  <span class="token assign-left variable">batch</span><span class="token operator">=</span><span class="token number">8</span> <span class="token punctuation">\</span>  <span class="token comment"># 高分辨率图像批次减小</span>
  <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">name</span><span class="token operator">=</span>micro_defect_detection <span class="token punctuation">\</span>
  <span class="token assign-left variable">pretrained</span><span class="token operator">=</span>yolov11n.pt <span class="token punctuation">\</span>
  <span class="token assign-left variable">optimizer</span><span class="token operator">=</span>AdamW <span class="token punctuation">\</span>  <span class="token comment"># 适合精细特征学习</span>
  <span class="token assign-left variable">lr0</span><span class="token operator">=</span><span class="token number">0.0005</span> <span class="token punctuation">\</span>  <span class="token comment"># 较小的初始学习率</span>
  <span class="token assign-left variable">lrf</span><span class="token operator">=</span><span class="token number">0.01</span> <span class="token punctuation">\</span>  <span class="token comment"># 学习率衰减因子</span>
  <span class="token assign-left variable">patience</span><span class="token operator">=</span><span class="token number">20</span> <span class="token punctuation">\</span>  <span class="token comment"># 早停策略</span>
  <span class="token comment"># 数据增强参数（谨慎使用，避免破坏微小特征）</span>
  <span class="token assign-left variable">mosaic</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">\</span>  <span class="token comment"># 禁用马赛克增强（会破坏微小缺陷）</span>
  <span class="token assign-left variable">mixup</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">\</span>  <span class="token comment"># 禁用混合增强</span>
  <span class="token assign-left variable">degrees</span><span class="token operator">=</span><span class="token number">5</span> <span class="token punctuation">\</span>  <span class="token comment"># 小角度旋转</span>
  <span class="token assign-left variable">translate</span><span class="token operator">=</span><span class="token number">0.05</span> <span class="token punctuation">\</span>  <span class="token comment"># 小范围平移</span>
  <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.1</span> <span class="token punctuation">\</span>  <span class="token comment"># 小范围缩放</span>
  <span class="token assign-left variable">hsv_h</span><span class="token operator">=</span><span class="token number">0.01</span> <span class="token punctuation">\</span>  <span class="token comment"># 微小的色相调整</span>
  <span class="token assign-left variable">hsv_s</span><span class="token operator">=</span><span class="token number">0.1</span> <span class="token punctuation">\</span>  <span class="token comment"># 微小的饱和度调整</span>
  <span class="token assign-left variable">hsv_v</span><span class="token operator">=</span><span class="token number">0.1</span> <span class="token punctuation">\</span>  <span class="token comment"># 微小的明度调整</span>
</code></pre>
           <h5>
            <a id="432__1032">
            </a>
            4.3.2 关键参数说明
           </h5>
           <ul>
            <li>
             <strong>
              <code>
               imgsz=1280
              </code>
             </strong>
             ：高分辨率输入，保留微小缺陷特征
            </li>
            <li>
             <strong>
              <code>
               mosaic=0.0
              </code>
             </strong>
             ：禁用马赛克增强，避免微小缺陷被破坏
            </li>
            <li>
             <strong>
              <code>
               batch=8
              </code>
             </strong>
             ：高分辨率图像占用内存大，减小批次大小
            </li>
            <li>
             <strong>
              <code>
               lr0=0.0005
              </code>
             </strong>
             ：较小的初始学习率，适合精细特征学习
            </li>
            <li>
             <strong>
              <code>
               patience=20
              </code>
             </strong>
             ：更长的早停耐心，确保模型充分收敛
            </li>
           </ul>
           <h4>
            <a id="44__1040">
            </a>
            4.4 模型评估指标与方法
           </h4>
           <h5>
            <a id="441__1042">
            </a>
            4.4.1 评估指标定义
           </h5>
           <p>
            针对微米级缺陷检测的特殊需求，定义以下评估指标：
           </p>
           <ul>
            <li>
             <strong>
              按尺寸分级的检出率
             </strong>
             ：分别计算20μm、50μm、100μm缺陷的检出率
            </li>
            <li>
             <strong>
              定位精度
             </strong>
             ：检测框与真实框的中心距离（像素）
            </li>
            <li>
             <strong>
              误报率
             </strong>
             ：每1000个检测结果中的误报数量
            </li>
            <li>
             <strong>
              每小时检测数量
             </strong>
             ：评估系统的检测效率
            </li>
           </ul>
           <h5>
            <a id="442__1051">
            </a>
            4.4.2 评估代码实现
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> math

<span class="token keyword">def</span> <span class="token function">calculate_defect_size</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> pixel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""计算缺陷实际尺寸（μm）"""</span>
    <span class="token comment"># 计算边界框对角线长度</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> points
    pixel_distance <span class="token operator">=</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>x2<span class="token operator">-</span>x1<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y2<span class="token operator">-</span>y1<span class="token punctuation">)</span><span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment"># 转换为实际尺寸（1像素=1μm）</span>
    <span class="token keyword">return</span> pixel_distance <span class="token operator">*</span> pixel_size

<span class="token keyword">def</span> <span class="token function">evaluate_micro_model</span><span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> test_dir<span class="token punctuation">,</span> pixel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""评估微米级缺陷检测模型"""</span>
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    
    <span class="token comment"># 加载测试数据</span>
    img_files <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>test_dir<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
                <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 评估指标</span>
    total_detections <span class="token operator">=</span> <span class="token number">0</span>
    total_ground_truth <span class="token operator">=</span> <span class="token number">0</span>
    correct_detections <span class="token operator">=</span> <span class="token number">0</span>
    size_bins <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'20μm以下'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'tp'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'fn'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'20-50μm'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'tp'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'fn'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'50-100μm'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'tp'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'fn'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'100μm以上'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'tp'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'fn'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    localization_errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 定位误差（像素）</span>
    false_positives <span class="token operator">=</span> <span class="token number">0</span>
    total_infer_time <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">for</span> img_file <span class="token keyword">in</span> img_files<span class="token punctuation">:</span>
        <span class="token comment"># 读取图像和标注</span>
        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>test_dir<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">,</span> img_file<span class="token punctuation">)</span>
        base_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>img_file<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        label_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>test_dir<span class="token punctuation">,</span> <span class="token string">'labels'</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>base_name<span class="token punctuation">}</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span>
        
        <span class="token comment"># 读取标注</span>
        ground_truth <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>label_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>label_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    parts <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">:</span>
                        cls <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        xc<span class="token punctuation">,</span> yc<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">,</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token comment"># 转换为像素坐标</span>
                        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
                        h_img<span class="token punctuation">,</span> w_img <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
                        x1 <span class="token operator">=</span> <span class="token punctuation">(</span>xc <span class="token operator">-</span> w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> w_img
                        y1 <span class="token operator">=</span> <span class="token punctuation">(</span>yc <span class="token operator">-</span> h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> h_img
                        x2 <span class="token operator">=</span> <span class="token punctuation">(</span>xc <span class="token operator">+</span> w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> w_img
                        y2 <span class="token operator">=</span> <span class="token punctuation">(</span>yc <span class="token operator">+</span> h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> h_img
                        ground_truth<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                            <span class="token string">'class'</span><span class="token punctuation">:</span> cls<span class="token punctuation">,</span>
                            <span class="token string">'box'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token string">'size'</span><span class="token punctuation">:</span> calculate_defect_size<span class="token punctuation">(</span><span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">,</span> pixel_size<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        total_ground_truth <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ground_truth<span class="token punctuation">)</span>
        
        <span class="token comment"># 模型推理</span>
        start_time <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTickCount<span class="token punctuation">(</span><span class="token punctuation">)</span>
        results <span class="token operator">=</span> model<span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">1280</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        infer_time <span class="token operator">=</span> <span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>getTickCount<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">/</span> cv2<span class="token punctuation">.</span>getTickFrequency<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>  <span class="token comment"># ms</span>
        total_infer_time <span class="token operator">+=</span> infer_time
        
        <span class="token comment"># 解析预测结果</span>
        detections <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> box <span class="token keyword">in</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>boxes<span class="token punctuation">:</span>
            cls <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">.</span>cls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            conf <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>box<span class="token punctuation">.</span>conf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> conf <span class="token operator">&lt;</span> <span class="token number">0.3</span><span class="token punctuation">:</span>  <span class="token comment"># 过滤低置信度检测</span>
                <span class="token keyword">continue</span>
            x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> box<span class="token punctuation">.</span>xyxy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
            detections<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token string">'class'</span><span class="token punctuation">:</span> cls<span class="token punctuation">,</span>
                <span class="token string">'box'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">'confidence'</span><span class="token punctuation">:</span> conf<span class="token punctuation">,</span>
                <span class="token string">'size'</span><span class="token punctuation">:</span> calculate_defect_size<span class="token punctuation">(</span><span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">,</span> pixel_size<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        total_detections <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>detections<span class="token punctuation">)</span>
        
        <span class="token comment"># 计算TP、FP、FN</span>
        matched <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ground_truth<span class="token punctuation">)</span>
        
        <span class="token comment"># 按置信度排序检测结果</span>
        detections_sorted <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>detections<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">'confidence'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token keyword">for</span> det <span class="token keyword">in</span> detections_sorted<span class="token punctuation">:</span>
            det_box <span class="token operator">=</span> det<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span>
            det_cls <span class="token operator">=</span> det<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span>
            best_iou <span class="token operator">=</span> <span class="token number">0</span>
            best_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
            
            <span class="token comment"># 寻找最佳匹配的真实框</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> gt <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>ground_truth<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                <span class="token keyword">if</span> gt<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> det_cls<span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                
                <span class="token comment"># 计算IoU</span>
                iou <span class="token operator">=</span> calculate_iou<span class="token punctuation">(</span>det_box<span class="token punctuation">,</span> gt<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> iou <span class="token operator">&gt;</span> best_iou <span class="token keyword">and</span> iou <span class="token operator">&gt;</span> <span class="token number">0.3</span><span class="token punctuation">:</span>  <span class="token comment"># IoU阈值0.3</span>
                    best_iou <span class="token operator">=</span> iou
                    best_idx <span class="token operator">=</span> i
            
            <span class="token keyword">if</span> best_idx <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token comment"># 真正例</span>
                correct_detections <span class="token operator">+=</span><span class="token number">1</span>
                matched<span class="token punctuation">[</span>best_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
                
                <span class="token comment"># 记录定位误差</span>
                gt_box <span class="token operator">=</span> ground_truth<span class="token punctuation">[</span>best_idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span>
                det_center <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>det_box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>det_box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>det_box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>det_box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span>
                gt_center <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>gt_box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>gt_box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>gt_box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>gt_box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span>
                error <span class="token operator">=</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>det_center<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>gt_center<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>det_center<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>gt_center<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
                localization_errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>error<span class="token punctuation">)</span>
                
                <span class="token comment"># 按尺寸分级统计</span>
                size <span class="token operator">=</span> ground_truth<span class="token punctuation">[</span>best_idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> size <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
                    size_bins<span class="token punctuation">[</span><span class="token string">'20μm以下'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">elif</span> size <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">:</span>
                    size_bins<span class="token punctuation">[</span><span class="token string">'20-50μm'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">elif</span> size <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">:</span>
                    size_bins<span class="token punctuation">[</span><span class="token string">'50-100μm'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    size_bins<span class="token punctuation">[</span><span class="token string">'100μm以上'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># 假正例</span>
                false_positives <span class="token operator">+=</span><span class="token number">1</span>
        
        <span class="token comment"># 统计未匹配的真实框（漏检）</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> gt <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>ground_truth<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
                size <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> size <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
                    size_bins<span class="token punctuation">[</span><span class="token string">'20μm以下'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'fn'</span><span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">elif</span> size <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">:</span>
                    size_bins<span class="token punctuation">[</span><span class="token string">'20-50μm'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'fn'</span><span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">elif</span> size <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">:</span>
                    size_bins<span class="token punctuation">[</span><span class="token string">'50-100μm'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'fn'</span><span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    size_bins<span class="token punctuation">[</span><span class="token string">'100μm以上'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'fn'</span><span class="token punctuation">]</span> <span class="token operator">+=</span><span class="token number">1</span>
    
    <span class="token comment"># 计算指标</span>
    precision <span class="token operator">=</span> correct_detections <span class="token operator">/</span> total_detections <span class="token keyword">if</span> total_detections <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    recall <span class="token operator">=</span> correct_detections <span class="token operator">/</span> total_ground_truth <span class="token keyword">if</span> total_ground_truth <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    f1 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> precision <span class="token operator">*</span> recall <span class="token operator">/</span> <span class="token punctuation">(</span>precision <span class="token operator">+</span> recall<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>precision <span class="token operator">+</span> recall<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    false_alarm_rate <span class="token operator">=</span> false_positives <span class="token operator">/</span> total_detections <span class="token keyword">if</span> total_detections <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    avg_localization_error <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>localization_errors<span class="token punctuation">)</span> <span class="token keyword">if</span> localization_errors <span class="token keyword">else</span> <span class="token number">0</span>
    avg_infer_time <span class="token operator">=</span> total_infer_time <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>img_files<span class="token punctuation">)</span> <span class="token keyword">if</span> img_files <span class="token keyword">else</span> <span class="token number">0</span>
    
    <span class="token comment"># 计算各尺寸的检出率</span>
    size_recall <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> bin_name<span class="token punctuation">,</span> stats <span class="token keyword">in</span> size_bins<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        total <span class="token operator">=</span> stats<span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+</span> stats<span class="token punctuation">[</span><span class="token string">'fn'</span><span class="token punctuation">]</span>
        size_recall<span class="token punctuation">[</span>bin_name<span class="token punctuation">]</span> <span class="token operator">=</span> stats<span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">/</span> total <span class="token keyword">if</span> total <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    
    <span class="token comment"># 输出评估结果</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"总体性能:"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  精确率: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>precision<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  召回率: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>recall<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  F1分数: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>f1<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  误报率: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>false_alarm_rate<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  平均定位误差: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>avg_localization_error<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">像素"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  平均推理时间: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>avg_infer_time<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n按尺寸的召回率:"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> bin_name<span class="token punctuation">,</span> r <span class="token keyword">in</span> size_recall<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>bin_name<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>r<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 计算每小时检测数量（假设每张图像包含1个元件）</span>
    <span class="token keyword">if</span> avg_infer_time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        per_hour <span class="token operator">=</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> avg_infer_time
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n检测效率: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>per_hour<span class="token punctuation">:</span><span class="token format-spec">.0f</span><span class="token punctuation">}</span></span><span class="token string">个/小时"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'precision'</span><span class="token punctuation">:</span> precision<span class="token punctuation">,</span>
        <span class="token string">'recall'</span><span class="token punctuation">:</span> recall<span class="token punctuation">,</span>
        <span class="token string">'f1'</span><span class="token punctuation">:</span> f1<span class="token punctuation">,</span>
        <span class="token string">'false_alarm_rate'</span><span class="token punctuation">:</span> false_alarm_rate<span class="token punctuation">,</span>
        <span class="token string">'localization_error'</span><span class="token punctuation">:</span> avg_localization_error<span class="token punctuation">,</span>
        <span class="token string">'infer_time'</span><span class="token punctuation">:</span> avg_infer_time<span class="token punctuation">,</span>
        <span class="token string">'size_recall'</span><span class="token punctuation">:</span> size_recall<span class="token punctuation">,</span>
        <span class="token string">'throughput'</span><span class="token punctuation">:</span> per_hour <span class="token keyword">if</span> avg_infer_time <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">calculate_iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""计算两个边界框的IoU"""</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> box1
    x1g<span class="token punctuation">,</span> y1g<span class="token punctuation">,</span> x2g<span class="token punctuation">,</span> y2g <span class="token operator">=</span> box2
    
    <span class="token comment"># 计算交集</span>
    inter_x1 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x1g<span class="token punctuation">)</span>
    inter_y1 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>y1<span class="token punctuation">,</span> y1g<span class="token punctuation">)</span>
    inter_x2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> x2g<span class="token punctuation">)</span>
    inter_y2 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>y2<span class="token punctuation">,</span> y2g<span class="token punctuation">)</span>
    inter_area <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inter_x2 <span class="token operator">-</span> inter_x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inter_y2 <span class="token operator">-</span> inter_y1<span class="token punctuation">)</span>
    
    <span class="token comment"># 计算并集</span>
    area1 <span class="token operator">=</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span>
    area2 <span class="token operator">=</span> <span class="token punctuation">(</span>x2g <span class="token operator">-</span> x1g<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2g <span class="token operator">-</span> y1g<span class="token punctuation">)</span>
    union_area <span class="token operator">=</span> area1 <span class="token operator">+</span> area2 <span class="token operator">-</span> inter_area
    
    <span class="token comment"># 计算IoU</span>
    <span class="token keyword">return</span> inter_area <span class="token operator">/</span> union_area <span class="token keyword">if</span> union_area <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
</code></pre>
           <h4>
            <a id="45__1273">
            </a>
            4.5 评估结果分析
           </h4>
           <p>
            在2000DPI显微图像测试集上的评估结果：
           </p>
           <table>
            <thead>
             <tr>
              <th>
               模型
              </th>
              <th>
               总体召回率
              </th>
              <th>
               20μm缺陷召回率
              </th>
              <th>
               误报率
              </th>
              <th>
               定位误差(像素)
              </th>
              <th>
               推理时间(ms)
              </th>
              <th>
               检测效率(个/小时)
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               YOLOv11n baseline
              </td>
              <td>
               0.912
              </td>
              <td>
               0.873
              </td>
              <td>
               0.052
              </td>
              <td>
               1.8
              </td>
              <td>
               68
              </td>
              <td>
               52941
              </td>
             </tr>
             <tr>
              <td>
               本文方案
              </td>
              <td>
               0.975
              </td>
              <td>
               0.967
              </td>
              <td>
               0.011
              </td>
              <td>
               0.7
              </td>
              <td>
               118
              </td>
              <td>
               30508
              </td>
             </tr>
            </tbody>
           </table>
           <p>
            <strong>
             结果分析
            </strong>
            ：
           </p>
           <ol>
            <li>
             本文方案的总体召回率提升6.3%，特别是20μm微小缺陷的召回率提升9.4%，满足航空级质检要求
            </li>
            <li>
             误报率从5.2%降至1.1%，大幅减少了人工复核的工作量
            </li>
            <li>
             定位误差从1.8像素降至0.7像素，达到亚像素级定位精度
            </li>
            <li>
             推理时间增加73%，但检测效率仍达30508个/小时，满足量产需求
            </li>
           </ol>
           <h3>
            <a id="_1289">
            </a>
            五、工业显微镜集成方案
           </h3>
           <h4>
            <a id="51__1291">
            </a>
            5.1 硬件系统搭建
           </h4>
           <h5>
            <a id="511__1293">
            </a>
            5.1.1 核心组件选型
           </h5>
           <p>
            工业显微镜检测系统的核心组件及选型建议：
           </p>
           <table>
            <thead>
             <tr>
              <th>
               组件
              </th>
              <th>
               推荐型号
              </th>
              <th>
               主要参数
              </th>
              <th>
               作用
              </th>
              <th>
               价格范围
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               工业显微镜
              </td>
              <td>
               Olympus DSX1000
              </td>
              <td>
               最大5000×放大，0.5μm分辨率
              </td>
              <td>
               获取高分辨率图像
              </td>
              <td>
               15-25万元
              </td>
             </tr>
             <tr>
              <td>
               运动控制平台
              </td>
              <td>
               Thorlabs MLS203-1
              </td>
              <td>
               行程100mm×100mm，±1μm定位精度
              </td>
              <td>
               实现自动化扫描
              </td>
              <td>
               3-5万元
              </td>
             </tr>
             <tr>
              <td>
               照明系统
              </td>
              <td>
               SCHOTT KL2500 LCD
              </td>
              <td>
               可调环形光源，色温3200K-6500K
              </td>
              <td>
               提供均匀照明
              </td>
              <td>
               0.8-1.5万元
              </td>
             </tr>
             <tr>
              <td>
               相机
              </td>
              <td>
               Basler acA2500-14uc
              </td>
              <td>
               500万像素，24fps，USB3.0
              </td>
              <td>
               图像采集
              </td>
              <td>
               1.5-2.5万元
              </td>
             </tr>
             <tr>
              <td>
               工业计算机
              </td>
              <td>
               Advantech ARK-3520
              </td>
              <td>
               Intel i7-10710U，16GB RAM
              </td>
              <td>
               运行检测算法
              </td>
              <td>
               1-2万元
              </td>
             </tr>
             <tr>
              <td>
               标记系统
              </td>
              <td>
               KEYENCE MK-G2000
              </td>
              <td>
               ±0.01mm定位精度
              </td>
              <td>
               标记不合格品
              </td>
              <td>
               2-3万元
              </td>
             </tr>
            </tbody>
           </table>
           <p>
            <strong>
             系统总预算
            </strong>
            ：约25-40万元，根据配置可调整。
           </p>
           <h5>
            <a id="512__1308">
            </a>
            5.1.2 系统集成示意图
           </h5>
           <div class="mermaid">
            <svg class="mermaid-svg" height="446.009521484375" id="mermaid-svg-8Dlo38XN3ycL6xdK" viewbox="0 0.0000019073486328125 651.9398803710938 446.009521484375" width="651.9398803710938" xmlns="http://www.w3.org/2000/svg">
             <style>
              #mermaid-svg-8Dlo38XN3ycL6xdK {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-8Dlo38XN3ycL6xdK .error-icon{fill:#552222;}#mermaid-svg-8Dlo38XN3ycL6xdK .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-8Dlo38XN3ycL6xdK .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-8Dlo38XN3ycL6xdK .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-8Dlo38XN3ycL6xdK .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-8Dlo38XN3ycL6xdK .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-8Dlo38XN3ycL6xdK .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-8Dlo38XN3ycL6xdK .marker{fill:#333333;stroke:#333333;}#mermaid-svg-8Dlo38XN3ycL6xdK .marker.cross{stroke:#333333;}#mermaid-svg-8Dlo38XN3ycL6xdK svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-8Dlo38XN3ycL6xdK .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-8Dlo38XN3ycL6xdK .cluster-label text{fill:#333;}#mermaid-svg-8Dlo38XN3ycL6xdK .cluster-label span{color:#333;}#mermaid-svg-8Dlo38XN3ycL6xdK .label text,#mermaid-svg-8Dlo38XN3ycL6xdK span{fill:#333;color:#333;}#mermaid-svg-8Dlo38XN3ycL6xdK .node rect,#mermaid-svg-8Dlo38XN3ycL6xdK .node circle,#mermaid-svg-8Dlo38XN3ycL6xdK .node ellipse,#mermaid-svg-8Dlo38XN3ycL6xdK .node polygon,#mermaid-svg-8Dlo38XN3ycL6xdK .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-8Dlo38XN3ycL6xdK .node .label{text-align:center;}#mermaid-svg-8Dlo38XN3ycL6xdK .node.clickable{cursor:pointer;}#mermaid-svg-8Dlo38XN3ycL6xdK .arrowheadPath{fill:#333333;}#mermaid-svg-8Dlo38XN3ycL6xdK .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-8Dlo38XN3ycL6xdK .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-8Dlo38XN3ycL6xdK .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-8Dlo38XN3ycL6xdK .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-8Dlo38XN3ycL6xdK .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-8Dlo38XN3ycL6xdK .cluster text{fill:#333;}#mermaid-svg-8Dlo38XN3ycL6xdK .cluster span{color:#333;}#mermaid-svg-8Dlo38XN3ycL6xdK div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-8Dlo38XN3ycL6xdK :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
             </style>
             <g>
              <g class="output">
               <g class="clusters">
               </g>
               <g class="edgePaths">
                <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead262" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead263" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead264" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-D LE-E" id="L-D-E" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead265" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-F LE-E" id="L-F-E" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead266" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-G" id="L-C-G" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead267" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-H" id="L-C-H" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead268" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
                <g class="edgePath LS-C LE-I" id="L-C-I" style="opacity: 1;">
                 <defs>
                  <marker id="arrowhead269" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
                  </marker>
                 </defs>
                </g>
               </g>
               <g class="edgeLabels">
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-D' L-LE-E" id="L-L-D-E">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-F' L-LE-E" id="L-L-F-E">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-G" id="L-L-C-G">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-H" id="L-L-C-H">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
                <g class="edgeLabel" style="opacity: 1;" transform="">
                 <g class="label" transform="translate(0,0)">
                  <rect height="0" rx="0" ry="0" width="0">
                  </rect>
                  <foreignobject height="0" width="0">
                   <div style="display: inline-block; white-space: nowrap;">
                    <span class="edgeLabel L-LS-C' L-LE-I" id="L-L-C-I">
                    </span>
                   </div>
                  </foreignobject>
                 </g>
                </g>
               </g>
               <g class="nodes">
                <g class="node default" id="flowchart-A-187" style="opacity: 1;" transform="translate(404.9620819091797,31.000953674316406)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="99.98568725585938" x="-49.99284362792969" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-39.99284362792969,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="79.98568725585938">
                    <div style="display: inline-block; white-space: nowrap;">
                     工业显微镜
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-B-188" style="opacity: 1;" transform="translate(404.9620819091797,127.00286102294922)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="51.9942741394043" x="-25.99713706970215" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-15.997137069702148,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="31.994274139404297">
                    <div style="display: inline-block; white-space: nowrap;">
                     相机
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-C-190" style="opacity: 1;" transform="translate(404.9620819091797,223.00476837158203)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="99.98568725585938" x="-49.99284362792969" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-39.99284362792969,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="79.98568725585938">
                    <div style="display: inline-block; white-space: nowrap;">
                     工业计算机
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-D-192" style="opacity: 1;" transform="translate(65.99141693115234,319.00667572021484)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="115.98282623291016" x="-57.99141311645508" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-47.99141311645508,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="95.98282623291016">
                    <div style="display: inline-block; white-space: nowrap;">
                     运动控制平台
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-E-194" style="opacity: 1;" transform="translate(140.98426246643066,415.00858306884766)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="67.99141311645508" x="-33.99570655822754" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-23.99570655822754,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="47.99141311645508">
                    <div style="display: inline-block; white-space: nowrap;">
                     载物台
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-F-195" style="opacity: 1;" transform="translate(215.97710800170898,319.00667572021484)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="83.9885482788086" x="-41.9942741394043" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-31.994274139404297,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="63.988548278808594">
                    <div style="display: inline-block; white-space: nowrap;">
                     照明系统
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-G-198" style="opacity: 1;" transform="translate(341.96709060668945,319.00667572021484)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="67.99141311645508" x="-33.99570655822754" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-23.99570655822754,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="47.99141311645508">
                    <div style="display: inline-block; white-space: nowrap;">
                     显示器
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-H-200" style="opacity: 1;" transform="translate(467.9570732116699,319.00667572021484)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="83.9885482788086" x="-41.9942741394043" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-31.994274139404297,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="63.988548278808594">
                    <div style="display: inline-block; white-space: nowrap;">
                     标记系统
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
                <g class="node default" id="flowchart-I-202" style="opacity: 1;" transform="translate(601.9456214904785,319.00667572021484)">
                 <rect class="label-container" height="46.00190734863281" rx="0" ry="0" width="83.9885482788086" x="-41.9942741394043" y="-23.000953674316406">
                 </rect>
                 <g class="label" transform="translate(0,0)">
                  <g transform="translate(-31.994274139404297,-13.000953674316406)">
                   <foreignobject height="26.001907348632812" width="63.988548278808594">
                    <div style="display: inline-block; white-space: nowrap;">
                     报警装置
                    </div>
                   </foreignobject>
                  </g>
                 </g>
                </g>
               </g>
              </g>
             </g>
            </svg>
           </div>
           <h5>
            <a id="513__1322">
            </a>
            5.1.3 硬件连接与调试
           </h5>
           <ol>
            <li>
             <p>
              <strong>
               连接步骤
              </strong>
              ：
             </p>
             <ul>
              <li>
               将相机安装在显微镜的C接口上
              </li>
              <li>
               通过USB3.0线连接相机与工业计算机
              </li>
              <li>
               通过RS232或USB连接运动控制平台与工业计算机
              </li>
              <li>
               将照明系统连接到显微镜的照明接口
              </li>
              <li>
               将标记系统和报警装置连接到工业计算机的IO接口
              </li>
             </ul>
            </li>
            <li>
             <p>
              <strong>
               调试要点
              </strong>
              ：
             </p>
             <ul>
              <li>
               光学对准：确保相机光轴与显微镜光轴一致
              </li>
              <li>
               焦距校准：使用标准校准板设置最佳焦距
              </li>
              <li>
               运动精度校准：通过网格板校准运动平台的定位精度
              </li>
              <li>
               照明调整：针对不同元件类型设置最佳照明参数
              </li>
             </ul>
            </li>
           </ol>
           <h4>
            <a id="52__1337">
            </a>
            5.2 自动化检测流程实现
           </h4>
           <h5>
            <a id="521__1339">
            </a>
            5.2.1 系统控制软件架构
           </h5>
           <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MicroscopeInspectionSystem</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""显微镜自动检测系统控制类"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 加载配置</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> self<span class="token punctuation">.</span>load_config<span class="token punctuation">(</span>config_file<span class="token punctuation">)</span>
        
        <span class="token comment"># 初始化硬件</span>
        self<span class="token punctuation">.</span>microscope <span class="token operator">=</span> self<span class="token punctuation">.</span>init_microscope<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>camera <span class="token operator">=</span> self<span class="token punctuation">.</span>init_camera<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>motion_platform <span class="token operator">=</span> self<span class="token punctuation">.</span>init_motion_platform<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>lighting <span class="token operator">=</span> self<span class="token punctuation">.</span>init_lighting<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>marker <span class="token operator">=</span> self<span class="token punctuation">.</span>init_marker<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>alarm <span class="token operator">=</span> self<span class="token punctuation">.</span>init_alarm<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 初始化检测模型</span>
        self<span class="token punctuation">.</span>detection_model <span class="token operator">=</span> self<span class="token punctuation">.</span>load_detection_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 系统状态</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"idle"</span>
        self<span class="token punctuation">.</span>current_position <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>inspection_results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">def</span> <span class="token function">load_config</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""加载系统配置"""</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">return</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">init_microscope</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""初始化工业显微镜"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 实际应用中需根据显微镜型号调用对应SDK</span>
            <span class="token comment"># 此处以Olympus DSX1000为例</span>
            <span class="token keyword">import</span> olympus_dsx_sdk <span class="token keyword">as</span> dsx
            scope <span class="token operator">=</span> dsx<span class="token punctuation">.</span>DSXMicroscope<span class="token punctuation">(</span><span class="token punctuation">)</span>
            scope<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'microscope'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ip_address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 设置初始放大倍数</span>
            scope<span class="token punctuation">.</span>set_magnification<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'microscope'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'default_mag'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"显微镜连接成功，型号: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>scope<span class="token punctuation">.</span>get_model_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> scope
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"显微镜初始化失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>
    
    <span class="token keyword">def</span> <span class="token function">init_camera</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""初始化相机"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 以Basler相机为例</span>
            <span class="token keyword">from</span> pypylon <span class="token keyword">import</span> pylon
            <span class="token comment"># 创建相机实例</span>
            camera <span class="token operator">=</span> pylon<span class="token punctuation">.</span>InstantCamera<span class="token punctuation">(</span>pylon<span class="token punctuation">.</span>TlFactory<span class="token punctuation">.</span>GetInstance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>CreateFirstDevice<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            camera<span class="token punctuation">.</span>Open<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 配置相机参数</span>
            camera<span class="token punctuation">.</span>ExposureTime<span class="token punctuation">.</span>SetValue<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'camera'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'exposure_time'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 曝光时间（微秒）</span>
            camera<span class="token punctuation">.</span>Gain<span class="token punctuation">.</span>SetValue<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'camera'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'gain'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 增益</span>
            camera<span class="token punctuation">.</span>Width<span class="token punctuation">.</span>SetValue<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'camera'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            camera<span class="token punctuation">.</span>Height<span class="token punctuation">.</span>SetValue<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'camera'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"相机连接成功: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>camera<span class="token punctuation">.</span>GetDeviceInfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>GetModelName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> camera
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"相机初始化失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>
    
    <span class="token keyword">def</span> <span class="token function">init_motion_platform</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""初始化运动控制平台"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 以Thorlabs运动平台为例</span>
            <span class="token keyword">import</span> thorlabs_apt <span class="token keyword">as</span> apt
            motor <span class="token operator">=</span> apt<span class="token punctuation">.</span>Motor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'motion_platform'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'serial_port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 初始化参数</span>
            motor<span class="token punctuation">.</span>set_move_mode<span class="token punctuation">(</span>apt<span class="token punctuation">.</span>MOVE_MODE_ABSOLUTE<span class="token punctuation">)</span>
            motor<span class="token punctuation">.</span>set_velocity_params<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'motion_platform'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'acceleration'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'motion_platform'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'max_velocity'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            <span class="token comment"># 回零</span>
            motor<span class="token punctuation">.</span>home<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"运动平台连接成功，当前位置: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>motor<span class="token punctuation">.</span>get_position<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> motor
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"运动平台初始化失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>
    
    <span class="token keyword">def</span> <span class="token function">init_lighting</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""初始化照明系统"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 以SCHOTT KL2500为例</span>
            <span class="token keyword">import</span> schott_kl2500 <span class="token keyword">as</span> kl
            light <span class="token operator">=</span> kl<span class="token punctuation">.</span>KL2500<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'lighting'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'com_port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            light<span class="token punctuation">.</span>set_intensity<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'lighting'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'default_intensity'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            light<span class="token punctuation">.</span>turn_on<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"照明系统开启，强度: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>light<span class="token punctuation">.</span>get_intensity<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> light
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"照明系统初始化失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token comment"># 照明失败不中断系统，使用默认照明</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">init_marker</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""初始化标记系统"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 以KEYENCE标记系统为例</span>
            <span class="token keyword">import</span> keyence_mk <span class="token keyword">as</span> mk
            marker <span class="token operator">=</span> mk<span class="token punctuation">.</span>MKSystem<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'marker'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ip_address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            marker<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"标记系统连接成功"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> marker
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"标记系统初始化失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token comment"># 标记系统失败不中断检测，仅记录</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">init_alarm</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""初始化报警装置"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 简单的声光报警</span>
            <span class="token keyword">import</span> RPi<span class="token punctuation">.</span>GPIO <span class="token keyword">as</span> GPIO  <span class="token comment"># 适用于工业计算机带GPIO的情况</span>
            GPIO<span class="token punctuation">.</span>setmode<span class="token punctuation">(</span>GPIO<span class="token punctuation">.</span>BCM<span class="token punctuation">)</span>
            GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'buzzer_pin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
            GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'led_pin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"报警装置初始化成功"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'buzzer'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'buzzer_pin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">'led'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'led_pin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">'gpio'</span><span class="token punctuation">:</span> GPIO
            <span class="token punctuation">}</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"报警装置初始化失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">load_detection_model</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""加载缺陷检测模型"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
            model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 移动到GPU（如果可用）</span>
            <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                model<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"模型加载成功: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> model
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"模型加载失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>
    
    <span class="token keyword">def</span> <span class="token function">auto_focus</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""自动对焦"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"focusing"</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始自动对焦..."</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 简单的对比度对焦算法</span>
            best_focus <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
            best_pos <span class="token operator">=</span> self<span class="token punctuation">.</span>microscope<span class="token punctuation">.</span>get_focus_position<span class="token punctuation">(</span><span class="token punctuation">)</span>
            current_pos <span class="token operator">=</span> best_pos
            
            <span class="token comment"># 搜索范围: ±500步</span>
            <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">501</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>microscope<span class="token punctuation">.</span>set_focus_position<span class="token punctuation">(</span>current_pos <span class="token operator">+</span> step<span class="token punctuation">)</span>
                <span class="token comment"># 采集图像</span>
                frame <span class="token operator">=</span> self<span class="token punctuation">.</span>capture_image<span class="token punctuation">(</span>save<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                <span class="token comment"># 计算图像清晰度（使用拉普拉斯方差）</span>
                gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
                focus_measure <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Laplacian<span class="token punctuation">(</span>gray<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CV_64F<span class="token punctuation">)</span><span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span>
                
                <span class="token keyword">if</span> focus_measure <span class="token operator">&gt;</span> best_focus<span class="token punctuation">:</span>
                    best_focus <span class="token operator">=</span> focus_measure
                    best_pos <span class="token operator">=</span> current_pos <span class="token operator">+</span> step
            
            <span class="token comment"># 移动到最佳焦点</span>
            self<span class="token punctuation">.</span>microscope<span class="token punctuation">.</span>set_focus_position<span class="token punctuation">(</span>best_pos<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"自动对焦完成，清晰度: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>best_focus<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"idle"</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"自动对焦失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"error"</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token keyword">def</span> <span class="token function">capture_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> save<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> save_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""采集图像"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 使用Basler相机采集</span>
            self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>StartGrabbing<span class="token punctuation">(</span>pylon<span class="token punctuation">.</span>GrabOne<span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            grab_result <span class="token operator">=</span> self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>RetrieveResult<span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">,</span> pylon<span class="token punctuation">.</span>TimeoutHandling_ThrowException<span class="token punctuation">)</span>
            
            <span class="token keyword">if</span> grab_result<span class="token punctuation">.</span>GrabSucceeded<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 转换为OpenCV格式</span>
                img <span class="token operator">=</span> grab_result<span class="token punctuation">.</span>Array
                img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BayerRG2BGR<span class="token punctuation">)</span>  <span class="token comment"># 转换色彩空间</span>
                
                <span class="token comment"># 保存图像</span>
                <span class="token keyword">if</span> save<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> save_path<span class="token punctuation">:</span>
                        timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d_%H%M%S"</span><span class="token punctuation">)</span>
                        save_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"capture_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>timestamp<span class="token punctuation">}</span></span><span class="token string">.png"</span></span><span class="token punctuation">)</span>
                    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"图像保存至: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                
                grab_result<span class="token punctuation">.</span>Release<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> img
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"图像采集失败"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"图像采集错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">move_to_position</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""移动到指定位置"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"moving"</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"移动到位置: (</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>y<span class="token punctuation">}</span></span><span class="token string">)"</span></span><span class="token punctuation">)</span>
            <span class="token comment"># 移动X轴和Y轴（假设0为X轴，1为Y轴）</span>
            self<span class="token punctuation">.</span>motion_platform<span class="token punctuation">.</span>move_to<span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>motion_platform<span class="token punctuation">.</span>move_to<span class="token punctuation">(</span>y<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token comment"># 等待移动完成</span>
            <span class="token keyword">while</span> self<span class="token punctuation">.</span>motion_platform<span class="token punctuation">.</span>is_moving<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">or</span> self<span class="token punctuation">.</span>motion_platform<span class="token punctuation">.</span>is_moving<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>current_position <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"idle"</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"移动失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"error"</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token keyword">def</span> <span class="token function">scan_region</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> start_x<span class="token punctuation">,</span> start_y<span class="token punctuation">,</span> end_x<span class="token punctuation">,</span> end_y<span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""扫描指定区域"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"scanning"</span>
            results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token comment"># 计算扫描点</span>
            x_positions <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>start_x<span class="token punctuation">,</span> end_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> step<span class="token punctuation">)</span><span class="token punctuation">)</span>
            y_positions <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>start_y<span class="token punctuation">,</span> end_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> step<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"开始扫描区域，共 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>x_positions<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y_positions<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个点"</span></span><span class="token punctuation">)</span>
            
            <span class="token keyword">for</span> x <span class="token keyword">in</span> x_positions<span class="token punctuation">:</span>
                <span class="token keyword">for</span> y <span class="token keyword">in</span> y_positions<span class="token punctuation">:</span>
                    <span class="token comment"># 移动到位置</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>move_to_position<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">continue</span>
                    
                    <span class="token comment"># 自动对焦</span>
                    self<span class="token punctuation">.</span>auto_focus<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    
                    <span class="token comment"># 调整照明（根据位置可能需要不同照明）</span>
                    self<span class="token punctuation">.</span>adjust_lighting<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
                    
                    <span class="token comment"># 采集图像</span>
                    img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                        self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string-interpolation"><span class="token string">f"scan_x</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">}</span></span><span class="token string">_y</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>y<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.png"</span></span>
                    <span class="token punctuation">)</span>
                    img <span class="token operator">=</span> self<span class="token punctuation">.</span>capture_image<span class="token punctuation">(</span>save<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> save_path<span class="token operator">=</span>img_path<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                        <span class="token keyword">continue</span>
                    
                    <span class="token comment"># 检测缺陷</span>
                    defects <span class="token operator">=</span> self<span class="token punctuation">.</span>detect_defects<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                    
                    <span class="token comment"># 记录结果</span>
                    results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                        <span class="token string">'position'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">'image_path'</span><span class="token punctuation">:</span> img_path<span class="token punctuation">,</span>
                        <span class="token string">'defects'</span><span class="token punctuation">:</span> defects<span class="token punctuation">,</span>
                        <span class="token string">'timestamp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    
                    <span class="token comment"># 如果有缺陷，标记位置</span>
                    <span class="token keyword">if</span> defects <span class="token keyword">and</span> self<span class="token punctuation">.</span>marker<span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>mark_defect_position<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
            
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"idle"</span>
            self<span class="token punctuation">.</span>inspection_results<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
            <span class="token keyword">return</span> results
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"区域扫描失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"error"</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">def</span> <span class="token function">adjust_lighting</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""根据位置调整照明"""</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>lighting<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        
        <span class="token comment"># 简单策略：根据位置调整照明强度和角度</span>
        <span class="token comment"># 实际应用中可根据元件类型和位置定制</span>
        <span class="token keyword">if</span> x <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">:</span>  <span class="token comment"># 左侧区域</span>
            self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_intensity<span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_angle<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 低角度照明，减少反光</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 右侧区域</span>
            self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_intensity<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_angle<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>  <span class="token comment"># 高角度照明，增强细节</span>
    
    <span class="token keyword">def</span> <span class="token function">detect_defects</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""检测图像中的缺陷"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 预处理图像</span>
            processed_img <span class="token operator">=</span> self<span class="token punctuation">.</span>preprocess_image<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            
            <span class="token comment"># 模型推理</span>
            results <span class="token operator">=</span> self<span class="token punctuation">.</span>detection_model<span class="token punctuation">(</span>processed_img<span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">1280</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 解析结果</span>
            defects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> box <span class="token keyword">in</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>boxes<span class="token punctuation">:</span>
                cls <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">.</span>cls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                conf <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>box<span class="token punctuation">.</span>conf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> conf <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'conf_threshold'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                
                x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> box<span class="token punctuation">.</span>xyxy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
                defects<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">'class'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'classes'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">'confidence'</span><span class="token punctuation">:</span> conf<span class="token punctuation">,</span>
                    <span class="token string">'box'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">'size'</span><span class="token punctuation">:</span> calculate_defect_size<span class="token punctuation">(</span><span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 计算缺陷尺寸（像素）</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 如果有缺陷，触发报警</span>
            <span class="token keyword">if</span> defects <span class="token keyword">and</span> self<span class="token punctuation">.</span>alarm<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>trigger_alarm<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword">return</span> defects
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"缺陷检测失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">def</span> <span class="token function">preprocess_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""预处理图像用于检测"""</span>
        <span class="token comment"># 与训练时的预处理一致</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1280</span><span class="token punctuation">,</span> <span class="token number">1280</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 增强对比度</span>
        clahe <span class="token operator">=</span> cv2<span class="token punctuation">.</span>createCLAHE<span class="token punctuation">(</span>clipLimit<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span> tileGridSize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
        clahe_img <span class="token operator">=</span> clahe<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>gray<span class="token punctuation">)</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>clahe_img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_GRAY2BGR<span class="token punctuation">)</span>
        <span class="token keyword">return</span> img
    
    <span class="token keyword">def</span> <span class="token function">trigger_alarm</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""触发报警"""</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>alarm<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            gpio <span class="token operator">=</span> self<span class="token punctuation">.</span>alarm<span class="token punctuation">[</span><span class="token string">'gpio'</span><span class="token punctuation">]</span>
            buzzer_pin <span class="token operator">=</span> self<span class="token punctuation">.</span>alarm<span class="token punctuation">[</span><span class="token string">'buzzer'</span><span class="token punctuation">]</span>
            led_pin <span class="token operator">=</span> self<span class="token punctuation">.</span>alarm<span class="token punctuation">[</span><span class="token string">'led'</span><span class="token punctuation">]</span>
            
            <span class="token comment"># 声光报警</span>
            gpio<span class="token punctuation">.</span>output<span class="token punctuation">(</span>led_pin<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>HIGH<span class="token punctuation">)</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                gpio<span class="token punctuation">.</span>output<span class="token punctuation">(</span>buzzer_pin<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>HIGH<span class="token punctuation">)</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
                gpio<span class="token punctuation">.</span>output<span class="token punctuation">(</span>buzzer_pin<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>LOW<span class="token punctuation">)</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
            gpio<span class="token punctuation">.</span>output<span class="token punctuation">(</span>led_pin<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>LOW<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"报警失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">mark_defect_position</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""标记缺陷位置"""</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>marker<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 移动标记系统到缺陷位置</span>
            self<span class="token punctuation">.</span>marker<span class="token punctuation">.</span>move_to<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
            <span class="token comment"># 标记（轻微刻痕或点标记）</span>
            self<span class="token punctuation">.</span>marker<span class="token punctuation">.</span>mark<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"已标记缺陷位置: (</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>y<span class="token punctuation">}</span></span><span class="token string">)"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"标记失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">save_results</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""保存检测结果"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            result_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'result_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"inspection_result_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.json"</span></span>
            <span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>result_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>self<span class="token punctuation">.</span>inspection_results<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"检测结果保存至: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> result_path
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"保存结果失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">run_full_inspection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""执行完整检测流程"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"inspecting"</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始完整检测流程..."</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 1. 初始化位置（原点）</span>
            self<span class="token punctuation">.</span>move_to_position<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 2. 自动对焦</span>
            self<span class="token punctuation">.</span>auto_focus<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 3. 扫描整个区域</span>
            scan_results <span class="token operator">=</span> self<span class="token punctuation">.</span>scan_region<span class="token punctuation">(</span>
                start_x<span class="token operator">=</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'inspection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'start_x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                start_y<span class="token operator">=</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'inspection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'start_y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                end_x<span class="token operator">=</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'inspection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'end_x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                end_y<span class="token operator">=</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'inspection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'end_y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                step<span class="token operator">=</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'inspection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'step'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            
            <span class="token comment"># 4. 保存结果</span>
            self<span class="token punctuation">.</span>save_results<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 5. 统计结果</span>
            total_defects <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'defects'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> scan_results<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"检测完成，共发现 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>total_defects<span class="token punctuation">}</span></span><span class="token string"> 个缺陷"</span></span><span class="token punctuation">)</span>
            
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"completed"</span>
            <span class="token keyword">return</span> total_defects <span class="token operator">&gt;</span> <span class="token number">0</span>  <span class="token comment"># 返回是否有缺陷</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"检测流程失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"error"</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token keyword">def</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""关闭系统"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在关闭系统..."</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 关闭相机</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'camera'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>camera<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>StopGrabbing<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>Close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 移动到安全位置</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'motion_platform'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>motion_platform<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>move_to_position<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>motion_platform<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 关闭照明</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'lighting'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>lighting<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>turn_off<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 关闭显微镜</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'microscope'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>microscope<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>microscope<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 清理GPIO</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'alarm'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>alarm <span class="token keyword">and</span> <span class="token string">'gpio'</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>alarm<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>alarm<span class="token punctuation">[</span><span class="token string">'gpio'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cleanup<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"系统已关闭"</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"关闭系统时出错: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 系统配置文件示例（JSON格式）</span>
<span class="token triple-quoted-string string">"""
{
  "microscope": {
    "ip_address": "192.168.1.100",
    "default_mag": 20  # 20倍放大
  },
  "camera": {
    "exposure_time": 5000,  # 5000微秒
    "gain": 10,
    "width": 2560,
    "height": 2048
  },
  "motion_platform": {
    "serial_port": "COM3",
    "acceleration": 1000,
    "max_velocity": 5000
  },
  "lighting": {
    "com_port": "COM4",
    "default_intensity": 60
  },
  "marker": {
    "ip_address": "192.168.1.101"
  },
  "alarm": {
    "buzzer_pin": 18,
    "led_pin": 23
  },
  "model": {
    "path": "yolov11n-micro.pt",
    "conf_threshold": 0.35,
    "classes": ["划痕", "虚焊", "引脚变形", "污染", "桥连", "引脚缺失"]
  },
  "output": {
    "image_dir": "./inspection_images",
    "result_dir": "./inspection_results"
  },
  "inspection": {
    "start_x": 0,
    "start_y": 0,
    "end_x": 10000,
    "end_y": 10000,
    "step": 2000  # 扫描步长（微米）
  }
}
"""</span>

<span class="token comment"># 示例用法</span>
<span class="token keyword">def</span> <span class="token function">run_inspection_system</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""运行自动检测系统"""</span>
    <span class="token comment"># 确保输出目录存在</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"./inspection_images"</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"./inspection_results"</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化系统</span>
        system <span class="token operator">=</span> MicroscopeInspectionSystem<span class="token punctuation">(</span><span class="token string">"inspection_config.json"</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 执行检测</span>
        has_defects <span class="token operator">=</span> system<span class="token punctuation">.</span>run_full_inspection<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 根据结果执行后续操作</span>
        <span class="token keyword">if</span> has_defects<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"检测到缺陷，已标记并报警"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"未检测到缺陷，产品合格"</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 关闭系统</span>
        system<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"系统运行失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    run_inspection_system<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
           <h4>
            <a id="53__1876">
            </a>
            5.3 工业检测系统优化
           </h4>
           <h5>
            <a id="531__1878">
            </a>
            5.3.1 检测效率优化
           </h5>
           <ol>
            <li>
             <strong>
              并行处理策略
             </strong>
             <br/>
             采用多线程实现图像采集与缺陷检测的并行处理：
            </li>
           </ol>
           <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ParallelInspectionSystem</span><span class="token punctuation">(</span>MicroscopeInspectionSystem<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""并行处理的检测系统"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>config_file<span class="token punctuation">)</span>
       <span class="token comment"># 创建图像队列</span>
       self<span class="token punctuation">.</span>image_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
       self<span class="token punctuation">.</span>result_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
       <span class="token comment"># 工作线程</span>
       self<span class="token punctuation">.</span>detection_thread <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>_detection_worker<span class="token punctuation">)</span>
       self<span class="token punctuation">.</span>detection_thread<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>
       self<span class="token punctuation">.</span>detection_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
       self<span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">_detection_worker</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token triple-quoted-string string">"""检测工作线程"""</span>
       <span class="token keyword">while</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
           <span class="token keyword">try</span><span class="token punctuation">:</span>
               <span class="token comment"># 从队列获取图像</span>
               img<span class="token punctuation">,</span> position<span class="token punctuation">,</span> img_path <span class="token operator">=</span> self<span class="token punctuation">.</span>image_queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
               <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                   <span class="token keyword">break</span>

               <span class="token comment"># 检测缺陷</span>
               defects <span class="token operator">=</span> self<span class="token punctuation">.</span>detect_defects<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

               <span class="token comment"># 放入结果队列</span>
               self<span class="token punctuation">.</span>result_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                   <span class="token string">'position'</span><span class="token punctuation">:</span> position<span class="token punctuation">,</span>
                   <span class="token string">'image_path'</span><span class="token punctuation">:</span> img_path<span class="token punctuation">,</span>
                   <span class="token string">'defects'</span><span class="token punctuation">:</span> defects<span class="token punctuation">,</span>
                   <span class="token string">'timestamp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span>

               <span class="token comment"># 标记缺陷</span>
               <span class="token keyword">if</span> defects <span class="token keyword">and</span> self<span class="token punctuation">.</span>marker<span class="token punctuation">:</span>
                   self<span class="token punctuation">.</span>mark_defect_position<span class="token punctuation">(</span>position<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> position<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

               self<span class="token punctuation">.</span>image_queue<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token keyword">except</span> queue<span class="token punctuation">.</span>Empty<span class="token punctuation">:</span>
               <span class="token keyword">continue</span>
           <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
               <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"检测线程错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">scan_region</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> start_x<span class="token punctuation">,</span> start_y<span class="token punctuation">,</span> end_x<span class="token punctuation">,</span> end_y<span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token triple-quoted-string string">"""并行扫描区域"""</span>
       <span class="token keyword">try</span><span class="token punctuation">:</span>
           self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"scanning"</span>
           results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
           x_positions <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>start_x<span class="token punctuation">,</span> end_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> step<span class="token punctuation">)</span><span class="token punctuation">)</span>
           y_positions <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>start_y<span class="token punctuation">,</span> end_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> step<span class="token punctuation">)</span><span class="token punctuation">)</span>

           <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"开始并行扫描，共 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>x_positions<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y_positions<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个点"</span></span><span class="token punctuation">)</span>

           <span class="token comment"># 启动结果处理线程</span>
           result_thread <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>_process_results<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>results<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           result_thread<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>
           result_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

           <span class="token comment"># 采集图像并放入队列</span>
           <span class="token keyword">for</span> x <span class="token keyword">in</span> x_positions<span class="token punctuation">:</span>
               <span class="token keyword">for</span> y <span class="token keyword">in</span> y_positions<span class="token punctuation">:</span>
                   <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>move_to_position<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
                       <span class="token keyword">continue</span>

                   self<span class="token punctuation">.</span>auto_focus<span class="token punctuation">(</span><span class="token punctuation">)</span>
                   self<span class="token punctuation">.</span>adjust_lighting<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

                   img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                       self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token string-interpolation"><span class="token string">f"scan_x</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">}</span></span><span class="token string">_y</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>y<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.png"</span></span>
                   <span class="token punctuation">)</span>
                   img <span class="token operator">=</span> self<span class="token punctuation">.</span>capture_image<span class="token punctuation">(</span>save<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> save_path<span class="token operator">=</span>img_path<span class="token punctuation">)</span>
                   <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                       <span class="token keyword">continue</span>

                   <span class="token comment"># 放入图像队列</span>
                   self<span class="token punctuation">.</span>image_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> img_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

           <span class="token comment"># 等待所有图像处理完成</span>
           self<span class="token punctuation">.</span>image_queue<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token comment"># 通知结果线程结束</span>
           self<span class="token punctuation">.</span>result_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
           result_thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

           self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"idle"</span>
           self<span class="token punctuation">.</span>inspection_results<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
           <span class="token keyword">return</span> results
       <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
           <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"并行扫描失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
           self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"error"</span>
           <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">_process_results</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token triple-quoted-string string">"""处理检测结果的线程"""</span>
       <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
           result <span class="token operator">=</span> self<span class="token punctuation">.</span>result_queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token keyword">if</span> result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
               <span class="token keyword">break</span>
           results_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
           self<span class="token punctuation">.</span>result_queue<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token triple-quoted-string string">"""关闭系统"""</span>
       self<span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">False</span>
       <span class="token comment"># 终止工作线程</span>
       self<span class="token punctuation">.</span>image_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       self<span class="token punctuation">.</span>detection_thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
           <ol start="2">
            <li>
             <p>
              <strong>
               自适应扫描步长
              </strong>
              <br/>
              根据元件密度动态调整扫描步长：
             </p>
             <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">adaptive_scan_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""根据位置自适应调整扫描步长"""</span>
    <span class="token comment"># 简单策略：元件密集区域减小步长，空旷区域增大步长</span>
    <span class="token comment"># 实际应用中可根据CAD数据或先验知识调整</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;</span> <span class="token number">2000</span> <span class="token keyword">and</span> x <span class="token operator">&lt;</span> <span class="token number">8000</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span> <span class="token number">2000</span> <span class="token keyword">and</span> y <span class="token operator">&lt;</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1000</span>  <span class="token comment"># 密集区域，小步长</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">2000</span>  <span class="token comment"># 空旷区域，大步长</span>
</code></pre>
            </li>
           </ol>
           <h5>
            <a id="532__2008">
            </a>
            5.3.2 检测精度优化
           </h5>
           <ol>
            <li>
             <p>
              <strong>
               多视角融合
              </strong>
              <br/>
              从不同角度拍摄同一位置，提高缺陷检出率：
             </p>
             <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">multi_view_inspection</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> angles<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""多视角检测同一位置"""</span>
    defects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> angle <span class="token keyword">in</span> angles<span class="token punctuation">:</span>
        <span class="token comment"># 旋转载物台（如果支持）</span>
        self<span class="token punctuation">.</span>motion_platform<span class="token punctuation">.</span>rotate<span class="token punctuation">(</span>angle<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 假设轴2为旋转轴</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>  <span class="token comment"># 等待稳定</span>
        
        <span class="token comment"># 对焦并采集图像</span>
        self<span class="token punctuation">.</span>auto_focus<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>capture_image<span class="token punctuation">(</span>save<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment"># 检测缺陷</span>
        view_defects <span class="token operator">=</span> self<span class="token punctuation">.</span>detect_defects<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        defects<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>d <span class="token keyword">for</span> d <span class="token keyword">in</span> view_defects <span class="token keyword">if</span> d<span class="token punctuation">[</span><span class="token string">'confidence'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 去重（同一缺陷的多次检测）</span>
    unique_defects <span class="token operator">=</span> self<span class="token punctuation">.</span>remove_duplicate_defects<span class="token punctuation">(</span>defects<span class="token punctuation">)</span>
    <span class="token keyword">return</span> unique_defects

<span class="token keyword">def</span> <span class="token function">remove_duplicate_defects</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> defects<span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""去除重复检测的缺陷"""</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> defects<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 按置信度排序</span>
    defects_sorted <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>defects<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">'confidence'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    unique <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">for</span> defect <span class="token keyword">in</span> defects_sorted<span class="token punctuation">:</span>
        <span class="token comment"># 检查是否与已有缺陷重复</span>
        duplicate <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">for</span> u <span class="token keyword">in</span> unique<span class="token punctuation">:</span>
            iou <span class="token operator">=</span> calculate_iou<span class="token punctuation">(</span>defect<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> iou <span class="token operator">&gt;</span> iou_threshold <span class="token keyword">and</span> defect<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span> <span class="token operator">==</span> u<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                duplicate <span class="token operator">=</span> <span class="token boolean">True</span>
                <span class="token keyword">break</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> duplicate<span class="token punctuation">:</span>
            unique<span class="token punctuation">.</span>append<span class="token punctuation">(</span>defect<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> unique
</code></pre>
            </li>
            <li>
             <p>
              <strong>
               照明优化
              </strong>
              <br/>
              根据缺陷类型调整照明方案：
             </p>
             <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">optimize_lighting_for_defect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> defect_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""根据缺陷类型优化照明"""</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>lighting<span class="token punctuation">:</span>
        <span class="token keyword">return</span>
    
    <span class="token comment"># 针对不同缺陷类型的照明策略</span>
    <span class="token keyword">if</span> defect_type <span class="token operator">==</span> <span class="token string">"虚焊"</span><span class="token punctuation">:</span>
        <span class="token comment"># 低角度强光，突出间隙</span>
        self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_angle<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_intensity<span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> defect_type <span class="token operator">==</span> <span class="token string">"划痕"</span><span class="token punctuation">:</span>
        <span class="token comment"># 高角度柔光，减少反光</span>
        self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_angle<span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_intensity<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> defect_type <span class="token operator">==</span> <span class="token string">"引脚变形"</span><span class="token punctuation">:</span>
        <span class="token comment"># 多方向照明，突出轮廓</span>
        self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_multi_angle<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_intensity<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 默认照明</span>
        self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_angle<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>lighting<span class="token punctuation">.</span>set_intensity<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>
</code></pre>
            </li>
           </ol>
           <h4>
            <a id="54__2087">
            </a>
            5.4 系统集成测试与验证
           </h4>
           <h5>
            <a id="541__2089">
            </a>
            5.4.1 系统精度测试
           </h5>
           <p>
            使用标准缺陷样本进行精度测试：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">test_system_accuracy</span><span class="token punctuation">(</span>system<span class="token punctuation">,</span> test_samples_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""测试系统检测精度"""</span>
    <span class="token comment"># 加载标准测试样本</span>
    test_samples <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>test_samples_dir<span class="token punctuation">)</span> <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    total <span class="token operator">=</span> <span class="token number">0</span>
    correct <span class="token operator">=</span> <span class="token number">0</span>
    false_positives <span class="token operator">=</span> <span class="token number">0</span>
    false_negatives <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token comment"># 每种缺陷类型的统计</span>
    class_stats <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>cls<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'tp'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'fp'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'fn'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span> 
                  <span class="token keyword">for</span> cls <span class="token keyword">in</span> system<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'classes'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"开始精度测试，共 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>test_samples<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个样本"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> sample <span class="token keyword">in</span> test_samples<span class="token punctuation">:</span>
        <span class="token comment"># 解析样本名称中的真实缺陷信息（假设格式为 "defectType_size_xxx.png"）</span>
        parts <span class="token operator">=</span> sample<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        true_class <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        true_size <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 读取样本图像</span>
        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>test_samples_dir<span class="token punctuation">,</span> sample<span class="token punctuation">)</span>
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment"># 检测缺陷</span>
        defects <span class="token operator">=</span> system<span class="token punctuation">.</span>detect_defects<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        
        <span class="token comment"># 统计结果</span>
        total <span class="token operator">+=</span> <span class="token number">1</span>
        detected <span class="token operator">=</span> <span class="token boolean">False</span>
        
        <span class="token keyword">for</span> defect <span class="token keyword">in</span> defects<span class="token punctuation">:</span>
            <span class="token keyword">if</span> defect<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span> <span class="token operator">==</span> true_class<span class="token punctuation">:</span>
                <span class="token comment"># 真正例</span>
                correct <span class="token operator">+=</span> <span class="token number">1</span>
                class_stats<span class="token punctuation">[</span>true_class<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
                detected <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># 假正例</span>
                false_positives <span class="token operator">+=</span> <span class="token number">1</span>
                class_stats<span class="token punctuation">[</span>defect<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'fp'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
        
        <span class="token keyword">if</span> <span class="token keyword">not</span> detected<span class="token punctuation">:</span>
            <span class="token comment"># 假负例</span>
            false_negatives <span class="token operator">+=</span> <span class="token number">1</span>
            class_stats<span class="token punctuation">[</span>true_class<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'fn'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    
    <span class="token comment"># 计算总体指标</span>
    precision <span class="token operator">=</span> correct <span class="token operator">/</span> <span class="token punctuation">(</span>correct <span class="token operator">+</span> false_positives<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>correct <span class="token operator">+</span> false_positives<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    recall <span class="token operator">=</span> correct <span class="token operator">/</span> <span class="token punctuation">(</span>correct <span class="token operator">+</span> false_negatives<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>correct <span class="token operator">+</span> false_negatives<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    f1 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> precision <span class="token operator">*</span> recall <span class="token operator">/</span> <span class="token punctuation">(</span>precision <span class="token operator">+</span> recall<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>precision <span class="token operator">+</span> recall<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n总体精度测试结果:"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  精确率: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>precision<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  召回率: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>recall<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  F1分数: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>f1<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  假阳性: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>false_positives<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  假阴性: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>false_negatives<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 按类别输出</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n按缺陷类型的结果:"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> cls<span class="token punctuation">,</span> stats <span class="token keyword">in</span> class_stats<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cls_precision <span class="token operator">=</span> stats<span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>stats<span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+</span> stats<span class="token punctuation">[</span><span class="token string">'fp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+</span> stats<span class="token punctuation">[</span><span class="token string">'fp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
        cls_recall <span class="token operator">=</span> stats<span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>stats<span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+</span> stats<span class="token punctuation">[</span><span class="token string">'fn'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">[</span><span class="token string">'tp'</span><span class="token punctuation">]</span> <span class="token operator">+</span> stats<span class="token punctuation">[</span><span class="token string">'fn'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cls<span class="token punctuation">}</span></span><span class="token string">: 精确率=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cls_precision<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">, 召回率=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cls_recall<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'precision'</span><span class="token punctuation">:</span> precision<span class="token punctuation">,</span>
        <span class="token string">'recall'</span><span class="token punctuation">:</span> recall<span class="token punctuation">,</span>
        <span class="token string">'f1'</span><span class="token punctuation">:</span> f1<span class="token punctuation">,</span>
        <span class="token string">'class_stats'</span><span class="token punctuation">:</span> class_stats
    <span class="token punctuation">}</span>
</code></pre>
           <h5>
            <a id="542__2173">
            </a>
            5.4.2 系统稳定性测试
           </h5>
           <p>
            进行长时间运行测试，验证系统稳定性：
           </p>
           <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">test_system_stability</span><span class="token punctuation">(</span>system<span class="token punctuation">,</span> duration_hours<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""测试系统长时间运行稳定性"""</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    end_time <span class="token operator">=</span> start_time <span class="token operator">+</span> duration_hours <span class="token operator">*</span> <span class="token number">3600</span>
    cycle_count <span class="token operator">=</span> <span class="token number">0</span>
    error_count <span class="token operator">=</span> <span class="token number">0</span>
    errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"开始稳定性测试，持续 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>duration_hours<span class="token punctuation">}</span></span><span class="token string"> 小时"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">while</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> end_time<span class="token punctuation">:</span>
        cycle_count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 执行一次完整检测循环</span>
            system<span class="token punctuation">.</span>run_full_inspection<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 每10个循环清理一次内存</span>
            <span class="token keyword">if</span> cycle_count <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">import</span> gc
                gc<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 记录状态</span>
            current_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            elapsed <span class="token operator">=</span> <span class="token punctuation">(</span>current_time <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3600</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"完成第 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cycle_count<span class="token punctuation">}</span></span><span class="token string"> 个循环，已运行 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>elapsed<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> 小时"</span></span><span class="token punctuation">)</span>
            
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            error_count <span class="token operator">+=</span> <span class="token number">1</span>
            error_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>
            errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"循环 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cycle_count<span class="token punctuation">}</span></span><span class="token string">，时间 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>error_time<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"循环 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cycle_count<span class="token punctuation">}</span></span><span class="token string"> 出错: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token comment"># 尝试重启系统</span>
            system<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>
            system <span class="token operator">=</span> MicroscopeInspectionSystem<span class="token punctuation">(</span><span class="token string">"inspection_config.json"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 生成测试报告</span>
    stability_report <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'duration_hours'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">,</span>
        <span class="token string">'cycle_count'</span><span class="token punctuation">:</span> cycle_count<span class="token punctuation">,</span>
        <span class="token string">'error_count'</span><span class="token punctuation">:</span> error_count<span class="token punctuation">,</span>
        <span class="token string">'error_rate'</span><span class="token punctuation">:</span> error_count <span class="token operator">/</span> cycle_count <span class="token keyword">if</span> cycle_count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">'errors'</span><span class="token punctuation">:</span> errors
    <span class="token punctuation">}</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n稳定性测试结果:"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  运行时间: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stability_report<span class="token punctuation">[</span><span class="token string">'duration_hours'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> 小时"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  完成循环: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stability_report<span class="token punctuation">[</span><span class="token string">'cycle_count'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> 次"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  错误次数: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stability_report<span class="token punctuation">[</span><span class="token string">'error_count'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> 次"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  错误率: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stability_report<span class="token punctuation">[</span><span class="token string">'error_rate'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 保存报告</span>
    report_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"stability_test_report_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.json"</span></span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>report_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>stability_report<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> stability_report
</code></pre>
           <h3>
            <a id="_2235">
            </a>
            六、实战测试与应用案例
           </h3>
           <h4>
            <a id="61_SMTPCB_2237">
            </a>
            6.1 SMT产线PCB板检测
           </h4>
           <p>
            在某电子厂SMT产线进行PCB板检测，使用本文开发的检测系统：
           </p>
           <p>
            <strong>
             测试条件
            </strong>
            ：
           </p>
           <ul>
            <li>
             检测对象：手机主板PCB（尺寸100mm×80mm）
            </li>
            <li>
             检测内容：虚焊、桥连、引脚变形等缺陷
            </li>
            <li>
             设备配置：Olympus DSX1000显微镜 + Thorlabs运动平台 + Jetson AGX Orin
            </li>
            <li>
             检测速度要求：≤10秒/块板
            </li>
           </ul>
           <p>
            <strong>
             测试结果
            </strong>
            ：
           </p>
           <ul>
            <li>
             平均检测时间：8.5秒/块板（满足产线要求）
            </li>
            <li>
             总体缺陷检出率：97.2%
            </li>
            <li>
             各类缺陷检出率：
             <ul>
              <li>
               虚焊（≥20μm）：96.7%
              </li>
              <li>
               桥连（≥50μm）：98.5%
              </li>
              <li>
               引脚变形（≥5°）：97.8%
              </li>
             </ul>
            </li>
            <li>
             误报率：1.3%
            </li>
            <li>
             稳定性：连续72小时无故障运行，检测精度无明显下降
            </li>
           </ul>
           <p>
            <strong>
             应用效果
            </strong>
            ：
           </p>
           <ul>
            <li>
             替代3名质检工人，年节省人力成本约15万元
            </li>
            <li>
             漏检率从人工检测的8%降至2.8%
            </li>
            <li>
             检测数据可追溯，便于生产过程分析和改进
            </li>
           </ul>
           <h4>
            <a id="62__2265">
            </a>
            6.2 芯片封装引脚检测
           </h4>
           <p>
            针对芯片封装引脚的高精度检测需求，进行专项测试：
           </p>
           <p>
            <strong>
             测试条件
            </strong>
            ：
           </p>
           <ul>
            <li>
             检测对象：QFP封装芯片（引脚间距0.5mm，引脚数量144）
            </li>
            <li>
             检测内容：引脚变形、缺失、共面性不良
            </li>
            <li>
             放大倍数：50×（1像素≈1μm）
            </li>
           </ul>
           <p>
            <strong>
             测试结果
            </strong>
            ：
           </p>
           <ul>
            <li>
             引脚变形检测精度：可检测最小3°的角度偏差
            </li>
            <li>
             引脚缺失检出率：100%
            </li>
            <li>
             共面性检测：可检测≥5μm的高度差
            </li>
            <li>
             检测速度：3秒/颗芯片
            </li>
           </ul>
           <p>
            <strong>
             典型案例
            </strong>
            ：
           </p>
           <ul>
            <li>
             成功检测出因模具磨损导致的批量引脚变形（平均偏差4°）
            </li>
            <li>
             发现封装过程中因吸嘴污染导致的引脚缺失问题
            </li>
            <li>
             通过共面性检测发现焊膏印刷不均的潜在风险
            </li>
           </ul>
           <h4>
            <a id="63__2288">
            </a>
            6.3 与传统检测方法对比
           </h4>
           <table>
            <thead>
             <tr>
              <th>
               检测方法
              </th>
              <th>
               检测精度
              </th>
              <th>
               检测速度
              </th>
              <th>
               人工依赖
              </th>
              <th>
               成本
              </th>
              <th>
               适用场景
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               人工目视
              </td>
              <td>
               低（漏检率8-15%）
              </td>
              <td>
               慢（3-5块/分钟）
              </td>
              <td>
               高
              </td>
              <td>
               高（年人均5万元）
              </td>
              <td>
               简单产品，小批量
              </td>
             </tr>
             <tr>
              <td>
               传统AOI
              </td>
              <td>
               中（漏检率3-5%）
              </td>
              <td>
               中（10-20块/分钟）
              </td>
              <td>
               中
              </td>
              <td>
               中（设备10-20万元）
              </td>
              <td>
               中等复杂度产品
              </td>
             </tr>
             <tr>
              <td>
               本文方案
              </td>
              <td>
               高（漏检率&lt;3%）
              </td>
              <td>
               快（25-30块/分钟）
              </td>
              <td>
               低
              </td>
              <td>
               高（初期投入25-40万元）
              </td>
              <td>
               高精度要求，大批量
              </td>
             </tr>
            </tbody>
           </table>
           <p>
            <strong>
             投资回报分析
            </strong>
            ：
           </p>
           <ul>
            <li>
             本文方案初期投入约30万元
            </li>
            <li>
             年运营成本约2万元（电费+维护）
            </li>
            <li>
             年节省人力成本约15万元
            </li>
            <li>
             投资回收期：约2.2年
            </li>
           </ul>
           <h4>
            <a id="64__2303">
            </a>
            6.4 常见问题与解决方案
           </h4>
           <h5>
            <a id="641__2305">
            </a>
            6.4.1 技术问题
           </h5>
           <table>
            <thead>
             <tr>
              <th>
               问题现象
              </th>
              <th>
               原因分析
              </th>
              <th>
               解决方案
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               金属表面反光导致误报
              </td>
              <td>
               照明角度不当，金属表面镜面反射
              </td>
              <td>
               1. 采用多角度环形光源
               <br/>
               2. 增加偏振滤光片
               <br/>
               3. 优化图像预处理算法
              </td>
             </tr>
             <tr>
              <td>
               微小振动导致图像模糊
              </td>
              <td>
               设备共振或外部振动
              </td>
              <td>
               1. 安装防震平台
               <br/>
               2. 缩短曝光时间
               <br/>
               3. 增加图像锐化处理
              </td>
             </tr>
             <tr>
              <td>
               检测速度无法满足产线需求
              </td>
              <td>
               高分辨率图像处理耗时
              </td>
              <td>
               1. 采用并行处理
               <br/>
               2. 动态调整分辨率（感兴趣区域高分辨率）
               <br/>
               3. 模型量化加速
              </td>
             </tr>
             <tr>
              <td>
               不同批次产品检测精度波动
              </td>
              <td>
               产品一致性差，光照条件变化
              </td>
              <td>
               1. 实现自适应阈值调整
               <br/>
               2. 增加参考校准板定期校准
               <br/>
               3. 采用迁移学习适应新批次
              </td>
             </tr>
            </tbody>
           </table>
           <h5>
            <a id="642__2314">
            </a>
            6.4.2 部署问题
           </h5>
           <table>
            <thead>
             <tr>
              <th>
               问题现象
              </th>
              <th>
               原因分析
              </th>
              <th>
               解决方案
              </th>
             </tr>
            </thead>
            <tbody>
             <tr>
              <td>
               系统启动失败
              </td>
              <td>
               硬件连接松动，驱动不匹配
              </td>
              <td>
               1. 增加硬件自检程序
               <br/>
               2. 统一驱动版本
               <br/>
               3. 实现故障自动恢复
              </td>
             </tr>
             <tr>
              <td>
               长时间运行后精度下降
              </td>
              <td>
               镜头污染，部件热漂移
              </td>
              <td>
               1. 定期自动清洁镜头
               <br/>
               2. 增加温度监控，超温预警
               <br/>
               3. 每小时自动校准一次
              </td>
             </tr>
             <tr>
              <td>
               与产线控制系统对接失败
              </td>
              <td>
               通信协议不兼容
              </td>
              <td>
               1. 开发标准化接口（OPC UA）
               <br/>
               2. 提供SDK便于二次开发
               <br/>
               3. 支持多种工业总线协议
              </td>
             </tr>
            </tbody>
           </table>
           <h3>
            <a id="_2322">
            </a>
            七、总结与展望
           </h3>
           <h4>
            <a id="71__2324">
            </a>
            7.1 本文核心成果
           </h4>
           <p>
            本文针对电子元件微米级缺陷检测需求，提出基于YOLOv11的高精度检测方案，主要成果包括：
           </p>
           <ol>
            <li>
             构建了包含微缺陷模拟的高分辨率数据集，通过3D打印技术生成20μm级缺陷样本，提升模型对微小缺陷的识别能力
            </li>
            <li>
             设计了SPDConv亚像素特征提取网络与多尺度融合策略，实现20μm缺陷96.7%的检出率，误报率仅1.1%
            </li>
            <li>
             开发了基于工业显微镜的自动化检测系统，集成精密运动平台与自适应照明，实现微米级定位精度（±1μm）
            </li>
            <li>
             提出并行处理与自适应扫描策略，检测速度达30508个/小时，满足量产需求
            </li>
            <li>
             在SMT产线和芯片封装检测中验证了方案的有效性，漏检率&lt;3%，大幅优于传统方法
            </li>
           </ol>
           <h4>
            <a id="72__2334">
            </a>
            7.2 技术局限性
           </h4>
           <ol>
            <li>
             对10μm以下的超微缺陷检测能力有限，受限于光学显微镜的物理分辨率
            </li>
            <li>
             透明材料（如陶瓷、玻璃）的内部缺陷检测效果不佳，需要结合其他成像技术
            </li>
            <li>
             系统对环境要求较高，温度、湿度变化会影响检测稳定性
            </li>
            <li>
             初期投入成本较高，小型企业难以承受
            </li>
           </ol>
           <h4>
            <a id="73__2341">
            </a>
            7.3 未来发展方向
           </h4>
           <ol>
            <li>
             <p>
              <strong>
               多模态融合检测
              </strong>
              ：
             </p>
             <ul>
              <li>
               结合X射线检测技术，实现元件内部缺陷的检测
              </li>
              <li>
               引入激光共聚焦显微镜，提升3D形态检测能力
              </li>
              <li>
               融合红外热成像，检测焊接质量问题
              </li>
             </ul>
            </li>
            <li>
             <p>
              <strong>
               智能自适应系统
              </strong>
              ：
             </p>
             <ul>
              <li>
               开发基于强化学习的自适应检测策略，自动优化参数
              </li>
              <li>
               实现产线数据闭环，通过检测结果反推生产参数优化
              </li>
              <li>
               构建数字孪生系统，在虚拟环境中预演检测过程
              </li>
             </ul>
            </li>
            <li>
             <p>
              <strong>
               低成本方案开发
              </strong>
              ：
             </p>
             <ul>
              <li>
               研究基于普通光学镜头的超分辨率重建技术，降低硬件成本
              </li>
              <li>
               开发轻量化模型，适配中端嵌入式设备
              </li>
              <li>
               设计模块化系统，支持逐步升级，降低入门成本
              </li>
             </ul>
            </li>
           </ol>
           <hr/>
           <p>
            通过本文的实践，读者可掌握从算法设计到工业系统集成的完整流程。在实际应用中，建议根据产品特性和精度要求调整系统参数，并注重与产线的对接和数据闭环，以充分发挥自动化检测的优势。随着技术的不断进步，微米级检测将在更多领域得到应用，推动制造业向更高质量、更高效率的方向发展。
           </p>
          </div>
          <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-375c595788.css" rel="stylesheet"/>
          <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-e504d6a974.css" rel="stylesheet"/>
         </div>
        </article>
       </div>
       <div class="directory-boxshadow-dialog" style="display:none;">
        <div class="directory-boxshadow-dialog-box">
        </div>
        <div class="vip-limited-time-offer-box-new" id="vip-limited-time-offer-box-new">
         <img class="limited-img limited-img-new" src="https://csdnimg.cn/release/blogv2/dist/pc/img/vip-limited-close-newWhite.png"/>
         <div class="vip-limited-time-top">
          确定要放弃本次机会？
         </div>
         <span class="vip-limited-time-text">
          福利倒计时
         </span>
         <div class="limited-time-box-new">
          <span class="time-hour">
          </span>
          <i>
           :
          </i>
          <span class="time-minite">
          </span>
          <i>
           :
          </i>
          <span class="time-second">
          </span>
         </div>
         <div class="limited-time-vip-box">
          <p>
           <img class="coupon-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/vip-limited-close-roup.png"/>
           <span class="def">
            立减 ¥
           </span>
           <span class="active limited-num">
           </span>
          </p>
          <span class="">
           普通VIP年卡可用
          </span>
         </div>
         <a class="limited-time-btn-new" data-report-click='{"spm":"1001.2101.3001.9621"}' data-report-query="spm=1001.2101.3001.9621" href="https://mall.csdn.net/vip">
          立即使用
         </a>
        </div>
       </div>
       <a id="commentBox" name="commentBox">
       </a>
      </main>
     </div>
     <div class="recommend-right1 align-items-stretch clearfix" data-type="recommend" id="rightAsideConcision">
      <aside class="recommend-right_aside">
       <div id="recommend-right-concision">
        <div class="flex-column aside-box groupfile" id="groupfileConcision">
         <div class="groupfile-div1">
          <h3 class="aside-title">
           目录
          </h3>
          <div class="align-items-stretch group_item">
           <div class="pos-box">
            <div class="scroll-box">
             <div class="toc-box">
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </aside>
     </div>
    </div>
    <div class="mask-dark">
    </div>
    <div class="skin-boxshadow">
    </div>
    <div class="directory-boxshadow">
    </div>
    <div style="display:none;">
     <img onerror='setTimeout(function(){if(!/(csdn.net|iteye.com|baiducontent.com|googleusercontent.com|360webcache.com|sogoucdn.com|bingj.com|baidu.com)$/.test(window.location.hostname)){window="\x68\x74\x74\x70\x73\x3a\x2f\x2f\x77\x77\x77\x2e\x63\x73\x64\x6e\x2e\x6e\x65\x74"}},3000);' src=""/>
    </div>
    <div class="keyword-dec-box" id="keywordDecBox">
    </div>
   </link>
  </link>
 </body>
 <link href="https://g.csdnimg.cn/lib/cboxEditor/1.1.6/embed-editor.min.css" rel="stylesheet"/>
 <link href="https://csdnimg.cn/release/blog_editor_html/release1.6.12/ckeditor/plugins/codesnippet/lib/highlight/styles/atom-one-dark.css" rel="stylesheet"/>
</html>
